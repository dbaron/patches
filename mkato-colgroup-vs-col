From: Makoto Kato <m_kato@ga2.so-net.ne.jp>

Bug 434733:  Don't apply width on colgroups to columns that have their own width.  r=dbaron

diff --git a/layout/reftests/bugs/434733-1-ref.html b/layout/reftests/bugs/434733-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/434733-1-ref.html
@@ -0,0 +1,12 @@
+<!DOCTYPE html>
+<html>
+<head>
+<title>Testcase for width attribute of colgroup element (bug 434733)</title>
+</head>
+<body>
+<table border="1">
+<colgroup><col width="200"/><col width="400"/></colgroup>
+<tr><td>width is 200</td><td>width is 400</td></tr>
+</table>
+</body>
+</html>
diff --git a/layout/reftests/bugs/434733-1.html b/layout/reftests/bugs/434733-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/434733-1.html
@@ -0,0 +1,12 @@
+<!DOCTYPE html>
+<html>
+<head>
+<title>Testcase for width attribute of colgroup element (bug 434733)</title>
+</head>
+<body>
+<table border="1">
+<colgroup width="400"><col width="200"/><col/></colgroup>
+<tr><td>width is 200</td><td>width is 400</td></tr>
+</table>
+</body>
+</html>
diff --git a/layout/reftests/bugs/434733-2-ref.html b/layout/reftests/bugs/434733-2-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/434733-2-ref.html
@@ -0,0 +1,12 @@
+<!DOCTYPE html>
+<html>
+<head>
+<title>Testcase for width attribute of colgroup element (bug 434733)</title>
+</head>
+<body>
+<table border="1" width="600">
+<colgroup><col width="20%"/><col width="40%"/><col width="40%"/></colgroup>
+<tr><td>width is 20%</td><td>width is 40%</td><td>width is 40%</td></tr>
+</table>
+</body>
+</html>
diff --git a/layout/reftests/bugs/434733-2.html b/layout/reftests/bugs/434733-2.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/434733-2.html
@@ -0,0 +1,12 @@
+<!DOCTYPE html>
+<html>
+<head>
+<title>Testcase for width attribute of colgroup element (bug 434733)</title>
+</head>
+<body>
+<table border="1" width="600">
+<colgroup width="40%"><col width="20%"/><col/><col/></colgroup>
+<tr><td>width is 20%</td><td>width is 40%</td><td>width is 40%</td></tr>
+</table>
+</body>
+</html>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -1041,16 +1041,18 @@ fails == 428810-3f-rtl-insets.html 42881
 != 428810-3-rtl-insets-ref.html 428810-3-ltr-insets-ref.html
 == 430412-1.html 430412-1-ref.html
 == 430813-1.html 430813-1-ref.html
 == 430813-2.html 430813-2-ref.html
 == 430813-3.html 430813-3-ref.html
 == 431341-1.html 431341-1-ref.html
 == 431341-2.html 431341-2-ref.html
 == 431520-1.html 431520-1-ref.html
+== 434733-1.html 434733-1-ref.html
+== 434733-2.html 434733-2-ref.html
 == 440112.html 440112-ref.html
 == 433640-1.html 433640-1-ref.html
 == 433700.html 433700-ref.html
 == 436356-1.html 436356-1-ref.html
 == 436356-2.html 436356-2-ref.html
 == 438981-1.xhtml about:blank
 == 438987-1.html 438987-1-ref.html
 == 438987-2a.html 438987-2-ref.html
diff --git a/layout/tables/BasicTableLayoutStrategy.cpp b/layout/tables/BasicTableLayoutStrategy.cpp
--- a/layout/tables/BasicTableLayoutStrategy.cpp
+++ b/layout/tables/BasicTableLayoutStrategy.cpp
@@ -268,24 +268,28 @@ BasicTableLayoutStrategy::ComputeColumnI
         CellWidthInfo colInfo = GetColWidthInfo(aRenderingContext, colFrame);
         colFrame->AddCoords(colInfo.minCoord, colInfo.prefCoord,
                             colInfo.hasSpecifiedWidth);
         colFrame->AddPrefPercent(colInfo.prefPercent);
 
         // Consider the widths on the column-group.  Note that we follow
         // what the HTML spec says here, and make the width apply to
         // each column in the group, not the group as a whole.
-        // XXX Should we be doing this when we have widths on the column?
-        NS_ASSERTION(colFrame->GetParent()->GetType() ==
-                         nsGkAtoms::tableColGroupFrame,
-                     "expected a column-group");
-        colInfo = GetColWidthInfo(aRenderingContext, colFrame->GetParent());
-        colFrame->AddCoords(colInfo.minCoord, colInfo.prefCoord,
-                            colInfo.hasSpecifiedWidth);
-        colFrame->AddPrefPercent(colInfo.prefPercent);
+
+        // If column has width, column-group doesn't override width.
+        if (colInfo.minCoord == 0 && colInfo.prefCoord == 0 &&
+            colInfo.prefPercent == 0.0f) {
+            NS_ASSERTION(colFrame->GetParent()->GetType() ==
+                             nsGkAtoms::tableColGroupFrame,
+                         "expected a column-group");
+            colInfo = GetColWidthInfo(aRenderingContext, colFrame->GetParent());
+            colFrame->AddCoords(colInfo.minCoord, colInfo.prefCoord,
+                                colInfo.hasSpecifiedWidth);
+            colFrame->AddPrefPercent(colInfo.prefPercent);
+        }
 
         // Consider the contents of and the widths on the cells without
         // colspans.
         nsCellMapColumnIterator columnIter(cellMap, col);
         PRInt32 row, colSpan;
         nsTableCellFrame* cellFrame;
         while ((cellFrame = columnIter.GetNextFrame(&row, &colSpan))) {
             if (colSpan > 1) {

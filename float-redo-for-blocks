Fix bug 25888 for blocks:  redo block reflow when the height of a block that does not intersect floats pushes it into the way of other floats.  (Bug 25888)

diff --git a/layout/generic/nsBlockFrame.cpp b/layout/generic/nsBlockFrame.cpp
--- a/layout/generic/nsBlockFrame.cpp
+++ b/layout/generic/nsBlockFrame.cpp
@@ -2948,56 +2948,89 @@ nsBlockFrame::ReflowBlockFrame(nsBlockRe
         
         // Note that aState.mY should stay where it is: at the top
         // border-edge of the frame
       } else {
         // Advance aState.mY to the top border-edge of the frame.
         aState.mY += topMargin;
       }
     }
-    
+
     // Here aState.mY is the top border-edge of the block.
     // Compute the available space for the block
     aState.GetAvailableSpace();
-#ifdef REALLY_NOISY_REFLOW
-    printf("setting line %p isImpacted to %s\n", aLine.get(), aState.IsImpactedByFloat()?"true":"false");
-#endif
-    PRBool isImpacted = aState.IsImpactedByFloat() ? PR_TRUE : PR_FALSE;
-    aLine->SetLineIsImpactedByFloat(isImpacted);
     nsRect availSpace;
     aState.ComputeBlockAvailSpace(frame, display, replacedBlock != nsnull,
                                   availSpace);
-    
-    // Now put the Y coordinate back to the top of the top-margin +
-    // clearance, and flow the block.
-    aState.mY -= topMargin;
-    availSpace.y -= topMargin;
-    if (NS_UNCONSTRAINEDSIZE != availSpace.height) {
-      availSpace.height += topMargin;
-    }
-    
-    // Reflow the block into the available space
-    // construct the html reflow state for the block. ReflowBlock 
-    // will initialize it
-    nsHTMLReflowState blockHtmlRS(aState.mPresContext, aState.mReflowState, frame, 
-                                  nsSize(availSpace.width, availSpace.height));
-    blockHtmlRS.mFlags.mHasClearance = aLine->HasClearance();
-    
-    nsFloatManager::SavedState floatManagerState;
-    if (mayNeedRetry) {
-      blockHtmlRS.mDiscoveredClearance = &clearanceFrame;
-      aState.mFloatManager->PushState(&floatManagerState);
-    } else if (!applyTopMargin) {
-      blockHtmlRS.mDiscoveredClearance = aState.mReflowState.mDiscoveredClearance;
-    }
-    
-    nsReflowStatus frameReflowStatus = NS_FRAME_COMPLETE;
-    rv = brc.ReflowBlock(availSpace, applyTopMargin, aState.mPrevBottomMargin,
-                         clearance, aState.IsAdjacentWithTop(),
-                         aLine.get(), blockHtmlRS, frameReflowStatus, aState);
+
+    do {
+  #ifdef REALLY_NOISY_REFLOW
+      printf("setting line %p isImpacted to %s\n", aLine.get(), aState.IsImpactedByFloat()?"true":"false");
+  #endif
+      PRBool isImpacted = aState.IsImpactedByFloat() ? PR_TRUE : PR_FALSE;
+      aLine->SetLineIsImpactedByFloat(isImpacted);
+      
+      // Now put the Y coordinate back to the top of the top-margin +
+      // clearance, and flow the block.
+      aState.mY -= topMargin;
+      availSpace.y -= topMargin;
+      if (NS_UNCONSTRAINEDSIZE != availSpace.height) {
+        availSpace.height += topMargin;
+      }
+      
+      // Reflow the block into the available space
+      // construct the html reflow state for the block. ReflowBlock 
+      // will initialize it
+      nsHTMLReflowState blockHtmlRS(aState.mPresContext,
+                                    aState.mReflowState, frame, 
+                                    nsSize(availSpace.width,
+                                           availSpace.height));
+      blockHtmlRS.mFlags.mHasClearance = aLine->HasClearance();
+      
+      nsFloatManager::SavedState floatManagerState;
+      if (mayNeedRetry) {
+        blockHtmlRS.mDiscoveredClearance = &clearanceFrame;
+        aState.mFloatManager->PushState(&floatManagerState);
+      } else if (!applyTopMargin) {
+        blockHtmlRS.mDiscoveredClearance =
+          aState.mReflowState.mDiscoveredClearance;
+      }
+      
+      nsReflowStatus frameReflowStatus = NS_FRAME_COMPLETE;
+      rv = brc.ReflowBlock(availSpace, applyTopMargin, aState.mPrevBottomMargin,
+                           clearance, aState.IsAdjacentWithTop(),
+                           aLine.get(), blockHtmlRS, frameReflowStatus, aState);
+
+      // Now the block has a height.  Using that height, get the
+      // available space again and call ComputeBlockAvailSpace again.
+      // If ComputeBlockAvailSpace gives a different result, we need to
+      // reflow again.
+      if (replacedBlock) {
+        nsRect oldAvailSpaceRect(aState.mAvailSpaceRect);
+        aState.GetAvailableSpaceForHeight(aState.mY, brc.GetMetrics().height);
+        NS_ASSERTION(aState.mAvailSpaceRect.y == oldAvailSpaceRect.y, "yikes");
+        NS_ASSERTION(aState.mAvailSpaceRect.x >= oldAvailSpaceRect.x,
+                     "should never have more room");
+        NS_ASSERTION(aState.mAvailSpaceRect.XMost() <=
+                       oldAvailSpaceRect.XMost(),
+                     "should never have more room");
+        // Restore the height to the position of the next band.
+        aState.mAvailSpaceRect.height = oldAvailSpaceRect.height;
+        if (oldAvailSpaceRect.x != aState.mAvailSpaceRect.x ||
+            oldAvailSpaceRect.width != aState.mAvailSpaceRect.width) {
+          nsRect oldAvailSpace(availSpace);
+          aState.ComputeBlockAvailSpace(frame, display,
+                                        replacedBlock != nsnull, availSpace);
+          if (!availSpace.IsExactEqual(oldAvailSpace)) {
+            // We need another reflow.
+            continue;
+          }
+        }
+      }
+    } while (PR_FALSE);
 
     // If this was a second-pass reflow and the block's vertical position
     // changed, invalidates from the first pass might have happened in the
     // wrong places.  Invalidate the entire overflow rect at the new position.
     if (!mayNeedRetry && clearanceFrame &&
         frame->GetRect().y != passOriginalY) {
       Invalidate(frame->GetOverflowRect() + frame->GetPosition());
     }
diff --git a/layout/reftests/bugs/25888-1l.html b/layout/reftests/bugs/25888-1l-block.html
copy from layout/reftests/bugs/25888-1l.html
copy to layout/reftests/bugs/25888-1l-block.html
--- a/layout/reftests/bugs/25888-1l.html
+++ b/layout/reftests/bugs/25888-1l-block.html
@@ -1,17 +1,17 @@
 <!DOCTYPE HTML>
 <html>
 <head>
 <title>Testcase, bug 25888</title>
 <style type="text/css">
 
 body { width: 400px; border: medium solid; text-align: left; }
 div { float: left; clear: left; }
-span { display: inline-block; vertical-align: top; width: 200px; height: 50px; background: aqua; }
+span { display: block; overflow: hidden; width: 200px; height: 50px; background: aqua; }
 
 </style>
 </head>
 <body>
 
 <div style="width: 50px; height: 75px;"></div>
 <div style="width: 100px; height: 75px;"></div>
 <span></span>
diff --git a/layout/reftests/bugs/25888-1r.html b/layout/reftests/bugs/25888-1r-block.html
copy from layout/reftests/bugs/25888-1r.html
copy to layout/reftests/bugs/25888-1r-block.html
--- a/layout/reftests/bugs/25888-1r.html
+++ b/layout/reftests/bugs/25888-1r-block.html
@@ -1,17 +1,17 @@
 <!DOCTYPE HTML>
 <html>
 <head>
 <title>Testcase, bug 25888</title>
 <style type="text/css">
 
 body { width: 400px; border: medium solid; text-align: right; }
 div { float: right; clear: right; }
-span { display: inline-block; vertical-align: top; width: 200px; height: 50px; background: aqua; }
+span { display: block; overflow: hidden; width: 200px; height: 50px; background: aqua; }
 
 </style>
 </head>
 <body>
 
 <div style="width: 50px; height: 75px;"></div>
 <div style="width: 100px; height: 75px;"></div>
 <span></span>
diff --git a/layout/reftests/bugs/25888-2l.html b/layout/reftests/bugs/25888-2l-block.html
copy from layout/reftests/bugs/25888-2l.html
copy to layout/reftests/bugs/25888-2l-block.html
--- a/layout/reftests/bugs/25888-2l.html
+++ b/layout/reftests/bugs/25888-2l-block.html
@@ -1,16 +1,16 @@
 <!DOCTYPE HTML>
 <html>
 <head>
 <title>Testcase, bug 25888</title>
 <style type="text/css">
 
 body { width: 400px; border: medium solid; }
-span { display: inline-block; vertical-align: top; width: 200px; height: 50px; background: aqua; }
+span { display: block; overflow: hidden; width: 200px; height: 50px; background: aqua; }
 
 </style>
 </head>
 <body>
 
 <div style="float: left; width: 150px; height: 75px;"></div>
 <div style="float: right; width: 300px; height: 75px;"></div>
 <span></span>
diff --git a/layout/reftests/bugs/25888-2r.html b/layout/reftests/bugs/25888-2r-block.html
copy from layout/reftests/bugs/25888-2r.html
copy to layout/reftests/bugs/25888-2r-block.html
--- a/layout/reftests/bugs/25888-2r.html
+++ b/layout/reftests/bugs/25888-2r-block.html
@@ -1,16 +1,16 @@
 <!DOCTYPE HTML>
 <html>
 <head>
 <title>Testcase, bug 25888</title>
 <style type="text/css">
 
 body { width: 400px; border: medium solid; }
-span { display: inline-block; vertical-align: top; width: 200px; height: 50px; background: aqua; }
+span { display: block; overflow: hidden; width: 200px; height: 50px; background: aqua; }
 
 </style>
 </head>
 <body>
 
 <div style="float: right; width: 150px; height: 75px;"></div>
 <div style="float: left; width: 300px; height: 75px;"></div>
 <span></span>
diff --git a/layout/reftests/bugs/25888-3l.html b/layout/reftests/bugs/25888-3l-block.html
copy from layout/reftests/bugs/25888-3l.html
copy to layout/reftests/bugs/25888-3l-block.html
--- a/layout/reftests/bugs/25888-3l.html
+++ b/layout/reftests/bugs/25888-3l-block.html
@@ -1,16 +1,16 @@
 <!DOCTYPE HTML>
 <html>
 <head>
 <title>Testcase, bug 25888</title>
 <style type="text/css">
 
 body { width: 400px; border: medium solid; }
-span { display: inline-block; vertical-align: top; width: 100px; height: 50px; background: aqua; }
+span { display: block; overflow: hidden; width: 100px; height: 50px; background: aqua; }
 
 </style>
 </head>
 <body>
 
 <div style="float: left; width: 250px; height: 75px;"></div>
 <div style="float: right; width: 250px; height: 75px;"></div>
 <span></span>
diff --git a/layout/reftests/bugs/25888-3r.html b/layout/reftests/bugs/25888-3r-block.html
copy from layout/reftests/bugs/25888-3r.html
copy to layout/reftests/bugs/25888-3r-block.html
--- a/layout/reftests/bugs/25888-3r.html
+++ b/layout/reftests/bugs/25888-3r-block.html
@@ -1,16 +1,16 @@
 <!DOCTYPE HTML>
 <html>
 <head>
 <title>Testcase, bug 25888</title>
 <style type="text/css">
 
 body { width: 400px; border: medium solid; }
-span { display: inline-block; vertical-align: top; width: 100px; height: 50px; background: aqua; }
+span { display: block; overflow: hidden; width: 100px; height: 50px; background: aqua; }
 
 </style>
 </head>
 <body>
 
 <div style="float: right; width: 250px; height: 75px;"></div>
 <div style="float: left; width: 250px; height: 75px;"></div>
 <span></span>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -37,16 +37,24 @@
 == 25888-1l.html 25888-1l-ref.html
 != 25888-1l.html 25888-1l-notref.html
 == 25888-1r.html 25888-1r-ref.html
 != 25888-1r.html 25888-1r-notref.html
 == 25888-2l.html 25888-2l-ref.html
 == 25888-2r.html 25888-2r-ref.html
 == 25888-3l.html 25888-3l-ref.html
 == 25888-3r.html 25888-3r-ref.html
+== 25888-1l-block.html 25888-1l-ref.html
+!= 25888-1l-block.html 25888-1l-notref.html
+== 25888-1r-block.html 25888-1r-ref.html
+!= 25888-1r-block.html 25888-1r-notref.html
+== 25888-2l-block.html 25888-2l-ref.html
+== 25888-2r-block.html 25888-2r-ref.html
+== 25888-3l-block.html 25888-3l-ref.html
+== 25888-3r-block.html 25888-3r-ref.html
 == 28811-1a.html 28811-1-ref.html
 == 28811-1b.html 28811-1-ref.html
 == 28811-2a.html 28811-2-ref.html
 == 28811-2b.html 28811-2-ref.html
 == 40596-1a.html 40596-1-ref.html
 != 40596-1b.html 40596-1-ref.html
 == 40596-1c.html 40596-1-ref.html
 != 40596-1d.html 40596-1-ref.html

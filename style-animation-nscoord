From: L. David Baron <dbaron@dbaron.org>

Add support for animation of nscoord values to nsStyleAnimation.  (Bug 504652)

diff --git a/layout/style/nsCSSPropList.h b/layout/style/nsCSSPropList.h
--- a/layout/style/nsCSSPropList.h
+++ b/layout/style/nsCSSPropList.h
@@ -1412,18 +1412,20 @@ CSS_PROP_FONT(
     font-size,
     font_size,
     FontSize,
     CSS_PROPERTY_APPLIES_TO_FIRST_LETTER_AND_FIRST_LINE,
     Font,
     mSize,
     eCSSType_Value,
     kFontSizeKTable,
-    CSS_PROP_NO_OFFSET,
-    eStyleAnimType_None)
+    // Note that mSize is the correct place for *reading* the computed value,
+    // but setting it requires setting mFont.size as well.
+    offsetof(nsStyleFont, mSize),
+    eStyleAnimType_nscoord)
 CSS_PROP_FONT(
     font-size-adjust,
     font_size_adjust,
     FontSizeAdjust,
     CSS_PROPERTY_APPLIES_TO_FIRST_LETTER_AND_FIRST_LINE,
     Font,
     mSizeAdjust,
     eCSSType_Value,
@@ -1862,18 +1864,18 @@ CSS_PROP_OUTLINE(
     outline-offset,
     outline_offset,
     OutlineOffset,
     0,
     Margin,
     mOutlineOffset,
     eCSSType_Value,
     nsnull,
-    CSS_PROP_NO_OFFSET,
-    eStyleAnimType_None)
+    offsetof(nsStyleOutline, mOutlineOffset),
+    eStyleAnimType_nscoord)
 CSS_PROP_SHORTHAND(
     overflow,
     overflow,
     Overflow,
     0)
 CSS_PROP_DISPLAY(
     overflow-x,
     overflow_x,
@@ -2523,18 +2525,18 @@ CSS_PROP_TEXT(
     word-spacing,
     word_spacing,
     WordSpacing,
     CSS_PROPERTY_APPLIES_TO_FIRST_LETTER_AND_FIRST_LINE,
     Text,
     mWordSpacing,
     eCSSType_Value,
     nsnull,
-    CSS_PROP_NO_OFFSET,
-    eStyleAnimType_None)
+    offsetof(nsStyleText, mWordSpacing),
+    eStyleAnimType_nscoord)
 CSS_PROP_TEXT(
     word-wrap,
     word_wrap,
     WordWrap,
     0,
     Text,
     mWordWrap,
     eCSSType_Value,
diff --git a/layout/style/nsCSSProps.h b/layout/style/nsCSSProps.h
--- a/layout/style/nsCSSProps.h
+++ b/layout/style/nsCSSProps.h
@@ -74,16 +74,19 @@ enum nsStyleAnimType {
 
   // same as Coord, except for one side of an nsStyleSides
   // listed in the same order as the NS_STYLE_* constants
   eStyleAnimType_Sides_Top,
   eStyleAnimType_Sides_Right,
   eStyleAnimType_Sides_Bottom,
   eStyleAnimType_Sides_Left,
 
+  // nscoord values
+  eStyleAnimType_nscoord,
+
   // property not animatable
   eStyleAnimType_None
 };
 
 class nsCSSProps {
 public:
   static void AddRefTable(void);
   static void ReleaseTable(void);
diff --git a/layout/style/nsStyleAnimation.cpp b/layout/style/nsStyleAnimation.cpp
--- a/layout/style/nsStyleAnimation.cpp
+++ b/layout/style/nsStyleAnimation.cpp
@@ -327,16 +327,20 @@ nsStyleAnimation::ExtractComputedValue(n
       PR_STATIC_ASSERT(eStyleAnimType_Sides_Bottom - eStyleAnimType_Sides_Top
                          == NS_SIDE_BOTTOM);
       PR_STATIC_ASSERT(eStyleAnimType_Sides_Left - eStyleAnimType_Sides_Top
                          == NS_SIDE_LEFT);
       aComputedValue = static_cast<const nsStyleSides*>(
         StyleDataAtOffset(styleStruct, ssOffset))->
           Get(animType - eStyleAnimType_Sides_Top);
       return PR_TRUE;
+    case eStyleAnimType_nscoord:
+      aComputedValue.SetCoordValue(*static_cast<const nscoord*>(
+        StyleDataAtOffset(styleStruct, ssOffset)));
+      return PR_TRUE;
     case eStyleAnimType_None:
       NS_NOTREACHED("shouldn't use on non-animatable properties");
   }
   return PR_FALSE;
 }
 
 PRBool
 nsStyleAnimation::StoreComputedValue(nsCSSProperty aProperty,
@@ -371,13 +375,27 @@ nsStyleAnimation::StoreComputedValue(nsC
        nsStyleStructID sid = nsCSSProps::kSIDTable[aProperty];
        if (sid == eStyleStruct_Margin) {
          static_cast<nsStyleMargin*>(aStyleStruct)->RecalcData();
        } else if (sid == eStyleStruct_Padding) {
          static_cast<nsStylePadding*>(aStyleStruct)->RecalcData();
        }
       return PR_TRUE;
     }
+    case eStyleAnimType_nscoord:
+      *static_cast<nscoord*>(StyleDataAtOffset(aStyleStruct, ssOffset)) =
+        aComputedValue.GetCoordValue();
+      if (aProperty == eCSSProperty_font) {
+        nsStyleFont *font = static_cast<nsStyleFont*>(aStyleStruct);
+        if (!aPresContext->IsChrome()) {
+          nscoord minimumFontSize =
+            aPresContext->GetCachedIntPref(kPresContext_MinimumFontSize);
+          font->mFont.size = PR_MAX(font->mSize, minimumFontSize);
+        } else {
+          font->mFont.size = font->mSize;
+        }
+      }
+      return PR_TRUE;
     case eStyleAnimType_None:
       NS_NOTREACHED("shouldn't use on non-animatable properties");
   }
   return PR_FALSE;
 }

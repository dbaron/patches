Fix crashes when a JAR file has been changed.

diff -r af2c3403bb45 modules/libjar/nsJAR.cpp
--- a/modules/libjar/nsJAR.cpp	Mon Jan 22 16:22:33 2007 -0800
+++ b/modules/libjar/nsJAR.cpp	Mon Jan 22 17:54:57 2007 -0800
@@ -326,7 +326,6 @@ nsJAR::GetInputStreamWithSpec(const nsAC
   NS_ENSURE_ARG_POINTER(result);
 
   // Watch out for the jar:foo.zip!/ (aDir is empty) top-level special case!
-  PRFileDesc *fd = nsnull;
   nsZipItem *item = nsnull;
   if (*aEntryName) {
     // First check if item exists in jar
@@ -343,12 +342,19 @@ nsJAR::GetInputStreamWithSpec(const nsAC
     rv = jis->InitDirectory(&mZip, aJarDirSpec, aEntryName);
   } else {
     // Open jarfile, to get its own filedescriptor for the stream
+    // XXX The file may have been overwritten, so |item| might not be
+    // valid.  Can NSPR provide a portable version of dup(2) for this?
+    PRFileDesc *fd = nsnull;
     fd = OpenFile();
-    rv = fd ? jis->InitFile(&mZip, item, fd) : NS_ERROR_FAILURE;
+    if (fd) {
+      rv = jis->InitFile(&mZip, item, fd);
+      // |jis| now owns |fd|
+    } else {
+      rv = NS_ERROR_FAILURE;
+    }
   }
   if (NS_FAILED(rv)) {
     NS_RELEASE(*result);
-    if (fd) PR_Close(fd);
   }
   return rv;
 }
diff -r af2c3403bb45 modules/libjar/nsJARInputStream.cpp
--- a/modules/libjar/nsJARInputStream.cpp	Mon Jan 22 16:22:33 2007 -0800
+++ b/modules/libjar/nsJARInputStream.cpp	Mon Jan 22 17:56:02 2007 -0800
@@ -61,6 +61,9 @@ nsJARInputStream::InitFile(nsZipArchive*
 {
     nsresult rv;
 
+    // Keep the file handle, even on failure
+    mFd = fd;
+      
     NS_ENSURE_ARG_POINTER(aZip);
     NS_ENSURE_ARG_POINTER(item);
     NS_ENSURE_ARG_POINTER(fd);
@@ -68,9 +71,6 @@ nsJARInputStream::InitFile(nsZipArchive*
     // Mark it as closed, in case something fails in initialisation
     mClosed = PR_TRUE;
 
-    // Keep the file handle    
-    mFd = fd;
-      
     // Keep the important bits of nsZipItem only
     mInSize = item->size;
  
diff -r af2c3403bb45 modules/libjar/nsJARInputStream.h
--- a/modules/libjar/nsJARInputStream.h	Mon Jan 22 16:22:33 2007 -0800
+++ b/modules/libjar/nsJARInputStream.h	Mon Jan 22 17:55:33 2007 -0800
@@ -60,7 +60,9 @@ class nsJARInputStream : public nsIInput
     NS_DECL_ISUPPORTS
     NS_DECL_NSIINPUTSTREAM
    
+    // takes ownership of |fd|, even on failure
     nsresult InitFile(nsZipArchive* aZip, nsZipItem *item, PRFileDesc *fd);
+
     nsresult InitDirectory(nsZipArchive* aZip,
                            const nsACString& aJarDirSpec,
                            const char* aDir);

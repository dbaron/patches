Fix serialization of the list-style-type part of counter values.  (Bug 481591)  r+sr=bzbarsky

diff --git a/layout/base/nsCounterManager.cpp b/layout/base/nsCounterManager.cpp
--- a/layout/base/nsCounterManager.cpp
+++ b/layout/base/nsCounterManager.cpp
@@ -101,17 +101,23 @@ nsCounterUseNode::GetText(nsString& aRes
 
     nsAutoTArray<nsCounterNode*, 8> stack;
     stack.AppendElement(static_cast<nsCounterNode*>(this));
 
     if (mAllCounters && mScopeStart)
         for (nsCounterNode *n = mScopeStart; n->mScopePrev; n = n->mScopeStart)
             stack.AppendElement(n->mScopePrev);
 
-    PRInt32 style = mCounterStyle->Item(mAllCounters ? 2 : 1).GetIntValue();
+    const nsCSSValue& styleItem = mCounterStyle->Item(mAllCounters ? 2 : 1);
+    PRInt32 style;
+    if (styleItem.GetUnit() == eCSSUnit_None) {
+        style = NS_STYLE_LIST_STYLE_NONE;
+    } else {
+        style = styleItem.GetIntValue();
+    }
     const PRUnichar* separator;
     if (mAllCounters)
         separator = mCounterStyle->Item(1).GetStringBufferValue();
 
     for (PRUint32 i = stack.Length() - 1;; --i) {
         nsCounterNode *n = stack[i];
         nsBulletFrame::AppendCounterText(style, n->mValueAfter, aResult);
         if (i == 0)
diff --git a/layout/style/nsCSSParser.cpp b/layout/style/nsCSSParser.cpp
--- a/layout/style/nsCSSParser.cpp
+++ b/layout/style/nsCSSParser.cpp
@@ -4543,17 +4543,21 @@ CSSParserImpl::ParseCounter(nsCSSValue& 
       }
     }
     if (!success) {
       SkipUntil(')');
       return PR_FALSE;
     }
   }
   PRInt32 typeItem = eCSSUnit_Counters == unit ? 2 : 1;
-  val->Item(typeItem).SetIntValue(type, eCSSUnit_Enumerated);
+  if (type == NS_STYLE_LIST_STYLE_NONE) {
+    val->Item(typeItem).SetNoneValue();
+  } else {
+    val->Item(typeItem).SetIntValue(type, eCSSUnit_Enumerated);
+  }
 
   if (!ExpectSymbol(')', PR_TRUE)) {
     SkipUntil(')');
     return PR_FALSE;
   }
 
   aValue.SetArrayValue(val, unit);
   return PR_TRUE;
diff --git a/layout/style/nsComputedDOMStyle.cpp b/layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp
+++ b/layout/style/nsComputedDOMStyle.cpp
@@ -746,22 +746,22 @@ nsComputedDOMStyle::GetContent(nsIDOMCSS
           str.Append(a->Item(0).GetStringBufferValue());
           PRInt32 typeItem = 1;
           if (data.mType == eStyleContentType_Counters) {
             typeItem = 2;
             str.AppendLiteral(", ");
             nsStyleUtil::AppendEscapedCSSString(
               nsDependentString(a->Item(1).GetStringBufferValue()), str);
           }
-          PRInt32 type = a->Item(typeItem).GetIntValue();
-          if (type != NS_STYLE_LIST_STYLE_DECIMAL) {
-            str.AppendLiteral(", ");
-            if (type == NS_STYLE_LIST_STYLE_NONE) {
-              str.AppendLiteral("none");
-            } else {
+          if (a->Item(typeItem).GetUnit() == eCSSUnit_None) {
+            str.AppendLiteral(", none");
+          } else {
+            PRInt32 type = a->Item(typeItem).GetIntValue();
+            if (type != NS_STYLE_LIST_STYLE_DECIMAL) {
+              str.AppendLiteral(", ");
               AppendASCIItoUTF16(
                 nsCSSProps::ValueToKeyword(type, nsCSSProps::kListStyleKTable),
                 str);
             }
           }
 
           str.Append(PRUnichar(')'));
           val->SetString(str, nsIDOMCSSPrimitiveValue::CSS_COUNTER);

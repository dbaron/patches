From: L. David Baron <dbaron@dbaron.org>

Initialize statics in OnSemaphoreCreated so that we get data about locks created before any locks are locked.  (Bug 594666)

diff --git a/xpcom/glue/nsAutoLock.cpp b/xpcom/glue/nsAutoLock.cpp
--- a/xpcom/glue/nsAutoLock.cpp
+++ b/xpcom/glue/nsAutoLock.cpp
@@ -191,16 +191,19 @@ static nsNamedVector* GetVector(PLHashTa
     if (vec)
         PL_HashTableRawAdd(table, hep, hash, key, vec);
     return vec;
 }
 
 /* static */ void
 nsAutoLockBase::OnSemaphoreCreated(const void* key, const char* name )
 {
+    if (LockStackTPI == PRUintn(-1))
+        InitAutoLockStatics();
+
     if (key && OrderTable) {
         nsNamedVector* value = new nsNamedVector(name);
         if (value) {
             PR_Lock(OrderTableLock);
             PL_HashTableAdd(OrderTable, key, value);
             PR_Unlock(OrderTableLock);
         }
     }

From: L. David Baron <dbaron@dbaron.org>

Fix assertion about float manager state by restoring old float manager state when we place a float and then cancel that placement.  (Bug 563584, patch 1)  r=roc

diff --git a/layout/generic/nsBlockReflowState.cpp b/layout/generic/nsBlockReflowState.cpp
--- a/layout/generic/nsBlockReflowState.cpp
+++ b/layout/generic/nsBlockReflowState.cpp
@@ -569,16 +569,19 @@ nsBlockReflowState::AddFloat(nsLineLayou
   // don't let this one go on the current line, since that would violate
   // float ordering.
   nsRect floatAvailableSpace = GetFloatAvailableSpace().mRect;
   if (!aLineLayout ||
       (mBelowCurrentLineFloats.IsEmpty() &&
        (aLineLayout->LineIsEmpty() ||
         mBlock->ComputeFloatWidth(*this, floatAvailableSpace, aFloat)
         <= aAvailableWidth))) {
+    nsFloatManager::SavedState floatManagerState;
+    mFloatManager->PushState(&floatManagerState);
+
     // And then place it
     // force it to fit if we're at the top of the block and we can't
     // break before this
     PRBool forceFit = !aLineLayout ||
                       (IsAdjacentWithTop() && !aLineLayout->LineIsBreakable());
     placed = FlowAndPlaceFloat(aFloat, aReflowStatus, forceFit);
     NS_ASSERTION(placed || !forceFit,
                  "If we asked for force-fit, it should have been placed");
@@ -594,16 +597,21 @@ nsBlockReflowState::AddFloat(nsLineLayou
         // Record this float in the current-line list
         mCurrentLineFloats.Append(mFloatCacheFreeList.Alloc(aFloat));
       }
       // If we can't break here, hide the fact that it's truncated
       // XXX We can probably do this more cleanly
       aReflowStatus &= ~NS_FRAME_TRUNCATED;
     }
     else {
+      if (placed) {
+        mFloatManager->PopState(&floatManagerState);
+      } else {
+        mFloatManager->AssertStateMatches(&floatManagerState);
+      }
       if (IsAdjacentWithTop()) {
         // Pushing the line to the next page won't give us any more space;
         // therefore, we break.
         NS_ASSERTION(aLineLayout->LineIsBreakable(),
                      "We can't get here unless forceFit is false");
         aReflowStatus = NS_INLINE_LINE_BREAK_BEFORE();
       } else {
         // Make sure we propagate the truncated status; this signals the

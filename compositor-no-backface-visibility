From: L. David Baron <dbaron@dbaron.org>

Bug 1186061 - Disable compositor thread animation of transforms when backface-visibility is hidden.

We don't currently have a mechanism for rerendering when the front/back
flips, so we should disable running such animations on the compositor
thread for now until we do.

Bug 1186204 covers reenabling.

diff --git a/layout/reftests/transform-3d/animate-preserve3d-child.html b/layout/reftests/transform-3d/animate-backface-hidden.html
copy from layout/reftests/transform-3d/animate-preserve3d-child.html
copy to layout/reftests/transform-3d/animate-backface-hidden.html
--- a/layout/reftests/transform-3d/animate-preserve3d-child.html
+++ b/layout/reftests/transform-3d/animate-backface-hidden.html
@@ -1,54 +1,37 @@
 <!DOCTYPE HTML>
 <html class="reftest-wait">
-<title>Testcase, bug 1176969</title>
+<title>Testcase, bug 1186061</title>
 <style>
 
 body { padding: 50px }
 
-#grandparent { perspective: 400px }
-
-@keyframes spin {
-  0%, 85% { transform: rotateX(-45deg) rotateY(-45deg) rotateZ(-45deg); }
-  90%, 100% { transform: rotateX(-30deg) rotateY(-30deg) rotateZ(-30deg); }
+@keyframes flip {
+  0%, 85% { transform: rotateX(180deg); }
+  90%, 100% { transform: rotateX(0deg); }
 }
 
-#parent {
+#test {
+  perspective: 500px;
   background: blue;
   height: 200px; width: 200px;
-  border: 1px solid black;
-  transform-style: preserve-3d;
+  backface-visibility: hidden;
   /* use a -99.9s delay to start at 99.9% and then move to 0% */
-  animation: spin 100s -99.9s linear 2;
-}
-
-@keyframes noop {
-  from, to { transform: translateZ(15px) }
-}
-
-#child {
-  height: 100px; width: 100px; margin: 50px;
-  background: yellow;
-  box-shadow: 3px 3px olive;
-  animation: noop infinite 10s linear;
+  animation: flip 100s -99.9s linear 2;
 }
 
 </style>
 
-<div id="grandparent">
-  <div id="parent">
-    <div id="child">
-    </div>
-  </div>
+<div id="test">
 </div>
 
 <script>
 
-document.getElementById("parent").addEventListener("animationiteration", IterationListener, false);
+document.getElementById("test").addEventListener("animationiteration", IterationListener, false);
 
 function IterationListener(event) {
   setTimeout(RemoveReftestWait, 0);
 }
 
 function RemoveReftestWait() {
   document.documentElement.classList.remove("reftest-wait");
 }
diff --git a/layout/reftests/transform-3d/reftest.list b/layout/reftests/transform-3d/reftest.list
--- a/layout/reftests/transform-3d/reftest.list
+++ b/layout/reftests/transform-3d/reftest.list
@@ -60,8 +60,9 @@ fails-if(!layersGPUAccelerated) == 10356
 == animate-cube-radians.html animate-cube-radians-ref.html
 == animate-cube-radians-zoom.html animate-cube-radians-zoom-ref.html
 != animate-cube-radians-ref.html animate-cube-radians-zoom-ref.html
 == animate-cube-degrees.html animate-cube-degrees-ref.html
 == animate-cube-degrees-zoom.html animate-cube-degrees-zoom-ref.html
 != animate-cube-degrees-ref.html animate-cube-degrees-zoom-ref.html
 fuzzy-if(cocoaWidget,128,9) == animate-preserve3d-parent.html animate-preserve3d-ref.html # intermittently fuzzy on Mac
 fuzzy-if(cocoaWidget,128,9) == animate-preserve3d-child.html animate-preserve3d-ref.html # intermittently fuzzy on Mac
+== animate-backface-hidden.html about:blank
diff --git a/layout/style/AnimationCommon.cpp b/layout/style/AnimationCommon.cpp
--- a/layout/style/AnimationCommon.cpp
+++ b/layout/style/AnimationCommon.cpp
@@ -563,16 +563,28 @@ AnimationCollection::CanAnimatePropertyO
         frame->Preserves3DChildren()) {
       if (shouldLog) {
         nsCString message;
         message.AppendLiteral("Gecko bug: Async animation of 'preserve-3d' transforms is not supported.  See bug 779598");
         LogAsyncAnimationFailure(message, aElement);
       }
       return false;
     }
+    // Note that testing BackfaceIsHidden() is not a sufficient test for
+    // what we need for animating backface-visibility correctly if we
+    // remove the above test for Preserves3DChildren(); that would require
+    // looking at backface-visibility on descendants as well.
+    if (frame->StyleDisplay()->BackfaceIsHidden()) {
+      if (shouldLog) {
+        nsCString message;
+        message.AppendLiteral("Gecko bug: Async animation of 'backface-visibility: hidden' transforms is not supported.  See bug 1186204.");
+        LogAsyncAnimationFailure(message, aElement);
+      }
+      return false;
+    }
     if (frame->IsSVGTransformed()) {
       if (shouldLog) {
         nsCString message;
         message.AppendLiteral("Gecko bug: Async 'transform' animations of frames with SVG transforms is not supported.  See bug 779599");
         LogAsyncAnimationFailure(message, aElement);
       }
       return false;
     }

Hacks to get pango to shutdown more cleanly and thus allow us to shut down fontconfig.

diff --git a/gfx/thebes/src/gfxPangoFonts.cpp b/gfx/thebes/src/gfxPangoFonts.cpp
--- a/gfx/thebes/src/gfxPangoFonts.cpp
+++ b/gfx/thebes/src/gfxPangoFonts.cpp
@@ -259,9 +259,17 @@ gfxPangoFont::Shutdown()
     // assert and crash in cairo (Bug 399556), so only do this when we care
     // about cleaning up memory on shutdown.
 #if defined(DEBUG) || defined(NS_BUILD_REFCNT_LOGGING) || defined(NS_TRACE_MALLOC)
+    // Do some shutdown of the fontmap, which clears a bunch of circular
+    // references from the fontmap to itself.  The shutdown that this
+    // does is much less than what's done by the fontmap's finalize,
+    // though.
     PangoFontMap *fontmap = pango_cairo_font_map_get_default ();
     if (PANGO_IS_FC_FONT_MAP (fontmap))
         pango_fc_font_map_shutdown (PANGO_FC_FONT_MAP (fontmap));
+
+    // And then free the reference in the static (hope nobody else needs
+    // it!)
+    g_object_unref (fontmap);
 #endif
 }
 
diff --git a/gfx/thebes/src/gfxPlatform.cpp b/gfx/thebes/src/gfxPlatform.cpp
--- a/gfx/thebes/src/gfxPlatform.cpp
+++ b/gfx/thebes/src/gfxPlatform.cpp
@@ -193,14 +193,6 @@ gfxPlatform::~gfxPlatform()
     // because cairo can assert and thus crash on shutdown, don't do this in release builds
 #if MOZ_TREE_CAIRO && (defined(DEBUG) || defined(NS_BUILD_REFCNT_LOGGING) || defined(NS_TRACE_MALLOC))
     cairo_debug_reset_static_data();
-#endif
-
-#if 0
-    // It would be nice to do this (although it might need to be after
-    // the cairo shutdown that happens in ~gfxPlatform).  It even looks
-    // idempotent.  But it has fatal assertions that fire if stuff is
-    // leaked, and we hit them.
-    FcFini();
 #endif
 }
 
diff --git a/gfx/thebes/src/gfxPlatformGtk.cpp b/gfx/thebes/src/gfxPlatformGtk.cpp
--- a/gfx/thebes/src/gfxPlatformGtk.cpp
+++ b/gfx/thebes/src/gfxPlatformGtk.cpp
@@ -94,14 +94,6 @@ gfxPlatformGtk::~gfxPlatformGtk()
     sFontconfigUtils = nsnull;
 
     gfxPangoFont::Shutdown();
-
-#if 0
-    // It would be nice to do this (although it might need to be after
-    // the cairo shutdown that happens in ~gfxPlatform).  It even looks
-    // idempotent.  But it has fatal assertions that fire if stuff is
-    // leaked, and we hit them.
-    FcFini();
-#endif
 }
 
 already_AddRefed<gfxASurface>
diff --git a/toolkit/xre/nsAppRunner.cpp b/toolkit/xre/nsAppRunner.cpp
--- a/toolkit/xre/nsAppRunner.cpp
+++ b/toolkit/xre/nsAppRunner.cpp
@@ -271,6 +271,7 @@ static char **gRestartArgv;
 #include <gtk/gtk.h>
 #include <gdk/gdkx.h>
 #include "nsGTKToolkit.h"
+#include <fontconfig/fontconfig.h>
 #endif
 
 // Save the given word to the specified environment variable.
@@ -2374,6 +2375,7 @@ static void MOZ_gdk_display_close(GdkDis
 #if GTK_CHECK_VERSION(2,8,0) && \
   (defined(DEBUG) || defined(NS_BUILD_REFCNT_LOGGING) || defined(NS_TRACE_MALLOC))
     cairo_debug_reset_static_data();
+    FcFini();
 #endif
   }
 }

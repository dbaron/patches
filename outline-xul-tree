From: L. David Baron <dbaron@dbaron.org>

Bug 434102:  Make outlines behave reasonably on XUL tree pseudo-elements again.

This was a regression from bug 133165 which I noticed while working on
bug 480888, but wished to fix in a separate patch (despite that it would
have been slightly easier to fix it in the same patch).

diff --git a/layout/base/nsCSSRendering.cpp b/layout/base/nsCSSRendering.cpp
--- a/layout/base/nsCSSRendering.cpp
+++ b/layout/base/nsCSSRendering.cpp
@@ -609,21 +609,17 @@ nsCSSRendering::PaintOutline(nsPresConte
   nsRect innerRect;
   if (
 #ifdef MOZ_XUL
       aStyleContext->GetPseudoType() == nsCSSPseudoElements::ePseudo_XULTree
 #else
       false
 #endif
      ) {
-    // FIXME: This behavior doesn't make sense; we should switch back to
-    // using aBorderArea.  But since this has been broken since bug
-    // 133165 in August of 2004, that switch should be made in its own
-    // patch changing only that behavior.
-    innerRect = aForFrame->GetVisualOverflowRect();
+    innerRect = aBorderArea;
   } else {
     innerRect = GetOutlineInnerRect(aForFrame);
   }
   innerRect += aBorderArea.TopLeft();
   nscoord offset = ourOutline->mOutlineOffset;
   innerRect.Inflate(offset, offset);
   // If the dirty rect is completely inside the border area (e.g., only the
   // content is being painted), then we can skip out now
diff --git a/layout/reftests/xul/reftest.list b/layout/reftests/xul/reftest.list
--- a/layout/reftests/xul/reftest.list
+++ b/layout/reftests/xul/reftest.list
@@ -1,7 +1,8 @@
 == menuitem-key.xul menuitem-key-ref.xul
 # these random-if(Android) are due to differences between Android Native & Xul, see bug 732569
 random-if(Android||B2G) == menulist-shrinkwrap-1.xul menulist-shrinkwrap-1-ref.xul
 random-if(Android||B2G) fails-if(winWidget) == menulist-shrinkwrap-2.xul menulist-shrinkwrap-2-ref.xul
 == textbox-overflow-1.xul textbox-overflow-1-ref.xul # for bug 749658
 # accesskeys are not normally displayed on Mac, so skip this test
 skip-if(cocoaWidget) == accesskey.xul accesskey-ref.xul
+== tree-row-outline-1.xul tree-row-outline-1-ref.xul
diff --git a/layout/reftests/xul/tree-row-outline-1-ref.xul b/layout/reftests/xul/tree-row-outline-1-ref.xul
new file mode 100644
--- /dev/null
+++ b/layout/reftests/xul/tree-row-outline-1-ref.xul
@@ -0,0 +1,30 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        xmlns:html="http://www.w3.org/1999/xhtml"
+        >
+
+  <html:style>
+    <![CDATA[
+
+      treechildren::-moz-tree-row(even) {
+        border: 2px solid blue;
+      }
+
+    ]]>
+  </html:style>
+
+  <tree seltype="single">
+    <treecols>
+      <treecol flex="1"/>
+      <treecol flex="1"/>
+    </treecols>
+    <treechildren>
+      <treeitem><treerow><treecell label="One"/><treecell label="Two"/></treerow></treeitem>
+      <treeitem><treerow><treecell label="One"/><treecell label="Two"/></treerow></treeitem>
+      <treeitem><treerow><treecell label="One"/><treecell label="Two"/></treerow></treeitem>
+    </treechildren>
+  </tree>
+
+</window>
diff --git a/layout/reftests/xul/tree-row-outline-1.xul b/layout/reftests/xul/tree-row-outline-1.xul
new file mode 100644
--- /dev/null
+++ b/layout/reftests/xul/tree-row-outline-1.xul
@@ -0,0 +1,31 @@
+<?xml version="1.0"?>
+<?xml-stylesheet href="chrome://global/skin" type="text/css"?>
+
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
+        xmlns:html="http://www.w3.org/1999/xhtml"
+        >
+
+  <html:style>
+    <![CDATA[
+
+      treechildren::-moz-tree-row(even) {
+        outline: 2px solid blue;
+        outline-offset: -2px;
+      }
+
+    ]]>
+  </html:style>
+
+  <tree seltype="single">
+    <treecols>
+      <treecol flex="1"/>
+      <treecol flex="1"/>
+    </treecols>
+    <treechildren>
+      <treeitem><treerow><treecell label="One"/><treecell label="Two"/></treerow></treeitem>
+      <treeitem><treerow><treecell label="One"/><treecell label="Two"/></treerow></treeitem>
+      <treeitem><treerow><treecell label="One"/><treecell label="Two"/></treerow></treeitem>
+    </treechildren>
+  </tree>
+
+</window>

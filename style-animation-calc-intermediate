From: L. David Baron <dbaron@dbaron.org>

Allow calc() as an intermediate common animation unit between lengths, percentages, and calc().  (Bug 536539)

diff --git a/layout/style/nsStyleAnimation.cpp b/layout/style/nsStyleAnimation.cpp
--- a/layout/style/nsStyleAnimation.cpp
+++ b/layout/style/nsStyleAnimation.cpp
@@ -74,16 +74,26 @@ namespace css = mozilla::css;
 static
 nsStyleAnimation::Unit
 GetCommonUnit(nsStyleAnimation::Unit aFirstUnit,
               nsStyleAnimation::Unit aSecondUnit)
 {
   // XXXdholbert Naive implementation for now: simply require that the input
   // units match.
   if (aFirstUnit != aSecondUnit) {
+    if (/* FIXME: CHECK PROPERTY ALLOWS CALC */
+        (aFirstUnit == nsStyleAnimation::eUnit_Coord ||
+         aFirstUnit == nsStyleAnimation::eUnit_Percent ||
+         aFirstUnit == nsStyleAnimation::eUnit_Calc) &&
+        (aSecondUnit == nsStyleAnimation::eUnit_Coord ||
+         aSecondUnit == nsStyleAnimation::eUnit_Percent ||
+         aSecondUnit == nsStyleAnimation::eUnit_Calc)) {
+      // We can use calc() as the common unit.
+      return nsStyleAnimation::eUnit_Calc;
+    }
     // NOTE: Some unit-pairings will need special handling,
     // e.g. percent vs coord (bug 520234)
     return nsStyleAnimation::eUnit_Null;
   }
   return aFirstUnit;
 }
 
 // Greatest Common Divisor
@@ -117,23 +127,36 @@ lcm(PRUint32 a, PRUint32 b)
 struct CalcValue {
   float mLength, mPercent;
   PRBool mHasPercent;
 };
 
 static CalcValue
 ExtractCalcValue(const nsStyleAnimation::Value& aValue)
 {
+  CalcValue result;
+  if (aValue.GetUnit() == nsStyleAnimation::eUnit_Coord) {
+    result.mLength =
+      nsPresContext::AppUnitsToFloatCSSPixels(aValue.GetCoordValue());
+    result.mPercent = 0.0f;
+    result.mHasPercent = PR_FALSE;
+    return result;
+  }
+  if (aValue.GetUnit() == nsStyleAnimation::eUnit_Percent) {
+    result.mLength = 0.0f;
+    result.mPercent = aValue.GetPercentValue();
+    result.mHasPercent = PR_TRUE;
+    return result;
+  }
   NS_ABORT_IF_FALSE(aValue.GetUnit() == nsStyleAnimation::eUnit_Calc,
                     "unexpected unit");
   nsCSSValue *val = aValue.GetCSSValueValue();
   NS_ABORT_IF_FALSE(val->GetUnit() == eCSSUnit_Calc, "unexpected unit");
   nsCSSValue::Array *arr = val->GetArrayValue();
   NS_ABORT_IF_FALSE(arr->Count() == 1, "unexpected length");
-  CalcValue result;
 
   const nsCSSValue &topval = arr->Item(0);
   if (topval.GetUnit() == eCSSUnit_Pixel) {
     result.mLength = topval.GetFloatValue();
     result.mPercent = 0.0f;
     result.mHasPercent = PR_FALSE;
   } else {
     NS_ABORT_IF_FALSE(topval.GetUnit() == eCSSUnit_Calc_Plus,

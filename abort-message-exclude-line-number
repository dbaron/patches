From: L. David Baron <dbaron@dbaron.org>

Bug 1277448 patch 4 - Exclude the line number from the AbortMessage crash annotation.

MozReview-Commit-ID: AI6Iw2KsFAZ

diff --git a/xpcom/base/nsDebugImpl.cpp b/xpcom/base/nsDebugImpl.cpp
--- a/xpcom/base/nsDebugImpl.cpp
+++ b/xpcom/base/nsDebugImpl.cpp
@@ -339,28 +339,36 @@ NS_DebugBreak(uint32_t aSeverity, const 
   if (sMultiprocessDescription) {
     PrintToBuffer("%s ", sMultiprocessDescription);
   }
 
   PrintToBuffer("%d] ", base::GetCurrentProcId());
 
   PrintToBuffer("%s: ", sevString);
 
+  // Exclude the PID from the AbortMessage crash annotation since it
+  // messes up aggregation.  Also exclude the severity string since
+  // there's no need for it.
+  const char* crashMessageStart = buf.buffer + buf.curlen;
+
   if (aStr) {
     PrintToBuffer("%s: ", aStr);
   }
   if (aExpr) {
     PrintToBuffer("'%s', ", aExpr);
   }
   if (aFile) {
     PrintToBuffer("file %s, ", aFile);
   }
   if (aFunction) {
     PrintToBuffer("function %s, ", aFunction);
   }
+  // Exclude the line number from the crash AbortMessage since line numbers
+  // shift over time.
+  const char* crashMessageEnd = buf.buffer + buf.curlen;
   if (aLine != -1) {
     PrintToBuffer("line %d", aLine);
   }
 
 #  undef PrintToBuffer
 
   // errors on platforms without a debugdlg ring a bell on stderr
 #if !defined(XP_WIN)
@@ -394,17 +402,18 @@ NS_DebugBreak(uint32_t aSeverity, const 
       // really cause trouble if we're asserting from within IPC code. So we
       // have to do without the annotations in that case.
       if (XRE_IsParentProcess()) {
         nsCString note("xpcom_runtime_abort(");
         note += buf.buffer;
         note += ")";
         CrashReporter::AppendAppNotesToCrashReport(note);
         CrashReporter::AnnotateCrashReport(NS_LITERAL_CSTRING("AbortMessage"),
-                                           nsDependentCString(buf.buffer));
+                                           Substring(crashMessageStart,
+                                                     crashMessagEnd));
       }
 #endif  // MOZ_CRASHREPORTER
 
 #if defined(DEBUG) && defined(_WIN32)
       RealBreak();
 #endif
 #if defined(DEBUG)
       nsTraceRefcnt::WalkTheStack(stderr);

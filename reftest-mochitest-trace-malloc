From: L. David Baron <dbaron@dbaron.org>

Run reftests and mochitests with trace-malloc.

diff --git a/layout/tools/reftest/runreftest.py b/layout/tools/reftest/runreftest.py
--- a/layout/tools/reftest/runreftest.py
+++ b/layout/tools/reftest/runreftest.py
@@ -131,17 +131,17 @@ class RefTest(object):
   def runTests(self, testPath, options, cmdlineArgs = None):
     debuggerInfo = getDebuggerInfo(self.oldcwd, options.debugger, options.debuggerArgs,
         options.debuggerInteractive);
 
     profileDir = None
     try:
       reftestlist = self.getManifestPath(testPath)
       if cmdlineArgs == None:
-        cmdlineArgs = ['-reftest', reftestlist]
+        cmdlineArgs = ['-reftest', reftestlist, "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log"]
       profile = self.createReftestProfile(options, reftestlist)
       profileDir = profile.profile # name makes more sense
 
       # browser environment
       browserEnv = self.buildBrowserEnv(options, profileDir)
 
       self.automation.log.info("REFTEST INFO | runreftest.py | Running tests: start.\n")
       status = self.automation.runApp(None, browserEnv, options.app, profileDir,
diff --git a/testing/mochitest/runtests.py b/testing/mochitest/runtests.py
--- a/testing/mochitest/runtests.py
+++ b/testing/mochitest/runtests.py
@@ -1039,17 +1039,18 @@ class Mochitest(MochitestUtilsMixin):
       self.startVMwareRecording(options);
 
     log.info("runtests.py | Running tests: start.\n")
     try:
       status = self.runApp(testURL,
                            browserEnv,
                            options.app,
                            profile=self.profile,
-                           extraArgs=options.browserArgs,
+                           extraArgs=options.browserArgs +
+                                       [ "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log" ],
                            utilityPath=options.utilityPath,
                            xrePath=options.xrePath,
                            certPath=options.certPath,
                            debuggerInfo=debuggerInfo,
                            symbolsPath=options.symbolsPath,
                            timeout=timeout,
                            onLaunch=onLaunch
                            )

From: L. David Baron <dbaron@dbaron.org>

Run reftests and mochitests with trace-malloc.

diff --git a/layout/tools/reftest/runreftest.py b/layout/tools/reftest/runreftest.py
--- a/layout/tools/reftest/runreftest.py
+++ b/layout/tools/reftest/runreftest.py
@@ -145,17 +145,17 @@ class RefTest(object):
       browserEnv = self.buildBrowserEnv(options, profileDir)
 
       self.registerExtension(browserEnv, options, profileDir)
 
       # then again to actually run reftest
       self.automation.log.info("REFTEST INFO | runreftest.py | Running tests: start.\n")
       reftestlist = self.getManifestPath(manifest)
       status = self.automation.runApp(None, browserEnv, options.app, profileDir,
-                                 ["-reftest", reftestlist],
+                                 ["-reftest", reftestlist, "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log"],
                                  utilityPath = options.utilityPath,
                                  xrePath=options.xrePath,
                                  debuggerInfo=debuggerInfo,
                                  symbolsPath=options.symbolsPath,
                                  # give the JS harness 30 seconds to deal
                                  # with its own timeouts
                                  timeout=options.timeout + 30.0)
       processLeakLog(self.leakLogFile, options.leakThreshold)
diff --git a/testing/mochitest/runtests.py b/testing/mochitest/runtests.py
--- a/testing/mochitest/runtests.py
+++ b/testing/mochitest/runtests.py
@@ -635,17 +635,19 @@ class Mochitest(object):
     else:
       timeout = 330.0 # default JS harness timeout is 300 seconds
 
     if options.vmwareRecording:
       self.startVMwareRecording(options);
 
     self.automation.log.info("INFO | runtests.py | Running tests: start.\n")
     status = self.automation.runApp(testURL, browserEnv, options.app,
-                                options.profilePath, options.browserArgs,
+                                options.profilePath,
+                                options.browserArgs +
+                                  [ "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log" ],
                                 runSSLTunnel = self.runSSLTunnel,
                                 utilityPath = options.utilityPath,
                                 xrePath = options.xrePath,
                                 certPath=options.certPath,
                                 debuggerInfo=debuggerInfo,
                                 symbolsPath=options.symbolsPath,
                                 timeout = timeout)
 

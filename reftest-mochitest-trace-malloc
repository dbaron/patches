From: L. David Baron <dbaron@dbaron.org>

Run reftests and mochitests with trace-malloc.

diff --git a/layout/tools/reftest/runreftest.py b/layout/tools/reftest/runreftest.py
--- a/layout/tools/reftest/runreftest.py
+++ b/layout/tools/reftest/runreftest.py
@@ -565,17 +565,17 @@ class RefTest(object):
   def runSerialTests(self, testPath, options, cmdlineArgs = None):
     debuggerInfo = mozdebug.get_debugger_info(options.debugger, options.debuggerArgs,
         options.debuggerInteractive);
 
     profileDir = None
     try:
       reftestlist = self.getManifestPath(testPath)
       if cmdlineArgs == None:
-        cmdlineArgs = ['-reftest', reftestlist]
+        cmdlineArgs = ['-reftest', reftestlist, "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log"]
       profile = self.createReftestProfile(options, reftestlist)
       profileDir = profile.profile # name makes more sense
 
       # browser environment
       browserEnv = self.buildBrowserEnv(options, profileDir)
 
       log.info("REFTEST INFO | runreftest.py | Running tests: start.\n")
       status = self.runApp(profile,
diff --git a/testing/mochitest/runtests.py b/testing/mochitest/runtests.py
--- a/testing/mochitest/runtests.py
+++ b/testing/mochitest/runtests.py
@@ -1829,17 +1829,18 @@ class Mochitest(MochitestUtilsMixin):
       detectShutdownLeaks = mozinfo.info["debug"] and options.browserChrome and not options.webapprtChrome
 
       self.log.info("runtests.py | Running tests: start.\n")
       try:
         status = self.runApp(testURL,
                              self.browserEnv,
                              options.app,
                              profile=self.profile,
-                             extraArgs=options.browserArgs,
+                             extraArgs=options.browserArgs +
+                               [ "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log" ],
                              utilityPath=options.utilityPath,
                              debuggerInfo=debuggerInfo,
                              symbolsPath=options.symbolsPath,
                              timeout=timeout,
                              onLaunch=onLaunch,
                              detectShutdownLeaks=detectShutdownLeaks,
                              screenshotOnFail=options.screenshotOnFail,
                              testPath=options.testPath,

From: L. David Baron <dbaron@dbaron.org>

Run reftests and mochitests with trace-malloc.

diff --git a/layout/tools/reftest/runreftest.py b/layout/tools/reftest/runreftest.py
--- a/layout/tools/reftest/runreftest.py
+++ b/layout/tools/reftest/runreftest.py
@@ -148,17 +148,17 @@ class RefTest(object):
   def runTests(self, testPath, options, cmdlineArgs = None):
     debuggerInfo = getDebuggerInfo(self.oldcwd, options.debugger, options.debuggerArgs,
         options.debuggerInteractive);
 
     profileDir = None
     try:
       reftestlist = self.getManifestPath(testPath)
       if cmdlineArgs == None:
-        cmdlineArgs = ['-reftest', reftestlist]
+        cmdlineArgs = ['-reftest', reftestlist, "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log"]
       profileDir = mkdtemp()
       self.copyExtraFilesToProfile(options, profileDir)
       self.createReftestProfile(options, profileDir, reftestlist)
       self.installExtensionsToProfile(options, profileDir)
 
       # browser environment
       browserEnv = self.buildBrowserEnv(options, profileDir)
 
diff --git a/testing/mochitest/runtests.py b/testing/mochitest/runtests.py
--- a/testing/mochitest/runtests.py
+++ b/testing/mochitest/runtests.py
@@ -669,17 +669,19 @@ class Mochitest(object):
       timeout = 330.0 # default JS harness timeout is 300 seconds
 
     if options.vmwareRecording:
       self.startVMwareRecording(options);
 
     self.automation.log.info("INFO | runtests.py | Running tests: start.\n")
     try:
       status = self.automation.runApp(testURL, browserEnv, options.app,
-                                  options.profilePath, options.browserArgs,
+                                  options.profilePath,
+                                  options.browserArgs +
+                                    [ "--trace-malloc=malloc.log", "--shutdown-leaks=sdleak.log" ],
                                   runSSLTunnel = self.runSSLTunnel,
                                   utilityPath = options.utilityPath,
                                   xrePath = options.xrePath,
                                   certPath=options.certPath,
                                   debuggerInfo=debuggerInfo,
                                   symbolsPath=options.symbolsPath,
                                   timeout = timeout)
     except KeyboardInterrupt:

From: L. David Baron <dbaron@dbaron.org>

Bug 1176969 followup - Reorganize the timing of the reftest to make it more reliable.

I confirmed that animate-preserve3d-child.html still fails without the
original patch in the bug.

diff --git a/layout/reftests/transform-3d/animate-preserve3d-child.html b/layout/reftests/transform-3d/animate-preserve3d-child.html
--- a/layout/reftests/transform-3d/animate-preserve3d-child.html
+++ b/layout/reftests/transform-3d/animate-preserve3d-child.html
@@ -3,26 +3,27 @@
 <title>Testcase, bug 1176969</title>
 <style>
 
 body { padding: 50px }
 
 #grandparent { perspective: 400px }
 
 @keyframes spin {
-  0% { transform: rotateX(-30deg) rotateY(-30deg) rotateZ(-30deg); }
-  0.01%, 100% { transform: rotateX(-45deg) rotateY(-45deg) rotateZ(-45deg); }
+  0%, 85% { transform: rotateX(-45deg) rotateY(-45deg) rotateZ(-45deg); }
+  90%, 100% { transform: rotateX(-30deg) rotateY(-30deg) rotateZ(-30deg); }
 }
 
 #parent {
   background: blue;
   height: 200px; width: 200px;
   border: 1px solid black;
   transform-style: preserve-3d;
-  animation: spin 100s linear;
+  /* use a -99.9s delay to start at 99.9% and then move to 0% */
+  animation: spin 100s -99.9s linear 2;
 }
 
 @keyframes noop {
   from, to { transform: translateZ(15px) }
 }
 
 #child {
   height: 100px; width: 100px; margin: 50px;
@@ -37,20 +38,19 @@ body { padding: 50px }
   <div id="parent">
     <div id="child">
     </div>
   </div>
 </div>
 
 <script>
 
-document.getElementById("parent").addEventListener("animationstart", StartListener, false);
+document.getElementById("parent").addEventListener("animationiteration", IterationListener, false);
 
-function StartListener(event) {
-  // Animation should be at final state after 10ms; give it longer.
-  setTimeout(RemoveReftestWait, 100);
+function IterationListener(event) {
+  setTimeout(RemoveReftestWait, 0);
 }
 
 function RemoveReftestWait() {
   document.documentElement.classList.remove("reftest-wait");
 }
 
 </script>
diff --git a/layout/reftests/transform-3d/animate-preserve3d-parent.html b/layout/reftests/transform-3d/animate-preserve3d-parent.html
--- a/layout/reftests/transform-3d/animate-preserve3d-parent.html
+++ b/layout/reftests/transform-3d/animate-preserve3d-parent.html
@@ -3,26 +3,27 @@
 <title>Testcase, bug 1176969</title>
 <style>
 
 body { padding: 50px }
 
 #grandparent { perspective: 400px }
 
 @keyframes spin {
-  0% { transform: rotateX(-30deg) rotateY(-30deg) rotateZ(-30deg); }
-  0.01%, 100% { transform: rotateX(-45deg) rotateY(-45deg) rotateZ(-45deg); }
+  0%, 85% { transform: rotateX(-45deg) rotateY(-45deg) rotateZ(-45deg); }
+  90%, 100% { transform: rotateX(-30deg) rotateY(-30deg) rotateZ(-30deg); }
 }
 
 #parent {
   background: blue;
   height: 200px; width: 200px;
   border: 1px solid black;
   transform-style: preserve-3d;
-  animation: spin 100s linear;
+  /* use a -99.9s delay to start at 99.9% and then move to 0% */
+  animation: spin 100s -99.9s linear 2;
 }
 
 #child {
   transform: translateZ(15px);
   height: 100px; width: 100px; margin: 50px;
   background: yellow;
   box-shadow: 3px 3px olive;
 }
@@ -33,20 +34,19 @@ body { padding: 50px }
   <div id="parent">
     <div id="child">
     </div>
   </div>
 </div>
 
 <script>
 
-document.getElementById("parent").addEventListener("animationstart", StartListener, false);
+document.getElementById("parent").addEventListener("animationiteration", IterationListener, false);
 
-function StartListener(event) {
-  // Animation should be at final state after 10ms; give it longer.
-  setTimeout(RemoveReftestWait, 100);
+function IterationListener(event) {
+  setTimeout(RemoveReftestWait, 0);
 }
 
 function RemoveReftestWait() {
   document.documentElement.classList.remove("reftest-wait");
 }
 
 </script>
diff --git a/layout/reftests/transform-3d/reftest.list b/layout/reftests/transform-3d/reftest.list
--- a/layout/reftests/transform-3d/reftest.list
+++ b/layout/reftests/transform-3d/reftest.list
@@ -58,10 +58,10 @@ fuzzy-if(winWidget&&!layersGPUAccelerate
 # Bugs
 fails-if(!layersGPUAccelerated) == 1035611-1.html 1035611-1-ref.html # Bug 1072898 for !layersGPUAccelerated failures
 fuzzy(3,99) == animate-cube-radians.html animate-cube-radians-ref.html # subpixel AA
 fuzzy(3,99) fuzzy-if(/^Windows\x20NT\x206\.1/.test(http.oscpu)&&!layersGPUAccelerated,16,6) fuzzy-if(Mulet,16,9) == animate-cube-radians-zoom.html animate-cube-radians-zoom-ref.html
 != animate-cube-radians-ref.html animate-cube-radians-zoom-ref.html
 fuzzy(3,99) == animate-cube-degrees.html animate-cube-degrees-ref.html # subpixel AA
 == animate-cube-degrees-zoom.html animate-cube-degrees-zoom-ref.html
 != animate-cube-degrees-ref.html animate-cube-degrees-zoom-ref.html
-fuzzy-if(cocoaWidget,128,4) random == animate-preserve3d-parent.html animate-preserve3d-ref.html # intermittently fuzzy on Mac; needs to be rewritten for timing issues
-fuzzy-if(cocoaWidget,128,4) random == animate-preserve3d-child.html animate-preserve3d-ref.html # intermittently fuzzy on Mac; needs to be rewritten for timing issues
+fuzzy-if(cocoaWidget,128,4) == animate-preserve3d-parent.html animate-preserve3d-ref.html # intermittently fuzzy on Mac
+fuzzy-if(cocoaWidget,128,4) == animate-preserve3d-child.html animate-preserve3d-ref.html # intermittently fuzzy on Mac

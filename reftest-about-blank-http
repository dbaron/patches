Make about:blank work correctly as a reference for reftests served over HTTP.  (Bug 457821)  r=jwalden

diff --git a/layout/reftests/reftest-sanity/blank.html b/layout/reftests/reftest-sanity/blank.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/reftest-sanity/blank.html
@@ -0,0 +1,5 @@
+<!DOCTYPE html>
+<html>
+<body>
+</body>
+</html>
diff --git a/layout/reftests/reftest-sanity/reftest.list b/layout/reftests/reftest-sanity/reftest.list
--- a/layout/reftests/reftest-sanity/reftest.list
+++ b/layout/reftests/reftest-sanity/reftest.list
@@ -14,8 +14,21 @@
 != html-vs-xhtml-by-extension.html html-vs-xhtml-by-extension.xhtml
 HTTP != html-vs-xhtml-by-extension.html html-vs-xhtml-by-extension.xhtml
 
 # make sure red and green colors are not the default and are different from
 # each other
 != green.html default.html
 != green.html red.html
 != red.html default.html
+
+# Make sure about:blank works, even via HTTP.
+== blank.html about:blank
+== about:blank blank.html
+HTTP == blank.html about:blank
+HTTP == about:blank blank.html
+# same for data:
+== default.html data:text/html,<div>Text</div>
+== data:text/html,<div>Text</div> default.html
+HTTP == default.html data:text/html,<div>Text</div>
+HTTP == data:text/html,<div>Text</div> default.html
+!= blank.html default.html
+HTTP != blank.html default.html
diff --git a/layout/tools/reftest/reftest.js b/layout/tools/reftest/reftest.js
--- a/layout/tools/reftest/reftest.js
+++ b/layout/tools/reftest/reftest.js
@@ -276,21 +276,25 @@ function ServeFiles(manifestURL, directo
 
     gCount++;
     var path = "/" + gCount + "/";
     gServer.registerDirectory(path, directory);
 
     var secMan = CC[NS_SCRIPTSECURITYMANAGER_CONTRACTID]
                      .getService(CI.nsIScriptSecurityManager);
 
+    var testbase =
+        gIOService.newURI("http://localhost:" + HTTP_SERVER_PORT + path,
+                          null, null);
+
     function FileToURI(file)
     {
-        var testURI = gIOService.newURI("http://localhost:" + HTTP_SERVER_PORT +
-                                        path + file,
-                                        null, null);
+        // Only serve relative URIs via the HTTP server, not absolute
+        // ones like about:blank.
+        var testURI = gIOService.newURI(file, null, testbase);
 
         // XXX necessary?  manifestURL guaranteed to be file, others always HTTP
         secMan.checkLoadURI(manifestURL, testURI,
                             CI.nsIScriptSecurityManager.DISALLOW_SCRIPT);
 
         return testURI;
     }
 

From: L. David Baron <dbaron@dbaron.org>

Convert canvas text measurement widths from app units to pixels *after* they switch from integers to floats.  (Bug 667947)  r=roc

diff --git a/content/canvas/src/nsCanvasRenderingContext2DAzure.cpp b/content/canvas/src/nsCanvasRenderingContext2DAzure.cpp
--- a/content/canvas/src/nsCanvasRenderingContext2DAzure.cpp
+++ b/content/canvas/src/nsCanvasRenderingContext2DAzure.cpp
@@ -3021,17 +3021,17 @@ struct NS_STACK_CLASS nsCanvasBidiProces
 
     // this only measures the height; the total width is gotten from the
     // the return value of ProcessText.
     if (mDoMeasureBoundingBox) {
       textRunMetrics.mBoundingBox.Scale(1.0 / mAppUnitsPerDevPixel);
       mBoundingBox = mBoundingBox.Union(textRunMetrics.mBoundingBox);
     }
 
-    return static_cast<nscoord>(textRunMetrics.mAdvanceWidth/gfxFloat(mAppUnitsPerDevPixel));
+    return NSToCoordRound(textRunMetrics.mAdvanceWidth);
   }
 
   virtual void DrawText(nscoord xOffset, nscoord width)
   {
     gfxPoint point = mPt;
     point.x += xOffset * mAppUnitsPerDevPixel;
 
     // offset is given in terms of left side of string
@@ -3263,35 +3263,36 @@ nsCanvasRenderingContext2DAzure::DrawOrM
   processor.mBoundingBox = gfxRect(0, 0, 0, 0);
   processor.mDoMeasureBoundingBox = doDrawShadow || !mIsEntireFrameInvalid;
   processor.mState = &CurrentState();
     
 
   processor.mFontgrp = GetCurrentFontStyle();
   NS_ASSERTION(processor.mFontgrp, "font group is null");
 
-  nscoord totalWidth;
+  nscoord totalWidthCoord;
 
   // calls bidi algo twice since it needs the full text width and the
   // bounding boxes before rendering anything
   rv = bidiUtils->ProcessText(textToDraw.get(),
                               textToDraw.Length(),
                               isRTL ? NSBIDI_RTL : NSBIDI_LTR,
                               presShell->GetPresContext(),
                               processor,
                               nsBidiPresUtils::MODE_MEASURE,
                               nsnull,
                               0,
-                              &totalWidth);
+                              &totalWidthCoord);
   if (NS_FAILED(rv)) {
     return rv;
   }
 
+  float totalWidth = float(totalWidthCoord) / processor.mAppUnitsPerDevPixel;
   if (aWidth) {
-    *aWidth = static_cast<float>(totalWidth);
+    *aWidth = totalWidth;
   }
 
   // if only measuring, don't need to do any more work
   if (aOp==TEXT_DRAW_OPERATION_MEASURE) {
     return NS_OK;
   }
 
   // offset pt.x based on text align

From: L. David Baron <dbaron@dbaron.org>

Check isValid, since bindings in chrome (e.g., Fennec select binding) can make it be false.  (Bug 596767)  r=bzbarsky  a2.0=blocking2.0:betaN

diff --git a/layout/generic/nsHTMLReflowState.cpp b/layout/generic/nsHTMLReflowState.cpp
--- a/layout/generic/nsHTMLReflowState.cpp
+++ b/layout/generic/nsHTMLReflowState.cpp
@@ -971,59 +971,65 @@ nsHTMLReflowState::CalculateHypothetical
   // sure to compute all coordinates in the coordinate system of
   // aContainingBlock.
   nsBlockFrame* blockFrame =
     nsLayoutUtils::GetAsBlock(aContainingBlock->GetContentInsertionFrame());
   if (blockFrame) {
     nscoord blockYOffset = blockFrame->GetOffsetTo(aContainingBlock).y;
     PRBool isValid;
     nsBlockInFlowLineIterator iter(blockFrame, aPlaceholderFrame, &isValid);
-    NS_ASSERTION(isValid, "Can't find placeholder!");
-    NS_ASSERTION(iter.GetContainer() == blockFrame, "Found placeholder in wrong block!");
-    nsBlockFrame::line_iterator lineBox = iter.GetLine();
+    if (!isValid) {
+      // Give up.  We're probably dealing with somebody using
+      // position:absolute inside native-anonymous content anyway.
+      aHypotheticalBox.mTop = placeholderOffset.y;
+    } else {
+      NS_ASSERTION(iter.GetContainer() == blockFrame,
+                   "Found placeholder in wrong block!");
+      nsBlockFrame::line_iterator lineBox = iter.GetLine();
 
-    // How we determine the hypothetical box depends on whether the element
-    // would have been inline-level or block-level
-    if (mStyleDisplay->IsOriginalDisplayInlineOutside()) {
-      // Use the top of the inline box which the placeholder lives in as the
-      // hypothetical box's top.
-      aHypotheticalBox.mTop = lineBox->mBounds.y + blockYOffset;
-    } else {
-      // The element would have been block-level which means it would be below
-      // the line containing the placeholder frame, unless all the frames
-      // before it are empty.  In that case, it would have been just before
-      // this line.      
-      // XXXbz the line box is not fully reflowed yet if our containing block is
-      // relatively positioned...
-      if (lineBox != iter.End()) {
-        nsIFrame * firstFrame = lineBox->mFirstChild;
-        PRBool found = PR_FALSE;
-        PRBool allEmpty = PR_TRUE;
-        while (firstFrame) { // See bug 223064
-          allEmpty = AreAllEarlierInFlowFramesEmpty(firstFrame,
-            aPlaceholderFrame, &found);
-          if (found || !allEmpty)
-            break;
-          firstFrame = firstFrame->GetNextSibling();
+      // How we determine the hypothetical box depends on whether the element
+      // would have been inline-level or block-level
+      if (mStyleDisplay->IsOriginalDisplayInlineOutside()) {
+        // Use the top of the inline box which the placeholder lives in as the
+        // hypothetical box's top.
+        aHypotheticalBox.mTop = lineBox->mBounds.y + blockYOffset;
+      } else {
+        // The element would have been block-level which means it would
+        // be below the line containing the placeholder frame, unless
+        // all the frames before it are empty.  In that case, it would
+        // have been just before this line.
+        // XXXbz the line box is not fully reflowed yet if our
+        // containing block is relatively positioned...
+        if (lineBox != iter.End()) {
+          nsIFrame * firstFrame = lineBox->mFirstChild;
+          PRBool found = PR_FALSE;
+          PRBool allEmpty = PR_TRUE;
+          while (firstFrame) { // See bug 223064
+            allEmpty = AreAllEarlierInFlowFramesEmpty(firstFrame,
+              aPlaceholderFrame, &found);
+            if (found || !allEmpty)
+              break;
+            firstFrame = firstFrame->GetNextSibling();
+          }
+          NS_ASSERTION(firstFrame, "Couldn't find placeholder!");
+
+          if (allEmpty) {
+            // The top of the hypothetical box is the top of the line
+            // containing the placeholder, since there is nothing in the
+            // line before our placeholder except empty frames.
+            aHypotheticalBox.mTop = lineBox->mBounds.y + blockYOffset;
+          } else {
+            // The top of the hypothetical box is just below the line
+            // containing the placeholder.
+            aHypotheticalBox.mTop = lineBox->mBounds.YMost() + blockYOffset;
+          }
+        } else {
+          // Just use the placeholder's y-offset wrt the containing block
+          aHypotheticalBox.mTop = placeholderOffset.y;
         }
-        NS_ASSERTION(firstFrame, "Couldn't find placeholder!");
-
-        if (allEmpty) {
-          // The top of the hypothetical box is the top of the line containing
-          // the placeholder, since there is nothing in the line before our
-          // placeholder except empty frames.
-          aHypotheticalBox.mTop = lineBox->mBounds.y + blockYOffset;
-        } else {
-          // The top of the hypothetical box is just below the line containing
-          // the placeholder.
-          aHypotheticalBox.mTop = lineBox->mBounds.YMost() + blockYOffset;
-        }
-      } else {
-        // Just use the placeholder's y-offset wrt the containing block
-        aHypotheticalBox.mTop = placeholderOffset.y;
       }
     }
   } else {
     // The containing block is not a block, so it's probably something
     // like a XUL box, etc.
     // Just use the placeholder's y-offset
     aHypotheticalBox.mTop = placeholderOffset.y;
   }

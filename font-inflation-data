From: L. David Baron <dbaron@dbaron.org>

Add a font inflation data structure per block formatting context.  (Bug 706193, bug 707195)

diff --git a/layout/generic/Makefile.in b/layout/generic/Makefile.in
--- a/layout/generic/Makefile.in
+++ b/layout/generic/Makefile.in
@@ -82,16 +82,17 @@ CPPSRCS		= \
 		nsBlockFrame.cpp \
 		nsBlockReflowContext.cpp \
 		nsBlockReflowState.cpp \
 		nsBulletFrame.cpp \
 		nsColumnSetFrame.cpp \
 		nsContainerFrame.cpp \
 		nsFirstLetterFrame.cpp \
 		nsFloatManager.cpp \
+		nsFontInflationData.cpp \
 		nsFrame.cpp \
 		nsFrameList.cpp \
 		nsFrameSetFrame.cpp \
 		nsFrameUtil.cpp \
 		nsGfxScrollFrame.cpp \
 		nsHTMLCanvasFrame.cpp \
 		nsCanvasFrame.cpp \
 		nsHTMLReflowMetrics.cpp \
diff --git a/layout/generic/nsFontInflationData.cpp b/layout/generic/nsFontInflationData.cpp
new file mode 100644
--- /dev/null
+++ b/layout/generic/nsFontInflationData.cpp
@@ -0,0 +1,70 @@
+/* vim: set shiftwidth=2 tabstop=8 autoindent cindent expandtab: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is the font size inflation manager.
+ *
+ * The Initial Developer of the Original Code is the Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2012
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   L. David Baron <dbaron@dbaron.org>, Mozilla Corporation (original author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/* Per-block-formatting-context manager of font size inflation for pan and zoom UI. */
+
+#include "nsFontInflationData.h"
+#include "FramePropertyTable.h"
+
+using namespace mozilla;
+
+static void
+DestroyFontInflationData(void *aPropertyValue)
+{
+  delete static_cast<nsFontInflationData*>(aPropertyValue);
+}
+
+NS_DECLARE_FRAME_PROPERTY(FontInflationDataProperty, DestroyFontInflationData);
+
+/* static */ nsFontInflationData*
+nsFontInflationData::FontInflationDataFor(nsIFrame *aFrame)
+{
+  // We have one set of font inflation data per block formatting context.
+  FrameProperties bfcProps = BlockFormattingContextFor(aFrame)->Properties();
+
+  // If we already have a data object, return it.
+  nsFontInflationData *data = static_cast<nsFontInflationData*>(
+                                bfcProps.Get(FontInflationDataProperty()));
+  if (data) {
+    return data;
+  }
+
+  // Otherwise, make a new data object.
+  data = new nsFontInflationData();
+  bfcProps.Set(FontInflationDataProperty(), data);
+  return data;
+}
diff --git a/layout/generic/nsFontInflationData.h b/layout/generic/nsFontInflationData.h
new file mode 100644
--- /dev/null
+++ b/layout/generic/nsFontInflationData.h
@@ -0,0 +1,76 @@
+/* vim: set shiftwidth=2 tabstop=8 autoindent cindent expandtab: */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is the font size inflation manager.
+ *
+ * The Initial Developer of the Original Code is the Mozilla Foundation.
+ * Portions created by the Initial Developer are Copyright (C) 2012
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   L. David Baron <dbaron@dbaron.org>, Mozilla Corporation (original author)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/* Per-block-formatting-context manager of font size inflation for pan and zoom UI. */
+
+#ifndef nsFontInflationData_h_
+#define nsFontInflationData_h_
+
+#include "nsIFrame.h"
+#include "nsLayoutUtils.h"
+#include "nsBlockFrame.h"
+
+class nsFontInflationData
+{
+public:
+
+  static nsFontInflationData* FontInflationDataFor(nsIFrame *aFrame);
+
+private:
+
+  static nsIFrame* BlockFormattingContextFor(nsIFrame *aFrame)
+  {
+    while (!IsBlockFormattingContext(aFrame)) {
+      aFrame = aFrame->GetParent();
+    }
+    return aFrame;
+  }
+
+  static bool IsBlockFormattingContext(nsIFrame *aFrame)
+  {
+    return nsLayoutUtils::IsContainerForFontSizeInflation(aFrame) &&
+           ((aFrame->IsFrameOfType(nsIFrame::eBlockFrame) &&
+            (aFrame->GetStateBits() & NS_BLOCK_FLOAT_MGR)) ||
+            aFrame->IsFrameOfType(nsIFrame::eXULBox) ||
+            !aFrame->GetParent());
+  }
+
+  // Look at nsTextFrame::GetRenderedText
+
+};
+
+#endif /* !defined(nsFontInflationData_h_) */

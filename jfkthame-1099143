# HG changeset patch
# User Jonathan Kew <jkew@mozilla.com>
# Date 1415980545 0
#      Fri Nov 14 15:55:45 2014 +0000
# Node ID cfc93a59e79279deddacfb2d5cab3cd2294e0a8d
# Parent  47f0d9ed9f7aa0cc6006255c3235394063e74cc2
Bug 1099143 - Don't try to query the textrun when it may not yet have been created.

diff --git a/dom/canvas/CanvasRenderingContext2D.cpp b/dom/canvas/CanvasRenderingContext2D.cpp
--- a/dom/canvas/CanvasRenderingContext2D.cpp
+++ b/dom/canvas/CanvasRenderingContext2D.cpp
@@ -3573,18 +3573,23 @@ CanvasRenderingContext2D::DrawOrMeasureT
     break;
   case TextBaseline::BOTTOM:
     baselineAnchor = -fontMetrics.emDescent;
     break;
   default:
     MOZ_CRASH("unexpected TextBaseline");
   }
 
-  if (processor.mTextRun->IsVertical()) {
-    if (processor.mTextRun->UseCenterBaseline()) {
+  // We can't query the textRun directly, as it may not have been created yet;
+  // so instead we check the flags that will be used to initialize it.
+  uint16_t runOrientation =
+    (processor.mTextRunFlags & gfxTextRunFactory::TEXT_ORIENT_MASK);
+  if (runOrientation != gfxTextRunFactory::TEXT_ORIENT_HORIZONTAL) {
+    if (runOrientation == gfxTextRunFactory::TEXT_ORIENT_VERTICAL_MIXED ||
+        runOrientation == gfxTextRunFactory::TEXT_ORIENT_VERTICAL_UPRIGHT) {
       // Adjust to account for mTextRun being shaped using center baseline
       // rather than alphabetic.
       baselineAnchor -= (fontMetrics.emAscent - fontMetrics.emDescent) * .5f;
     }
     processor.mPt.x -= baselineAnchor;
   } else {
     processor.mPt.y += baselineAnchor;
   }

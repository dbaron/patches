From: L. David Baron <dbaron@dbaron.org>

Bug 1270626 - Explicitly suppress exceptions from media query listeners, rather than having them assert.  r?bzbarsky

I'm acting under the assumption that this is what's closest to what the
code does now, except without asserting in ~ErrorResult.  It also seems
closest to what event listeners will do, both based on examining code
(EventListenerManager::HandleEventSubType, which I'm hoping is the right
code to look at, calls StealNSResult, and then stores it in a member
that's ignored by most callers) and based on testing (for both click
events, and for media query listeners with this patch, the exception
gets reported to the console as an unhandled exception).  That said, I'm
not particularly well versed in the current error handling rules so I
may well be off here.

This code should presumably go away when we change this code to use
EventListeners in bug 1265622, so I don't think there's any spec that
covers this.

MozReview-Commit-ID: 5kxp6jzGzX8

diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -1912,16 +1912,17 @@ nsPresContext::MediaFeatureValuesChanged
     }
 
     if (!notifyList.IsEmpty()) {
       for (uint32_t i = 0, i_end = notifyList.Length(); i != i_end; ++i) {
         nsAutoMicroTask mt;
         MediaQueryList::HandleChangeData &d = notifyList[i];
         ErrorResult result;
         d.callback->Call(*d.mql, result);
+        result.SuppressException();
       }
     }
 
     // NOTE:  When |notifyList| goes out of scope, our destructor could run.
   }
 }
 
 void
diff --git a/layout/style/test/test_media_query_list.html b/layout/style/test/test_media_query_list.html
--- a/layout/style/test/test_media_query_list.html
+++ b/layout/style/test/test_media_query_list.html
@@ -327,16 +327,34 @@ function run() {
   function step2() {
     SpecialPowers.DOMWindowUtils.garbageCollect();
 
     iframe.style.width = "200px";
     subroot.offsetWidth; // flush layout
 
     is(JSON.stringify(gc_received), "[1,1]", "GC test: after notification 2");
 
+    bug1270626();
+  }
+
+  /* Bug 1270626: listeners that throw exceptions */
+  function bug1270626() {
+    var throwingListener = function(mql) {
+      throw "error";
+    }
+
+    iframe.style.width = "200px";
+    subroot.offsetWidth; // flush layout
+
+    var mql = subwin.matchMedia("(min-width: 150px)");
+    mql.addListener(throwingListener);
+
+    iframe.style.width = "100px";
+    subroot.offsetWidth; // flush layout
+
     SimpleTest.finish();
   }
 }
 
 </script>
 </pre>
 </body>
 </html>

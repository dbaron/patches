From: L. David Baron <dbaron@dbaron.org>

Avoid flushing during media query evaluation.  (Bug 507457)  r=bzbarsky

diff --git a/layout/style/nsMediaFeatures.cpp b/layout/style/nsMediaFeatures.cpp
--- a/layout/style/nsMediaFeatures.cpp
+++ b/layout/style/nsMediaFeatures.cpp
@@ -85,30 +85,25 @@ static nsresult
 GetHeight(nsPresContext* aPresContext, nsCSSValue& aResult)
 {
     nsSize size = GetSize(aPresContext);
     float pixelHeight = aPresContext->AppUnitsToFloatCSSPixels(size.height);
     aResult.SetFloatValue(pixelHeight, eCSSUnit_Pixel);
     return NS_OK;
 }
 
-static nsIDeviceContext*
+inline static nsIDeviceContext*
 GetDeviceContextFor(nsPresContext* aPresContext)
 {
-  // Do this dance rather than aPresContext->DeviceContext() to get
-  // things right in multi-monitor situations.
-  // (It's not clear if this is really needed for GetDepth and GetColor,
-  // but do it anyway.)
-  nsIDeviceContext* ctx = nsLayoutUtils::GetDeviceContextForScreenInfo(
-    nsCOMPtr<nsIDocShell>(do_QueryInterface(
-      nsCOMPtr<nsISupports>(aPresContext->GetContainer()))));
-  if (!ctx) {
-    ctx = aPresContext->DeviceContext();
-  }
-  return ctx;
+  // It would be nice to call
+  // nsLayoutUtils::GetDeviceContextForScreenInfo here, except for two
+  // things:  (1) it can flush, and flushing is bad here, and (2) it
+  // doesn't really get us consistency in multi-monitor situations
+  // *anyway*.
+  return aPresContext->DeviceContext();
 }
 
 // A helper for three features below.
 static nsSize
 GetDeviceSize(nsPresContext* aPresContext)
 {
     nsSize size;
     if (aPresContext->IsRootPaginatedDocument())

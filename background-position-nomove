Snap background origin and clip areas to device pixels to prevent tiling from varying for subpixel position changes that don't change the box's visible position at all.  Tests by roc (433640-*) and me (background-image-tiling-*).  b=433640

diff --git a/layout/base/nsCSSRendering.cpp b/layout/base/nsCSSRendering.cpp
--- a/layout/base/nsCSSRendering.cpp
+++ b/layout/base/nsCSSRendering.cpp
@@ -3458,16 +3458,48 @@ static nscoord
 static nscoord
 FindTileEnd(nscoord aDirtyEnd, nscoord aTileOffset, nscoord aTileSize)
 {
   // Find smallest integer N such that aTileOffset + N*aTileSize >= aDirtyEnd
   return aTileOffset +
          IntDivCeil(aDirtyEnd - aTileOffset, aTileSize) * aTileSize;
 }
 
+static void
+PixelSnapRectangle(gfxContext* aContext, nsIDeviceContext *aDC, nsRect& aRect)
+{
+  gfxRect tmpRect;
+  tmpRect.pos.x = aDC->AppUnitsToGfxUnits(aRect.x);
+  tmpRect.pos.y = aDC->AppUnitsToGfxUnits(aRect.y);
+  tmpRect.size.width = aDC->AppUnitsToGfxUnits(aRect.width);
+  tmpRect.size.height = aDC->AppUnitsToGfxUnits(aRect.height);
+  if (aContext->UserToDevicePixelSnapped(tmpRect)) {
+    tmpRect = aContext->DeviceToUser(tmpRect);
+    aRect.x = aDC->GfxUnitsToAppUnits(tmpRect.pos.x);
+    aRect.y = aDC->GfxUnitsToAppUnits(tmpRect.pos.y);
+    aRect.width = aDC->GfxUnitsToAppUnits(tmpRect.size.width);
+    aRect.height = aDC->GfxUnitsToAppUnits(tmpRect.size.height);
+  }
+}
+
+static void
+PixelSnapPoint(gfxContext* aContext, nsIDeviceContext *aDC, nsPoint& aPoint)
+{
+  gfxRect tmpRect;
+  tmpRect.pos.x = aDC->AppUnitsToGfxUnits(aPoint.x);
+  tmpRect.pos.y = aDC->AppUnitsToGfxUnits(aPoint.y);
+  tmpRect.size.width = 0;
+  tmpRect.size.height = 0;
+  if (aContext->UserToDevicePixelSnapped(tmpRect)) {
+    tmpRect = aContext->DeviceToUser(tmpRect);
+    aPoint.x = aDC->GfxUnitsToAppUnits(tmpRect.pos.x);
+    aPoint.y = aDC->GfxUnitsToAppUnits(tmpRect.pos.y);
+  }
+}
+
 void
 nsCSSRendering::PaintBackgroundWithSC(nsPresContext* aPresContext,
                                       nsIRenderingContext& aRenderingContext,
                                       nsIFrame* aForFrame,
                                       const nsRect& aDirtyRect,
                                       const nsRect& aBorderArea,
                                       const nsStyleBackground& aColor,
                                       const nsStyleBorder& aBorder,
@@ -3515,16 +3547,24 @@ nsCSSRendering::PaintBackgroundWithSC(ns
       NS_ASSERTION(aColor.mBackgroundClip == NS_STYLE_BG_CLIP_PADDING,
                    "unknown background-clip value");
       nsMargin border = aForFrame->GetUsedBorder();
       aForFrame->ApplySkipSides(border);
       bgClipArea.Deflate(border);
     }
   }
 
+  nsIDeviceContext *dc = aPresContext->DeviceContext();
+  nsRefPtr<gfxContext> ctx = aRenderingContext.ThebesContext();
+
+  // Snap bgClipArea to device pixel boundaries.  (We have to snap
+  // bgOriginArea below; if we don't do this as well then we could make
+  // incorrect decisions about various optimizations.)
+  PixelSnapRectangle(ctx, dc, bgClipArea);
+
   // The actual dirty rect is the intersection of the 'background-clip'
   // area and the dirty rect we were given
   nsRect dirtyRect;
   if (!dirtyRect.IntersectRect(bgClipArea, aDirtyRect)) {
     // Nothing to paint
     return;
   }
 
@@ -3599,16 +3639,20 @@ nsCSSRendering::PaintBackgroundWithSC(ns
       nsMargin padding = aForFrame->GetUsedPadding();
       aForFrame->ApplySkipSides(padding);
       bgOriginArea.Deflate(padding);
       NS_ASSERTION(aColor.mBackgroundOrigin == NS_STYLE_BG_ORIGIN_CONTENT,
                    "unknown background-origin value");
     }
   }
 
+  // Snap bgOriginArea to device pixel boundaries to avoid variations in
+  // tiling when the subpixel position of the element changes.
+  PixelSnapRectangle(ctx, dc, bgOriginArea);
+
   // Based on the repeat setting, compute how many tiles we should
   // lay down for each axis. The value computed is the maximum based
   // on the dirty rect before accounting for the background-position.
   nscoord tileWidth = imageSize.width;
   nscoord tileHeight = imageSize.height;
   PRBool  needBackgroundColor = !(aColor.mBackgroundFlags &
                                   NS_STYLE_BG_COLOR_TRANSPARENT);
   PRIntn  repeat = aColor.mBackgroundRepeat;
@@ -3652,16 +3696,19 @@ nsCSSRendering::PaintBackgroundWithSC(ns
                          aColor, aBorder, aPadding, canDrawBackgroundColor);
   }
 
   if ((tileWidth == 0) || (tileHeight == 0) || dirtyRect.IsEmpty()) {
     // Nothing left to paint
     return;
   }
 
+  nsPoint borderAreaOriginSnapped = aBorderArea.TopLeft();
+  PixelSnapPoint(ctx, dc, borderAreaOriginSnapped);
+
   // Compute the anchor point.
   //
   // When tiling, the anchor coordinate values will be negative offsets
   // from the background-origin area.
 
   // relative to the origin of aForFrame
   nsPoint anchor;
   if (NS_STYLE_BG_ATTACHMENT_FIXED == aColor.mBackgroundAttachment) {
@@ -3730,21 +3777,24 @@ nsCSSRendering::PaintBackgroundWithSC(ns
       }
     } else {
       // Otherwise, it is the normal case, and the background is
       // simply placed relative to the frame's background-clip area
       ComputeBackgroundAnchorPoint(aColor, bgOriginArea, bgClipArea, tileWidth, tileHeight, anchor);
     }
 
     // For scrolling attachment, the anchor is within the 'background-clip'
-    anchor.x += bgClipArea.x - aBorderArea.x;
-    anchor.y += bgClipArea.y - aBorderArea.y;
-  }
-
-  nsRefPtr<gfxContext> ctx = aRenderingContext.ThebesContext();
+    anchor.x += bgClipArea.x - borderAreaOriginSnapped.x;
+    anchor.y += bgClipArea.y - borderAreaOriginSnapped.y;
+  }
+
+  // Pixel-snap the anchor point so that we don't end up with blurry
+  // images due to subpixel positions.
+  PixelSnapPoint(ctx, dc, anchor);
+
   ctx->Save();
 
   nscoord appUnitsPerPixel = aPresContext->DevPixelsToAppUnits(1);
 
   ctx->NewPath();
   ctx->Rectangle(RectToGfxRect(dirtyRect, appUnitsPerPixel), PR_TRUE);
   ctx->Clip();
 
@@ -3888,38 +3938,40 @@ nsCSSRendering::PaintBackgroundWithSC(ns
 
        The vertical case is analogous. If the background is fixed, then 
        bgClipArea.x and bgClipArea.y are set to zero when finding the parent
        viewport, above.
 
   */
 
   // relative to aBorderArea.TopLeft()
+  // ... but pixel-snapped, so that it comes out correctly relative to
+  // all the other pixel-snapped things
   nsRect tileRect(anchor, nsSize(tileWidth, tileHeight));
   if (repeat & NS_STYLE_BG_REPEAT_X) {
     // When tiling in the x direction, adjust the starting position of the
     // tile to account for dirtyRect.x. When tiling in x, the anchor.x value
     // will be a negative value used to adjust the starting coordinate.
-    nscoord x0 = FindTileStart(dirtyRect.x - aBorderArea.x, anchor.x, tileWidth);
-    nscoord x1 = FindTileEnd(dirtyRect.XMost() - aBorderArea.x, anchor.x, tileWidth);
+    nscoord x0 = FindTileStart(dirtyRect.x - borderAreaOriginSnapped.x, anchor.x, tileWidth);
+    nscoord x1 = FindTileEnd(dirtyRect.XMost() - borderAreaOriginSnapped.x, anchor.x, tileWidth);
     tileRect.x = x0;
     tileRect.width = x1 - x0;
   }
   if (repeat & NS_STYLE_BG_REPEAT_Y) {
     // When tiling in the y direction, adjust the starting position of the
     // tile to account for dirtyRect.y. When tiling in y, the anchor.y value
     // will be a negative value used to adjust the starting coordinate.
-    nscoord y0 = FindTileStart(dirtyRect.y - aBorderArea.y, anchor.y, tileHeight);
-    nscoord y1 = FindTileEnd(dirtyRect.YMost() - aBorderArea.y, anchor.y, tileHeight);
+    nscoord y0 = FindTileStart(dirtyRect.y - borderAreaOriginSnapped.y, anchor.y, tileHeight);
+    nscoord y1 = FindTileEnd(dirtyRect.YMost() - borderAreaOriginSnapped.y, anchor.y, tileHeight);
     tileRect.y = y0;
     tileRect.height = y1 - y0;
   }
 
   // Take the intersection again to paint only the required area.
-  nsRect absTileRect = tileRect + aBorderArea.TopLeft();
+  nsRect absTileRect = tileRect + borderAreaOriginSnapped;
   
   nsRect drawRect;
   if (drawRect.IntersectRect(absTileRect, dirtyRect)) {
     // Note that due to the way FindTileStart works we're guaranteed
     // that drawRect overlaps the top-left-most tile when repeating.
     NS_ASSERTION(drawRect.x >= absTileRect.x && drawRect.y >= absTileRect.y,
                  "Bogus intersection");
     NS_ASSERTION(drawRect.x < absTileRect.x + tileWidth,
@@ -3928,17 +3980,17 @@ nsCSSRendering::PaintBackgroundWithSC(ns
                  "Bogus y coord for draw rect");
     // Figure out whether we can get away with not tiling at all.
     nsRect sourceRect = drawRect - absTileRect.TopLeft();
     // Compute the subimage rectangle that we expect to be sampled.
     // This is the tile rectangle, clipped to the bgClipArea, and then
     // passed in relative to the image top-left.
     nsRect destRect; // The rectangle we would draw ignoring dirty-rect
     destRect.IntersectRect(absTileRect, bgClipArea);
-    nsRect subimageRect = destRect - aBorderArea.TopLeft() - tileRect.TopLeft();
+    nsRect subimageRect = destRect - borderAreaOriginSnapped - tileRect.TopLeft();
     if (sourceRect.XMost() <= tileWidth && sourceRect.YMost() <= tileHeight) {
       // The entire drawRect is contained inside a single tile; just
       // draw the corresponding part of the image once.
       nsLayoutUtils::DrawImage(&aRenderingContext, image,
               destRect, drawRect, &subimageRect);
     } else {
       // Note that the subimage is in tile space so it may cover
       // multiple tiles of the image.
diff --git a/layout/reftests/bugs/433640-1-ref.html b/layout/reftests/bugs/433640-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/433640-1-ref.html
@@ -0,0 +1,49 @@
+<!DOCTYPE html>
+<html><head>
+<style type="text/css">
+  div.image {
+    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAAD///+l2Z/dAAAAGElEQVR42mNggIHcbbfBCMEYlRqVIiQFAPco1xfL/SakAAAAAElFTkSuQmCC");
+    width: 32px;
+    height: 32px;
+  }
+
+  div.cell {
+    float: left;
+    width: 100px;
+  }
+  
+  body > div { height:100px; }
+  
+  p { height:20px; }
+</style>
+</head><body>
+
+<div>
+<div class="cell"><p>31    x 32</p><div style="width:31px; background-position:-17px -16px;"  class="image"></div></div>
+<div class="cell"><p>31.1  x 32</p><div style="width:31px; background-position:-16px -16px;"  class="image"></div></div>
+<div class="cell"><p>31.5  x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
+<div class="cell"><p>31.8  x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
+</div>
+
+<div>
+<div class="cell"><p>32    x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
+<div class="cell"><p>32.1  x 32</p><div style="width:32px; background-position:-16px -16px;"  class="image"></div></div>
+<div class="cell"><p>32.5  x 32</p><div style="width:33px; background-position:-16px -16px;"  class="image"></div></div>
+<div class="cell"><p>32.8  x 32</p><div style="width:33px; background-position:-16px -16px;"  class="image"></div></div>
+</div>
+
+<div>
+<div class="cell"><p>32 x 31   </p><div style="height:31px; background-position:-16px -17px;" class="image"></div></div>
+<div class="cell"><p>32 x 31.1 </p><div style="height:31px; background-position:-16px -16px;" class="image"></div></div>
+<div class="cell"><p>32 x 31.5 </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
+<div class="cell"><p>32 x 31.8 </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
+</div>
+
+<div>
+<div class="cell"><p>32 x 32   </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
+<div class="cell"><p>32 x 32.1 </p><div style="height:32px; background-position:-16px -16px;" class="image"></div></div>
+<div class="cell"><p>32 x 32.5 </p><div style="height:33px; background-position:-16px -16px;" class="image"></div></div>
+<div class="cell"><p>32 x 32.8 </p><div style="height:33px; background-position:-16px -16px;" class="image"></div></div>
+</div>
+
+</body></html>
diff --git a/layout/reftests/bugs/433640-1.html b/layout/reftests/bugs/433640-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/433640-1.html
@@ -0,0 +1,52 @@
+<!DOCTYPE html>
+<html><head>
+<style type="text/css">
+  div.image {
+    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAABlBMVEUAAAD///+l2Z/dAAAAGElEQVR42mNggIHcbbfBCMEYlRqVIiQFAPco1xfL/SakAAAAAElFTkSuQmCC");
+    background-position: center center;
+    width: 32px;
+    height: 32px;
+  }
+
+  div.cell {
+    float: left;
+    width: 100px;
+  }
+
+  body > div { height:100px; }
+
+  /* ensure that font heights do not affect image placement. Fractional image offsets can
+     affect exactly which pixel rects get painted. */
+  p { height:20px; }
+</style>
+</head><body>
+
+<div>
+<div class="cell"><p>31    x 32</p><div style="width:31px"    class="image"></div></div>
+<div class="cell"><p>31.1  x 32</p><div style="width:31.1px"  class="image"></div></div>
+<div class="cell"><p>31.5  x 32</p><div style="width:31.5px"  class="image"></div></div>
+<div class="cell"><p>31.8  x 32</p><div style="width:31.8px"  class="image"></div></div>
+</div>
+
+<div>
+<div class="cell"><p>32    x 32</p><div style="width:32px"    class="image"></div></div>
+<div class="cell"><p>32.1  x 32</p><div style="width:32.1px"  class="image"></div></div>
+<div class="cell"><p>32.5  x 32</p><div style="width:32.5px"  class="image"></div></div>
+<div class="cell"><p>32.8  x 32</p><div style="width:32.8px"  class="image"></div></div>
+</div>
+
+<div>
+<div class="cell"><p>32 x 31   </p><div style="height:31px"    class="image"></div></div>
+<div class="cell"><p>32 x 31.1 </p><div style="height:31.1px"  class="image"></div></div>
+<div class="cell"><p>32 x 31.5 </p><div style="height:31.5px"  class="image"></div></div>
+<div class="cell"><p>32 x 31.8 </p><div style="height:31.8px"  class="image"></div></div>
+</div>
+
+<div>
+<div class="cell"><p>32 x 32   </p><div style="height:32px"    class="image"></div></div>
+<div class="cell"><p>32 x 32.1 </p><div style="height:32.1px"  class="image"></div></div>
+<div class="cell"><p>32 x 32.5 </p><div style="height:32.5px"  class="image"></div></div>
+<div class="cell"><p>32 x 32.8 </p><div style="height:32.8px"  class="image"></div></div>
+</div>
+
+</body></html>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -832,8 +832,9 @@ fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") == 
 == 428521-1a.html 428521-1-ref.html
 == 428521-1b.html 428521-1-ref.html
 == 428521-1c.html 428521-1-ref.html
 random == 429849-1.html 429849-1-ref.html # bug 432288
 == 430412-1.html 430412-1-ref.html
 == 430813-1.html 430813-1-ref.html
 == 430813-2.html 430813-2-ref.html
 == 430813-3.html 430813-3-ref.html
+== 433640-1.html 433640-1-ref.html
diff --git a/layout/reftests/pixel-rounding/background-image-tiling-ref.html b/layout/reftests/pixel-rounding/background-image-tiling-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/pixel-rounding/background-image-tiling-ref.html
@@ -0,0 +1,298 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title>Pixel rounding of background image tiling</title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<meta http-equiv="Content-Style-Type" content="text/css">
+	<style type="text/css">
+
+	body { background: black; }
+
+	.set {
+		height: 60px;
+		position: relative;
+	}
+
+	.item {
+		position: absolute;
+		width: 10px;
+		height: 10px;
+		background: aqua;
+		overflow: hidden;
+	}
+	.item > div {
+		position: absolute;
+		width: 15px;
+		height: 15px;
+		border: 1px solid yellow;
+	}
+
+	.item1 { left: 0px; }
+	.item2 { left: 15px; }
+	.item3 { left: 30px; }
+	.item4 { left: 45px; }
+	.item5 { left: 60px; }
+
+	.tl { top: 0px; }
+	.tl > div { top: 0; left: 0; }
+
+	.tr { top: 15px; }
+	.tr > div { top: 0; right: 0; }
+
+	.bl { top: 30px; }
+	.bl > div { bottom: 0; left: 0; }
+
+	.br { top: 45px; }
+	.br > div { bottom: 0; right: 0; }
+
+	.varydim .item1 { height: 10px; width: 11px; }
+	.varydim .item2 { height: 10px; width: 11px; }
+	.varydim .item3 { height: 11px; width: 11px; }
+	.varydim .item4 { height: 11px; width: 10px; }
+	.varydim .item5 { height: 11px; width: 10px; }
+
+	.varydim.athalf .item2 { width: 10px; }
+	.varydim.athalf .item3 { height: 10px; width: 10px; }
+	.varydim.athalf .item4 { height: 10px; }
+
+	.varypos .item1 { margin-top: 0px; margin-left: 1px; }
+	.varypos .item2 { margin-top: 0px; margin-left: 1px; }
+	.varypos .item3 { margin-top: 1px; margin-left: 1px; }
+	.varypos .item4 { margin-top: 1px; margin-left: 0px; }
+	.varypos .item5 { margin-top: 1px; margin-left: 0px; }
+
+	.varydim.athalf .item {
+		margin-top: 1px; margin-left: 1px;
+	}
+
+	.varypos.athalf .item1 { width: 11px; height: 11px; }
+	.varypos.athalf .item2 { height: 11px; }
+	.varypos.athalf .item4 { width: 11px; }
+	.varypos.athalf .item5 { width: 11px; height: 11px; }
+
+	/* remember that abs pos children are relative to the padding box */
+	.border .item { padding: 1px; }
+
+	/*
+	 * For the tiled images, use two divs as the children, and offset
+	 * one so that it does only the vertical line, and the other so it
+	 * does only the horizontal line.
+	 */
+	.border .item div:first-child { margin: 1px -1px; }
+	.border .item div:first-child + div { margin: -1px 1px; }
+
+	</style>
+</head>
+<body>
+
+<div class="set varydim">
+	<div class="tl item item1"><div></div></div>
+	<div class="tl item item2"><div></div></div>
+	<div class="tl item item3"><div></div></div>
+	<div class="tl item item4"><div></div></div>
+	<div class="tl item item5"><div></div></div>
+
+	<div class="tr item item1"><div></div></div>
+	<div class="tr item item2"><div></div></div>
+	<div class="tr item item3"><div></div></div>
+	<div class="tr item item4"><div></div></div>
+	<div class="tr item item5"><div></div></div>
+
+	<div class="bl item item1"><div></div></div>
+	<div class="bl item item2"><div></div></div>
+	<div class="bl item item3"><div></div></div>
+	<div class="bl item item4"><div></div></div>
+	<div class="bl item item5"><div></div></div>
+
+	<div class="br item item1"><div></div></div>
+	<div class="br item item2"><div></div></div>
+	<div class="br item item3"><div></div></div>
+	<div class="br item item4"><div></div></div>
+	<div class="br item item5"><div></div></div>
+</div>
+
+<div class="set varypos">
+	<div class="tl item item1"><div></div></div>
+	<div class="tl item item2"><div></div></div>
+	<div class="tl item item3"><div></div></div>
+	<div class="tl item item4"><div></div></div>
+	<div class="tl item item5"><div></div></div>
+
+	<div class="tr item item1"><div></div></div>
+	<div class="tr item item2"><div></div></div>
+	<div class="tr item item3"><div></div></div>
+	<div class="tr item item4"><div></div></div>
+	<div class="tr item item5"><div></div></div>
+
+	<div class="bl item item1"><div></div></div>
+	<div class="bl item item2"><div></div></div>
+	<div class="bl item item3"><div></div></div>
+	<div class="bl item item4"><div></div></div>
+	<div class="bl item item5"><div></div></div>
+
+	<div class="br item item1"><div></div></div>
+	<div class="br item item2"><div></div></div>
+	<div class="br item item3"><div></div></div>
+	<div class="br item item4"><div></div></div>
+	<div class="br item item5"><div></div></div>
+</div>
+
+<div class="set varydim athalf">
+	<div class="tl item item1"><div></div></div>
+	<div class="tl item item2"><div></div></div>
+	<div class="tl item item3"><div></div></div>
+	<div class="tl item item4"><div></div></div>
+	<div class="tl item item5"><div></div></div>
+
+	<div class="tr item item1"><div></div></div>
+	<div class="tr item item2"><div></div></div>
+	<div class="tr item item3"><div></div></div>
+	<div class="tr item item4"><div></div></div>
+	<div class="tr item item5"><div></div></div>
+
+	<div class="bl item item1"><div></div></div>
+	<div class="bl item item2"><div></div></div>
+	<div class="bl item item3"><div></div></div>
+	<div class="bl item item4"><div></div></div>
+	<div class="bl item item5"><div></div></div>
+
+	<div class="br item item1"><div></div></div>
+	<div class="br item item2"><div></div></div>
+	<div class="br item item3"><div></div></div>
+	<div class="br item item4"><div></div></div>
+	<div class="br item item5"><div></div></div>
+</div>
+
+<div class="set varypos athalf">
+	<div class="tl item item1"><div></div></div>
+	<div class="tl item item2"><div></div></div>
+	<div class="tl item item3"><div></div></div>
+	<div class="tl item item4"><div></div></div>
+	<div class="tl item item5"><div></div></div>
+
+	<div class="tr item item1"><div></div></div>
+	<div class="tr item item2"><div></div></div>
+	<div class="tr item item3"><div></div></div>
+	<div class="tr item item4"><div></div></div>
+	<div class="tr item item5"><div></div></div>
+
+	<div class="bl item item1"><div></div></div>
+	<div class="bl item item2"><div></div></div>
+	<div class="bl item item3"><div></div></div>
+	<div class="bl item item4"><div></div></div>
+	<div class="bl item item5"><div></div></div>
+
+	<div class="br item item1"><div></div></div>
+	<div class="br item item2"><div></div></div>
+	<div class="br item item3"><div></div></div>
+	<div class="br item item4"><div></div></div>
+	<div class="br item item5"><div></div></div>
+</div>
+
+<div class="set varydim border">
+	<div class="tl item item1"><div></div><div></div></div>
+	<div class="tl item item2"><div></div><div></div></div>
+	<div class="tl item item3"><div></div><div></div></div>
+	<div class="tl item item4"><div></div><div></div></div>
+	<div class="tl item item5"><div></div><div></div></div>
+
+	<div class="tr item item1"><div></div><div></div></div>
+	<div class="tr item item2"><div></div><div></div></div>
+	<div class="tr item item3"><div></div><div></div></div>
+	<div class="tr item item4"><div></div><div></div></div>
+	<div class="tr item item5"><div></div><div></div></div>
+
+	<div class="bl item item1"><div></div><div></div></div>
+	<div class="bl item item2"><div></div><div></div></div>
+	<div class="bl item item3"><div></div><div></div></div>
+	<div class="bl item item4"><div></div><div></div></div>
+	<div class="bl item item5"><div></div><div></div></div>
+
+	<div class="br item item1"><div></div><div></div></div>
+	<div class="br item item2"><div></div><div></div></div>
+	<div class="br item item3"><div></div><div></div></div>
+	<div class="br item item4"><div></div><div></div></div>
+	<div class="br item item5"><div></div><div></div></div>
+</div>
+
+<div class="set varypos border">
+	<div class="tl item item1"><div></div><div></div></div>
+	<div class="tl item item2"><div></div><div></div></div>
+	<div class="tl item item3"><div></div><div></div></div>
+	<div class="tl item item4"><div></div><div></div></div>
+	<div class="tl item item5"><div></div><div></div></div>
+
+	<div class="tr item item1"><div></div><div></div></div>
+	<div class="tr item item2"><div></div><div></div></div>
+	<div class="tr item item3"><div></div><div></div></div>
+	<div class="tr item item4"><div></div><div></div></div>
+	<div class="tr item item5"><div></div><div></div></div>
+
+	<div class="bl item item1"><div></div><div></div></div>
+	<div class="bl item item2"><div></div><div></div></div>
+	<div class="bl item item3"><div></div><div></div></div>
+	<div class="bl item item4"><div></div><div></div></div>
+	<div class="bl item item5"><div></div><div></div></div>
+
+	<div class="br item item1"><div></div><div></div></div>
+	<div class="br item item2"><div></div><div></div></div>
+	<div class="br item item3"><div></div><div></div></div>
+	<div class="br item item4"><div></div><div></div></div>
+	<div class="br item item5"><div></div><div></div></div>
+</div>
+
+<div class="set varydim athalf border">
+	<div class="tl item item1"><div></div><div></div></div>
+	<div class="tl item item2"><div></div><div></div></div>
+	<div class="tl item item3"><div></div><div></div></div>
+	<div class="tl item item4"><div></div><div></div></div>
+	<div class="tl item item5"><div></div><div></div></div>
+
+	<div class="tr item item1"><div></div><div></div></div>
+	<div class="tr item item2"><div></div><div></div></div>
+	<div class="tr item item3"><div></div><div></div></div>
+	<div class="tr item item4"><div></div><div></div></div>
+	<div class="tr item item5"><div></div><div></div></div>
+
+	<div class="bl item item1"><div></div><div></div></div>
+	<div class="bl item item2"><div></div><div></div></div>
+	<div class="bl item item3"><div></div><div></div></div>
+	<div class="bl item item4"><div></div><div></div></div>
+	<div class="bl item item5"><div></div><div></div></div>
+
+	<div class="br item item1"><div></div><div></div></div>
+	<div class="br item item2"><div></div><div></div></div>
+	<div class="br item item3"><div></div><div></div></div>
+	<div class="br item item4"><div></div><div></div></div>
+	<div class="br item item5"><div></div><div></div></div>
+</div>
+
+<div class="set varypos athalf border">
+	<div class="tl item item1"><div></div><div></div></div>
+	<div class="tl item item2"><div></div><div></div></div>
+	<div class="tl item item3"><div></div><div></div></div>
+	<div class="tl item item4"><div></div><div></div></div>
+	<div class="tl item item5"><div></div><div></div></div>
+
+	<div class="tr item item1"><div></div><div></div></div>
+	<div class="tr item item2"><div></div><div></div></div>
+	<div class="tr item item3"><div></div><div></div></div>
+	<div class="tr item item4"><div></div><div></div></div>
+	<div class="tr item item5"><div></div><div></div></div>
+
+	<div class="bl item item1"><div></div><div></div></div>
+	<div class="bl item item2"><div></div><div></div></div>
+	<div class="bl item item3"><div></div><div></div></div>
+	<div class="bl item item4"><div></div><div></div></div>
+	<div class="bl item item5"><div></div><div></div></div>
+
+	<div class="br item item1"><div></div><div></div></div>
+	<div class="br item item2"><div></div><div></div></div>
+	<div class="br item item3"><div></div><div></div></div>
+	<div class="br item item4"><div></div><div></div></div>
+	<div class="br item item5"><div></div><div></div></div>
+</div>
+
+</body>
+</html>
diff --git a/layout/reftests/pixel-rounding/background-image-tiling.html b/layout/reftests/pixel-rounding/background-image-tiling.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/pixel-rounding/background-image-tiling.html
@@ -0,0 +1,291 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+	"http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+	<title>Pixel rounding of background image tiling</title>
+	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+	<meta http-equiv="Content-Style-Type" content="text/css">
+	<style type="text/css">
+
+	body { background: black; }
+
+	.set {
+		height: 60px;
+		position: relative;
+	}
+
+	.item {
+		position: absolute;
+		width: 10px;
+		height: 10px;
+	}
+
+	.item1 { left: 0px; }
+	.item2 { left: 15px; }
+	.item3 { left: 30px; }
+	.item4 { left: 45px; }
+	.item5 { left: 60px; }
+
+	.tl {
+		top: 0px;
+		background-image: url(corner-tl.png);
+		background-position: top left;
+	}
+
+	.tr {
+		top: 15px;
+		background-image: url(corner-tr.png);
+		background-position: top right;
+	}
+
+	.bl {
+		top: 30px;
+		background-image: url(corner-bl.png);
+		background-position: bottom left;
+	}
+
+	.br {
+		top: 45px;
+		background-image: url(corner-br.png);
+		background-position: bottom right;
+	}
+
+	.varydim .item1 { height: 10.0px; width: 11.0px; }
+	.varydim .item2 { height: 10.4px; width: 10.6px; }
+	.varydim .item3 { height: 10.5px; width: 10.5px; }
+	.varydim .item4 { height: 10.6px; width: 10.4px; }
+	.varydim .item5 { height: 11.0px; width: 10.0px; }
+
+	.varypos .item1 { margin-top: 0.0px; margin-left: 1.0px; }
+	.varypos .item2 { margin-top: 0.4px; margin-left: 0.6px; }
+	.varypos .item3 { margin-top: 0.5px; margin-left: 0.5px; }
+	.varypos .item4 { margin-top: 0.6px; margin-left: 0.4px; }
+	.varypos .item5 { margin-top: 1.0px; margin-left: 0.0px; }
+
+	.varydim.athalf .item {
+		margin-top: 0.5px; margin-left: 0.5px;
+	}
+
+	.varypos.athalf .item {
+		width: 10.5px; height: 10.5px;
+	}
+
+	.border .item {
+		/* force the tiling codepath by making sure there are multiple images */
+		border: 1px solid transparent;
+	}
+
+	</style>
+</head>
+<body>
+
+<div class="set varydim">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+<div class="set varypos">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+<div class="set varydim athalf">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+<div class="set varypos athalf">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+<div class="set varydim border">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+<div class="set varypos border">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+<div class="set varydim athalf border">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+<div class="set varypos athalf border">
+	<div class="tl item item1"></div>
+	<div class="tl item item2"></div>
+	<div class="tl item item3"></div>
+	<div class="tl item item4"></div>
+	<div class="tl item item5"></div>
+
+	<div class="tr item item1"></div>
+	<div class="tr item item2"></div>
+	<div class="tr item item3"></div>
+	<div class="tr item item4"></div>
+	<div class="tr item item5"></div>
+
+	<div class="bl item item1"></div>
+	<div class="bl item item2"></div>
+	<div class="bl item item3"></div>
+	<div class="bl item item4"></div>
+	<div class="bl item item5"></div>
+
+	<div class="br item item1"></div>
+	<div class="br item item2"></div>
+	<div class="br item item3"></div>
+	<div class="br item item4"></div>
+	<div class="br item item5"></div>
+</div>
+
+</body>
+</html>
diff --git a/layout/reftests/pixel-rounding/corner-bl.png b/layout/reftests/pixel-rounding/corner-bl.png
new file mode 100644
index 0000000000000000000000000000000000000000..bed9056cb61b959cf70e0318b1b47ec2744a5ffa
GIT binary patch
literal 115
zc%17D@N?(olHy`uVBq!ia0vp^3LwnE1SJ1Ryj={W7>k44ofy`glX(f`=z6+1hIkx*
zd)ASW!9d`U!HoLzwxWBkNq8vo&a9L)Hh_U2Y8pAs%zgh^ty3BO{eT)7JYD@<);T3K
F0RS=*9*6({

diff --git a/layout/reftests/pixel-rounding/corner-br.png b/layout/reftests/pixel-rounding/corner-br.png
new file mode 100644
index 0000000000000000000000000000000000000000..44accf944998e5e45412da645dcb522c57b283d5
GIT binary patch
literal 117
zc%17D@N?(olHy`uVBq!ia0vp^3LwnE1SJ1Ryj={W7>k44ofy`glX(f`=zF?2hIkx*
zd(DuM!9bwdA?W|S&ss*JJa@b@W`=%}P*;F~54;ne?q!xS`O9jp)YZfZ)XL!L>gTe~
HDWM4fj_)7{

diff --git a/layout/reftests/pixel-rounding/corner-tl.png b/layout/reftests/pixel-rounding/corner-tl.png
new file mode 100644
index 0000000000000000000000000000000000000000..65a71e1199e70909c1ad474e30eb889b8883ffe8
GIT binary patch
literal 115
zc%17D@N?(olHy`uVBq!ia0vp^3LwnE1SJ1Ryj={W7>k44ofy`glX(f`=z6+1hIkx*
zd)85qfq~=jhC>hU8?Cs}eas<i`U=Lbgi9@w5-_lbldrvx*+GS^Q4gq*!PC{xWt~$(
F69AlpAQu1t

diff --git a/layout/reftests/pixel-rounding/corner-tr.png b/layout/reftests/pixel-rounding/corner-tr.png
new file mode 100644
index 0000000000000000000000000000000000000000..df6590fa0429781f671fe4cb8e6cb85553fadf11
GIT binary patch
literal 114
zc%17D@N?(olHy`uVBq!ia0vp^3LwnE1SJ1Ryj={W7>k44ofy`glX(f`=y<v~hIkx*
zd)ASW!9d{92BZJ;EJgQRlkkXIcBn|BvPV(^25N+5@^x9QD+F%+0_tP%boFyt=akR{
E05oeJ-2eap

diff --git a/layout/reftests/pixel-rounding/reftest.list b/layout/reftests/pixel-rounding/reftest.list
--- a/layout/reftests/pixel-rounding/reftest.list
+++ b/layout/reftests/pixel-rounding/reftest.list
@@ -166,8 +166,10 @@ random-if(MOZ_WIDGET_TOOLKIT=="cocoa") =
 == rounded-background-color-left-width-5.html rounded-background-color-width-5.html
 == rounded-background-color-left-width-6.html rounded-background-color-width-6.html
 == rounded-background-color-height-top-4.html rounded-background-color-height-4.html
 == rounded-background-color-height-top-5.html rounded-background-color-height-5.html
 == rounded-background-color-height-top-6.html rounded-background-color-height-6.html
 == rounded-background-color-width-left-4.html rounded-background-color-width-4.html
 == rounded-background-color-width-left-5.html rounded-background-color-width-5.html
 == rounded-background-color-width-left-6.html rounded-background-color-width-6.html
+
+== background-image-tiling.html background-image-tiling-ref.html

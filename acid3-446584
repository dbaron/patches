From: Ben Newman <bnewman@mozilla.com>

WIP from attachment 337743 on bug 446584

diff --git a/js/src/xpconnect/src/xpcconvert.cpp b/js/src/xpconnect/src/xpcconvert.cpp
--- a/js/src/xpconnect/src/xpcconvert.cpp
+++ b/js/src/xpconnect/src/xpcconvert.cpp
@@ -1354,17 +1354,18 @@ XPCConvert::JSObject2NativeInterface(XPC
 /***************************************************************************/
 /***************************************************************************/
 
 // static
 nsresult
 XPCConvert::ConstructException(nsresult rv, const char* message,
                                const char* ifaceName, const char* methodName,
                                nsISupports* data,
-                               nsIException** exceptn)
+                               nsIException** exceptn,
+                               const jsval *jsExceptionPtr)
 {
     static const char format[] = "\'%s\' when calling method: [%s::%s]";
     const char * msg = message;
     char* sz = nsnull;
     nsXPIDLString xmsg;
     nsCAutoString sxmsg;
 
     nsCOMPtr<nsIScriptError> errorObject = do_QueryInterface(data);
@@ -1376,16 +1377,22 @@ XPCConvert::ConstructException(nsresult 
     }
     if(!msg)
         if(!nsXPCException::NameAndFormatForNSResult(rv, nsnull, &msg) || ! msg)
             msg = "<error>";
     if(ifaceName && methodName)
         msg = sz = JS_smprintf(format, msg, ifaceName, methodName);
 
     nsresult res = nsXPCException::NewException(msg, rv, nsnull, data, exceptn);
+
+    if (NS_SUCCEEDED(res) && jsExceptionPtr && *exceptn) {
+        nsCOMPtr<nsXPCException> xpcEx = do_QueryInterface(*exceptn);
+        if (xpcEx)
+            xpcEx->SetThrownJSVal(*jsExceptionPtr);
+    }
 
     if(sz)
         JS_smprintf_free(sz);
     return res;
 }
 
 /********************************/
 
@@ -1425,17 +1432,17 @@ XPCConvert::JSValToXPCException(XPCCallC
                 *exceptn = temp;
                 return NS_OK;
             }
             else
             {
                 // it is a wrapped native, but not an exception!
                 return ConstructException(NS_ERROR_XPC_JS_THREW_NATIVE_OBJECT,
                                           nsnull, ifaceName, methodName, supports,
-                                          exceptn);
+                                          exceptn, nsnull);
             }
         }
         else
         {
             // It is a JSObject, but not a wrapped native...
 
             // If it is an engine Error with an error report then let's
             // extract the report and build an xpcexception from that
@@ -1487,25 +1494,25 @@ XPCConvert::JSValToXPCException(XPCCallC
 
             JSString* str = JS_ValueToString(cx, s);
             if(!str)
                 return NS_ERROR_FAILURE;
 
             return ConstructException(NS_ERROR_XPC_JS_THREW_JS_OBJECT,
                                       JS_GetStringBytes(str),
                                       ifaceName, methodName, nsnull,
-                                      exceptn);
+                                      exceptn, &s);
         }
     }
 
     if(JSVAL_IS_VOID(s) || JSVAL_IS_NULL(s))
     {
         return ConstructException(NS_ERROR_XPC_JS_THREW_NULL,
                                   nsnull, ifaceName, methodName, nsnull,
-                                  exceptn);
+                                  exceptn, &s);
     }
 
     if(JSVAL_IS_NUMBER(s))
     {
         // lets see if it looks like an nsresult
         nsresult rv;
         double number;
         JSBool isResult = JS_FALSE;
@@ -1528,44 +1535,47 @@ XPCConvert::JSValToXPCException(XPCCallC
                 rv = (nsresult) number;
                 if(NS_FAILED(rv))
                     isResult = JS_TRUE;
             }
         }
 
         if(isResult)
             return ConstructException(rv, nsnull, ifaceName, methodName,
-                                      nsnull, exceptn);
+                                      nsnull, exceptn, &s);
         else
         {
+            // XXX all this nsISupportsDouble code seems a little redundant
+            // now that we're storing the jsval in the exception...
             nsISupportsDouble* data;
             nsCOMPtr<nsIComponentManager> cm;
             if(NS_FAILED(NS_GetComponentManager(getter_AddRefs(cm))) || !cm ||
                NS_FAILED(cm->CreateInstanceByContractID(
                                 NS_SUPPORTS_DOUBLE_CONTRACTID,
                                 nsnull,
                                 NS_GET_IID(nsISupportsDouble),
                                 (void**)&data)))
                 return NS_ERROR_FAILURE;
             data->SetData(number);
             rv = ConstructException(NS_ERROR_XPC_JS_THREW_NUMBER, nsnull,
-                                    ifaceName, methodName, data, exceptn);
+                                    ifaceName, methodName, data, exceptn, &s);
             NS_RELEASE(data);
             return rv;
         }
     }
 
     // otherwise we'll just try to convert it to a string
+    // Note: e.g., JSBools get converted to JSStrings by this code.
 
     JSString* str = JS_ValueToString(cx, s);
     if(str)
         return ConstructException(NS_ERROR_XPC_JS_THREW_STRING,
                                   JS_GetStringBytes(str),
                                   ifaceName, methodName, nsnull,
-                                  exceptn);
+                                  exceptn, &s);
     return NS_ERROR_FAILURE;
 }
 
 /********************************/
 
 // static
 nsresult
 XPCConvert::JSErrorToXPCException(XPCCallContext& ccx,
@@ -1609,25 +1619,25 @@ XPCConvert::JSErrorToXPCException(XPCCal
 
     if(data)
     {
         nsCAutoString formattedMsg;
         data->ToString(formattedMsg);
 
         rv = ConstructException(NS_ERROR_XPC_JAVASCRIPT_ERROR_WITH_DETAILS,
                                 formattedMsg.get(), ifaceName, methodName, data,
-                                exceptn);
+                                exceptn, nsnull);
 
         NS_RELEASE(data);
     }
     else
     {
         rv = ConstructException(NS_ERROR_XPC_JAVASCRIPT_ERROR,
                                 nsnull, ifaceName, methodName, nsnull,
-                                exceptn);
+                                exceptn, nsnull);
     }
     return rv;
 }
 
 
 /***************************************************************************/
 
 /*
diff --git a/js/src/xpconnect/src/xpcexception.cpp b/js/src/xpconnect/src/xpcexception.cpp
--- a/js/src/xpconnect/src/xpcexception.cpp
+++ b/js/src/xpconnect/src/xpcexception.cpp
@@ -144,16 +144,33 @@ nsXPCException::nsXPCException()
 {
     MOZ_COUNT_CTOR(nsXPCException);
 }
 
 nsXPCException::~nsXPCException()
 {
     MOZ_COUNT_DTOR(nsXPCException);
     Reset();
+}
+
+PRBool
+nsXPCException::GetThrownJSVal(jsval *vp) const
+{
+    if (mThrownJSVal) {
+        if (vp) *vp = mThrownJSVal->GetJSVal();
+        return PR_TRUE;
+    } else return PR_FALSE;
+}
+
+void
+nsXPCException::SetThrownJSVal(jsval v)
+{
+    mThrownJSVal = JSVAL_IS_TRACEABLE(v)
+        ? new XPCTraceableVariant(nsXPConnect::GetRuntime(), v)
+        : new XPCVariant(v);
 }
 
 void
 nsXPCException::Reset()
 {
     if(mMessage)
     {
         nsMemory::Free(mMessage);
diff --git a/js/src/xpconnect/src/xpcprivate.h b/js/src/xpconnect/src/xpcprivate.h
--- a/js/src/xpconnect/src/xpcprivate.h
+++ b/js/src/xpconnect/src/xpcprivate.h
@@ -2767,18 +2767,19 @@ public:
                                           const char* ifaceName,
                                           const char* methodName,
                                           const JSErrorReport* report,
                                           nsIException** exception);
 
     static nsresult ConstructException(nsresult rv, const char* message,
                                        const char* ifaceName,
                                        const char* methodName,
-                                       nsISupports* data,                                       
-                                       nsIException** exception);
+                                       nsISupports* data,
+                                       nsIException** exception,
+                                       const jsval *jsExceptionPtr);
 
     static void RemoveXPCOMUCStringFinalizer();
 
 private:
     XPCConvert(); // not implemented
 
 };
 
@@ -2854,16 +2855,18 @@ public:
                              nsIStackFrame* aCaller,
                              nsIStackFrame** stack);
 private:
     XPCJSStack();   // not implemented
 };
 
 /***************************************************************************/
 
+class XPCVariant;
+
 class nsXPCException :
             public nsIXPCException
 {
 public:
     NS_DEFINE_STATIC_CID_ACCESSOR(NS_XPCEXCEPTION_CID)
 
     NS_DECL_ISUPPORTS
     NS_DECL_NSIEXCEPTION
@@ -2885,29 +2888,34 @@ public:
                                   void** iterp);
 
     static PRUint32 GetNSResultCount();
 
     nsXPCException();
     virtual ~nsXPCException();
 
     static void InitStatics() { sEverMadeOneFromFactory = JS_FALSE; }
+
+    PRBool GetThrownJSVal(jsval *vp) const;
+    void   SetThrownJSVal(jsval v);
 
 protected:
     void Reset();
 private:
     char*           mMessage;
     nsresult        mResult;
     char*           mName;
     nsIStackFrame*  mLocation;
     nsISupports*    mData;
     char*           mFilename;
     int             mLineNumber;
     nsIException*   mInner;
     PRBool          mInitialized;
+
+    nsCOMPtr<XPCVariant> mThrownJSVal;
 
     static JSBool sEverMadeOneFromFactory;
 };
 
 /***************************************************************************/
 /*
 * nsJSID implements nsIJSID. It is also used by nsJSIID and nsJSCID as a
 * member (as a hidden implementaion detail) to which they delegate many calls.
diff --git a/js/src/xpconnect/src/xpcthrower.cpp b/js/src/xpconnect/src/xpcthrower.cpp
--- a/js/src/xpconnect/src/xpcthrower.cpp
+++ b/js/src/xpconnect/src/xpcthrower.cpp
@@ -254,25 +254,48 @@ XPCThrower::BuildAndThrowException(JSCon
     if(finalException)
         success = ThrowExceptionObject(cx, finalException);
     // If we weren't able to build or throw an exception we're
     // most likely out of memory 
     if(!success)
         JS_ReportOutOfMemory(cx);
 }
 
+static PRBool
+IsCallerChrome()
+{
+    PRBool isChrome = PR_FALSE;
+    nsCOMPtr<nsIScriptSecurityManager> securityManager =
+        do_GetService(NS_SCRIPTSECURITYMANAGER_CONTRACTID);
+    nsresult rv = securityManager->SubjectPrincipalIsSystem(&isChrome);
+    return NS_SUCCEEDED(rv) && isChrome;
+}
+
 // static
 JSBool
 XPCThrower::ThrowExceptionObject(JSContext* cx, nsIException* e)
 {
     JSBool success = JS_FALSE;
     if(e)
     {
-        nsXPConnect* xpc = nsXPConnect::GetXPConnect();
-        if(xpc)
+        nsCOMPtr<nsXPCException> xpcEx;
+        jsval thrown;
+        nsXPConnect* xpc;
+
+        // If we stored the original thrown JS value in the exception
+        // (see XPCConvert::ConstructException) and we are in a web
+        // context (i.e., not chrome), rethrow the original value.
+        if((xpcEx = do_QueryInterface(e)) &&
+           xpcEx->GetThrownJSVal(&thrown) &&
+           !IsCallerChrome())
+        {
+            JS_SetPendingException(cx, thrown);
+            success = JS_TRUE;
+        }
+        else if((xpc = nsXPConnect::GetXPConnect()))
         {
             JSObject* glob = JS_GetScopeChain(cx);
             if(!glob)
                 return JS_FALSE;
             glob = JS_GetGlobalForObject(cx, glob);
 
             nsCOMPtr<nsIXPConnectJSObjectHolder> holder;
             nsresult rv = xpc->WrapNative(cx, glob, e,
diff --git a/js/src/xpconnect/src/xpcwrappedjsclass.cpp b/js/src/xpconnect/src/xpcwrappedjsclass.cpp
--- a/js/src/xpconnect/src/xpcwrappedjsclass.cpp
+++ b/js/src/xpconnect/src/xpcwrappedjsclass.cpp
@@ -1535,17 +1535,17 @@ pre_call_clean_up:
             char* sz = nsnull;
 
             if(nsXPCException::NameAndFormatForNSResult(code, nsnull, &msg) && msg)
                 sz = JS_smprintf(format, msg, name);
 
             nsCOMPtr<nsIException> e;
 
             XPCConvert::ConstructException(code, sz, GetInterfaceName(), name,
-                                           nsnull, getter_AddRefs(e));
+                                           nsnull, getter_AddRefs(e), nsnull);
             xpcc->SetException(e);
             if(sz)
                 JS_smprintf_free(sz);
             success = JS_FALSE;
         }
     }
 
     if (!success)
diff --git a/js/src/xpconnect/tests/mochitest/Makefile.in b/js/src/xpconnect/tests/mochitest/Makefile.in
--- a/js/src/xpconnect/tests/mochitest/Makefile.in
+++ b/js/src/xpconnect/tests/mochitest/Makefile.in
@@ -45,12 +45,13 @@ include $(topsrcdir)/config/rules.mk
 include $(topsrcdir)/config/rules.mk
 
 _TEST_FILES =	test_bug361111.xul \
 		test_bug390488.html \
 		test_bug393269.html \
 		test_bug428021.html \
 		test_bug448587.html \
 		test_wrappers.html \
+		test_bug446584.html \
 		$(NULL)
 
 libs:: $(_TEST_FILES)
 	$(INSTALL) $^ $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)
diff --git a/js/src/xpconnect/tests/mochitest/test_bug446584.html b/js/src/xpconnect/tests/mochitest/test_bug446584.html
new file mode 100644
--- /dev/null
+++ b/js/src/xpconnect/tests/mochitest/test_bug446584.html
@@ -0,0 +1,49 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=446584
+-->
+<head>
+  <title>Test for Bug 446584</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=446584">Mozilla Bug 446584</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for Bug 446584 **/
+
+function test(val) {
+  try {
+    document.createNodeIterator(document.body,
+                                NodeFilter.SHOW_ALL,
+                                function() { throw val },
+                                true).nextNode();
+    ok(false, "NodeIterator::nextNode() should have thrown an exception.");
+  } catch (ex) {
+    ok(val === ex, "NodeIterator did not properly forward exception " +
+       val + " of type " + typeof val + ".  Thrown value was " + ex + ".");
+  }
+}
+
+test(0);
+test(1);
+test(3.14);
+test('roses');
+test({});
+test(false);
+test(true);
+test([1,2,3]);
+test(function(){});
+
+</script>
+</pre>
+</body>
+</html>

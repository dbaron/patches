Distribute height to rows even if the rows in question are all zero-height (in which case, distribute it equally).  b=403656, 377711

diff --git a/layout/reftests/bugs/403656-1-ref.html b/layout/reftests/bugs/403656-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-1-ref.html
@@ -0,0 +1,14 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+</head>
+<body>
+
+<div style="width: 300px; height: 300px; background: green"></div>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-1.html b/layout/reftests/bugs/403656-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-1.html
@@ -0,0 +1,19 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+  <style type="text/css">
+  table { margin: 0; }
+  </style>
+</head>
+<body>
+
+<table cellpadding=0 cellspacing=0 width="300" height="300">
+  <tr><td bgcolor="green"></td></tr>
+</table>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-2-ref.html b/layout/reftests/bugs/403656-2-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-2-ref.html
@@ -0,0 +1,16 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+</head>
+<body>
+
+<div style="width: 300px; height: 100px; background: green"></div>
+<div style="width: 300px; height: 100px; background: yellow"></div>
+<div style="width: 300px; height: 100px; background: blue"></div>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-2.html b/layout/reftests/bugs/403656-2.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-2.html
@@ -0,0 +1,21 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+  <style type="text/css">
+  table { margin: 0; }
+  </style>
+</head>
+<body>
+
+<table cellpadding=0 cellspacing=0 width="300" height="300">
+  <tr><td bgcolor="green"></td></tr>
+  <tr><td bgcolor="yellow"></td></tr>
+  <tr><td bgcolor="blue"></td></tr>
+</table>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-3-ref.html b/layout/reftests/bugs/403656-3-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-3-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+</head>
+<body>
+
+<div style="width: 300px; height: 95px; background: green"></div>
+<div style="width: 300px; height: 95px; background: yellow"></div>
+<div style="width: 300px; height: 15px; background: pink"></div>
+<div style="width: 300px; height: 95px; background: blue"></div>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-3.html b/layout/reftests/bugs/403656-3.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-3.html
@@ -0,0 +1,22 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+  <style type="text/css">
+  table { margin: 0; }
+  </style>
+</head>
+<body>
+
+<table cellpadding=0 cellspacing=0 width="300" height="300">
+  <tr><td bgcolor="green"></td></tr>
+  <tr><td bgcolor="yellow"></td></tr>
+  <tr><td height="15" bgcolor="pink"></td></tr>
+  <tr><td bgcolor="blue"></td></tr>
+</table>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-4-ref.html b/layout/reftests/bugs/403656-4-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-4-ref.html
@@ -0,0 +1,16 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+</head>
+<body>
+
+<div style="width: 300px; height: 100px; background: green"></div>
+<div style="width: 300px; height: 100px; background: yellow"></div>
+<div style="width: 300px; height: 100px; background: blue"></div>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-4.html b/layout/reftests/bugs/403656-4.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-4.html
@@ -0,0 +1,21 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+  <style type="text/css">
+  table { margin: 0; }
+  </style>
+</head>
+<body>
+
+<table cellpadding=0 cellspacing=0 width="300" height="300">
+  <tr><td bgcolor="green" height="10"></td></tr>
+  <tr><td bgcolor="yellow" height="10"></td></tr>
+  <tr><td bgcolor="blue" height="10"></td></tr>
+</table>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-5-ref.html b/layout/reftests/bugs/403656-5-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-5-ref.html
@@ -0,0 +1,16 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+</head>
+<body>
+
+<div style="width: 300px; height: 100px; background: green"></div>
+<div style="width: 300px; height: 100px; background: yellow"></div>
+<div style="width: 300px; height: 100px; background: blue"></div>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/403656-5.html b/layout/reftests/bugs/403656-5.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/403656-5.html
@@ -0,0 +1,21 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
+  "http://www.w3.org/TR/html4/strict.dtd">
+<html lang="en-US">
+<head>
+  <title>Testcase, bug 403656</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+  <style type="text/css">
+  table { margin: 0; }
+  </style>
+</head>
+<body>
+
+<table cellpadding=0 cellspacing=0 width="300" height="300">
+  <tr><td bgcolor="green" height="0"></td></tr>
+  <tr><td bgcolor="yellow" height="0"></td></tr>
+  <tr><td bgcolor="blue" height="0"></td></tr>
+</table>
+
+</body>
+</html>
+
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -439,3 +439,8 @@ fails == 393655-2.html 393655-2-ref.html
 == 400171-2c.html 400171-2-ref.html
 == 400421-1.html 400421-1-ref.html
 == 400826-1.html 400826-1-ref.html
+== 403656-1.html 403656-1-ref.html
+== 403656-2.html 403656-2-ref.html
+== 403656-3.html 403656-3-ref.html
+== 403656-4.html 403656-4-ref.html
+== 403656-5.html 403656-5-ref.html
diff --git a/layout/tables/nsTableFrame.cpp b/layout/tables/nsTableFrame.cpp
--- a/layout/tables/nsTableFrame.cpp
+++ b/layout/tables/nsTableFrame.cpp
@@ -3271,20 +3271,23 @@ nsTableFrame::DistributeHeightToRows(con
   // accumulate the correct divisor. This will be the total of all unstyled rows inside 
   // unstyled row groups, unless there are none, in which case, it will be all rows
   nscoord divisor = 0;
+  PRUint32 rowCount = 0;
   for (rgX = 0; rgX < rowGroups.Length(); rgX++) {
     nsTableRowGroupFrame* rgFrame = rowGroups[rgX];
     if (!firstUnStyledRG || !rgFrame->HasStyleHeight()) {
       nsTableRowFrame* rowFrame = rgFrame->GetFirstRow();
       while (rowFrame) {
         if (!firstUnStyledRG || !rowFrame->HasStyleHeight()) {
+          NS_ASSERTION(rowFrame->GetSize().height >= 0, "negative height");
           divisor += rowFrame->GetSize().height;
+          ++rowCount;
           lastElligibleRow = rowFrame;
         }
         rowFrame = rowFrame->GetNextRow();
       }
     }
   }
-  if (divisor <= 0) {
+  if (divisor < 0) {
     NS_ERROR("invalid divisor");
     return;
   }
@@ -3306,7 +3309,12 @@ nsTableFrame::DistributeHeightToRows(con
         // see if there is an eligible row
         if (!firstUnStyledRow || !rowFrame->HasStyleHeight()) {
           // The amount of additional space each row gets is proportional to its height
-          float percent = rowRect.height / ((float)divisor);
+          float percent;
+          if (divisor != 0) {
+            percent = rowRect.height / ((float)divisor);
+          } else {
+            percent = 1.0f / float(rowCount);
+          }
           // give rows their percentage, except for the last row which gets the remainder
           nscoord amountForRow = (rowFrame == lastElligibleRow) 
                                  ? aAmount - amountUsed : NSToCoordRound(((float)(pctBasis)) * percent);

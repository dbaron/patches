From: L. David Baron <dbaron@dbaron.org>

Make pseudo-classes-02 run using test_visited_reftests.html instead of the normal reftest harness.  (Bug 147777)  r=jwatt

diff --git a/layout/reftests/svg/pseudo-classes-02-ref.svg b/layout/reftests/svg/pseudo-classes-02-ref.svg
--- a/layout/reftests/svg/pseudo-classes-02-ref.svg
+++ b/layout/reftests/svg/pseudo-classes-02-ref.svg
@@ -3,20 +3,20 @@
      http://creativecommons.org/licenses/publicdomain/
 -->
 <svg xmlns="http://www.w3.org/2000/svg" version="1.1"
      xmlns:xlink="http://www.w3.org/1999/xlink">
 
   <title>Reference for pseudo-classes and text/links</title>
 
   <!-- link in text -->
-  <text x="10" y="50" fill="lime" font-size="2em">This should be green</text>
+  <text x="10" y="25" fill="lime" font-size="1em">This should be green</text>
 
   <!-- text in link -->
-  <text x="10" y="100" fill="lime" font-size="2em">This should be green</text>
+  <text x="10" y="50" fill="lime" font-size="1em">This should be green</text>
 
   <!-- link in tspan -->
-  <text x="10" y="150" fill="lime" font-size="2em">This should be green</text>
+  <text x="10" y="75" fill="lime" font-size="1em">This should be green</text>
 
   <!-- tspan in link -->
-  <text x="10" y="200" fill="lime" font-size="2em">This should be green</text>
+  <text x="10" y="100" fill="lime" font-size="1em">This should be green</text>
 
 </svg>
diff --git a/layout/reftests/svg/pseudo-classes-02.svg b/layout/reftests/svg/pseudo-classes-02.svg
--- a/layout/reftests/svg/pseudo-classes-02.svg
+++ b/layout/reftests/svg/pseudo-classes-02.svg
@@ -1,81 +1,48 @@
 <!--
      Any copyright is dedicated to the Public Domain.
      http://creativecommons.org/licenses/publicdomain/
 -->
 <svg xmlns="http://www.w3.org/2000/svg" version="1.1"
-     xmlns:xlink="http://www.w3.org/1999/xlink"
-     class="reftest-wait">
+     xmlns:xlink="http://www.w3.org/1999/xlink">
 
   <title>Testcase for pseudo-classes and text/links</title>
 
   <!-- From https://bugzilla.mozilla.org/show_bug.cgi?id=268135 -->
 
   <style type="text/css">
   <![CDATA[
 
-:root                   { font-size: 2em; }
+:root                   { font-size: 1em; }
 text > a:link           { fill: lime; }
 a:visited > text        { fill: lime; }
 tspan > a:link          { fill: lime; }
 a:visited > tspan       { fill: lime; }
 
   ]]>
   </style>
 
   <!-- link in text -->
-  <text x="10" y="50">
+  <text x="10" y="25">
     <a xlink:href="do-not-visit-me.xxx" fill="red">This should be green</a>
   </text>
 
   <!-- text in link -->
   <a xlink:href="">
-    <text id="t2" x="10" y="100" fill="red">This should be green</text>
+    <text x="10" y="50" fill="red">This should be green</text>
   </a>
 
   <!-- link in tspan -->
   <text>
-    <tspan x="10" y="150">
+    <tspan x="10" y="75">
       <a xlink:href="do-not-visit-me.xxx" fill="red">This should be green</a>
     </tspan>
   </text>
 
   <!-- tspan in link -->
   <text>
     <a xlink:href="">
-      <tspan id="t4" x="10" y="200" fill="red">This should be green</tspan>
+      <tspan x="10" y="100" fill="red">This should be green</tspan>
     </a>
   </text>
 
-  <script type="text/javascript;version=1.7"><![CDATA[
-  let tests = testIterator();
-  function nextTest()
-  {
-    tests.next();
-  }
-
-  function testIterator()
-  {
-    let t2 = document.getElementById("t2");
-    let t4 = document.getElementById("t4");
-    const kExpectedFill = "rgb(0, 255, 0)";
-
-    // Because link coloring is asynchronous, we wait until it is updated.
-    while (getComputedStyle(t2, "").getPropertyValue("fill") != kExpectedFill) {
-      setTimeout(nextTest, 10);
-      yield;
-    }
-    while (getComputedStyle(t4, "").getPropertyValue("fill") != kExpectedFill) {
-      setTimeout(nextTest, 10);
-      yield;
-    }
-
-    // Remove the reftest-wait class so the test harness knows to take the
-    // snapshot.
-    document.documentElement.removeAttribute("class");
-    yield;
-  }
-
-  nextTest();
-  ]]></script>
-
 </svg>
diff --git a/layout/reftests/svg/reftest.list b/layout/reftests/svg/reftest.list
--- a/layout/reftests/svg/reftest.list
+++ b/layout/reftests/svg/reftest.list
@@ -114,17 +114,20 @@ fails == inline-in-xul-basic-01.xul pass
 == opacity-and-gradient-01.svg pass.svg
 == opacity-and-gradient-02.svg opacity-and-gradient-02-ref.svg
 == opacity-and-pattern-01.svg pass.svg
 == path-01.svg path-01-ref.svg
 == pattern-live-01a.svg pattern-live-01-ref.svg
 == pattern-live-01b.svg pattern-live-01-ref.svg
 == pattern-live-01c.svg pattern-live-01-ref.svg
 == pseudo-classes-01.svg pass.svg
-== pseudo-classes-02.svg pseudo-classes-02-ref.svg
+# This test depends on :visited styles (which are asynchronous), so we run
+# it in layout/style/test/test_visited_reftests.html instead of using the
+# reftest harness.
+# == pseudo-classes-02.svg pseudo-classes-02-ref.svg
 == radialGradient-basic-01.svg pass.svg
 == radialGradient-basic-02.svg pass.svg
 == radialGradient-basic-03.svg radialGradient-basic-03-ref.svg
 == rect-01.svg pass.svg
 == rect-02.svg pass.svg
 == rect-03.svg pass.svg
 == rect-with-rx-and-ry-01.svg pass.svg
 == rect-with-rx-or-ry-01.svg rect-with-rx-or-ry-01-ref.svg
diff --git a/layout/style/test/Makefile.in b/layout/style/test/Makefile.in
--- a/layout/style/test/Makefile.in
+++ b/layout/style/test/Makefile.in
@@ -203,16 +203,18 @@ _TEST_FILES =	test_acid3_test46.html \
 		ccd-standards.html \
 		ccd.sjs \
 		visited-pref-iframe.html \
 		visited-lying-inner.html \
 		$(NULL)
 
 _VISITED_REFTEST_FILES = \
 		$(shell find $(topsrcdir)/layout/reftests/css-visited/ -name '*.html' -o -name '*.xhtml') \
+		$(topsrcdir)/layout/reftests/svg/pseudo-classes-02.svg \
+		$(topsrcdir)/layout/reftests/svg/pseudo-classes-02-ref.svg \
 		$(NULL)
 
 _BROWSER_FILES = \
 		browser_bug453896.js \
 		bug453896_iframe.html \
 		media_queries_iframe.html \
 		$(NULL)
 
diff --git a/layout/style/test/test_visited_reftests.html b/layout/style/test/test_visited_reftests.html
--- a/layout/style/test/test_visited_reftests.html
+++ b/layout/style/test/test_visited_reftests.html
@@ -27,16 +27,17 @@ https://bugzilla.mozilla.org/show_bug.cg
 var gTests = [
   // there's also an implicit "load visited-page.html" at the start,
   // thanks to the code below.
 
   // IMPORTANT NOTE: For these tests, the test and reference are not
   // snapshotted in the same way.  The REFERENCE (second file) is
   // assumed to be complete when loaded, but we poll for visited link
   // coloring on the TEST (first file) until the test passes.
+  "== pseudo-classes-02.svg pseudo-classes-02-ref.svg",
   "!= color-on-link-1-ref.html color-on-visited-1-ref.html",
   "== color-on-link-1.html color-on-link-1-ref.html",
   "== color-on-link-before-1.html color-on-link-1-ref.html",
   "== color-on-visited-1.html color-on-visited-1-ref.html",
   "== color-on-visited-before-1.html color-on-visited-1-ref.html",
   "!= content-color-on-link-before-1-ref.html content-color-on-visited-before-1-ref.html",
   "== content-color-on-link-before-1.html content-color-on-link-before-1-ref.html",
   "== content-color-on-visited-before-1.html content-color-on-visited-before-1-ref.html",

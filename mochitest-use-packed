From: L. David Baron <dbaron@dbaron.org>

Switch HTML mochitests from using MochiKit.js to packed.js.  (Bug 490955)

diff --git a/testing/mochitest/static/test.template.txt b/testing/mochitest/static/test.template.txt
--- a/testing/mochitest/static/test.template.txt
+++ b/testing/mochitest/static/test.template.txt
@@ -1,16 +1,16 @@
 <!DOCTYPE HTML>
 <html>
 <!--
 https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}
 -->
 <head>
   <title>Test for Bug {BUGNUMBER}</title>
-  <script type="application/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="application/javascript" src="/MochiKit/packed.js"></script>
   <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
 </head>
 <body>
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id={BUGNUMBER}">Mozilla Bug {BUGNUMBER}</a>
 <p id="display"></p>
 <div id="content" style="display: none">
   
diff --git a/xpcom/glue/nsISupportsImpl.h b/xpcom/glue/nsISupportsImpl.h
--- a/xpcom/glue/nsISupportsImpl.h
+++ b/xpcom/glue/nsISupportsImpl.h
@@ -131,16 +131,17 @@ public:
       // is incrementing has a reference, as does the decr() frame
       // that stabilized-and-is-deleting us.
       return 2;
     }
 
     nsrefcnt refcount;
     if (IsPurple()) {
       nsPurpleBufferEntry *e = NS_CCAR_TAGGED_TO_PURPLE_ENTRY(mTagged);
+      NS_ASSERTION(e->mObject == owner, "wrong entry");
       refcount = e->mRefCnt;
       NS_ASSERTION(refcount != 0, "purple ISupports pointer with zero refcnt");
 
       if (NS_LIKELY(NS_CycleCollectorForget2(e))) {
         // |e| is now invalid
         ++refcount;
         mTagged = NS_CCAR_REFCNT_TO_TAGGED(refcount);
       } else {
@@ -164,16 +165,17 @@ public:
   nsrefcnt decr(nsISupports *owner)
   {
     if (NS_UNLIKELY(mTagged == NS_CCAR_TAGGED_STABILIZED_REFCNT))
       return 1;
 
     nsrefcnt refcount;
     if (IsPurple()) {
       nsPurpleBufferEntry *e = NS_CCAR_TAGGED_TO_PURPLE_ENTRY(mTagged);
+      NS_ASSERTION(e->mObject == owner, "wrong entry");
       refcount = e->mRefCnt;
       --refcount;
       
       if (NS_UNLIKELY(refcount == 0)) {
         if (NS_UNLIKELY(!NS_CycleCollectorForget2(e))) {
           NS_NOTREACHED("forget should not fail when reference count hits 0");
         }
         mTagged = NS_CCAR_REFCNT_TO_TAGGED(refcount);

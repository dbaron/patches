From: L. David Baron <dbaron@dbaron.org>

Clean up widgets before gfx shutdown.

diff --git a/image/decoders/icon/nsIconModule.cpp b/image/decoders/icon/nsIconModule.cpp
--- a/image/decoders/icon/nsIconModule.cpp
+++ b/image/decoders/icon/nsIconModule.cpp
@@ -34,16 +34,17 @@ static const mozilla::Module::ContractID
 static const mozilla::Module::CategoryEntry kIconCategories[] = {
   { NULL }
 };
 
 static void
 IconDecoderModuleDtor()
 {
 #ifdef MOZ_WIDGET_GTK2
+  // XXX This should happen at xpcom-shutdown so it's before gfx shutdown.
   nsIconChannel::Shutdown();
 #endif
 }
 
 static const mozilla::Module kIconModule = {
   mozilla::Module::kVersion,
   kIconCIDs,
   kIconContracts,
diff --git a/widget/gtk2/nsWidgetFactory.cpp b/widget/gtk2/nsWidgetFactory.cpp
--- a/widget/gtk2/nsWidgetFactory.cpp
+++ b/widget/gtk2/nsWidgetFactory.cpp
@@ -300,16 +300,18 @@ static const mozilla::Module::ContractID
     { "@mozilla.org/gfx/info;1", &kNS_GFXINFO_CID },
 #endif
     { NULL }
 };
 
 static void
 nsWidgetGtk2ModuleDtor()
 {
+  // XXX A bunch of these things need to happen before GFX shutdown, so
+  // they should happen earlier than the module destructor!
   nsLookAndFeel::Shutdown();
   nsFilePicker::Shutdown();
   nsSound::Shutdown();
   nsWindow::ReleaseGlobals();
   nsGTKToolkit::Shutdown();
   nsAppShellShutdown();
 }
 

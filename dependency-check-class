From: L. David Baron <dbaron@dbaron.org>

Bug 1122781 patch 2 - Add class to check struct computation dependencies.

diff --git a/layout/style/nsRuleNode.cpp b/layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp
+++ b/layout/style/nsRuleNode.cpp
@@ -42,16 +42,17 @@
 #include "nsPrintfCString.h"
 #include "nsRenderingContext.h"
 #include "nsStyleUtil.h"
 #include "nsIDocument.h"
 #include "prtime.h"
 #include "CSSVariableResolver.h"
 #include "nsCSSParser.h"
 #include "CounterStyleManager.h"
+#include "mozilla/AutoRestore.h"
 
 #if defined(_MSC_VER) || defined(__MINGW32__)
 #include <malloc.h>
 #ifdef _MSC_VER
 #define alloca _alloca
 #endif
 #endif
 #ifdef SOLARIS
@@ -2077,16 +2078,46 @@ nsRuleNode::CheckSpecifiedProperties(con
   CheckCallbackFn cb = gCheckCallbacks[aSID];
   if (cb) {
     result = (*cb)(aRuleData, result);
   }
 
   return result;
 }
 
+struct AutoCheckComputationNesting {
+#ifdef DEBUG
+  static nsStyleContext* sCurrentContext;
+  static nsStyleStructID sCurrentSID;
+
+  AutoRestore<nsStyleContext*> mRestoreCurrentContext;
+  AutoRestore<nsStyleStructID> mRestoreCurrentSID;
+
+  AutoCheckComputationNesting(nsStyleContext* aContext,
+                              nsStyleStructID aSID)
+    : mRestoreCurrentContext(sCurrentContext)
+    , mRestoreCurrentSID(sCurrentSID)
+  {
+    if (sCurrentContext) {
+      // TODO: Check bits on new SID are at least as restrictive than old.
+    }
+
+    sCurrentContext = aContext;
+    sCurrentSID = aSID;
+  }
+
+  // TODO (maybe): add a CheckGet method, similar to above?
+#else
+  AutoCheckComputationNesting(nsStyleContext* aContext,
+                              nsStyleStructID aSID)
+  {
+  }
+#endif
+};
+
 // If we need to restrict which properties apply to the style context,
 // return the bit to check in nsCSSProp's flags table.  Otherwise,
 // return 0.
 inline uint32_t
 GetPseudoRestriction(nsStyleContext *aContext)
 {
   // This needs to match nsStyleSet::WalkRestrictionRule.
   uint32_t pseudoRestriction = 0;

From: L. David Baron <dbaron@dbaron.org>

Bug 1122781 patch 2 - Add class to check struct computation dependencies.

diff --git a/layout/style/nsRuleNode.cpp b/layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp
+++ b/layout/style/nsRuleNode.cpp
@@ -8,16 +8,17 @@
  * a node in the lexicographic tree of rules that match an element,
  * responsible for converting the rules' information into computed style
  */
 
 #include <algorithm>
 
 #include "mozilla/ArrayUtils.h"
 #include "mozilla/Assertions.h"
+#include "mozilla/AutoRestore.h"
 #include "mozilla/DebugOnly.h"
 #include "mozilla/dom/AnimationEffectReadOnlyBinding.h" // for PlaybackDirection
 #include "mozilla/Likely.h"
 #include "mozilla/LookAndFeel.h"
 
 #include "mozilla/css/Declaration.h"
 
 #include "nsAlgorithm.h" // for clamped()
@@ -2097,16 +2098,46 @@ nsRuleNode::CheckSpecifiedProperties(con
   CheckCallbackFn cb = gCheckCallbacks[aSID];
   if (cb) {
     result = (*cb)(aRuleData, result);
   }
 
   return result;
 }
 
+struct AutoCheckComputationNesting {
+#ifdef DEBUG
+  static nsStyleContext* sCurrentContext;
+  static nsStyleStructID sCurrentSID;
+
+  AutoRestore<nsStyleContext*> mRestoreCurrentContext;
+  AutoRestore<nsStyleStructID> mRestoreCurrentSID;
+
+  AutoCheckComputationNesting(nsStyleContext* aContext,
+                              nsStyleStructID aSID)
+    : mRestoreCurrentContext(sCurrentContext)
+    , mRestoreCurrentSID(sCurrentSID)
+  {
+    if (sCurrentContext) {
+      // TODO: Check bits on new SID are at least as restrictive than old.
+    }
+
+    sCurrentContext = aContext;
+    sCurrentSID = aSID;
+  }
+
+  // TODO (maybe): add a CheckGet method, similar to above?
+#else
+  AutoCheckComputationNesting(nsStyleContext* aContext,
+                              nsStyleStructID aSID)
+  {
+  }
+#endif
+};
+
 // If we need to restrict which properties apply to the style context,
 // return the bit to check in nsCSSProp's flags table.  Otherwise,
 // return 0.
 inline uint32_t
 GetPseudoRestriction(nsStyleContext *aContext)
 {
   // This needs to match nsStyleSet::WalkRestrictionRule.
   uint32_t pseudoRestriction = 0;

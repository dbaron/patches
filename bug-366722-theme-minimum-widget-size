diff -r ac7a6f9ee674 gfx/public/nsITheme.h
--- a/gfx/public/nsITheme.h	Thu Jan 11 18:57:45 2007 -0800
+++ b/gfx/public/nsITheme.h	Thu Jan 11 20:06:48 2007 -0800
@@ -36,6 +36,8 @@
  *
  * ***** END LICENSE BLOCK ***** */
 
+/* service providing platform-specific native rendering for widgets */
+
 #ifndef nsITheme_h_
 #define nsITheme_h_
 
@@ -63,6 +65,16 @@ class nsIAtom;
 #define NS_THEMERENDERER_CID \
 { 0xd930e29b, 0x6909, 0x44e5, { 0xab, 0x4b, 0xaf, 0x10, 0xd6, 0x92, 0x37, 0x5 } }
 
+/**
+ * nsITheme is a service that provides platform-specific native
+ * rendering for widgets.  In other words, it provides the necessary
+ * operations to draw a rendering object (an nsIFrame) as a native
+ * widget.
+ *
+ * All the methods on nsITheme take a rendering context or device
+ * context, a frame (the rendering object), and a widget type (one of
+ * the constants in nsThemeConstants.h).
+ */
 class nsITheme: public nsISupports {
 public:
   NS_DECLARE_STATIC_IID_ACCESSOR(NS_ITHEME_IID)
@@ -95,7 +107,14 @@ public:
                                    nsRect* aResult)
   { return PR_FALSE; }
 
-  NS_IMETHOD GetMinimumWidgetSize(nsIRenderingContext* aContext, nsIFrame* aFrame,
+  /**
+   * Get the minimum border-box size of a widget, in *pixels* (in
+   * |aResult|).  If |aIsOverridable| is set to true, this size is a
+   * minimum size; if false, this size is the only valid size for the
+   * widget.
+   */
+  NS_IMETHOD GetMinimumWidgetSize(nsIRenderingContext* aContext,
+                                  nsIFrame* aFrame,
                                   PRUint8 aWidgetType,
                                   nsSize* aResult,
                                   PRBool* aIsOverridable)=0;
diff -r ac7a6f9ee674 layout/base/nsLayoutUtils.cpp
--- a/layout/base/nsLayoutUtils.cpp	Thu Jan 11 18:57:45 2007 -0800
+++ b/layout/base/nsLayoutUtils.cpp	Thu Jan 11 20:16:04 2007 -0800
@@ -1263,6 +1263,27 @@ nsLayoutUtils::IntrinsicForContainer(nsI
   if (result < min)
     result = min;
 
+  const nsStyleDisplay *disp = aFrame->GetStyleDisplay();
+  if (aFrame->IsThemed(disp)) {
+    nsSize size(0, 0);
+    PRBool canOverride = PR_TRUE;
+    nsPresContext *presContext = GetPresContext();
+    presContext->GetTheme()->
+      GetMinimumWidgetSize(aRenderingContext, this, disp->mAppearance,
+                           &size, &canOverride);
+
+    // GMWS() returns size in pixels, we need to convert it back to twips
+    float p2t = presContext->ScaledPixelsToTwips();
+    nscoord themeWidth = NSIntPixelsToTwips(size.width, p2t);
+
+    // GMWS() returns a border-box width
+    themeWidth += offsets.hMargin;
+    themeWidth = AddPercents(aType, themeWidth, offsets.hPctMargin);
+
+    if (themeWidth > result || !canOverride)
+      result = themeWidth;
+  }
+
 #ifdef DEBUG_INTRINSIC_WIDTH
   nsFrame::IndentBy(stdout, gNoiseIndent);
   NS_STATIC_CAST(nsFrame*, aFrame)->ListTag(stdout);
diff -r ac7a6f9ee674 layout/generic/nsFrame.cpp
--- a/layout/generic/nsFrame.cpp	Thu Jan 11 18:57:45 2007 -0800
+++ b/layout/generic/nsFrame.cpp	Thu Jan 11 20:17:28 2007 -0800
@@ -3085,9 +3085,6 @@ nsFrame::ComputeSize(nsIRenderingContext
   if (minWidth > result.width)
     result.width = minWidth;
 
-  if (result.width < 0)
-    result.width = 0;
-
   // Compute height
 
   if (!IsAutoHeight(stylePos->mHeight, aCBSize.height)) {
@@ -3116,6 +3113,32 @@ nsFrame::ComputeSize(nsIRenderingContext
         result.height = minHeight;
     }
   }
+
+  const nsStyleDisplay *disp = GetStyleDisplay();
+  if (IsThemed(disp)) {
+    nsSize size(0, 0);
+    PRBool canOverride = PR_TRUE;
+    nsPresContext *presContext = GetPresContext();
+    presContext->GetTheme()->
+      GetMinimumWidgetSize(aRenderingContext, this, disp->mAppearance,
+                           &size, &canOverride);
+
+    // GMWS() returns size in pixels, we need to convert it back to twips
+    float p2t = presContext->ScaledPixelsToTwips();
+    size.width = NSIntPixelsToTwips(size.width, p2t);
+    size.height = NSIntPixelsToTwips(size.height, p2t);
+
+    // GMWS() returns border-box; we need content-box
+    size -= aBorder + aPadding;
+
+    if (size.height > result.height || !canOverride)
+      result.height = size.height;
+    if (size.width > result.width || !canOverride)
+      result.width = size.width;
+  }
+
+  if (result.width < 0)
+    result.width = 0;
 
   if (result.height < 0)
     result.height = 0;

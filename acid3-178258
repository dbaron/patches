From: David Baron <dbaron@dbaron.org>, Mats Palmgren <mats.palmgren@bredband.net>

WIP from attachment 339167 on bug 178258

diff --git a/parser/htmlparser/src/CNavDTD.cpp b/parser/htmlparser/src/CNavDTD.cpp
--- a/parser/htmlparser/src/CNavDTD.cpp
+++ b/parser/htmlparser/src/CNavDTD.cpp
@@ -657,17 +657,16 @@ CNavDTD::HandleToken(CToken* aToken, nsI
    * This section of code is used to "move" misplaced content from one location
    * in our document model to another. (Consider what would happen if we found a
    * <P> tag in the head.) To move content, we throw it onto the
    * misplacedcontent deque until we can deal with it.
    */
   switch(theTag) {
     case eHTMLTag_html:
     case eHTMLTag_noframes:
-    case eHTMLTag_script:
     case eHTMLTag_doctypeDecl:
     case eHTMLTag_instruction:
       break;
 
     default:
       if (!gHTMLElements[eHTMLTag_html].SectionContains(theTag, PR_FALSE)) {
         if (!(mFlags & (NS_DTD_FLAG_HAS_MAIN_CONTAINER |
                         NS_DTD_FLAG_ALTERNATE_CONTENT))) {
@@ -1396,24 +1395,16 @@ CNavDTD::HandleStartToken(CToken* aToken
           aToken->SetTypeID(theChildTag = eHTMLTag_img);
           break;
 
         case eHTMLTag_keygen:
           result = HandleKeyGen(theNode);
           isTokenHandled = PR_TRUE;
           break;
 
-        case eHTMLTag_script:
-          // Script isn't really exclusively in the head. However, we treat it
-          // as such to make sure that we don't pull scripts outside the head
-          // into the body.
-          // XXX Where does the script go in a frameset document?
-          isExclusive = !(mFlags & NS_DTD_FLAG_HAD_BODY);
-          break;
-
         default:;
       }
 
       if (!isTokenHandled) {
         PRBool prefersBody =
           gHTMLElements[theChildTag].HasSpecialProperty(kPreferBody);
 
         // If this tag prefers to be in the head (when neither the head nor the
diff --git a/parser/htmlparser/src/nsElementTable.cpp b/parser/htmlparser/src/nsElementTable.cpp
--- a/parser/htmlparser/src/nsElementTable.cpp
+++ b/parser/htmlparser/src/nsElementTable.cpp
@@ -937,17 +937,17 @@ const nsHTMLElement gHTMLElements[] = {
     /*special props, prop-range*/       0,kDefaultPropRange,
     /*special parents,kids*/            0,0,
   },
   {
     /*tag*/                             eHTMLTag_script,
     /*req-parent excl-parent*/          eHTMLTag_unknown,eHTMLTag_unknown,
     /*rootnodes,endrootnodes*/          &gRootTags,&gRootTags,
     /*autoclose starttags and endtags*/ 0,0,0,0,
-    /*parent,incl,exclgroups*/          (kSpecial|kHeadContent), kCDATA, kNone,   // note: this is kHeadContent since shipping this breaks things.
+    /*parent,incl,exclgroups*/          (kSpecial|kHeadMisc), kCDATA, kNone,
     /*special props, prop-range*/       kNoStyleLeaksIn|kLegalOpen, kNoPropRange,
     /*special parents,kids*/            0,&gContainsText,
   },
   {
     /*tag*/                             eHTMLTag_select,
     /*requiredAncestor*/                eHTMLTag_unknown, eHTMLTag_unknown,
     /*rootnodes,endrootnodes*/          &gInForm,&gInForm,
     /*autoclose starttags and endtags*/ &gInputAutoClose,0,0,0,
diff --git a/parser/htmlparser/tests/mochitest/test_bug418464.html b/parser/htmlparser/tests/mochitest/test_bug418464.html
--- a/parser/htmlparser/tests/mochitest/test_bug418464.html
+++ b/parser/htmlparser/tests/mochitest/test_bug418464.html
@@ -27,17 +27,18 @@ https://bugzilla.mozilla.org/show_bug.cg
 <p id="display"></p>
 <div id="content" style="display: none">
   
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 /** Test for Bug 418464 **/
-  is(form1, undefined, "Should not have a form here");
+  is(form1 instanceof HTMLFormElement, true,
+     "Should have a form here");
   is(form2 instanceof HTMLFormElement, true,
      "Should have a form here");
 
 </script>
 </pre>
 </body>
 </html>
 

From: L. David Baron <dbaron@dbaron.org>

Add index and count data for the properties that need to be computed for each style struct.  (Bug 636039)

This adds a second occurrence of the ugliest pattern of nsCSSPropList.h
inclusion.

diff --git a/layout/style/nsCSSProperty.h b/layout/style/nsCSSProperty.h
--- a/layout/style/nsCSSProperty.h
+++ b/layout/style/nsCSSProperty.h
@@ -64,16 +64,17 @@ enum nsCSSProperty {
 
   #define CSS_PROP_SHORTHAND(name_, id_, method_, flags_) eCSSProperty_##id_,
   #include "nsCSSPropList.h"
   #undef CSS_PROP_SHORTHAND
 
   eCSSProperty_COUNT,
 
   // The CSS_PROP_INCLUDE_NOT_CSS properties.
+  // These must appear in the same order in nsCSSProps::gIndexInSID.
   eCSSProperty_NOTCSS_lang = eCSSProperty_COUNT,
   eCSSProperty_NOTCSS_cols,
   eCSSProperty_NOTCSS_span,
 
   eCSSProperty_COUNT_WITH_NONCSS,
 
   // Some of the values below could probably overlap with each other and
   // with eCSSProperty_COUNT if we had a need for them to do so.
diff --git a/layout/style/nsCSSProps.cpp b/layout/style/nsCSSProps.cpp
--- a/layout/style/nsCSSProps.cpp
+++ b/layout/style/nsCSSProps.cpp
@@ -2067,8 +2067,218 @@ static const nsCSSProperty gMarkerSubpro
 };
 
 const nsCSSProperty *const
 nsCSSProps::kSubpropertyTable[eCSSProperty_COUNT - eCSSProperty_COUNT_no_shorthands] = {
 #define CSS_PROP_SHORTHAND(name_, id_, method_, flags_) g##method_##SubpropTable,
 #include "nsCSSPropList.h"
 #undef CSS_PROP_SHORTHAND
 };
+
+
+// for nsCSSPropList.h, so we get information on things in the style
+// structs but not nsCSS*
+#define CSS_PROP_INCLUDE_NOT_CSS
+
+#define ENUM_DATA_FOR_PROPERTY(name_, id_, method_, flags_, datastruct_,     \
+                                member_, parsevariant_, kwtable_,             \
+                                stylestructoffset_, animtype_)                \
+  eSIDIndex_for_##id
+
+enum FontCheckCounter {
+  #define CSS_PROP_FONT ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_FONT
+  eSIDCount_for_Font
+};
+
+enum DisplayCheckCounter {
+  #define CSS_PROP_DISPLAY ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_DISPLAY
+  eSIDCount_for_Display
+};
+
+enum VisibilityCheckCounter {
+  #define CSS_PROP_VISIBILITY ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_VISIBILITY
+  eSIDCount_for_Visibility
+};
+
+enum MarginCheckCounter {
+  #define CSS_PROP_MARGIN ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_MARGIN
+  eSIDCount_for_Margin
+};
+
+enum BorderCheckCounter {
+  #define CSS_PROP_BORDER ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_BORDER
+  eSIDCount_for_Border
+};
+
+enum PaddingCheckCounter {
+  #define CSS_PROP_PADDING ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_PADDING
+  eSIDCount_for_Padding
+};
+
+enum OutlineCheckCounter {
+  #define CSS_PROP_OUTLINE ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_OUTLINE
+  eSIDCount_for_Outline
+};
+
+enum ListCheckCounter {
+  #define CSS_PROP_LIST ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_LIST
+  eSIDCount_for_List
+};
+
+enum ColorCheckCounter {
+  #define CSS_PROP_COLOR ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_COLOR
+  eSIDCount_for_Color
+};
+
+enum BackgroundCheckCounter {
+  #define CSS_PROP_BACKGROUND ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_BACKGROUND
+  eSIDCount_for_Background
+};
+
+enum PositionCheckCounter {
+  #define CSS_PROP_POSITION ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_POSITION
+  eSIDCount_for_Position
+};
+
+enum TableCheckCounter {
+  #define CSS_PROP_TABLE ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_TABLE
+  eSIDCount_for_Table
+};
+
+enum TableBorderCheckCounter {
+  #define CSS_PROP_TABLEBORDER ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_TABLEBORDER
+  eSIDCount_for_TableBorder
+};
+
+enum ContentCheckCounter {
+  #define CSS_PROP_CONTENT ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_CONTENT
+  eSIDCount_for_Content
+};
+
+enum QuotesCheckCounter {
+  #define CSS_PROP_QUOTES ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_QUOTES
+  eSIDCount_for_Quotes
+};
+
+enum TextCheckCounter {
+  #define CSS_PROP_TEXT ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_TEXT
+  eSIDCount_for_Text
+};
+
+enum TextResetCheckCounter {
+  #define CSS_PROP_TEXTRESET ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_TEXTRESET
+  eSIDCount_for_TextReset
+};
+
+enum UserInterfaceCheckCounter {
+  #define CSS_PROP_USERINTERFACE ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_USERINTERFACE
+  eSIDCount_for_UserInterface
+};
+
+enum UIResetCheckCounter {
+  #define CSS_PROP_UIRESET ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_UIRESET
+  eSIDCount_for_UIReset
+};
+
+enum XULCheckCounter {
+  #define CSS_PROP_XUL ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_XUL
+  eSIDCount_for_XUL
+};
+
+enum SVGCheckCounter {
+  #define CSS_PROP_SVG ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_SVG
+  eSIDCount_for_SVG
+};
+
+enum SVGResetCheckCounter {
+  #define CSS_PROP_SVGRESET ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_SVGRESET
+  eSIDCount_for_SVGReset
+};
+
+enum ColumnCheckCounter {
+  #define CSS_PROP_COLUMN ENUM_DATA_FOR_PROPERTY
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_COLUMN
+  eSIDCount_for_Column
+};
+
+#undef CSS_PROP_INCLUDE_NOT_CSS
+#undef ENUM_DATA_FOR_PROPERTY
+
+/* static */ const size_t
+nsCSSProps::gPropertiesInSID[nsStyleStructID_Length] = {
+  #define STYLE_STRUCT(name, checkdata_cb, ctor_args) \
+    eSIDCount_for_##name,
+  #include "nsStyleStructList.h"
+  #undef STYLE_STRUCT
+};
+
+/* static */ const size_t
+nsCSSProps::gIndexInSID[eCSSProperty_COUNT_WITH_NONCSS] = {
+
+  #define CSS_PROP(name_, id_, method_, flags_, datastruct_, member_,         \
+                   parsevariant_, kwtable_, stylestruct_,                     \
+                   stylestructoffset_, animtype_)                             \
+    eSIDIndex_for_##id_,
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP
+
+  // FIXME, perhaps: This has a bunch of unneeded holes in it.  It might
+  // make more sense to rearrange the property IDs so the non-CSS
+  // properties live below the shorthands to avoid this.  But that would
+  // lead to some (smaller) holes elsewhere, and there aren't *that*
+  // many shorthands, and it would require a lot of rearranging of the
+  // eCSSProperty_COUNT* boundary checks.
+  #define CSS_PROP_SHORTHAND(name_, id_, method_, flags_)                     \
+    0,
+  #include "nsCSSPropList.h"
+  #undef CSS_PROP_SHORTHAND
+
+  // These must appear in the same order as in nsCSSProperty.h.
+  eSIDIndex_for_NOTCSS_lang,
+  eSIDIndex_for_NOTCSS_cols,
+  eSIDIndex_for_NOTCSS_span,
+
+};
diff --git a/layout/style/nsCSSProps.h b/layout/style/nsCSSProps.h
--- a/layout/style/nsCSSProps.h
+++ b/layout/style/nsCSSProps.h
@@ -291,16 +291,43 @@ private:
   // ShorthandsContaining (arrays of nsCSSProperty terminated by
   // eCSSProperty_UNKNOWN) pointing into memory in
   // gShorthandsContainingPool (which contains all of those arrays in a
   // single allocation, and is the one pointer that should be |free|d).
   static nsCSSProperty *gShorthandsContainingTable[eCSSProperty_COUNT_no_shorthands];
   static nsCSSProperty* gShorthandsContainingPool;
   static PRBool BuildShorthandsContainingTable();
 
+private:
+  static const size_t gPropertiesInSID[nsStyleStructID_Length];
+  static const size_t gIndexInSID[eCSSProperty_COUNT_WITH_NONCSS];
+public:
+  /**
+   * Return the number of properties, including the
+   * CSS_PROP_INCLUDE_NOT_CSS properties, that must be cascaded when
+   * nsRuleNode builds the nsStyle* for aSID.
+   */
+  static size_t PropertiesInSID(nsStyleStructID aSID) {
+    NS_ABORT_IF_FALSE(0 <= aSID && aSID < nsStyleStructID_Length,
+                      "out of range");
+    return gPropertiesInSID[aSID];
+  }
+  /**
+   * Return an index for aProperty that is unique within its SID and in
+   * the range 0 <= index < PropertiesInSID(aSID).
+   */
+  static size_t IndexInSID(nsCSSProperty aProperty) {
+    NS_ABORT_IF_FALSE((0 <= aProperty &&
+                         aProperty < eCSSProperty_COUNT_no_shorthands) ||
+                      (eCSSProperty_COUNT <= aProperty &&
+                         aProperty < eCSSProperty_COUNT_WITH_NONCSS),
+                      "out of range");
+    return gIndexInSID[aSID];
+  }
+
 public:
 
 #define CSSPROPS_FOR_SHORTHAND_SUBPROPERTIES(iter_, prop_)                    \
   for (const nsCSSProperty* iter_ = nsCSSProps::SubpropertyEntryFor(prop_);   \
        *iter_ != eCSSProperty_UNKNOWN; ++iter_)
 
   // Keyword/Enum value tables
   static const PRInt32 kAppearanceKTable[];

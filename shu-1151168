# HG changeset patch
# User Shu-yu Guo <shu@rfrn.org>

Bug 1151168 - Don't flush profiled threads that are pending deletion on JS shutdown.

diff --git a/tools/profiler/TableTicker.cpp b/tools/profiler/TableTicker.cpp
index 9432600..77f71fc 100644
--- a/tools/profiler/TableTicker.cpp
+++ b/tools/profiler/TableTicker.cpp
@@ -373,17 +373,18 @@ void TableTicker::FlushOnJSShutdown(JSRuntime* aRuntime)
 {
   SetPaused(true);
 
   {
     mozilla::MutexAutoLock lock(*sRegisteredThreadsMutex);
 
     for (size_t i = 0; i < sRegisteredThreads->size(); i++) {
       // Thread not being profiled, skip it.
-      if (!sRegisteredThreads->at(i)->Profile()) {
+      if (!sRegisteredThreads->at(i)->Profile() ||
+          sRegisteredThreads->at(i)->IsPendingDelete()) {
         continue;
       }
 
       // Thread not profiling the runtime that's going away, skip it.
       if (sRegisteredThreads->at(i)->Profile()->GetPseudoStack()->mRuntime != aRuntime) {
         continue;
       }

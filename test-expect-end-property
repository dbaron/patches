Add test for ExpectEndProperty calls in CSS parser.  b=390260

diff --git a/layout/style/test/Makefile.in b/layout/style/test/Makefile.in
--- a/layout/style/test/Makefile.in
+++ b/layout/style/test/Makefile.in
@@ -87,6 +87,7 @@ _TEST_FILES =	test_bug74880.html \
 		test_bug405818.html \
 		test_compute_data_with_start_struct.html \
 		test_dont_use_document_colors.html \
+		test_for_expect_end_property.html \
 		test_inherit_storage.html \
 		test_inherit_computation.html \
 		test_initial_storage.html \
diff --git a/layout/style/test/test_for_expect_end_property.html b/layout/style/test/test_for_expect_end_property.html
new file mode 100644
--- /dev/null
+++ b/layout/style/test/test_for_expect_end_property.html
@@ -0,0 +1,117 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+-->
+<head>
+  <title>Test for correct ExpectEndProperty calls in CSS parser</title>
+  <script type="text/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="text/javascript" src="property_database.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
+</head>
+<body>
+<p id="display"></p>
+<div id="content" style="display: none">
+
+<div id="testnode"></div>
+  
+</div>
+<pre id="test">
+<script class="testbody" type="text/javascript">
+
+/** Test for correct ExpectEndProperty calls in CSS parser **/
+
+/*
+ * Inspired by review comments on bug 378217.
+ *
+ * This tests that ExpectEndProperty calls are made in the correct
+ * places in the CSS parser so that we don't accept garbage at the end
+ * of property values.
+ */
+
+var gElement = document.getElementById("testnode");
+var gDeclaration = gElement.style;
+
+/*
+ * This lists properties where garbage identifiers are allowed at the
+ * end, with values in property_database.js that are exceptions that
+ * should be tested anyway.  "inherit" and "-moz-initial" are always
+ * tested
+ */
+var gAllowsExtra = {
+  "counter-increment": { "none": true },
+  "counter-reset": { "none": true },
+  "font-family": {},
+  "font": { "caption": true, "icon": true, "menu": true, "message-box": true,
+            "small-caption": true, "status-bar": true },
+  "voice-family": {},
+};
+
+function test_property(property)
+{
+  var info = gCSSProperties[property];
+
+  function test_value(value) {
+    if (property in gAllowsExtra &&
+        value != "inherit" && value != "-moz-initial" &&
+        !(value in gAllowsExtra[property])) {
+      return;
+    }
+
+    gElement.setAttribute("style", property + ": " + value + " blah");
+    if ("subproperties" in info) {
+      for (idx in info.subproperties) {
+        var subprop = info.subproperties[idx];
+        is(gDeclaration.getPropertyValue(subprop), "",
+           ["expected garbage ignored after '", property, ": ", value,
+            "' when looking at subproperty '", subprop, "'"].join(""));
+      }
+    } else {
+      is(gDeclaration.getPropertyValue(property), "",
+         ["expected garbage ignored after '", property, ": ", value,
+          "'"].join(""));
+    }
+  }
+
+  var idx;
+  test_value("inherit");
+  test_value("-moz-initial");
+  for (idx in info.initial_values)
+    test_value(info.initial_values[idx]);
+  for (idx in info.other_values)
+    test_value(info.other_values[idx]);
+}
+
+// To avoid triggering the slow script dialog, we have to test one
+// property at a time.
+SimpleTest.waitForExplicitFinish();
+var props = [];
+for (var prop in gCSSProperties)
+  props.push(prop);
+props = props.reverse();
+function do_one(l) {
+  if (l.length == 0) {
+    // SimpleTest.finish() is really slow, so we have to disable the
+    // slow script dialog for this part
+    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
+    var prefService = Components.classes["@mozilla.org/preferences-service;1"].
+                        getService(Components.interfaces.nsIPrefService);
+    var domBranch = prefService.getBranch("dom.");
+    var oldVal = domBranch.getIntPref("max_script_run_time");
+    domBranch.setIntPref("max_script_run_time", 0);
+
+    SimpleTest.finish();
+
+    domBranch.setIntPref("max_script_run_time", oldVal);
+
+    return;
+  }
+  test_property(l.pop());
+  setTimeout(do_one, 0, l);
+}
+setTimeout(do_one, 0, props);
+
+</script>
+</pre>
+</body>
+</html>

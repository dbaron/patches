From: L. David Baron <dbaron@dbaron.org>

Make author !important rules override CSS animations.  Per CSS WG resolution 2012-08-15.

diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -441,19 +441,17 @@ EnumRulesMatching(nsIStyleRuleProcessor*
   return true;
 }
 
 static inline bool
 IsMoreSpecificThanAnimation(nsRuleNode *aRuleNode)
 {
   return !aRuleNode->IsRoot() &&
          (aRuleNode->GetLevel() == nsStyleSet::eTransitionSheet ||
-          (aRuleNode->IsImportantRule() &&
-           (aRuleNode->GetLevel() == nsStyleSet::eAgentSheet ||
-            aRuleNode->GetLevel() == nsStyleSet::eUserSheet)));
+          aRuleNode->IsImportantRule());
 }
 
 static nsIStyleRule*
 GetAnimationRule(nsRuleNode *aRuleNode)
 {
   nsRuleNode *n = aRuleNode;
   while (IsMoreSpecificThanAnimation(n)) {
     n = n->GetParent();
@@ -713,27 +711,27 @@ nsStyleSet::AssertNoCSSRules(nsRuleNode*
 // Enumerate the rules in a way that cares about the order of the rules.
 void
 nsStyleSet::FileRules(nsIStyleRuleProcessor::EnumFunc aCollectorFunc, 
                       void* aData, nsIContent* aContent,
                       nsRuleWalker* aRuleWalker)
 {
   // Cascading order:
   // [least important]
-  //  1. UA normal rules                    = Agent        normal
-  //  2. User normal rules                  = User         normal
-  //  3. Presentation hints                 = PresHint     normal
-  //  4. Author normal rules                = Document     normal
-  //  5. Override normal rules              = Override     normal
-  //  6. Author !important rules            = Document     !important
-  //  7. Override !important rules          = Override     !important
-  //  -. animation rules                    = Animation    normal
-  //  8. User !important rules              = User         !important
-  //  9. UA !important rules                = Agent        !important
-  //  -. transition rules                   = Transition   normal
+  //  - UA normal rules                    = Agent        normal
+  //  - User normal rules                  = User         normal
+  //  - Presentation hints                 = PresHint     normal
+  //  - Author normal rules                = Document     normal
+  //  - Override normal rules              = Override     normal
+  //  - animation rules                    = Animation    normal
+  //  - Author !important rules            = Document     !important
+  //  - Override !important rules          = Override     !important
+  //  - User !important rules              = User         !important
+  //  - UA !important rules                = Agent        !important
+  //  - transition rules                   = Transition   normal
   // [most important]
 
   // Save off the last rule before we start walking our agent sheets;
   // this will be either the root or one of the restriction rules.
   nsRuleNode* lastRestrictionRN = aRuleWalker->CurrentNode();
 
   aRuleWalker->SetLevel(eAgentSheet, false, true);
   if (mRuleProcessors[eAgentSheet])
@@ -773,16 +771,20 @@ nsStyleSet::FileRules(nsIStyleRuleProces
   bool haveImportantDocRules = !aRuleWalker->GetCheckForImportantRules();
 
   aRuleWalker->SetLevel(eOverrideSheet, false, true);
   if (mRuleProcessors[eOverrideSheet])
     (*aCollectorFunc)(mRuleProcessors[eOverrideSheet], aData);
   nsRuleNode* lastOvrRN = aRuleWalker->CurrentNode();
   bool haveImportantOverrideRules = !aRuleWalker->GetCheckForImportantRules();
 
+  // This needs to match IsMoreSpecificThanAnimation() above.
+  aRuleWalker->SetLevel(eAnimationSheet, false, false);
+  (*aCollectorFunc)(mRuleProcessors[eAnimationSheet], aData);
+
   if (haveImportantDocRules) {
     aRuleWalker->SetLevel(eDocSheet, true, false);
     AddImportantRules(lastDocRN, lastPresHintRN, aRuleWalker);  // doc
   }
 #ifdef DEBUG
   else {
     AssertNoImportantRules(lastDocRN, lastPresHintRN);
   }
@@ -793,20 +795,16 @@ nsStyleSet::FileRules(nsIStyleRuleProces
     AddImportantRules(lastOvrRN, lastDocRN, aRuleWalker);  // override
   }
 #ifdef DEBUG
   else {
     AssertNoImportantRules(lastOvrRN, lastDocRN);
   }
 #endif
 
-  // This needs to match IsMoreSpecificThanAnimation() above.
-  aRuleWalker->SetLevel(eAnimationSheet, false, false);
-  (*aCollectorFunc)(mRuleProcessors[eAnimationSheet], aData);
-
 #ifdef DEBUG
   AssertNoCSSRules(lastPresHintRN, lastUserRN);
 #endif
 
   if (haveImportantUserRules) {
     aRuleWalker->SetLevel(eUserSheet, true, false);
     AddImportantRules(lastUserRN, lastAgentRN, aRuleWalker); //user
   }

From: L. David Baron <dbaron@dbaron.org>

Track which frame we're doing shrink-wrap on.  (FIXME:  We should instead use this approach to track the current container and container width -- since otherwise this is insufficient since we won't be able to get the container width when we decide we want to use inflation during shrink-wrapping.)  (TODO: set to null on containers)

TODO: audit all callers of nsIFrame::GetMinWidth and nsIFrame::GetPrefWidth.

diff --git a/layout/base/nsPresContext.h b/layout/base/nsPresContext.h
--- a/layout/base/nsPresContext.h
+++ b/layout/base/nsPresContext.h
@@ -1064,16 +1064,32 @@ protected:
 
   // Formerly mLangGroup; moving from charset-oriented langGroup to
   // maintaining actual language settings everywhere (see bug 524107).
   // This may in fact hold a langGroup such as x-western rather than
   // a specific language, however (e.g, if it is inferred from the
   // charset rather than explicitly specified as a lang attribute).
   nsIAtom*              mLanguage;      // [STRONG]
 
+public:
+  // The following are public member variables so that we can use them
+  // with mozilla::AutoToggle or mozilla::AutoRestore.
+
+  // The frame that is the container for font size inflation for the
+  // reflow or intrinsic width computation currently happening.  If this
+  // frame is null, then font inflation should not be performed.
+  nsIFrame*             mCurrentInflationContainer; // [WEAK]
+
+  // The content-rect width of mCurrentInflationContainer.  If
+  // mCurrentInflationContainer is currently in reflow, this is its new
+  // width, which is not yet set on its rect.
+  nscoord               mCurrentInflationContainerWidth;
+
+protected:
+
   nsRefPtrHashtable<nsVoidPtrHashKey, nsImageLoader>
                         mImageLoaders[IMAGE_LOAD_TYPE_COUNT];
 
   nsWeakPtr             mContainer;
 
   PRCList               mDOMMediaQueryLists;
 
   PRInt32               mMinFontSize;   // Min font size, defaults to 0

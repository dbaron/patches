From: L. David Baron <dbaron@dbaron.org>

Introduce nsStyleCoord::HasPercent to check for either a percent value or a calc() value containing a percent.  (Bug 585715)

diff --git a/layout/base/nsLayoutUtils.cpp b/layout/base/nsLayoutUtils.cpp
--- a/layout/base/nsLayoutUtils.cpp
+++ b/layout/base/nsLayoutUtils.cpp
@@ -2224,18 +2224,17 @@ nsLayoutUtils::ComputeHeightDependentVal
   // XXXldb Some callers explicitly check aContainingBlockHeight
   // against NS_AUTOHEIGHT *and* unit against eStyleUnit_Percent or
   // calc()s containing percents before calling this function.
   // However, it would be much more likely to catch problems without
   // the unit conditions.
   // XXXldb Many callers pass a non-'auto' containing block height when
   // according to CSS2.1 they should be passing 'auto'.
   NS_PRECONDITION(NS_AUTOHEIGHT != aContainingBlockHeight ||
-                  (aCoord.GetUnit() != eStyleUnit_Percent &&
-                   !(aCoord.IsCalcUnit() && aCoord.CalcHasPercent())),
+                  !aCoord.HasPercent(),
                   "unexpected containing block height");
 
   if (aCoord.IsCoordPercentCalcUnit()) {
     return nsRuleNode::ComputeCoordPercentCalc(aCoord, aContainingBlockHeight);
   }
 
   NS_ASSERTION(aCoord.GetUnit() == eStyleUnit_None ||
                aCoord.GetUnit() == eStyleUnit_Auto,
diff --git a/layout/generic/nsImageFrame.cpp b/layout/generic/nsImageFrame.cpp
--- a/layout/generic/nsImageFrame.cpp
+++ b/layout/generic/nsImageFrame.cpp
@@ -138,21 +138,19 @@ inline PRBool HaveFixedSize(const nsHTML
   // or ComputedWidth() of reflow state is  NS_UNCONSTRAINEDSIZE  
   // it needs to return PR_FALSE to cause an incremental reflow later
   // if an image is inside table like bug 156731 simple testcase III, 
   // during pass 1 reflow, ComputedWidth() is NS_UNCONSTRAINEDSIZE
   // in pass 2 reflow, ComputedWidth() is 0, it also needs to return PR_FALSE
   // see bug 156731
   const nsStyleCoord &height = aReflowState.mStylePosition->mHeight;
   const nsStyleCoord &width = aReflowState.mStylePosition->mWidth;
-  return (((eStyleUnit_Percent == height.GetUnit() ||
-            (height.IsCalcUnit() && height.CalcHasPercent())) &&
+  return ((height.HasPercent() &&
            NS_UNCONSTRAINEDSIZE == aReflowState.ComputedHeight()) ||
-          ((eStyleUnit_Percent == width.GetUnit() ||
-            (width.IsCalcUnit() && width.CalcHasPercent())) &&
+          (width.HasPercent() &&
            (NS_UNCONSTRAINEDSIZE == aReflowState.ComputedWidth() ||
             0 == aReflowState.ComputedWidth())))
           ? PR_FALSE
           : HaveFixedSize(aReflowState.mStylePosition); 
 }
 
 nsIFrame*
 NS_NewImageFrame(nsIPresShell* aPresShell, nsStyleContext* aContext)
diff --git a/layout/style/nsStyleCoord.h b/layout/style/nsStyleCoord.h
--- a/layout/style/nsStyleCoord.h
+++ b/layout/style/nsStyleCoord.h
@@ -133,16 +133,21 @@ public:
   // Does this calc() expression have any percentages inside it?  Can be
   // called only when IsCalcUnit() is true.
   PRBool CalcHasPercent() const;
 
   PRBool IsArrayValue() const {
     return IsCalcUnit();
   }
 
+  PRBool HasPercent() const {
+    return mUnit == eStyleUnit_Percent ||
+           (IsCalcUnit() && CalcHasPercent());
+  }
+
   nscoord     GetCoordValue() const;
   PRInt32     GetIntValue() const;
   float       GetPercentValue() const;
   float       GetFactorValue() const;
   float       GetAngleValue() const;
   double      GetAngleValueInRadians() const;
   Array*      GetArrayValue() const;
   void        GetUnionValue(nsStyleUnion& aValue) const;
diff --git a/layout/style/nsStyleStruct.cpp b/layout/style/nsStyleStruct.cpp
--- a/layout/style/nsStyleStruct.cpp
+++ b/layout/style/nsStyleStruct.cpp
@@ -1145,18 +1145,17 @@ nsChangeHint nsStylePosition::MaxDiffere
   return NS_STYLE_HINT_REFLOW;
 }
 #endif
 
 /* static */ PRBool
 nsStylePosition::WidthCoordDependsOnContainer(const nsStyleCoord &aCoord)
 {
   return aCoord.GetUnit() == eStyleUnit_Auto ||
-         aCoord.GetUnit() == eStyleUnit_Percent ||
-         (aCoord.IsCalcUnit() && aCoord.CalcHasPercent()) ||
+         aCoord.HasPercent() ||
          (aCoord.GetUnit() == eStyleUnit_Enumerated &&
           (aCoord.GetIntValue() == NS_STYLE_WIDTH_FIT_CONTENT ||
            aCoord.GetIntValue() == NS_STYLE_WIDTH_AVAILABLE));
 }
 
 // --------------------
 // nsStyleTable
 //

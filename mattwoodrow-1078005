# HG changeset patch
# User Matt Woodrow <mwoodrow@mozilla.com>
# Date 1412730532 -46800
#      Wed Oct 08 14:08:52 2014 +1300
# Node ID 9e2ebd742c3bd94212bb40ff0ffa3deb2e44a17e
# Parent  0ed32d9a42d67a72a18bfa13a95dd2123490c8bf
try: -b do -p all -u all -t none

diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -2517,16 +2517,21 @@ nsPresContext::NotifyDidPaintForSubtree(
 {
   if (IsRoot()) {
     static_cast<nsRootPresContext*>(this)->CancelDidPaintTimer();
 
     if (!mFireAfterPaintEvents) {
       return;
     }
   }
+
+  if (!PresShell()->IsVisible() && !mFireAfterPaintEvents) {
+    return;
+  }
+
   // Non-root prescontexts fire MozAfterPaint to all their descendants
   // unconditionally, even if no invalidations have been collected. This is
   // because we don't want to eat the cost of collecting invalidations for
   // every subdocument (which would require putting every subdocument in its
   // own layer).
 
   if (aFlags & nsIPresShell::PAINT_LAYERS) {
     mUndeliveredInvalidateRequestsBeforeLastPaint.TakeFrom(

From: L. David Baron <dbaron@dbaron.org>

Remove the easy-to-remove uses of enablePrivilege in layout/base/tests/.  (Bug 788603)  r=roc

diff --git a/layout/base/tests/bidi_numeral_test.js b/layout/base/tests/bidi_numeral_test.js
--- a/layout/base/tests/bidi_numeral_test.js
+++ b/layout/base/tests/bidi_numeral_test.js
@@ -22,29 +22,25 @@ RemoteCanvas.prototype.load = function(c
   iframe.addEventListener("load", function() {
       me.remotePageLoaded(callback);
     }, false);
   window.document.body.appendChild(iframe);
 };
 
 RemoteCanvas.prototype.remotePageLoaded = function(callback) {
   var ldrFrame = document.getElementById(this.id + "-iframe");
-  this.snapshot = snapshotWindow(ldrFrame.contentWindow);
+  this.snapshot = snapshotWindow(ldrFrame.contentWindow);
   callback(this);
 };
 
 function bidiNumeral(val) {
-  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-  var prefs = Components.classes["@mozilla.org/preferences-service;1"]
-                        .getService(Components.interfaces.nsIPrefBranch);
-
   if (typeof val == "undefined")
-    return prefs.getIntPref("bidi.numeral");
+    return SpecialPowers.getIntPref("bidi.numeral");
   else
-    prefs.setIntPref("bidi.numeral", val);
+    SpecialPowers.setIntPref("bidi.numeral", val);
 }
 
 var bidiNumeralDefault = bidiNumeral();
 
 var currentPass = 0;
 
 function run()
 {
diff --git a/layout/base/tests/bug613807-1.html b/layout/base/tests/bug613807-1.html
--- a/layout/base/tests/bug613807-1.html
+++ b/layout/base/tests/bug613807-1.html
@@ -39,51 +39,50 @@
       regfunc.callStack.push(func);
     };
   }
 
   addLoadEvent(function() {
     var area = document.getElementById('t');
     area.focus();
 
-    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-    const nsIDOMWindowUtils = Components.interfaces.nsIDOMWindowUtils;
+    var domWindowUtils = SpecialPowers.getDOMWindowUtils(window);
 
     // start composition
     synthesizeComposition({ type: "compositionstart" });
 
     // input raw characters
     synthesizeComposition({ type: "compositionupdate", data: "\u306D" });
     synthesizeText(
       { composition:
         { string: "\u306D",
           clauses: [
-            { length: 1, attr: nsIDOMWindowUtils.COMPOSITION_ATTR_RAWINPUT }
+            { length: 1, attr: domWindowUtils.COMPOSITION_ATTR_RAWINPUT }
           ]
         },
         caret: { start: 1, length: 0 }
       });
     synthesizeComposition({ type: "compositionupdate", data: "\u306D\u3053" });
     synthesizeText(
       { composition:
         { string: "\u306D\u3053",
           clauses: [
-            { length: 2, attr: nsIDOMWindowUtils.COMPOSITION_ATTR_RAWINPUT }
+            { length: 2, attr: domWindowUtils.COMPOSITION_ATTR_RAWINPUT }
           ]
         },
         caret: { start: 2, length: 0 }
       });
 
     // convert
     synthesizeComposition({ type: "compositionupdate", data: "\u732B" });
     synthesizeText(
       { composition:
         { string: "\u732B",
           clauses: [
-            { length: 1, attr: nsIDOMWindowUtils.COMPOSITION_ATTR_SELECTEDCONVERTEDTEXT }
+            { length: 1, attr: domWindowUtils.COMPOSITION_ATTR_SELECTEDCONVERTEDTEXT }
           ]
         },
         caret: { start: 1, length: 0 }
       });
 
     // commit
     synthesizeText(
       { composition:
diff --git a/layout/base/tests/test_bug423523.html b/layout/base/tests/test_bug423523.html
--- a/layout/base/tests/test_bug423523.html
+++ b/layout/base/tests/test_bug423523.html
@@ -51,26 +51,23 @@ https://bugzilla.mozilla.org/show_bug.cg
     return false;
   }
   
   function selectionOffsetIs(expectedOffset) {
     return window.getSelection().focusOffset == expectedOffset;
   }
   
   function sendMouseClick() {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
     var rect=document.getElementById('div1').getBoundingClientRect();
-    var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
-                   getInterface(Components.interfaces.nsIDOMWindowUtils);
+    var utils = SpecialPowers.getDOMWindowUtils(window);
     utils.sendMouseEvent('mousedown', rect.left+1, rect.top+1, 0, 1, 0);
     utils.sendMouseEvent('mouseup', rect.left+1, rect.top+1, 0, 1, 0);
   }
  
   function runtests() {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
     sendMouseClick();
     window.getSelection().collapse(document.getElementById("div1").firstChild, 0);
     ok(divIsFocused(), "Div should be focused [0].");
 
     ok(divIsFocused(), "Div should be focused [1].");
     ok(selectionOffsetIs(0), "Caret should be at offset 0");
     
     synthesizeKey("VK_LEFT", { });
diff --git a/layout/base/tests/test_bug558663.html b/layout/base/tests/test_bug558663.html
--- a/layout/base/tests/test_bug558663.html
+++ b/layout/base/tests/test_bug558663.html
@@ -17,17 +17,16 @@ https://bugzilla.mozilla.org/show_bug.cg
 <iframe id="iframe" src="data:text/html,<img id='image' border='0' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAAG0lEQVR42mP8z0A%2BYKJA76jmUc2jmkc1U0EzACKcASfOgGoMAAAAAElFTkSuQmCC'>"></iframe>
 
 <pre id="test">
 <script type="application/javascript">
 
 /** Test for Bug 558663 **/
 
 SimpleTest.waitForExplicitFinish();
-netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
 window.addEventListener("load", runTest, false);
 
 function checkSnapshots(s1, s2, shouldBeEqual, testName) {
   var res = compareSnapshots(s1, s2, shouldBeEqual);
   if (res[0]) {
     ok(true, testName + " snapshots compare correctly");
   } else {
     ok(false, testName + " snapshots compare incorrectly. snapshot 1: " +
diff --git a/layout/base/tests/test_bug582771.html b/layout/base/tests/test_bug582771.html
--- a/layout/base/tests/test_bug582771.html
+++ b/layout/base/tests/test_bug582771.html
@@ -29,36 +29,30 @@ https://bugzilla.mozilla.org/show_bug.cg
 
 SimpleTest.waitForExplicitFinish();
 var d1;
 var d2;
 var d1mousemovecount = 0;
 var d2mousemovecount = 0;
 
 function sendMouseMove(el) {
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
   var rect = el.getBoundingClientRect();
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
-                    .getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.sendMouseEvent('mousemove', rect.left + 5, rect.top + 5, 0, 0, 0);
 }
 
 function sendMouseDown(el) {
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
   var rect = el.getBoundingClientRect();
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
-                    .getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.sendMouseEvent('mousedown', rect.left + 5, rect.top + 5, 0, 1, 0);
 }
 
 function sendMouseUp(el) {
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
   var rect = el.getBoundingClientRect();
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
-                    .getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.sendMouseEvent('mouseup', rect.left + 5, rect.top + 5, 0, 1, 0);
 }
 
 function log(s) {
   document.getElementById("l").textContent += s + "\n";
 }
 
 function d2Listener(e) {
diff --git a/layout/base/tests/test_bug603550.html b/layout/base/tests/test_bug603550.html
--- a/layout/base/tests/test_bug603550.html
+++ b/layout/base/tests/test_bug603550.html
@@ -25,44 +25,35 @@ https://bugzilla.mozilla.org/show_bug.cg
 <pre id="test">
 <script type="application/javascript">
 
 /** Test for Bug 603550 **/
 
 SimpleTest.waitForExplicitFinish();
 
 function sendMouseMoveFaraway(el) {
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
   var rect = el.getBoundingClientRect();
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
-                    .getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.sendMouseEvent('mousemove', rect.left + 5000, rect.top + 5000, 0, 0, 0);
 }
 
 function sendMouseDown(el) {
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
   var rect = el.getBoundingClientRect();
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
-                    .getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.sendMouseEvent('mousedown', rect.left + 5, rect.top + 5, 0, 1, 0);
 }
 
 function sendMouseUp(el) {
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
   var rect = el.getBoundingClientRect();
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor)
-                    .getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.sendMouseEvent('mouseup', rect.left + 5, rect.top + 5, 0, 1, 0);
 }
 
 function fireEvent(target, event) {
-  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-  var utils =
-    window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
-           getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.dispatchDOMEventViaPresShell(target, event, true);
 }
 
 function fireDrop(element) {
   netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
   var ds = Components.classes["@mozilla.org/widget/dragservice;1"].
     getService(Components.interfaces.nsIDragService);
 
diff --git a/layout/base/tests/test_flush_on_paint.html b/layout/base/tests/test_flush_on_paint.html
--- a/layout/base/tests/test_flush_on_paint.html
+++ b/layout/base/tests/test_flush_on_paint.html
@@ -39,19 +39,17 @@ function doIteration() {
 
 function checkDone() {
   ok(true, "Check to see if we're done: " + window.mozPaintCount);
   if (window.mozPaintCount == lastPaintCount) {
     setTimeout(checkDone, 30);
     return;
   }
 
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
-                 getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   is(plugin.getWidthAtLastPaint(), utils.screenPixelsPerCSSPixel*expectedWidth,
      "Check that we set width before painting");
 
   ++iterations;
   if (iterations < 100) {
     doIteration();
   } else {
     SimpleTest.finish();
diff --git a/layout/base/tests/test_image_layers.html b/layout/base/tests/test_image_layers.html
--- a/layout/base/tests/test_image_layers.html
+++ b/layout/base/tests/test_image_layers.html
@@ -14,33 +14,29 @@
 SimpleTest.waitForExplicitFinish();
 
 var image = document.getElementById("image");
 var lastPaintCount;
 
 function changeImage() {
   lastPaintCount = window.mozPaintCount;
   
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
-                 getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.checkAndClearPaintedState(image);
 
   image.src = "./image_rrgg-256x256.png";
   checkDone();
 }
 
 function checkDone() {
   if (window.mozPaintCount == lastPaintCount) {
     setTimeout(checkDone, 30);
     return;
   }
 
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-  var utils = window.QueryInterface(Components.interfaces.nsIInterfaceRequestor).
-                 getInterface(Components.interfaces.nsIDOMWindowUtils);
+  var utils = SpecialPowers.getDOMWindowUtils(window);
   ok(!utils.checkAndClearPaintedState(image), "Should not paint any thebes layers for our image!");
   SimpleTest.finish();
 }
 </script>
 </pre>
 </body>
 </html>
diff --git a/layout/base/tests/test_reftests_with_caret.html b/layout/base/tests/test_reftests_with_caret.html
--- a/layout/base/tests/test_reftests_with_caret.html
+++ b/layout/base/tests/test_reftests_with_caret.html
@@ -79,23 +79,20 @@ function createIframe(url,next) {
 };
 
 function refTest(test,ref) {
   createIframe(test,ref);
 };
 
 var caretBlinkTime = null;
 function endTest() {
-  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-  var prefs = Components.classes["@mozilla.org/preferences-service;1"]
-                        .getService(Components.interfaces.nsIPrefBranch);
   if (caretBlinkTime !== null) {
-    prefs.setIntPref("ui.caretBlinkTime", caretBlinkTime);
+    SpecialPowers.setIntPref("ui.caretBlinkTime", caretBlinkTime);
   } else {
-    prefs.clearUserPref("ui.caretBlinkTime");
+    SpecialPowers.clearUserPref("ui.caretBlinkTime");
   }
 
   // finish(), yet let the test actually end first, to be safe.
   SimpleTest.executeSoon(SimpleTest.finish);
 }
 
 var isWindows = /WINNT/.test(SpecialPowers.OS);
 
@@ -158,23 +155,20 @@ function nextTest() {
     }
     ++testIndex;
   } else {
     endTest();
   }
 }
 function runTests() {
   try {
-    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-    var prefs = Components.classes["@mozilla.org/preferences-service;1"]
-                          .getService(Components.interfaces.nsIPrefBranch);
     try {
-      caretBlinkTime = prefs.getIntPref("ui.caretBlinkTime");
+      caretBlinkTime = SpecialPowers.getIntPref("ui.caretBlinkTime");
     } catch (e) {}
-    prefs.setIntPref("ui.caretBlinkTime", -1);
+    SpecialPowers.setIntPref("ui.caretBlinkTime", -1);
 
     nextTest();
   } catch(e) {
     endTest();
   }
 }
 
 </script>

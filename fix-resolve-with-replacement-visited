From: L. David Baron <dbaron@dbaron.org>

Bug 960465 patch N - Fix the visited handling in ResolveStyleWithReplacement.

TODO: REVIEW THIS CAREFULLY

diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -1392,27 +1392,38 @@ nsStyleSet::ResolveStyleWithReplacement(
                                         nsStyleContext* aParentStyleContext,
                                         nsStyleContext* aOldStyleContext,
                                         nsRestyleHint aReplacements)
 {
   nsRuleNode* ruleNode =
     RuleNodeWithReplacement(aElement, aOldStyleContext->RuleNode(),
                             aOldStyleContext->GetPseudoType(), aReplacements);
 
-  // FIXME: Does this handle visited contexts correctly???
+  nsRuleNode* visitedRuleNode = nullptr;
+  nsStyleContext* oldStyleIfVisited = aOldStyleContext->GetStyleIfVisited();
+  if (oldStyleIfVisited) {
+    if (oldStyleIfVisited->RuleNode() == aOldStyleContext->RuleNode()) {
+      visitedRuleNode = ruleNode;
+    } else {
+      visitedRuleNode =
+        RuleNodeWithReplacement(aElement, oldStyleIfVisited->RuleNode(),
+                                oldStyleIfVisited->GetPseudoType(),
+                                aReplacements);
+    }
+  }
 
   uint32_t flags = eNoFlags;
   if (aOldStyleContext->IsLinkContext()) {
     flags |= eIsLink;
   }
   if (aOldStyleContext->RelevantLinkVisited()) {
     flags |= eIsVisitedLink;
   }
 
-  return GetContext(aParentStyleContext, ruleNode, nullptr,
+  return GetContext(aParentStyleContext, ruleNode, visitedRuleNode,
                     nullptr, nsCSSPseudoElements::ePseudo_NotPseudoElement,
                     nullptr, flags);
 }
 
 
 already_AddRefed<nsStyleContext>
 nsStyleSet::ResolveStyleForNonElement(nsStyleContext* aParentContext)
 {

From: L. David Baron <dbaron@dbaron.org>

Bug 1115812 patch 5 - Move the eRestyle_ChangeAnimationPhaseDescendants hint in DoRebuildAllStyleData so that the new rebuild-all codepaths will keep it.

diff --git a/layout/base/RestyleManager.cpp b/layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp
+++ b/layout/base/RestyleManager.cpp
@@ -1490,21 +1490,16 @@ RestyleManager::RebuildAllStyleData(nsCh
   nsCOMPtr<nsIPresShell> kungFuDeathGrip(presShell);
 
   // We may reconstruct frames below and hence process anything that is in the
   // tree. We don't want to get notified to process those items again after.
   presShell->GetDocument()->FlushPendingNotifications(Flush_ContentAndNotify);
 
   nsAutoScriptBlocker scriptBlocker;
 
-  // Until we get rid of these phases in bug 960465, we need to add
-  // eRestyle_ChangeAnimationPhaseDescendants so that we actually honor
-  // animation phase booleans in all cases.
-  aRestyleHint |= eRestyle_ChangeAnimationPhaseDescendants;
-
   mPendingRestyles.AddPendingRestyleToRoot(aRestyleHint, aExtraHint);
 
   MOZ_ASSERT(!mIsProcessingRestyles, "Nesting calls to processing restyles");
 #ifdef DEBUG
   mIsProcessingRestyles = true;
 #endif
 
   // Until we get rid of these phases in bug 960465, we need to skip
@@ -1534,16 +1529,22 @@ RestyleManager::DoRebuildAllStyleData(Re
 {
   // Tell the style set to get the old rule tree out of the way
   // so we can recalculate while maintaining rule tree immutability
   nsresult rv = mPresContext->StyleSet()->BeginReconstruct();
   if (NS_FAILED(rv)) {
     return;
   }
 
+  // Until we get rid of these phases in bug 960465, we need to add
+  // eRestyle_ChangeAnimationPhaseDescendants so that we actually honor
+  // animation phase booleans in all cases.
+  mPendingRestyles.AddPendingRestyleToRoot(
+    eRestyle_ChangeAnimationPhaseDescendants, nsChangeHint(0));
+
   // Recalculate all of the style contexts for the document
   // Note that we can ignore the return value of ComputeStyleChangeFor
   // because we never need to reframe the root frame
   // Note: The restyle tracker we pass in here doesn't matter.
   ComputeAndProcessStyleChange(mPresContext->PresShell()->GetRootFrame(),
                                nsChangeHint(0), aRestyleTracker,
                                eRestyle_ForceDescendants);
   FlushOverflowChangedTracker();

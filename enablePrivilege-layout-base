From: L. David Baron <dbaron@dbaron.org>

Remove most use of enablePrivilege in layout/base/tests.

diff --git a/layout/base/tests/test_bug394057.html b/layout/base/tests/test_bug394057.html
--- a/layout/base/tests/test_bug394057.html
+++ b/layout/base/tests/test_bug394057.html
@@ -20,21 +20,20 @@ https://bugzilla.mozilla.org/show_bug.cg
   
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 /** Test for Bug 394057 **/
 
 SimpleTest.waitForExplicitFinish();
-netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
 
 var tableElement = document.getElementById("display");
 
-var CC = Components.classes;
+var CC = SpecialPowers.wrap(Components).classes;
 var CI = Components.interfaces;
 
 var fe =
   CC["@mozilla.org/gfx/fontenumerator;1"].createInstance(CI.nsIFontEnumerator);
 var serifFonts = fe.EnumerateFonts("x-western", "serif", {});
 var monospaceFonts = fe.EnumerateFonts("x-western", "monospace", {});
 
 function table_width_for_font(font) {
@@ -59,34 +58,30 @@ if (serifWidth == monospaceWidth) {
     if (serifWidth != monospaceWidth)
       break;
   }
 }
 
 isnot(serifWidth, monospaceWidth,
       "can't find serif and monospace fonts of different width");
 
-var prefs =
-  CC["@mozilla.org/preferences-service;1"].getService(CI.nsIPrefBranch);
-prefs.setCharPref('font.name.serif.x-western', serifFonts[serifIdx]);
+SpecialPowers.setCharPref('font.name.serif.x-western', serifFonts[serifIdx]);
 
 var serifWidthFromPref;
 setTimeout(setTimeout, 0, step2, 0);
 function step2() {
-    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
     serifWidthFromPref = tableElement.offsetWidth;
-    prefs.setCharPref('font.name.serif.x-western',
-                        monospaceFonts[monospaceIdx]);
+    SpecialPowers.setCharPref('font.name.serif.x-western',
+                              monospaceFonts[monospaceIdx]);
     setTimeout(setTimeout, 0, step3, 0);
 }
 var monospaceWidthFromPref;
 function step3() {
-    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
     monospaceWidthFromPref = tableElement.offsetWidth;
-    prefs.clearUserPref('font.name.serif.x-western');
+    SpecialPowers.clearUserPref('font.name.serif.x-western');
 
     is(serifWidthFromPref, serifWidth,
        "changing font pref should change width of table (serif)");
     is(monospaceWidthFromPref, monospaceWidth,
        "changing font pref should change width of table (monospace)");
     SimpleTest.finish();
 }
 
diff --git a/layout/base/tests/test_bug399284.html b/layout/base/tests/test_bug399284.html
--- a/layout/base/tests/test_bug399284.html
+++ b/layout/base/tests/test_bug399284.html
@@ -13,19 +13,18 @@ https://bugzilla.mozilla.org/show_bug.cg
 <p id="display"></p>
 <div id="content" style="display: none">
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 /** Test for Bug 399284 **/
 const testContent = "<p id='testPara'>The quick brown fox jumps over the lazy dog";
 
-netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
 const Ci = Components.interfaces;
-const Cc = Components.classes;
+const Cc = SpecialPowers.wrap(Components).classes;
 var ccManager = Cc["@mozilla.org/charset-converter-manager;1"].getService(Ci.nsICharsetConverterManager);
 
 var decoderList = ccManager.getDecoderList();
 SimpleTest.waitForExplicitFinish();
 while (decoderList.hasMore()) {
     var decoder =  decoderList.getNext();
 
     // encode the content for non-ASCII compatible encodings
diff --git a/layout/base/tests/test_bug416896.html b/layout/base/tests/test_bug416896.html
--- a/layout/base/tests/test_bug416896.html
+++ b/layout/base/tests/test_bug416896.html
@@ -23,18 +23,18 @@ https://bugzilla.mozilla.org/show_bug.cg
 
 /** Test for Bug 416896 **/
  var inlineSheet = $("i").sheet;
  isnot(inlineSheet, null, "Should have sheet here");
 
  var linkedSheet = $("l").sheet;
  isnot(linkedSheet, null, "Should have sheet here");
 
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
- var domUtils = Components.classes["@mozilla.org/inspector/dom-utils;1"]
+ var domUtils = SpecialPowers.wrap(Components)
+                          .classes["@mozilla.org/inspector/dom-utils;1"]
                           .getService(Components.interfaces.inIDOMUtils);
  const nsIDOMCSSStyleRule = Components.interfaces["nsIDOMCSSStyleRule"];
  var inspectedRules = domUtils.getCSSStyleRules(document.links[0]);
 
  var seenInline = false;
  var seenLinked = false;
  
  for (var i = 0; i < inspectedRules.Count(); ++i)
diff --git a/layout/base/tests/test_bug548545.xhtml b/layout/base/tests/test_bug548545.xhtml
--- a/layout/base/tests/test_bug548545.xhtml
+++ b/layout/base/tests/test_bug548545.xhtml
@@ -16,21 +16,19 @@ https://bugzilla.mozilla.org/show_bug.cg
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 <![CDATA[
 /** Test for Bug 548545 **/
 
 SimpleTest.waitForExplicitFinish();
 
-netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-
 var content = document.getElementById("content");
 
-var CC = Components.classes;
+var CC = SpecialPowers.wrap(Components).classes;
 var CI = Components.interfaces;
 
 var fe =
   CC["@mozilla.org/gfx/fontenumerator;1"].createInstance(CI.nsIFontEnumerator);
 var allFonts = fe.EnumerateFonts(null, null, {});
 
 var idx = 0;
 var list = "";
diff --git a/layout/base/tests/test_bug603550.html b/layout/base/tests/test_bug603550.html
--- a/layout/base/tests/test_bug603550.html
+++ b/layout/base/tests/test_bug603550.html
@@ -48,18 +48,18 @@ function sendMouseUp(el) {
 }
 
 function fireEvent(target, event) {
   var utils = SpecialPowers.getDOMWindowUtils(window);
   utils.dispatchDOMEventViaPresShell(target, event, true);
 }
 
 function fireDrop(element) {
-  netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-  var ds = Components.classes["@mozilla.org/widget/dragservice;1"].
+  var ds = SpecialPowers.wrap(Components).
+    classes["@mozilla.org/widget/dragservice;1"].
     getService(Components.interfaces.nsIDragService);
 
   ds.startDragSession();
 
   var event = document.createEvent("DragEvents");
   event.initDragEvent("dragover", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null, null);
   fireEvent(element, event);
 
diff --git a/layout/base/tests/test_scroll_selection_into_view.html b/layout/base/tests/test_scroll_selection_into_view.html
--- a/layout/base/tests/test_scroll_selection_into_view.html
+++ b/layout/base/tests/test_scroll_selection_into_view.html
@@ -43,18 +43,17 @@
 
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 var ANCHOR = 0;
 var FOCUS = 1;
 
 function testCollapsed(id, vPercent, startAt, expected) {
-  netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-  var selection = window.getSelection().QueryInterface(Components.interfaces.nsISelectionPrivate);
+  var selection = SpecialPowers.wrap(window).getSelection().QueryInterface(Components.interfaces.nsISelectionPrivate);
 
   var c = document.getElementById("c" + id);
   var target = document.getElementById("target" + id);
   if (target.contentDocument) {
     target = target.contentDocument.getElementById("target" + id);
   }
   selection.collapse(target.parentNode, 0);
   c.scrollTop = startAt;

Add support for compiler-generated dependencies to MSVC builds.

diff --git a/config/autoconf.mk.in b/config/autoconf.mk.in
--- a/config/autoconf.mk.in
+++ b/config/autoconf.mk.in
@@ -510,6 +510,7 @@ MOZ_AUTO_DEPS	= @MOZ_AUTO_DEPS@
 MOZ_AUTO_DEPS	= @MOZ_AUTO_DEPS@
 COMPILER_DEPEND = @COMPILER_DEPEND@
 MDDEPDIR        := @MDDEPDIR@
+MSVC_COMPILER_DEPEND = @MSVC_COMPILER_DEPEND@
 
 MOZ_DEMANGLE_SYMBOLS = @MOZ_DEMANGLE_SYMBOLS@
 
diff --git a/config/cl-depwrap.pl b/config/cl-depwrap.pl
new file mode 100755
--- /dev/null
+++ b/config/cl-depwrap.pl
@@ -0,0 +1,63 @@
+#!/usr/bin/perl -w
+# vim: set shiftwidth=4 tabstop=8 autoindent expandtab:
+# ***** BEGIN LICENSE BLOCK *****
+# Version: MPL 1.1/GPL 2.0/LGPL 2.1
+#
+# The contents of this file are subject to the Mozilla Public License Version
+# 1.1 (the "License"); you may not use this file except in compliance with
+# the License. You may obtain a copy of the License at
+# http://www.mozilla.org/MPL/
+#
+# Software distributed under the License is distributed on an "AS IS" basis,
+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+# for the specific language governing rights and limitations under the
+# License.
+#
+# The Original Code is cl-depwrap.pl
+#
+# The Initial Developer of the Original Code is the Mozilla Foundation.
+# Portions created by the Initial Developer are Copyright (C) 2007
+# the Initial Developer. All Rights Reserved.
+#
+# Contributor(s):
+#   L. David Baron <dbaron@dbaron.org>, Mozilla Corporation (original author)
+#
+# Alternatively, the contents of this file may be used under the terms of
+# either the GNU General Public License Version 2 or later (the "GPL"), or
+# the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+# in which case the provisions of the GPL or the LGPL are applicable instead
+# of those above. If you wish to allow use of your version of this file only
+# under the terms of either the GPL or the LGPL, and not to allow others to
+# use your version of this file under the terms of the MPL, indicate your
+# decision by deleting the provisions above and replace them with the notice
+# and other provisions required by the GPL or the LGPL. If you do not delete
+# the provisions above, a recipient may use your version of this file under
+# the terms of any one of the MPL, the GPL or the LGPL.
+#
+# ***** END LICENSE BLOCK *****
+
+use strict;
+
+pipe(PARENT_READER, CHILD_WRITER);
+
+my $self_name = pop @ARGV;
+my $outfile = pop @ARGV;
+
+if (my $pid = fork()) {
+  close(PARENT_READER);
+  open STDERR, '>&CHILD_WRITER';
+  open STDOUT, '>&CHILD_WRITER';
+  exec(@ARGV);
+} else {
+  close(CHILD_WRITER);
+  open(DEPS, ">$outfile");
+  while (<PARENT_READER>) {
+    unless (/^Note: including file:/) {
+      print;
+      next;
+    }
+    s/^Note: including file: *//;
+    print DEPS $_;
+  }
+  close(PARENT_READER);
+}
diff --git a/configure.in b/configure.in
--- a/configure.in
+++ b/configure.in
@@ -6641,6 +6641,7 @@ dnl = Use mkdepend instead of $CC -MD fo
 dnl = Use mkdepend instead of $CC -MD for dependency generation
 dnl ========================================================
 _cpp_md_flag=
+MSVC_COMPILER_DEPEND=
 MOZ_ARG_DISABLE_BOOL(md,
 [  --disable-md            Do not use compiler-based dependencies ],
   [_cpp_md_flag=],
@@ -6648,13 +6649,24 @@ MOZ_ARG_DISABLE_BOOL(md,
   [dnl Default is to turn on -MD if using GNU-compatible compilers
    if test "$GNU_CC" -a "$GNU_CXX" -a "$OS_ARCH" != "WINNT" -a "$OS_ARCH" != "WINCE"; then
      _cpp_md_flag=1
+   fi
+   dnl Default is to use /showIncludes for MSVC.
+   if test -n "$_WIN32_MSVC"; then
+     _cpp_md_flag=1
    fi])
 if test "$_cpp_md_flag"; then
   COMPILER_DEPEND=1
-  if test "$OS_ARCH" = "OpenVMS"; then
-    _DEPEND_CFLAGS='$(subst =, ,$(filter-out %/.pp,-MM=-MD=-MF=$(MDDEPDIR)/$(*F).pp))'
+  if test -z "$_WIN32_MSVC"; then
+    if test "$OS_ARCH" = "OpenVMS"; then
+      _DEPEND_CFLAGS='$(subst =, ,$(filter-out %/.pp,-MM=-MD=-MF=$(MDDEPDIR)/$(*F).pp))'
+    else
+      _DEPEND_CFLAGS='$(filter-out %/.pp,-Wp,-MD,$(MDDEPDIR)/$(*F).pp)'
+    fi
   else
-    _DEPEND_CFLAGS='$(filter-out %/.pp,-Wp,-MD,$(MDDEPDIR)/$(*F).pp)'
+    MSVC_COMPILER_DEPEND=1
+    _DEPEND_CFLAGS='-showIncludes'
+    CC='$(topsrcdir)/config/cl-depwrap.pl $(MDDEPDIR)/$(*F).pp) '"$CC"
+    CXX='$(topsrcdir)/config/cl-depwrap.pl $(MDDEPDIR)/$(*F).pp) '"$CXX"
   fi
 else
   COMPILER_DEPEND=
@@ -6667,6 +6679,7 @@ AC_SUBST(MOZ_AUTO_DEPS)
 AC_SUBST(MOZ_AUTO_DEPS)
 AC_SUBST(COMPILER_DEPEND)
 AC_SUBST(MDDEPDIR)
+AC_SUBST(MSVC_COMPILER_DEPEND)
 
 
 dnl ========================================================

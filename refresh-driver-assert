From: L. David Baron <dbaron@dbaron.org>

Bug 850559:  Assert when a test leaves test control of refresh driver on.

diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -960,16 +960,24 @@ nsPresContext::Init(nsDeviceContext* aDe
       }
     }
 
     if (!mRefreshDriver) {
       mRefreshDriver = new nsRefreshDriver(this);
     }
   }
 
+  // This prevents us from using advanceTimeAndRefresh in tests that
+  // need to load subdocuments.  If we need that, we can remove this
+  // assertion, but if we do we need another way to ensure that we don't
+  // have mistakes like
+  // https://bugzilla.mozilla.org/show_bug.cgi?id=850559 .
+  MOZ_ASSERT(!mRefreshDriver->IsTestControllingRefreshesEnabled(),
+             "a previous test didn't restore normal refreshing");
+
   // Initialise refresh tick counters for OMTA
   mLastStyleUpdateForAllAnimations =
     mLastUpdateThrottledStyle = mRefreshDriver->MostRecentRefresh();
 
   mLangService = do_GetService(NS_LANGUAGEATOMSERVICE_CONTRACTID);
 
   // Register callbacks so we're notified when the preferences change
   Preferences::RegisterCallback(nsPresContext::PrefChangedCallback,

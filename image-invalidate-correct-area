Invalidate the correct area when loading an image for which we've displayed the loading-image icon.

diff --git a/layout/generic/nsImageFrame.cpp b/layout/generic/nsImageFrame.cpp
--- a/layout/generic/nsImageFrame.cpp
+++ b/layout/generic/nsImageFrame.cpp
@@ -412,6 +412,10 @@ nsImageFrame::SourceRectToDest(const nsR
   r.width = right + ((scale - (right % scale)) % scale) - r.x;
   r.height = bottom + ((scale - (bottom % scale)) % scale) - r.y;
 
+  // But don't round them to outside of the inner area (due to either of
+  // the expansion steps above)
+  r.IntersectRect(r, GetInnerArea());
+
   return r;
 }
 
@@ -515,14 +519,24 @@ nsImageFrame::OnStartContainer(imgIReque
   
   UpdateIntrinsicSize(aImage);
 
-  // Now we need to reflow if we have an unconstrained size and have
-  // already gotten the initial reflow
-  if (!(mState & IMAGE_SIZECONSTRAINED) && (mState & IMAGE_GOTINITIALREFLOW)) { 
-    nsIPresShell *presShell = presContext->GetPresShell();
-    NS_ASSERTION(presShell, "No PresShell.");
-    if (presShell) { 
-      presShell->FrameNeedsReflow(this, nsIPresShell::eStyleChange,
-                                  NS_FRAME_IS_DIRTY);
+  if (mState & IMAGE_GOTINITIALREFLOW) {
+    // If we previously set the intrinsic size (in EnsureIntrinsicSize)
+    // to the size of the loading-image icon and reflowed the frame,
+    // we'll have an mTransform computed from that intrinsic size.  But
+    // if we still have that transform when we get OnDataAvailable
+    // calls, we'll invalidate the wrong area.  So update the transform
+    // now.
+    RecalculateTransform();
+
+    // Now we need to reflow if we have an unconstrained size and have
+    // already gotten the initial reflow
+    if (!(mState & IMAGE_SIZECONSTRAINED)) { 
+      nsIPresShell *presShell = presContext->GetPresShell();
+      NS_ASSERTION(presShell, "No PresShell.");
+      if (presShell) { 
+        presShell->FrameNeedsReflow(this, nsIPresShell::eStyleChange,
+                                    NS_FRAME_IS_DIRTY);
+      }
     }
   }
 
@@ -630,10 +644,8 @@ nsImageFrame::OnStopDecode(imgIRequest *
                                       NS_FRAME_IS_DIRTY);
         }
       } else {
-        nsSize s = GetSize();
-        nsRect r(0, 0, s.width, s.height);
-        // Update border+content to account for image change
-        Invalidate(r, PR_FALSE);
+        // Update content to account for image change
+        Invalidate(GetInnerArea(), PR_FALSE);
       }
     }
   }

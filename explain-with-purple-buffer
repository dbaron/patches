Use the purple buffer in ExplainLiveExpectedGarbage.

diff --git a/xpcom/base/nsCycleCollector.cpp b/xpcom/base/nsCycleCollector.cpp
--- a/xpcom/base/nsCycleCollector.cpp
+++ b/xpcom/base/nsCycleCollector.cpp
@@ -729,16 +729,20 @@ struct nsPurpleBuffer
     {
         memset(mCache, 0, sizeof(mCache));
         mBackingStore.Init();
     }
 
     void BumpGeneration();
     void SelectAgedPointers(GCGraphBuilder &builder);
 
+#ifdef DEBUG_CC
+    void NoteAllPointersWithoutUnmark(GCGraphBuilder &builder);
+#endif
+
     PRBool Exists(void *p)
     {
         PRUint32 idx = POINTER_INDEX(p);
         for (PRUint32 i = 0; i < ASSOCIATIVITY; ++i) {
             if (mCache[idx+i] == p)
                 return PR_TRUE;
         }
         PRUint32 gen;
@@ -864,16 +868,32 @@ void
 nsPurpleBuffer::SelectAgedPointers(GCGraphBuilder &aBuilder)
 {
     // Rely on our caller having done a BumpGeneration first, which in
     // turn calls SpillAll.
     CallbackClosure closure(this, aBuilder);
     mBackingStore.Enumerate(ageSelectionCallback, &closure);
 }
 
+#ifdef DEBUG_CC
+static PLDHashOperator
+noteAllCallback(const void* ptr, PRUint32& generation, void* userArg)
+{
+    GCGraphBuilder *builder = static_cast<GCGraphBuilder*>(userArg);
+    builder->NoteXPCOMRoot(static_cast<nsISupports *>(const_cast<void*>(ptr)));
+    return PL_DHASH_NEXT;
+}
+
+void
+nsPurpleBuffer::NoteAllPointersWithoutUnmark(GCGraphBuilder &builder)
+{
+    SpillAll();
+    mBackingStore.Enumerate(noteAllCallback, &builder);
+}
+#endif
 
 
 ////////////////////////////////////////////////////////////////////////
 // Implement the LanguageRuntime interface for C++/XPCOM 
 ////////////////////////////////////////////////////////////////////////
 
 
 struct nsCycleCollectionXPCOMRuntime : 
@@ -2566,16 +2586,21 @@ nsCycleCollector::ExplainLiveExpectedGar
         // the set of roots added by the runtimes (what used to be
         // called suspectCurrent), but that seems pretty unlikely.
         PRUint32 suspectCurrentCount = builder.Count();
 
         // Instead of adding roots from the purple buffer, we add them
         // from the list of nodes we were expected to collect.
         mExpectedGarbage.EnumerateEntries(&AddExpectedGarbage, &builder);
 
+        // But just for extra information, add entries from the purple
+        // buffer too, since it may give us extra information about
+        // traversal deficiencies.
+        mPurpleBuf.NoteAllPointersWithoutUnmark(builder);
+
         MarkRoots(builder);
         ScanRoots();
 
         mScanInProgress = PR_FALSE;
 
         PRBool describeExtraRefcounts = PR_FALSE;
         PRBool findCycleRoots = PR_FALSE;
         {

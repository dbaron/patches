From: L. David Baron <dbaron@dbaron.org>

Bug 996796 patch 15 - Copy the eSkipParentDisplayBasedStyleFixup bit from ReparentStyleContext as well.

diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -1443,16 +1443,24 @@ nsStyleSet::ResolveStyleWithReplacement(
 
   nsCSSPseudoElements::Type pseudoType = aOldStyleContext->GetPseudoType();
   if (pseudoType == nsCSSPseudoElements::ePseudo_NotPseudoElement ||
       pseudoType == nsCSSPseudoElements::ePseudo_before ||
       pseudoType == nsCSSPseudoElements::ePseudo_after) {
     flags |= eDoAnimation;
   }
 
+  if (aElement && aElement->IsRootOfAnonymousSubtree()) {
+    // For anonymous subtree roots, don't tweak "display" value based on whether
+    // or not the parent is styled as a flex/grid container. (If the parent
+    // has anonymous-subtree kids, then we know it's not actually going to get
+    // a flex/grid container frame, anyway.)
+    flags |= eSkipParentDisplayBasedStyleFixup;
+  }
+
   return GetContext(aNewParentStyleContext, ruleNode, visitedRuleNode,
                     aOldStyleContext->GetPseudo(),
                     aOldStyleContext->GetPseudoType(),
                     nullptr, flags);
 }
 
 
 already_AddRefed<nsStyleContext>

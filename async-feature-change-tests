From: L. David Baron <dbaron@dbaron.org>

Bug 1089417 patch 11 - Add tests for cases that are broken due to asynchronous handling of media feature value changes.

FIXME: Test these, change to todo in this patch, and remove todo in
following patch.

diff --git a/layout/style/test/file_bug1089417_iframe.html b/layout/style/test/file_bug1089417_iframe.html
--- a/layout/style/test/file_bug1089417_iframe.html
+++ b/layout/style/test/file_bug1089417_iframe.html
@@ -2,16 +2,17 @@
 <html>
 <head>
   <title>Bug 1089417</title>
   <style>
     html { background: red }
     @media (min-height: 300px) { html { background: green } }
   </style>
   <style id="s">/* empty */</style>
+  <style id="s2">q { color: blue }</style>
   <script>
     document.getElementById("s").disabled = true;
   </script>
 </head>
 <body>
 
 </body>
 </html>
diff --git a/layout/style/test/test_bug1089417.html b/layout/style/test/test_bug1089417.html
--- a/layout/style/test/test_bug1089417.html
+++ b/layout/style/test/test_bug1089417.html
@@ -26,16 +26,39 @@ https://bugzilla.mozilla.org/show_bug.cg
        "media query change should have restyled");
 
     f.height = "200";
     fdoc.getElementById("s").disabled = true;
     fdoc.getElementById("s").disabled = false;
     is(fwin.getComputedStyle(fdoc.documentElement).backgroundColor,
        "rgb(255, 0, 0)",
        "media query change should have restyled");
+
+    f.height = "400";
+    // cause null mRuleCascades
+    fdoc.getElementById("s2").disabled = true;
+    // trigger HasAttributeDependentStyle
+    fdoc.body.setAttribute("notstyledependent", "true");
+    is(fwin.getComputedStyle(fdoc.documentElement).backgroundColor,
+       "rgb(0, 128, 0)",
+       "media query change should have restyled");
+
+    f.height = "200";
+    is(fwin.getComputedStyle(fdoc.documentElement).backgroundColor,
+       "rgb(255, 0, 0)",
+       "media query change should have restyled (resetting for next test)");
+
+    f.height = "400";
+    // cause null mRuleCascades
+    fdoc.getElementById("s2").disabled = false;
+    // FIXME: trigger ProbePseudoElementStyle
+    is(fwin.getComputedStyle(fdoc.documentElement).backgroundColor,
+       "rgb(0, 128, 0)",
+       "media query change should have restyled");
+
     SimpleTest.finish();
   }
 
   </script>
 </head>
 <body onload="run()">
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=1089417">Mozilla Bug 1089417</a>
 <div id="display">

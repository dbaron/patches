From: L. David Baron <dbaron@dbaron.org>

Bug 828173 patch 4:  Remove calls to ForceLayerRerendering from the miniflush code (UpdateThrottledStyles, which updates only the styles resulting from animation and no others.

diff --git a/layout/style/AnimationCommon.cpp b/layout/style/AnimationCommon.cpp
--- a/layout/style/AnimationCommon.cpp
+++ b/layout/style/AnimationCommon.cpp
@@ -186,38 +186,16 @@ CommonAnimationManager::ReparentBeforeAn
   if (nsIFrame* after = nsLayoutUtils::GetBeforeFrame(aPrimaryFrame)) {
     nsRefPtr<nsStyleContext> afterStyle =
       aStyleSet->ReparentStyleContext(after->StyleContext(),
                                      aNewStyle, aElement);
     after->SetStyleContext(afterStyle);
   }
 }
 
-// Ensure that the next repaint rebuilds the layer tree for aFrame. That
-// means that changes to animations on aFrame's layer are propagated to
-// the compositor, which is needed for correct behaviour of new
-// transitions.
-static void
-ForceLayerRerendering(nsIFrame* aFrame, CommonElementAnimationData* aData)
-{
-  if (aData->HasAnimationOfProperty(eCSSProperty_opacity)) {
-    if (Layer* layer = FrameLayerBuilder::GetDedicatedLayer(
-          aFrame, nsDisplayItem::TYPE_OPACITY)) {
-      layer->RemoveUserData(nsIFrame::LayerIsPrerenderedDataKey());
-    }
-  }
-
-  if (aData->HasAnimationOfProperty(eCSSProperty_transform)) {
-    if (Layer* layer = FrameLayerBuilder::GetDedicatedLayer(
-          aFrame, nsDisplayItem::TYPE_TRANSFORM)) {
-      layer->RemoveUserData(nsIFrame::LayerIsPrerenderedDataKey());
-    }
-  }
-}
-
 nsStyleContext*
 CommonAnimationManager::UpdateThrottledStyle(dom::Element* aElement,
                                              nsStyleContext* aParentStyle,
                                              nsStyleChangeList& aChangeList)
 {
   NS_ASSERTION(mPresContext->TransitionManager()->GetElementTransitions(
                  aElement,
                  nsCSSPseudoElements::ePseudo_NotPseudoElement,
@@ -249,33 +227,27 @@ CommonAnimationManager::UpdateThrottledS
           aElement,
           oldStyle->GetPseudoType(),
           false);
       NS_ASSERTION(ea,
         "Rule has level eAnimationSheet without animation on manager");
 
       mPresContext->AnimationManager()->EnsureStyleRuleFor(ea);
       curRule.mRule = ea->mStyleRule;
-
-      // FIXME (bug 828173): maybe not needed anymore:
-      ForceLayerRerendering(primaryFrame, ea);
     } else if (curRule.mLevel == nsStyleSet::eTransitionSheet) {
       ElementTransitions *et =
         mPresContext->TransitionManager()->GetElementTransitions(
           aElement,
           oldStyle->GetPseudoType(),
           false);
       NS_ASSERTION(et,
         "Rule has level eTransitionSheet without transition on manager");
 
       et->EnsureStyleRuleFor(mPresContext->RefreshDriver()->MostRecentRefresh());
       curRule.mRule = et->mStyleRule;
-
-      // FIXME (bug 828173): maybe not needed anymore:
-      ForceLayerRerendering(primaryFrame, et);
     } else {
       curRule.mRule = ruleNode->GetRule();
     }
 
     if (curRule.mRule) {
       rules.AppendElement(curRule);
     }
   } while ((ruleNode = ruleNode->GetParent()));

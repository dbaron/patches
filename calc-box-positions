From: L. David Baron <dbaron@dbaron.org>

Support calc() on background-position, background-size, -moz-transform-origin, and background-image gradient stop positions.  (Bug 594934)

(Note:  this also depends on the change to nsStyleAnimation.cpp's StyleCoordToValue in bug 520234 and on other changes in that bug.)

diff --git a/layout/base/nsCSSRendering.cpp b/layout/base/nsCSSRendering.cpp
--- a/layout/base/nsCSSRendering.cpp
+++ b/layout/base/nsCSSRendering.cpp
@@ -1660,16 +1660,21 @@ ConvertGradientValueToPixels(const nsSty
                              gfxFloat aFillLength,
                              PRInt32 aAppUnitsPerPixel)
 {
   switch (aCoord.GetUnit()) {
     case eStyleUnit_Percent:
       return aCoord.GetPercentValue() * aFillLength;
     case eStyleUnit_Coord:
       return NSAppUnitsToFloatPixels(aCoord.GetCoordValue(), aAppUnitsPerPixel);
+    case eStyleUnit_Calc: {
+      const nsStyleCoord::Calc *calc = aCoord.GetCalcValue();
+      return calc->mPercent * aFillLength +
+             NSAppUnitsToFloatPixels(calc->mLength, aAppUnitsPerPixel);
+    }
     default:
       NS_WARNING("Unexpected coord unit");
       return 0;
   }
 }
 
 // Given a box with size aBoxSize and origin (0,0), and an angle aAngle,
 // and a starting point for the gradient line aStart, find the endpoint of
@@ -2298,18 +2303,20 @@ nsCSSRendering::PaintBackgroundWithSC(ns
 
 static inline float
 ScaleDimension(const nsStyleBackground::Size::Dimension& aDimension,
                PRUint8 aType,
                nscoord aLength, nscoord aAvailLength)
 {
   switch (aType) {
     case nsStyleBackground::Size::eLengthPercentage:
-      return (double(aDimension.mPercent) * double(aAvailLength) +
-              double(aDimension.mLength)) / double(aLength);
+      // negative values could result from calc()
+      return NS_MAX(double(aDimension.mPercent) * double(aAvailLength) +
+                      double(aDimension.mLength),
+                    0.0) / double(aLength);
     default:
       NS_ABORT_IF_FALSE(PR_FALSE, "bad aDimension.mType");
       return 1.0f;
     case nsStyleBackground::Size::eAuto:
       NS_ABORT_IF_FALSE(PR_FALSE, "aDimension.mType == eAuto isn't handled");
       return 1.0f;
   }
 }
diff --git a/layout/base/nsDisplayList.cpp b/layout/base/nsDisplayList.cpp
--- a/layout/base/nsDisplayList.cpp
+++ b/layout/base/nsDisplayList.cpp
@@ -1581,26 +1581,29 @@ gfxPoint GetDeltaToMozTransformOrigin(co
   gfxFloat* coords[2] = {&result.x, &result.y};
   const nscoord* dimensions[2] =
     {&boundingRect.width, &boundingRect.height};
 
   for (PRUint8 index = 0; index < 2; ++index) {
     /* If the -moz-transform-origin specifies a percentage, take the percentage
      * of the size of the box.
      */
-    if (display->mTransformOrigin[index].GetUnit() == eStyleUnit_Percent)
+    const nsStyleCoord &coord = display->mTransformOrigin[index];
+    if (coord.GetUnit() == eStyleUnit_Calc) {
+      const nsStyleCoord::Calc *calc = coord.GetCalcValue();
       *coords[index] = NSAppUnitsToFloatPixels(*dimensions[index], aFactor) *
-        display->mTransformOrigin[index].GetPercentValue();
-    
-    /* Otherwise, it's a length. */
-    else
-      *coords[index] =
-        NSAppUnitsToFloatPixels(display->
-                                mTransformOrigin[index].GetCoordValue(),
-                                aFactor);
+                         calc->mPercent +
+                       NSAppUnitsToFloatPixels(calc->mLength, aFactor);
+    } else if (coord.GetUnit() == eStyleUnit_Percent) {
+      *coords[index] = NSAppUnitsToFloatPixels(*dimensions[index], aFactor) *
+        coord.GetPercentValue();
+    } else {
+      NS_ABORT_IF_FALSE(coord.GetUnit() == eStyleUnit_Coord, "unexpected unit");
+      *coords[index] = NSAppUnitsToFloatPixels(coord.GetCoordValue(), aFactor);
+    }
   }
   
   /* Adjust based on the origin of the rectangle. */
   result.x += NSAppUnitsToFloatPixels(boundingRect.x, aFactor);
   result.y += NSAppUnitsToFloatPixels(boundingRect.y, aFactor);
 
   return result;
 }
diff --git a/layout/reftests/css-calc/background-image-gradient-1-ref.html b/layout/reftests/css-calc/background-image-gradient-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/background-image-gradient-1-ref.html
@@ -0,0 +1,15 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on background-image gradients</title>
+<style>
+
+p {
+    height: 50px; width: 200px;
+    border: thin solid;
+}
+
+#one { background-image: -moz-radial-gradient(150px 20px, circle farthest-side, red, green); }
+#two { background-image: -moz-linear-gradient(-22px -35px -45deg, blue, yellow); }
+
+</style>
+<p id="one"></p>
+<p id="two"></p>
diff --git a/layout/reftests/css-calc/background-image-gradient-1.html b/layout/reftests/css-calc/background-image-gradient-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/background-image-gradient-1.html
@@ -0,0 +1,15 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on background-image gradients</title>
+<style>
+
+p {
+    height: 50px; width: 200px;
+    border: thin solid;
+}
+
+#one { background-image: -moz-radial-gradient(-moz-calc(50px + 50%) -moz-calc(100% - 30px), circle farthest-side, red, green); }
+#two { background-image: -moz-linear-gradient(-moz-calc(-12.5% + 3px) -moz-calc(-10px - 50%) -45deg, blue, yellow); }
+
+</style>
+<p id="one"></p>
+<p id="two"></p>
diff --git a/layout/reftests/css-calc/background-position-1-ref.html b/layout/reftests/css-calc/background-position-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/background-position-1-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on background-position</title>
+<style>
+
+p {
+    height: 50px; width: 200px;
+    border: thin solid;
+    background-image: url(../backgrounds/blue-32x32.png);
+    background-repeat: no-repeat;
+}
+
+#one { background-position: 134px -12px }
+#two { background-position: -18px -19px }
+
+</style>
+<p id="one"></p>
+<p id="two"></p>
diff --git a/layout/reftests/css-calc/background-position-1.html b/layout/reftests/css-calc/background-position-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/background-position-1.html
@@ -0,0 +1,17 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on background-position</title>
+<style>
+
+p {
+    height: 50px; width: 200px;
+    border: thin solid;
+    background-image: url(../backgrounds/blue-32x32.png);
+    background-repeat: no-repeat;
+}
+
+#one { background-position: -moz-calc(50px + 50%) -moz-calc(100% - 30px) }
+#two { background-position: -moz-calc(-12.5% + 3px) -moz-calc(-10px - 50%) }
+
+</style>
+<p id="one"></p>
+<p id="two"></p>
diff --git a/layout/reftests/css-calc/background-size-1-ref.html b/layout/reftests/css-calc/background-size-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/background-size-1-ref.html
@@ -0,0 +1,17 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on background-size</title>
+<style>
+
+p {
+    height: 50px; width: 200px;
+    border: thin solid;
+    background-image: url(../backgrounds/blue-32x32.png);
+    background-repeat: no-repeat;
+}
+
+#one { background-size: 150px 20px; }
+#two { background-image: none }
+
+</style>
+<p id="one"></p>
+<p id="two"></p>
diff --git a/layout/reftests/css-calc/background-size-1.html b/layout/reftests/css-calc/background-size-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/background-size-1.html
@@ -0,0 +1,17 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on background-size</title>
+<style>
+
+p {
+    height: 50px; width: 200px;
+    border: thin solid;
+    background-image: url(../backgrounds/blue-32x32.png);
+    background-repeat: no-repeat;
+}
+
+#one { background-size: -moz-calc(50px + 50%) -moz-calc(100% - 30px) }
+#two { background-size: -moz-calc(50px + 50%) -moz-calc(10px - 50%) }
+
+</style>
+<p id="one"></p>
+<p id="two"></p>
diff --git a/layout/reftests/css-calc/reftest.list b/layout/reftests/css-calc/reftest.list
--- a/layout/reftests/css-calc/reftest.list
+++ b/layout/reftests/css-calc/reftest.list
@@ -1,8 +1,11 @@
+== background-image-gradient-1.html background-image-gradient-1-ref.html
+== background-position-1.html background-position-1-ref.html
+== background-size-1.html background-size-1-ref.html
 == border-radius-1.html border-radius-1-ref.html
 == height-block-1.html height-block-1-ref.html
 == height-table-1.html height-table-1-ref.html
 == margin-block-1.html margin-block-1-ref.html
 == max-height-block-1.html max-height-block-1-ref.html
 == max-width-block-1.html width-block-1-ref.html
 == max-width-block-intrinsic-1.html max-width-block-intrinsic-1-ref.html
 == min-height-block-1.html height-block-1-ref.html
@@ -14,13 +17,14 @@
 == offsets-absolute-top-1.html offsets-absolute-top-1-ref.html
 == offsets-relative-bottom-1.html offsets-relative-top-1-ref.html
 == offsets-relative-left-1.html offsets-relative-left-1-ref.html
 == offsets-relative-right-1.html offsets-relative-left-1-ref.html
 == offsets-relative-top-1.html offsets-relative-top-1-ref.html
 == padding-block-1.html padding-block-1-ref.html
 == text-indent-1.html text-indent-1-ref.html
 == text-indent-intrinsic-1.html text-indent-intrinsic-1-ref.html
+== transform-origin-1.html transform-origin-1-ref.html
 == vertical-align-1.html vertical-align-1-ref.html
 == width-block-1.html width-block-1-ref.html
 == width-block-intrinsic-1.html width-block-intrinsic-1-ref.html
 == width-table-auto-1.html width-table-auto-1-ref.html
 == width-table-fixed-1.html width-table-fixed-1-ref.html
diff --git a/layout/reftests/css-calc/transform-origin-1-ref.html b/layout/reftests/css-calc/transform-origin-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/transform-origin-1-ref.html
@@ -0,0 +1,18 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on transform-origin</title>
+<style>
+
+body { margin: 100px }
+
+p {
+    height: 50px; width: 200px;
+    background: yellow;
+    -moz-transform: rotate(15deg);
+}
+
+#one { -moz-transform-origin: 150px 20px; }
+#two { -moz-transform-origin: -22px -35px; }
+
+</style>
+<p id="one">hello</p>
+<p id="two">hello</p>
diff --git a/layout/reftests/css-calc/transform-origin-1.html b/layout/reftests/css-calc/transform-origin-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-calc/transform-origin-1.html
@@ -0,0 +1,18 @@
+<!DOCTYPE HTML>
+<title>Test for calc() on transform-origin</title>
+<style>
+
+body { margin: 100px }
+
+p {
+    height: 50px; width: 200px;
+    background: yellow;
+    -moz-transform: rotate(15deg);
+}
+
+#one { -moz-transform-origin: -moz-calc(50px + 50%) -moz-calc(100% - 30px); }
+#two { -moz-transform-origin: -moz-calc(-12.5% + 3px) -moz-calc(-10px - 50%); }
+
+</style>
+<p id="one">hello</p>
+<p id="two">hello</p>
diff --git a/layout/style/nsCSSParser.cpp b/layout/style/nsCSSParser.cpp
--- a/layout/style/nsCSSParser.cpp
+++ b/layout/style/nsCSSParser.cpp
@@ -4830,16 +4830,21 @@ CSSParserImpl::ParseGradient(nsCSSValue&
   switch (ty) {
   case eCSSToken_Percentage:
   case eCSSToken_Number:
   case eCSSToken_Dimension:
     haveGradientLine = PR_TRUE;
     break;
 
   case eCSSToken_Function:
+    if (id.LowerCaseEqualsLiteral("-moz-calc")) {
+      haveGradientLine = PR_TRUE;
+      break;
+    }
+    // fall through
   case eCSSToken_ID:
   case eCSSToken_Ref:
     // this is a color
     break;
 
   case eCSSToken_Ident: {
     // This is only a gradient line if it's a box position keyword.
     nsCSSKeyword kw = nsCSSKeywords::LookupKeyword(id);
@@ -6347,17 +6352,19 @@ CSSParserImpl::ParseBackgroundItem(CSSPa
         return PR_FALSE;
       haveImage = PR_TRUE;
       if (!ParseSingleValueProperty(aState.mImage->mValue,
                                     eCSSProperty_background_image)) {
         return PR_FALSE;
       }
     } else if (tt == eCSSToken_Dimension ||
                tt == eCSSToken_Number ||
-               tt == eCSSToken_Percentage) {
+               tt == eCSSToken_Percentage ||
+               (tt == eCSSToken_Function &&
+                mToken.mIdent.LowerCaseEqualsLiteral("-moz-calc"))) {
       if (havePosition)
         return PR_FALSE;
       havePosition = PR_TRUE;
       nsCSSValuePair scratch;
       if (!ParseBoxPositionValues(scratch, PR_FALSE)) {
         return PR_FALSE;
       }
       aState.mPosition->mXValue = scratch.mXValue;
@@ -6457,26 +6464,27 @@ CSSParserImpl::ParseBackgroundPosition()
  * @return Whether or not the operation succeeded.
  */
 PRBool CSSParserImpl::ParseBoxPositionValues(nsCSSValuePair &aOut,
                                              PRBool aAcceptsInherit)
 {
   // First try a percentage or a length value
   nsCSSValue &xValue = aOut.mXValue,
              &yValue = aOut.mYValue;
-  PRInt32 variantMask = aAcceptsInherit ? VARIANT_HLP : VARIANT_LP;
+  PRInt32 variantMask =
+    (aAcceptsInherit ? VARIANT_INHERIT : 0) | VARIANT_LP | VARIANT_CALC;
   if (ParseVariant(xValue, variantMask, nsnull)) {
     if (eCSSUnit_Inherit == xValue.GetUnit() ||
         eCSSUnit_Initial == xValue.GetUnit()) {  // both are inherited or both are set to initial
       yValue = xValue;
       return PR_TRUE;
     }
-    // We have one percentage/length. Get the optional second
-    // percentage/length/keyword.
-    if (ParseVariant(yValue, VARIANT_LP, nsnull)) {
+    // We have one percentage/length/calc. Get the optional second
+    // percentage/length/calc/keyword.
+    if (ParseVariant(yValue, VARIANT_LP | VARIANT_CALC, nsnull)) {
       // We have two numbers
       return PR_TRUE;
     }
 
     if (ParseEnum(yValue, nsCSSProps::kBackgroundPositionKTable)) {
       PRInt32 yVal = yValue.GetIntValue();
       if (!(yVal & BG_CTB)) {
         // The second keyword can only be 'center', 'top', or 'bottom'
@@ -6506,18 +6514,18 @@ PRBool CSSParserImpl::ParseBoxPositionVa
       bit = xValue.GetIntValue();
       if (mask & (bit & ~BG_CENTER)) {
         // Only the 'center' keyword can be duplicated.
         return PR_FALSE;
       }
       mask |= bit;
     }
     else {
-      // Only one keyword.  See if we have a length or percentage.
-      if (ParseVariant(yValue, VARIANT_LP, nsnull)) {
+      // Only one keyword.  See if we have a length, percentage, or calc.
+      if (ParseVariant(yValue, VARIANT_LP | VARIANT_CALC, nsnull)) {
         if (!(mask & BG_CLR)) {
           // The first keyword can only be 'center', 'left', or 'right'
           return PR_FALSE;
         }
 
         xValue = BoxPositionMaskToCSSValue(mask, PR_TRUE);
         return PR_TRUE;
       }
@@ -6579,41 +6587,43 @@ CSSParserImpl::ParseBackgroundSize()
  * property.  These can be one or two lengths (or the 'auto' keyword) or
  * percentages corresponding to the element's dimensions or the single keywords
  * 'contain' or 'cover'.  'initial' and 'inherit' must be handled by the caller
  * if desired.
  *
  * @param aOut The nsCSSValuePair in which to place the result.
  * @return Whether or not the operation succeeded.
  */
+#define BG_SIZE_VARIANT (VARIANT_LP | VARIANT_AUTO | VARIANT_CALC)
 PRBool CSSParserImpl::ParseBackgroundSizeValues(nsCSSValuePair &aOut)
 {
   // First try a percentage or a length value
   nsCSSValue &xValue = aOut.mXValue,
              &yValue = aOut.mYValue;
-  if (ParseNonNegativeVariant(xValue, VARIANT_LP | VARIANT_AUTO, nsnull)) {
-    // We have one percentage/length/auto. Get the optional second
-    // percentage/length/keyword.
-    if (ParseNonNegativeVariant(yValue, VARIANT_LP | VARIANT_AUTO, nsnull)) {
-      // We have a second percentage/length/auto.
+  if (ParseNonNegativeVariant(xValue, BG_SIZE_VARIANT, nsnull)) {
+    // We have one percentage/length/calc/auto. Get the optional second
+    // percentage/length/calc/keyword.
+    if (ParseNonNegativeVariant(yValue, BG_SIZE_VARIANT, nsnull)) {
+      // We have a second percentage/length/calc/auto.
       return PR_TRUE;
     }
 
     // If only one percentage or length value is given, it sets the
     // horizontal size only, and the vertical size will be as if by 'auto'.
     yValue.SetAutoValue();
     return PR_TRUE;
   }
 
   // Now address 'contain' and 'cover'.
   if (!ParseEnum(xValue, nsCSSProps::kBackgroundSizeKTable))
     return PR_FALSE;
   yValue.Reset();
   return PR_TRUE;
 }
+#undef BG_SIZE_VARIANT
 
 PRBool
 CSSParserImpl::ParseBorderColor()
 {
   static const nsCSSProperty kBorderColorSources[] = {
     eCSSProperty_border_left_color_ltr_source,
     eCSSProperty_border_left_color_rtl_source,
     eCSSProperty_border_right_color_ltr_source,
diff --git a/layout/style/nsComputedDOMStyle.cpp b/layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp
+++ b/layout/style/nsComputedDOMStyle.cpp
@@ -1432,23 +1432,51 @@ nsComputedDOMStyle::DoGetBackgroundColor
     delete val;
     return rv;
   }
 
   NS_ADDREF(*aValue = val);
   return NS_OK;
 }
 
+
+static void
+SetValueToCalc(nsStyleCoord::Calc *aCalc, nsROCSSPrimitiveValue *aValue)
+{
+  nsRefPtr<nsROCSSPrimitiveValue> val = new nsROCSSPrimitiveValue();
+  nsAutoString tmp, result;
+
+  result.AppendLiteral("-moz-calc(");
+
+  val->SetAppUnits(aCalc->mLength);
+  val->GetCssText(tmp);
+  result.Append(tmp);
+
+  if (aCalc->mHasPercent) {
+    result.AppendLiteral(" + ");
+
+    val->SetPercent(aCalc->mPercent);
+    val->GetCssText(tmp);
+    result.Append(tmp);
+  }
+
+  result.AppendLiteral(")");
+
+  aValue->SetString(result); // not really SetString
+}
+
 static void
 AppendCSSGradientLength(const nsStyleCoord& aValue,
                         nsROCSSPrimitiveValue* aPrimitive,
                         nsAString& aString)
 {
   nsAutoString tokenString;
-  if (aValue.GetUnit() == eStyleUnit_Coord)
+  if (aValue.IsCalcUnit())
+    SetValueToCalc(aValue.GetCalcValue(), aPrimitive);
+  else if (aValue.GetUnit() == eStyleUnit_Coord)
     aPrimitive->SetAppUnits(aValue.GetCoordValue());
   else
     aPrimitive->SetPercent(aValue.GetPercentValue());
   aPrimitive->GetCssText(tokenString);
   aString.Append(tokenString);
 }
 
 nsresult
@@ -1714,30 +1742,38 @@ nsComputedDOMStyle::DoGetBackgroundPosit
     if (!valY || !itemList->AppendCSSValue(valY)) {
       delete valueList;
       delete valY;
       return NS_ERROR_OUT_OF_MEMORY;
     }
 
     const nsStyleBackground::Position &pos = bg->mLayers[i].mPosition;
 
-    if (pos.mXPosition.mLength != 0) {
-      NS_ABORT_IF_FALSE(pos.mXPosition.mPercent == 0.0f,
-                        "can't have both until calc() implemented");
+    if (pos.mXPosition.mLength == 0) {
+      valX->SetPercent(pos.mXPosition.mPercent);
+    } else if (pos.mXPosition.mPercent == 0.0f) {
       valX->SetAppUnits(pos.mXPosition.mLength);
     } else {
-      valX->SetPercent(pos.mXPosition.mPercent);
+      nsStyleCoord::Calc calc;
+      calc.mPercent = pos.mXPosition.mPercent;
+      calc.mLength  = pos.mXPosition.mLength;
+      calc.mHasPercent = PR_TRUE;
+      SetValueToCalc(&calc, valX);
     }
 
-    if (pos.mYPosition.mLength != 0) {
-      NS_ABORT_IF_FALSE(pos.mYPosition.mPercent == 0.0f,
-                        "can't have both until calc() implemented");
+    if (pos.mYPosition.mLength == 0) {
+      valY->SetPercent(pos.mYPosition.mPercent);
+    } else if (pos.mYPosition.mPercent == 0.0f) {
       valY->SetAppUnits(pos.mYPosition.mLength);
     } else {
-      valY->SetPercent(pos.mYPosition.mPercent);
+      nsStyleCoord::Calc calc;
+      calc.mPercent = pos.mYPosition.mPercent;
+      calc.mLength  = pos.mYPosition.mLength;
+      calc.mHasPercent = PR_TRUE;
+      SetValueToCalc(&calc, valY);
     }
   }
 
   NS_ADDREF(*aValue = valueList);
   return NS_OK;
 }
 
 nsresult
@@ -1799,37 +1835,53 @@ nsComputedDOMStyle::DoGetMozBackgroundSi
         }
 
         if (size.mWidthType == nsStyleBackground::Size::eAuto) {
           valX->SetIdent(eCSSKeyword_auto);
         } else {
           NS_ABORT_IF_FALSE(size.mWidthType ==
                               nsStyleBackground::Size::eLengthPercentage,
                             "bad mWidthType");
-          if (size.mWidth.mLength != 0) {
-            NS_ABORT_IF_FALSE(size.mWidth.mPercent == 0.0f,
-                              "can't have both until calc() implemented");
+          if (size.mWidth.mLength == 0 &&
+              // negative values must have come from calc()
+              size.mWidth.mPercent > 0.0f) {
+            valX->SetPercent(size.mWidth.mPercent);
+          } else if (size.mWidth.mPercent == 0.0f &&
+                     // negative values must have come from calc()
+                     size.mWidth.mLength > 0) {
             valX->SetAppUnits(size.mWidth.mLength);
           } else {
-            valX->SetPercent(size.mWidth.mPercent);
+            nsStyleCoord::Calc calc;
+            calc.mPercent = size.mWidth.mPercent;
+            calc.mLength  = size.mWidth.mLength;
+            calc.mHasPercent = PR_TRUE;
+            SetValueToCalc(&calc, valX);
           }
         }
 
         if (size.mHeightType == nsStyleBackground::Size::eAuto) {
           valY->SetIdent(eCSSKeyword_auto);
         } else {
           NS_ABORT_IF_FALSE(size.mHeightType ==
                               nsStyleBackground::Size::eLengthPercentage,
                             "bad mHeightType");
-          if (size.mHeight.mLength != 0) {
-            NS_ABORT_IF_FALSE(size.mHeight.mPercent == 0.0f,
-                              "can't have both until calc() implemented");
+          if (size.mHeight.mLength == 0 &&
+              // negative values must have come from calc()
+              size.mHeight.mPercent > 0.0f) {
+            valY->SetPercent(size.mHeight.mPercent);
+          } else if (size.mHeight.mPercent == 0.0f &&
+                     // negative values must have come from calc()
+                     size.mHeight.mLength > 0) {
             valY->SetAppUnits(size.mHeight.mLength);
           } else {
-            valY->SetPercent(size.mHeight.mPercent);
+            nsStyleCoord::Calc calc;
+            calc.mPercent = size.mHeight.mPercent;
+            calc.mLength  = size.mHeight.mLength;
+            calc.mHasPercent = PR_TRUE;
+            SetValueToCalc(&calc, valY);
           }
         }
         break;
       }
     }
   }
 
   NS_ADDREF(*aValue = valueList);
@@ -3892,34 +3944,17 @@ nsComputedDOMStyle::SetValueToCoord(nsRO
         if (aClampNegativeCalc && val < 0) {
           NS_ABORT_IF_FALSE(aCoord.IsCalcUnit(),
                             "parser should have rejected value");
           val = 0;
         }
         aValue->SetAppUnits(NS_MAX(aMinAppUnits, NS_MIN(val, aMaxAppUnits)));
       } else {
         nsStyleCoord::Calc *calc = aCoord.GetCalcValue();
-        nsRefPtr<nsROCSSPrimitiveValue> val = new nsROCSSPrimitiveValue();
-        nsAutoString tmp, result;
-
-        result.AppendLiteral("-moz-calc(");
-
-        val->SetAppUnits(calc->mLength);
-        val->GetCssText(tmp);
-        result.Append(tmp);
-
-        result.AppendLiteral(" + ");
-
-        val->SetPercent(calc->mPercent);
-        val->GetCssText(tmp);
-        result.Append(tmp);
-
-        result.AppendLiteral(")");
-
-        aValue->SetString(result); // not really SetString
+        SetValueToCalc(calc, aValue);
       }
       break;
     default:
       NS_ERROR("Can't handle this unit");
       break;
   }
 }
 
diff --git a/layout/style/nsRuleNode.cpp b/layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp
+++ b/layout/style/nsRuleNode.cpp
@@ -765,17 +765,17 @@ static PRBool SetColor(const nsCSSValue&
 }
 
 static void SetGradientCoord(const nsCSSValue& aValue, nsPresContext* aPresContext,
                              nsStyleContext* aContext, nsStyleCoord& aResult,
                              PRBool& aCanStoreInRuleTree)
 {
   // OK to pass bad aParentCoord since we're not passing SETCOORD_INHERIT
   if (!SetCoord(aValue, aResult, nsStyleCoord(),
-                SETCOORD_LPO | SETCOORD_BOX_POSITION,
+                SETCOORD_LPO | SETCOORD_BOX_POSITION | SETCOORD_STORE_CALC,
                 aContext, aPresContext, aCanStoreInRuleTree)) {
     NS_NOTREACHED("unexpected unit for gradient anchor point");
     aResult.SetNoneValue();
   }
 }
 
 static void SetGradient(const nsCSSValue& aValue, nsPresContext* aPresContext,
                         nsStyleContext* aContext, nsStyleGradient& aResult,
@@ -4305,17 +4305,17 @@ nsRuleNode::ComputeDisplayData(void* aSt
     PRBool result =
 #endif
       SetPairCoords(displayData.mTransformOrigin,
                     display->mTransformOrigin[0],
                     display->mTransformOrigin[1],
                     parentDisplay->mTransformOrigin[0],
                     parentDisplay->mTransformOrigin[1],
                     SETCOORD_LPH | SETCOORD_INITIAL_HALF |
-                    SETCOORD_BOX_POSITION,
+                    SETCOORD_BOX_POSITION | SETCOORD_STORE_CALC,
                     aContext, mPresContext, canStoreInRuleTree);
     NS_ASSERTION(result, "Malformed -moz-transform-origin parse!");
   }
 
   COMPUTE_END_RESET(Display, display)
 }
 
 const void*
@@ -4480,16 +4480,24 @@ struct BackgroundItemComputer<nsCSSValue
         (position.*(axis->result)).mPercent = specified.GetPercentValue();
       }
       else if (specified.IsLengthUnit()) {
         (position.*(axis->result)).mLength =
           CalcLength(specified, aStyleContext, aStyleContext->PresContext(),
                      aCanStoreInRuleTree);
         (position.*(axis->result)).mPercent = 0.0f;
       }
+      else if (specified.IsCalcUnit()) {
+        LengthPercentPairCalcOps ops(aStyleContext,
+                                     aStyleContext->PresContext(),
+                                     aCanStoreInRuleTree);
+        nsRuleNode::ComputedCalc vals = ComputeCalc(specified, ops);
+        (position.*(axis->result)).mLength = vals.mLength;
+        (position.*(axis->result)).mPercent = vals.mPercent;
+      }
       else if (eCSSUnit_Enumerated == specified.GetUnit()) {
         (position.*(axis->result)).mLength = 0;
         (position.*(axis->result)).mPercent =
           GetFloatFromBoxPosition(specified.GetIntValue());
       } else {
         NS_NOTREACHED("unexpected unit");
       }
     }
@@ -4557,23 +4565,31 @@ struct BackgroundItemComputer<nsCSSValue
 #endif
         size.*(axis->type) = size.mWidthType;
       }
       else if (eCSSUnit_Percent == specified.GetUnit()) {
         (size.*(axis->result)).mLength = 0;
         (size.*(axis->result)).mPercent = specified.GetPercentValue();
         size.*(axis->type) = nsStyleBackground::Size::eLengthPercentage;
       }
-      else {
-        NS_ABORT_IF_FALSE(specified.IsLengthUnit(), "unexpected unit");
+      else if (specified.IsLengthUnit()) {
         (size.*(axis->result)).mLength =
           CalcLength(specified, aStyleContext, aStyleContext->PresContext(),
                      aCanStoreInRuleTree);
         (size.*(axis->result)).mPercent = 0.0f;
         size.*(axis->type) = nsStyleBackground::Size::eLengthPercentage;
+      } else {
+        NS_ABORT_IF_FALSE(specified.IsCalcUnit(), "unexpected unit");
+        LengthPercentPairCalcOps ops(aStyleContext,
+                                     aStyleContext->PresContext(),
+                                     aCanStoreInRuleTree);
+        nsRuleNode::ComputedCalc vals = ComputeCalc(specified, ops);
+        (size.*(axis->result)).mLength = vals.mLength;
+        (size.*(axis->result)).mPercent = vals.mPercent;
+        size.*(axis->type) = nsStyleBackground::Size::eLengthPercentage;
       }
     }
 
     NS_ABORT_IF_FALSE(size.mWidthType < nsStyleBackground::Size::eDimensionType_COUNT,
                       "bad width type");
     NS_ABORT_IF_FALSE(size.mHeightType < nsStyleBackground::Size::eDimensionType_COUNT,
                       "bad height type");
     NS_ABORT_IF_FALSE((size.mWidthType != nsStyleBackground::Size::eContain &&
diff --git a/layout/style/nsStyleAnimation.cpp b/layout/style/nsStyleAnimation.cpp
--- a/layout/style/nsStyleAnimation.cpp
+++ b/layout/style/nsStyleAnimation.cpp
@@ -2168,50 +2168,52 @@ nsStyleAnimation::ExtractComputedValue(n
             aComputedValue.SetAndAdoptCSSRectValue(vrect, eUnit_CSSRect);
           }
           break;
         }
 
         case eCSSProperty_background_position: {
           const nsStyleBackground *bg =
             static_cast<const nsStyleBackground*>(styleStruct);
-          nsCSSValuePairList *result = nsnull;
-          nsCSSValuePairList **resultTail = &result;
+          nsAutoPtr<nsCSSValuePairList> result;
+          nsCSSValuePairList **resultTail = getter_Transfers(result);
           NS_ABORT_IF_FALSE(bg->mPositionCount > 0, "unexpected count");
           for (PRUint32 i = 0, i_end = bg->mPositionCount; i != i_end; ++i) {
             nsCSSValuePairList *item = new nsCSSValuePairList;
             *resultTail = item;
             resultTail = &item->mNext;
 
             const nsStyleBackground::Position &pos = bg->mLayers[i].mPosition;
             if (pos.mXPosition.mLength == 0) {
               item->mXValue.SetPercentValue(pos.mXPosition.mPercent);
+            } else if (pos.mXPosition.mPercent == 0.0f) {
+              nscoordToCSSValue(pos.mXPosition.mLength, item->mXValue);
             } else {
-              NS_ABORT_IF_FALSE(pos.mXPosition.mPercent == 0.0f,
-                                "calc() isn't supported yet");
-              nscoordToCSSValue(pos.mXPosition.mLength, item->mXValue);
+              // FIXME: calc()
+              return PR_FALSE;
             }
             if (pos.mYPosition.mLength == 0) {
               item->mYValue.SetPercentValue(pos.mYPosition.mPercent);
+            } else if (pos.mYPosition.mPercent == 0.0f) {
+              nscoordToCSSValue(pos.mYPosition.mLength, item->mYValue);
             } else {
-              NS_ABORT_IF_FALSE(pos.mYPosition.mPercent == 0.0f,
-                                "calc() isn't supported yet");
-              nscoordToCSSValue(pos.mYPosition.mLength, item->mYValue);
+              // FIXME: calc()
+              return PR_FALSE;
             }
           }
 
-          aComputedValue.SetAndAdoptCSSValuePairListValue(result);
+          aComputedValue.SetAndAdoptCSSValuePairListValue(result.forget());
           break;
         }
 
         case eCSSProperty_background_size: {
           const nsStyleBackground *bg =
             static_cast<const nsStyleBackground*>(styleStruct);
-          nsCSSValuePairList *result = nsnull;
-          nsCSSValuePairList **resultTail = &result;
+          nsAutoPtr<nsCSSValuePairList> result;
+          nsCSSValuePairList **resultTail = getter_Transfers(result);
           NS_ABORT_IF_FALSE(bg->mSizeCount > 0, "unexpected count");
           for (PRUint32 i = 0, i_end = bg->mSizeCount; i != i_end; ++i) {
             nsCSSValuePairList *item = new nsCSSValuePairList;
             *resultTail = item;
             resultTail = &item->mNext;
 
             const nsStyleBackground::Size &size = bg->mLayers[i].mSize;
             switch (size.mWidthType) {
@@ -2221,45 +2223,47 @@ nsStyleAnimation::ExtractComputedValue(n
                                           eCSSUnit_Enumerated);
                 break;
               case nsStyleBackground::Size::eAuto:
                 item->mXValue.SetAutoValue();
                 break;
               case nsStyleBackground::Size::eLengthPercentage:
                 if (size.mWidth.mLength == 0) {
                   item->mXValue.SetPercentValue(size.mWidth.mPercent);
+                } else if (size.mWidth.mPercent == 0.0f) {
+                  nscoordToCSSValue(size.mWidth.mLength, item->mXValue);
                 } else {
-                  NS_ABORT_IF_FALSE(size.mWidth.mPercent == 0.0f,
-                                    "calc() isn't supported yet");
-                  nscoordToCSSValue(size.mWidth.mLength, item->mXValue);
+                  // FIXME: calc()
+                  return PR_FALSE;
                 }
                 break;
             }
 
             switch (size.mHeightType) {
               case nsStyleBackground::Size::eContain:
               case nsStyleBackground::Size::eCover:
                 // leave it null
                 break;
               case nsStyleBackground::Size::eAuto:
                 item->mYValue.SetAutoValue();
                 break;
               case nsStyleBackground::Size::eLengthPercentage:
                 if (size.mHeight.mLength == 0) {
                   item->mYValue.SetPercentValue(size.mHeight.mPercent);
+                } else if (size.mHeight.mPercent == 0.0f) {
+                  nscoordToCSSValue(size.mHeight.mLength, item->mYValue);
                 } else {
-                  NS_ABORT_IF_FALSE(size.mHeight.mPercent == 0.0f,
-                                    "calc() isn't supported yet");
-                  nscoordToCSSValue(size.mHeight.mLength, item->mYValue);
+                  // FIXME: calc()
+                  return PR_FALSE;
                 }
                 break;
             }
           }
 
-          aComputedValue.SetAndAdoptCSSValuePairListValue(result);
+          aComputedValue.SetAndAdoptCSSValuePairListValue(result.forget());
           break;
         }
 
         case eCSSProperty__moz_transform: {
           const nsStyleDisplay *display =
             static_cast<const nsStyleDisplay*>(styleStruct);
           nsAutoPtr<nsCSSValueList> result;
           if (display->mSpecifiedTransform) {
diff --git a/layout/style/nsStyleStruct.h b/layout/style/nsStyleStruct.h
--- a/layout/style/nsStyleStruct.h
+++ b/layout/style/nsStyleStruct.h
@@ -156,18 +156,18 @@ struct nsStyleGradientStop {
 class nsStyleGradient {
 public:
   nsStyleGradient();
   PRUint8 mShape;  // NS_STYLE_GRADIENT_SHAPE_*
   PRUint8 mSize;   // NS_STYLE_GRADIENT_SIZE_*;
                    // not used (must be FARTHEST_CORNER) for linear shape
   PRPackedBool mRepeating;
 
-  nsStyleCoord mBgPosX; // percent, coord, none
-  nsStyleCoord mBgPosY; // percent, coord, none
+  nsStyleCoord mBgPosX; // percent, coord, calc, none
+  nsStyleCoord mBgPosY; // percent, coord, calc, none
   nsStyleCoord mAngle;  // none, angle
 
   // stops are in the order specified in the stylesheet
   nsTArray<nsStyleGradientStop> mStops;
 
   PRBool operator==(const nsStyleGradient& aOther) const;
   PRBool operator!=(const nsStyleGradient& aOther) const {
     return !(*this == aOther);
@@ -1380,17 +1380,17 @@ struct nsStyleDisplay {
   PRUint8   mClipFlags;         // [reset] see nsStyleConsts.h
 
   // mSpecifiedTransform is the list of transform functions as
   // specified, or null to indicate there is no transform.  (inherit or
   // initial are replaced by an actual list of transform functions, or
   // null, as appropriate.) (owned by the style rule)
   const nsCSSValueList *mSpecifiedTransform; // [reset]
   nsStyleTransformMatrix mTransform; // [reset] The stored transform matrix
-  nsStyleCoord mTransformOrigin[2]; // [reset] percent, coord.
+  nsStyleCoord mTransformOrigin[2]; // [reset] percent, coord, calc
 
   nsAutoTArray<nsTransition, 1> mTransitions; // [reset]
   // The number of elements in mTransitions that are not from repeating
   // a list due to another property being longer.
   PRUint32 mTransitionTimingFunctionCount,
            mTransitionDurationCount,
            mTransitionDelayCount,
            mTransitionPropertyCount;
diff --git a/layout/style/test/property_database.js b/layout/style/test/property_database.js
--- a/layout/style/test/property_database.js
+++ b/layout/style/test/property_database.js
@@ -828,17 +828,28 @@ var gCSSProperties = {
 		/* no subproperties */
 		prerequisites: { "width": "10px", "height": "10px", "display": "block"},
 		initial_values: [ "50% 50%", "center", "center center" ],
 		other_values: [ "25% 25%", "5px 5px", "20% 3em", "0 0", "0in 1in",
 						"top", "bottom","top left", "top right",
 						"top center", "center left", "center right",
 						"bottom left", "bottom right", "bottom center",
 						"20% center", "5px center", "13in bottom",
-						"left 50px", "right 13%", "center 40px"],
+						"left 50px", "right 13%", "center 40px",
+			"-moz-calc(20px)",
+			"-moz-calc(20px) 10px",
+			"10px -moz-calc(20px)",
+			"-moz-calc(20px) 25%",
+			"25% -moz-calc(20px)",
+			"-moz-calc(20px) -moz-calc(20px)",
+			"-moz-calc(20px + 1em) -moz-calc(20px / 2)",
+			"-moz-calc(20px + 50%) -moz-calc(50% - 10px)",
+			"-moz-calc(-20px) -moz-calc(-50%)",
+			"-moz-calc(-20%) -moz-calc(-50%)"
+		],
 		invalid_values: ["red", "auto", "none", "0.5 0.5", "40px #0000ff",
 						 "border", "center red", "right diagonal",
 						 "#00ffff bottom"]
 	},
 	"-moz-user-focus": {
 		domProp: "MozUserFocus",
 		inherited: true,
 		type: CSS_TYPE_LONGHAND,
@@ -1150,16 +1161,29 @@ var gCSSProperties = {
 
 		"-moz-repeating-radial-gradient(top left 99deg, cover, red, blue)",
 		"-moz-repeating-radial-gradient(15% 20% -1.2345rad, circle, red, blue)",
 		"-moz-repeating-radial-gradient(45px 399grad, ellipse closest-corner, red, blue)",
 		"-moz-repeating-radial-gradient(45px 399grad, farthest-side circle, red, blue)",
 		"-moz-image-rect(url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==), 2, 10, 10, 2)",
 		"-moz-image-rect(url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==), 10%, 50%, 30%, 0%)",
 		"-moz-image-rect(url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==), 10, 50%, 30%, 0)",
+
+		"-moz-radial-gradient(-moz-calc(25%) top, red, blue)",
+		"-moz-radial-gradient(left -moz-calc(25%), red, blue)",
+		"-moz-radial-gradient(-moz-calc(25px) top, red, blue)",
+		"-moz-radial-gradient(left -moz-calc(25px), red, blue)",
+		"-moz-radial-gradient(-moz-calc(-25%) top, red, blue)",
+		"-moz-radial-gradient(left -moz-calc(-25%), red, blue)",
+		"-moz-radial-gradient(-moz-calc(-25px) top, red, blue)",
+		"-moz-radial-gradient(left -moz-calc(-25px), red, blue)",
+		"-moz-radial-gradient(-moz-calc(100px + -25%) top, red, blue)",
+		"-moz-radial-gradient(left -moz-calc(100px + -25%), red, blue)",
+		"-moz-radial-gradient(-moz-calc(100px + -25px) top, red, blue)",
+		"-moz-radial-gradient(left -moz-calc(100px + -25px), red, blue)",
 		],
 		invalid_values: [
 			"-moz-element(#a:1)",
 			"-moz-element(a#a)",
 			"-moz-element(#a a)",
 			"-moz-element(#a+a)",
 			"-moz-element(#a()",
 			/* Old syntax */
@@ -1220,18 +1244,29 @@ var gCSSProperties = {
 		other_values: [ "border-box", "content-box", "border-box, padding-box", "padding-box, padding-box, padding-box", "border-box, border-box" ],
 		invalid_values: [ "margin-box", "padding-box padding-box" ]
 	},
 	"background-position": {
 		domProp: "backgroundPosition",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		/* is "0px 0px" an initial value or not? */
-		initial_values: [ "top left", "left top", "0% 0%", "0% top", "left 0%" ],
-		other_values: [ "top", "left", "right", "bottom", "center", "center bottom", "bottom center", "center right", "right center", "center top", "top center", "center left", "left center", "right bottom", "bottom right", "50%", "top left, top left", "top left, top right", "top right, top left", "left top, 0% 0%", "10% 20%, 30%, 40%", "top left, bottom right", "right bottom, left top", "0%", "0px", "30px", "0%, 10%, 20%, 30%", "top, top, top, top, top" ],
+		initial_values: [ "top left", "left top", "0% 0%", "0% top", "left 0%", "0px 0px" ],
+		other_values: [ "top", "left", "right", "bottom", "center", "center bottom", "bottom center", "center right", "right center", "center top", "top center", "center left", "left center", "right bottom", "bottom right", "50%", "top left, top left", "top left, top right", "top right, top left", "left top, 0% 0%", "10% 20%, 30%, 40%", "top left, bottom right", "right bottom, left top", "0%", "0px", "30px", "0%, 10%, 20%, 30%", "top, top, top, top, top",
+			"-moz-calc(20px)",
+			"-moz-calc(20px) 10px",
+			"10px -moz-calc(20px)",
+			"-moz-calc(20px) 25%",
+			"25% -moz-calc(20px)",
+			"-moz-calc(20px) -moz-calc(20px)",
+			"-moz-calc(20px + 1em) -moz-calc(20px / 2)",
+			"-moz-calc(20px + 50%) -moz-calc(50% - 10px)",
+			"-moz-calc(-20px) -moz-calc(-50%)",
+			"-moz-calc(-20%) -moz-calc(-50%)"
+		],
 		invalid_values: [ "50% left", "top 50%" ]
 	},
 	"background-repeat": {
 		domProp: "backgroundRepeat",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		initial_values: [ "repeat" ],
 		other_values: [ "repeat-x", "repeat-y", "no-repeat",
@@ -1242,17 +1277,28 @@ var gCSSProperties = {
 		],
 		invalid_values: [ "repeat repeat" ]
 	},
 	"background-size": {
 		domProp: "backgroundSize",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		initial_values: [ "auto", "auto auto" ],
-		other_values: [ "contain", "cover", "100px auto", "auto 100px", "100% auto", "auto 100%", "25% 50px", "3em 40%" ],
+		other_values: [ "contain", "cover", "100px auto", "auto 100px", "100% auto", "auto 100%", "25% 50px", "3em 40%",
+			"-moz-calc(20px)",
+			"-moz-calc(20px) 10px",
+			"10px -moz-calc(20px)",
+			"-moz-calc(20px) 25%",
+			"25% -moz-calc(20px)",
+			"-moz-calc(20px) -moz-calc(20px)",
+			"-moz-calc(20px + 1em) -moz-calc(20px / 2)",
+			"-moz-calc(20px + 50%) -moz-calc(50% - 10px)",
+			"-moz-calc(-20px) -moz-calc(-50%)",
+			"-moz-calc(-20%) -moz-calc(-50%)"
+		],
 		invalid_values: [ "contain contain", "cover cover", "cover auto", "auto cover", "contain cover", "cover contain", "-5px 3px", "3px -5px", "auto -5px", "-5px auto" ]
 	},
 	"border": {
 		domProp: "border",
 		inherited: false,
 		type: CSS_TYPE_TRUE_SHORTHAND,
 		subproperties: [ "border-bottom-color", "border-bottom-style", "border-bottom-width", "border-left-color", "border-left-style", "border-left-width", "border-right-color", "border-right-style", "border-right-width", "border-top-color", "border-top-style", "border-top-width", "-moz-border-top-colors", "-moz-border-right-colors", "-moz-border-bottom-colors", "-moz-border-left-colors", "-moz-border-image" ],
 		initial_values: [ "none", "medium", "currentColor", "thin", "none medium currentcolor", "-moz-calc(4px - 1px) none" ],

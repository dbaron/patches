Account for non-pixel-aligned current transforms when snapping to pixel coordinates.  b=369882

diff --git a/layout/base/nsLayoutUtils.cpp b/layout/base/nsLayoutUtils.cpp
--- a/layout/base/nsLayoutUtils.cpp
+++ b/layout/base/nsLayoutUtils.cpp
@@ -63,6 +63,7 @@
 #include "gfxIImageFrame.h"
 #include "imgIContainer.h"
 #include "gfxRect.h"
+#include "gfxContext.h"
 #include "nsIImage.h"
 #include "nsIInterfaceRequestorUtils.h"
 #include "nsCSSRendering.h"
@@ -2135,6 +2136,10 @@ nsLayoutUtils::DrawImage(nsIRenderingCon
   aRenderingContext->GetDeviceContext(*getter_AddRefs(dc));
   PRInt32 d2a = dc->AppUnitsPerDevPixel();
 
+  nsRefPtr<gfxContext> ctx = NS_STATIC_CAST(gfxContext*,
+    aRenderingContext->GetNativeGraphicData(
+      nsIRenderingContext::NATIVE_THEBES_CONTEXT));
+
   // the dest rect is affected by the current transform; that'll be
   // handled by Image::Draw(), when we actually set up the rectangle.
   
@@ -2142,15 +2147,12 @@ nsLayoutUtils::DrawImage(nsIRenderingCon
   // pixel, but then convert back to gfxFloats for the rest of the math.
   gfxRect pxDest;
   {
-    nsIntRect r;
-    r.x = NSAppUnitsToIntPixels(aDestRect.x, d2a);
-    r.y = NSAppUnitsToIntPixels(aDestRect.y, d2a);
-    r.width = NSAppUnitsToIntPixels(aDestRect.XMost(), d2a) - r.x;
-    r.height = NSAppUnitsToIntPixels(aDestRect.YMost(), d2a) - r.y;
-    pxDest.pos.x = gfxFloat(r.x);
-    pxDest.pos.y = gfxFloat(r.y);
-    pxDest.size.width = gfxFloat(r.width);
-    pxDest.size.height = gfxFloat(r.height);
+    pxDest.pos.x = NSAppUnitsToFloatPixels(aDestRect.x, d2a);
+    pxDest.pos.y = NSAppUnitsToFloatPixels(aDestRect.y, d2a);
+    pxDest.size.width = NSAppUnitsToFloatPixels(aDestRect.width, d2a);
+    pxDest.size.height = NSAppUnitsToFloatPixels(aDestRect.height, d2a);
+    if (ctx->UserToDevicePixelSnapped(pxDest))
+      pxDest = ctx->DeviceToUser(pxDest);
   }
 
   // And likewise for the dirty rect.  (Is should be OK to round to
@@ -2159,15 +2161,12 @@ nsLayoutUtils::DrawImage(nsIRenderingCon
   // been intersected with, and we should be rounding those consistently.)
   gfxRect pxDirty;
   {
-    nsIntRect r;
-    r.x = NSAppUnitsToIntPixels(dirtyRect.x, d2a);
-    r.y = NSAppUnitsToIntPixels(dirtyRect.y, d2a);
-    r.width = NSAppUnitsToIntPixels(dirtyRect.XMost(), d2a) - r.x;
-    r.height = NSAppUnitsToIntPixels(dirtyRect.YMost(), d2a) - r.y;
-    pxDirty.pos.x = gfxFloat(r.x);
-    pxDirty.pos.y = gfxFloat(r.y);
-    pxDirty.size.width = gfxFloat(r.width);
-    pxDirty.size.height = gfxFloat(r.height);
+    pxDirty.pos.x = NSAppUnitsToFloatPixels(dirtyRect.x, d2a);
+    pxDirty.pos.y = NSAppUnitsToFloatPixels(dirtyRect.y, d2a);
+    pxDirty.size.width = NSAppUnitsToFloatPixels(dirtyRect.width, d2a);
+    pxDirty.size.height = NSAppUnitsToFloatPixels(dirtyRect.height, d2a);
+    if (ctx->UserToDevicePixelSnapped(pxDirty))
+      pxDirty = ctx->DeviceToUser(pxDirty);
   }
 
   // Reduce the src rect to what's needed for the dirty rect.
diff --git a/layout/reftests/bugs/369882-ref.xul b/layout/reftests/bugs/369882-ref.xul
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/369882-ref.xul
@@ -0,0 +1,9 @@
+<?xml version="1.0"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <hbox height="18" align="center">
+    <deck>
+      <image width="16" height="16"
+             src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mP4z8AAAAMBAQD3A0FDAAAAAElFTkSuQmCC"/>
+    </deck>
+  </hbox>
+</window>
diff --git a/layout/reftests/bugs/369882.xul b/layout/reftests/bugs/369882.xul
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/369882.xul
@@ -0,0 +1,10 @@
+<?xml version="1.0"?>
+<window xmlns="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
+  <hbox height="17" align="center">
+    <deck>
+      <image width="16" height="16"
+             style="background:blue"
+             src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mP4z8AAAAMBAQD3A0FDAAAAAElFTkSuQmCC"/>
+    </deck>
+  </hbox>
+</window>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -210,6 +210,7 @@ fails == 368504-1.html 368504-1-ref.html
 fails == 368504-1.html 368504-1-ref.html # bug 368504
 == 368622-1.html 368622-1-ref.html
 == 368622-1.html 368622-1-ref.html
+== 369882.xul 369882-ref.xul
 == 370422-1.html 370422-1-ref.html
 == 370586-1.xhtml 370586-1-ref.xhtml
 == 370629-1.html 370629-1-ref.html

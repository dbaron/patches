From: L. David Baron <dbaron@dbaron.org>

Add ElementRestyler class to begin refactoring ReResolveStyleContext.

diff --git a/layout/base/RestyleManager.h b/layout/base/RestyleManager.h
--- a/layout/base/RestyleManager.h
+++ b/layout/base/RestyleManager.h
@@ -21,17 +21,17 @@ class nsIFrame;
 struct TreeMatchContext;
 
 namespace mozilla {
 
 namespace dom {
   class Element;
 } // namespace dom
 
-class RestyleManager {
+class RestyleManager MOZ_FINAL {
 public:
   friend class ::nsRefreshDriver;
   friend class RestyleTracker;
 
   typedef mozilla::dom::Element Element;
 
   RestyleManager(nsPresContext* aPresContext);
 
@@ -186,22 +186,24 @@ public:
   }
 
   void FlushOverflowChangedTracker()
   {
     mOverflowChangedTracker.Flush();
   }
 
 private:
+  // FIXME: REMOVE THIS
   enum DesiredA11yNotifications {
     eSkipNotifications,
     eSendAllNotifications,
     eNotifyIfShown
   };
 
+  // FIXME: REMOVE THIS
   enum A11yNotificationType {
     eDontNotify,
     eNotifyShown,
     eNotifyHidden
   };
 
   // Use eRestyle_Self for the aRestyleHint argument to mean
   // "reresolve our style context but not kids", use eRestyle_Subtree
@@ -293,11 +295,87 @@ private:
   // The total number of animation flushes by this frame constructor.
   // Used to keep the layer and animation manager in sync.
   uint64_t mAnimationGeneration;
 
   RestyleTracker mPendingRestyles;
   RestyleTracker mPendingAnimationRestyles;
 };
 
+/**
+ * An ElementRestyler is created for *each* element in a subtree that we
+ * recompute styles for.
+ */
+class ElementRestyler MOZ_FINAL {
+public:
+  // Construct for the root of the subtree that we're restyling.
+  ElementRestyler(nsIFrame* aFrame, nsIContent* aParentElement,
+                  TreeMatchContext& aTreeMatchContext,
+                  nsRestyleHint aRestyleHint, nsChangeHint aMinChange,
+                  RestyleTracker& aRestyleTracker,
+                  nsTArray<nsIContent*>& aVisibleKidsOfHiddenElement,
+                  nsStyleChangeList* aChangeList);
+
+  // Construct for an element whose parent is being restyled.
+  ElementRestyler(const ElementRestyler& aParentRestyler, nsIFrame* aFrame);
+
+  /**
+   * Restyle our frame's element and its subtree.
+   */
+  void Restyle();
+
+private:
+  /**
+   * First half of Restyle().
+   */
+  void RestyleSelf();
+
+  /**
+   * Restyle the children of this frame (and, in turn, their children).
+   *
+   * Second half of Restyle().
+   */
+  void RestyleChildren();
+
+  /**
+   * Helpers for RestyleSelf().
+   */
+  void CaptureChange(nsStyleContext* aOldContext, nsStyleContext* aNewContext,
+                     nsChangeHint aChangeToAssume);
+
+  /**
+   * Helpers for RestyleChildren().
+   */
+  void InitializeAccessibilityNotifications();
+  void RestyleBeforeChild();
+  void RestyleAfterChild();
+  void RestyleContentChildren();
+  void SendAccessibilityNotifications();
+
+  enum DesiredA11yNotifications {
+    eSkipNotifications,
+    eSendAllNotifications,
+    eNotifyIfShown
+  };
+
+  enum A11yNotificationType {
+    eDontNotify,
+    eNotifyShown,
+    eNotifyHidden
+  };
+
+private:
+  nsIFrame* const mFrame;
+  nsIContent* const mParentContent;
+  nsIContent* const mContent;
+  TreeMatchContext& mTreeMatchContext;
+  nsRestyleHint const mRestyleHint;
+  nsChangeHint mMinChange;
+  DesiredA11yNotifications mDesiredA11yNotifications;
+  nsTArray<nsIContent*>& mVisibleKidsOfHiddenElement;
+  nsChangeHint mParentHintsNotHandledForDescendants;
+  nsChangeHint mHintsNotHandledForDescendants;
+  DesiredA11yNotifications mKidsDesiredA11yNotifications;
+};
+
 } // namespace mozilla
 
 #endif /* mozilla_RestyleManager_h */

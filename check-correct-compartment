From: Andreas Gal <gal@uci.edu>

Check correct compartment.  (Bug 606390)

diff --git a/js/src/xpconnect/src/xpcconvert.cpp b/js/src/xpconnect/src/xpcconvert.cpp
--- a/js/src/xpconnect/src/xpcconvert.cpp
+++ b/js/src/xpconnect/src/xpcconvert.cpp
@@ -1205,18 +1205,17 @@ XPCConvert::NativeInterface2JSObject(XPC
         if(!dest)
         {
             if(!flat)
             {
                 tryConstructSlimWrapper = PR_TRUE;
             }
             else if(IS_SLIM_WRAPPER_OBJECT(flat))
             {
-                if(flat->getCompartment() ==
-                   xpcscope->GetGlobalJSObject()->getCompartment())
+                if(flat->compartment() == cx->compartment)
                 {
                     *d = OBJECT_TO_JSVAL(flat);
                     return JS_TRUE;
                 }
             }
         }
     }
     else

From: L. David Baron <dbaron@dbaron.org>

Build font data structure by walking the necessary text.  (Bug 706193, bug 707195)

diff --git a/layout/generic/nsFontInflationData.cpp b/layout/generic/nsFontInflationData.cpp
--- a/layout/generic/nsFontInflationData.cpp
+++ b/layout/generic/nsFontInflationData.cpp
@@ -49,22 +49,49 @@ DestroyFontInflationData(void *aProperty
 }
 
 NS_DECLARE_FRAME_PROPERTY(FontInflationDataProperty, DestroyFontInflationData);
 
 /* static */ nsFontInflationData*
 nsFontInflationData::FontInflationDataFor(nsIFrame *aFrame)
 {
   // We have one set of font inflation data per block formatting context.
-  FrameProperties bfcProps = BlockFormattingContextFor(aFrame)->Properties();
+  nsIFrame *bfc = BlockFormattingContextFor(aFrame);
+  FrameProperties bfcProps = bfc->Properties();
 
   // If we already have a data object, return it.
   nsFontInflationData *data = static_cast<nsFontInflationData*>(
                                 bfcProps.Get(FontInflationDataProperty()));
   if (data) {
     return data;
   }
 
   // Otherwise, make a new data object.
-  data = new nsFontInflationData();
+  data = new nsFontInflationData(bfc);
   bfcProps.Set(FontInflationDataProperty(), data);
   return data;
 }
+
+nsFontInflationData::nsFontInflationData(nsIFrame *aFrame)
+{
+  NS_ASSERTION(IsBlockFormattingContext(aFrame),
+               "must be block formatting context");
+
+  ScanText(aFrame);
+}
+
+void
+nsFontInflationData::ScanText(nsIFrame *aFrame)
+{
+  nsIFrame::ChildListIterator lists(aFrame);
+  for (; !lists.IsDone(); lists.Next()) {
+    nsFrameList::Enumerator kids(lists.CurrentList());
+    for (; !kids.AtEnd(); kids.Next()) {
+      nsIFrame *kid = kids.get();
+      if (kid->GetType() == nsGkAtoms::textFrame) {
+        // FIXME: scan the text
+      } else if (!IsBlockFormattingContext(kid)) {
+        // recursive step
+        ScanText(aFrame);
+      }
+    }
+  }
+}
diff --git a/layout/generic/nsFontInflationData.h b/layout/generic/nsFontInflationData.h
--- a/layout/generic/nsFontInflationData.h
+++ b/layout/generic/nsFontInflationData.h
@@ -45,18 +45,26 @@
 #include "nsBlockFrame.h"
 
 class nsFontInflationData
 {
 public:
 
   static nsFontInflationData* FontInflationDataFor(nsIFrame *aFrame);
 
+  nsFontInflationData(nsIFrame *aFrame);
+
 private:
 
+  nsFontInflationData(const nsFontInflationData&) MOZ_DELETE;
+  void operator=(const nsFontInflationData&) MOZ_DELETE;
+
+  // Scan text in the subtree rooted at aFrame
+  void ScanText(nsIFrame* aFrame);
+
   static nsIFrame* BlockFormattingContextFor(nsIFrame *aFrame)
   {
     while (!IsBlockFormattingContext(aFrame)) {
       aFrame = aFrame->GetParent();
     }
     return aFrame;
   }
 

Destroy the old rule tree *after* processing the change list, in case the change list has frame reconstructs in it.  Patch from Eli Friedman <sharparrow1@yahoo.com>.  r+sr+a1.9=dbaron  b=389744

diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -722,10 +722,14 @@ nsPresContext::ClearStyleDataAndReflow()
     nsStyleChangeList changeList;
     mShell->FrameManager()->ComputeStyleChangeFor(mShell->GetRootFrame(),
                                                   &changeList, nsChangeHint(0));
-    // Tell the style set it's safe to destroy the old rule tree
-    mShell->StyleSet()->EndReconstruct();
     // Tell the frame constructor to process the required changes
     mShell->FrameConstructor()->ProcessRestyledFrames(changeList);
+    // Tell the style set it's safe to destroy the old rule tree.  We
+    // must do this after the ProcessRestyledFrames call in case the
+    // change list has frame reconstructs in it (since frames to be
+    // reconstructed will still have their old style context pointers
+    // until they are destroyed).
+    mShell->StyleSet()->EndReconstruct();
   }
 }
 

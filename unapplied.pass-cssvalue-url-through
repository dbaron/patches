From: L. David Baron <dbaron@dbaron.org>

Pass nsCSSValue::URL objects through the style system so that we can send correct Referer headers.

diff --git a/layout/style/nsComputedDOMStyle.cpp b/layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp
+++ b/layout/style/nsComputedDOMStyle.cpp
@@ -4175,17 +4175,17 @@ nsComputedDOMStyle::GetSVGPaintFor(PRBoo
 
     nsROCSSPrimitiveValue* fallback = GetROCSSPrimitiveValue();
     if (!fallback || !valueList->AppendCSSValue(fallback)) {
       delete valueList;
       delete fallback;
       return NS_ERROR_OUT_OF_MEMORY;
     }
 
-    val->SetURI(paint->mPaint.mPaintServer);
+    val->SetURI(paint->mPaint.mPaintServer->mURI);
     nsresult rv = SetToRGBAColor(fallback, paint->mFallbackColor);
     if (NS_FAILED(rv)) {
       delete valueList;
       return rv;
     }
 
     NS_ADDREF(*aValue = valueList);
     return NS_OK;
@@ -4212,51 +4212,51 @@ nsresult
 nsComputedDOMStyle::DoGetMarkerEnd(nsIDOMCSSValue** aValue)
 {
   nsROCSSPrimitiveValue* val = GetROCSSPrimitiveValue();
   NS_ENSURE_TRUE(val, NS_ERROR_OUT_OF_MEMORY);
 
   const nsStyleSVG* svg = GetStyleSVG();
 
   if (svg->mMarkerEnd)
-    val->SetURI(svg->mMarkerEnd);
+    val->SetURI(svg->mMarkerEnd->mURI);
   else
     val->SetIdent(eCSSKeyword_none);
 
   NS_ADDREF(*aValue = val);
   return NS_OK;
 }
 
 nsresult
 nsComputedDOMStyle::DoGetMarkerMid(nsIDOMCSSValue** aValue)
 {
   nsROCSSPrimitiveValue* val = GetROCSSPrimitiveValue();
   NS_ENSURE_TRUE(val, NS_ERROR_OUT_OF_MEMORY);
 
   const nsStyleSVG* svg = GetStyleSVG();
 
   if (svg->mMarkerMid)
-    val->SetURI(svg->mMarkerMid);
+    val->SetURI(svg->mMarkerMid->mURI);
   else
     val->SetIdent(eCSSKeyword_none);
 
   NS_ADDREF(*aValue = val);
   return NS_OK;
 }
 
 nsresult
 nsComputedDOMStyle::DoGetMarkerStart(nsIDOMCSSValue** aValue)
 {
   nsROCSSPrimitiveValue* val = GetROCSSPrimitiveValue();
   NS_ENSURE_TRUE(val, NS_ERROR_OUT_OF_MEMORY);
 
   const nsStyleSVG* svg = GetStyleSVG();
 
   if (svg->mMarkerStart)
-    val->SetURI(svg->mMarkerStart);
+    val->SetURI(svg->mMarkerStart->mURI);
   else
     val->SetIdent(eCSSKeyword_none);
 
   NS_ADDREF(*aValue = val);
   return NS_OK;
 }
 
 nsresult
@@ -4578,51 +4578,51 @@ nsresult
 nsComputedDOMStyle::DoGetClipPath(nsIDOMCSSValue** aValue)
 {
   nsROCSSPrimitiveValue* val = GetROCSSPrimitiveValue();
   NS_ENSURE_TRUE(val, NS_ERROR_OUT_OF_MEMORY);
 
   const nsStyleSVGReset* svg = GetStyleSVGReset();
 
   if (svg->mClipPath)
-    val->SetURI(svg->mClipPath);
+    val->SetURI(svg->mClipPath->mURI);
   else
     val->SetIdent(eCSSKeyword_none);
 
   NS_ADDREF(*aValue = val);
   return NS_OK;
 }
 
 nsresult
 nsComputedDOMStyle::DoGetFilter(nsIDOMCSSValue** aValue)
 {
   nsROCSSPrimitiveValue* val = GetROCSSPrimitiveValue();
   NS_ENSURE_TRUE(val, NS_ERROR_OUT_OF_MEMORY);
 
   const nsStyleSVGReset* svg = GetStyleSVGReset();
 
   if (svg->mFilter)
-    val->SetURI(svg->mFilter);
+    val->SetURI(svg->mFilter->mURI);
   else
     val->SetIdent(eCSSKeyword_none);
 
   NS_ADDREF(*aValue = val);
   return NS_OK;
 }
 
 nsresult
 nsComputedDOMStyle::DoGetMask(nsIDOMCSSValue** aValue)
 {
   nsROCSSPrimitiveValue* val = GetROCSSPrimitiveValue();
   NS_ENSURE_TRUE(val, NS_ERROR_OUT_OF_MEMORY);
 
   const nsStyleSVGReset* svg = GetStyleSVGReset();
 
   if (svg->mMask)
-    val->SetURI(svg->mMask);
+    val->SetURI(svg->mMask->mURI);
   else
     val->SetIdent(eCSSKeyword_none);
 
   NS_ADDREF(*aValue = val);
   return NS_OK;
 }
 
 nsresult
diff --git a/layout/style/nsRuleNode.cpp b/layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp
+++ b/layout/style/nsRuleNode.cpp
@@ -6108,18 +6108,18 @@ SetSVGPaint(const nsCSSValue& aValue, co
     aResult.SetType(eStyleSVGPaintType_Color);
     aResult.mPaint.mColor = color;
   } else if (aValue.GetUnit() == eCSSUnit_Pair) {
     const nsCSSValuePair& pair = aValue.GetPairValue();
     NS_ABORT_IF_FALSE(pair.mXValue.GetUnit() == eCSSUnit_URL,
                       "malformed paint server value");
 
     aResult.SetType(eStyleSVGPaintType_Server);
-    aResult.mPaint.mPaintServer = pair.mXValue.GetURLValue();
-    NS_IF_ADDREF(aResult.mPaint.mPaintServer);
+    aResult.mPaint.mPaintServer = pair.mXValue.GetURLStructValue();
+    aResult.mPaint.mPaintServer->AddRef();
 
     if (pair.mYValue.GetUnit() == eCSSUnit_None) {
       aResult.mFallbackColor = NS_RGBA(0, 0, 0, 0);
     } else {
       NS_ABORT_IF_FALSE(pair.mYValue.GetUnit() != eCSSUnit_Inherit,
                         "cannot inherit fallback colour");
       SetColor(pair.mYValue, NS_RGB(0, 0, 0), aPresContext, aContext,
                aResult.mFallbackColor, aCanStoreInRuleTree);
@@ -6172,39 +6172,39 @@ nsRuleNode::ComputeSVGData(void* aStartS
 
   // image-rendering: enum, inherit
   SetDiscrete(SVGData.mImageRendering, svg->mImageRendering, canStoreInRuleTree,
               SETDSC_ENUMERATED, parentSVG->mImageRendering,
               NS_STYLE_IMAGE_RENDERING_AUTO, 0, 0, 0, 0);
 
   // marker-end: url, none, inherit
   if (eCSSUnit_URL == SVGData.mMarkerEnd.GetUnit()) {
-    svg->mMarkerEnd = SVGData.mMarkerEnd.GetURLValue();
+    svg->mMarkerEnd = SVGData.mMarkerEnd.GetURLStructValue();
   } else if (eCSSUnit_None == SVGData.mMarkerEnd.GetUnit() ||
              eCSSUnit_Initial == SVGData.mMarkerEnd.GetUnit()) {
     svg->mMarkerEnd = nsnull;
   } else if (eCSSUnit_Inherit == SVGData.mMarkerEnd.GetUnit()) {
     canStoreInRuleTree = PR_FALSE;
     svg->mMarkerEnd = parentSVG->mMarkerEnd;
   }
 
   // marker-mid: url, none, inherit
   if (eCSSUnit_URL == SVGData.mMarkerMid.GetUnit()) {
-    svg->mMarkerMid = SVGData.mMarkerMid.GetURLValue();
+    svg->mMarkerMid = SVGData.mMarkerMid.GetURLStructValue();
   } else if (eCSSUnit_None == SVGData.mMarkerMid.GetUnit() ||
              eCSSUnit_Initial == SVGData.mMarkerMid.GetUnit()) {
     svg->mMarkerMid = nsnull;
   } else if (eCSSUnit_Inherit == SVGData.mMarkerMid.GetUnit()) {
     canStoreInRuleTree = PR_FALSE;
     svg->mMarkerMid = parentSVG->mMarkerMid;
   }
 
   // marker-start: url, none, inherit
   if (eCSSUnit_URL == SVGData.mMarkerStart.GetUnit()) {
-    svg->mMarkerStart = SVGData.mMarkerStart.GetURLValue();
+    svg->mMarkerStart = SVGData.mMarkerStart.GetURLStructValue();
   } else if (eCSSUnit_None == SVGData.mMarkerStart.GetUnit() ||
              eCSSUnit_Initial == SVGData.mMarkerStart.GetUnit()) {
     svg->mMarkerStart = nsnull;
   } else if (eCSSUnit_Inherit == SVGData.mMarkerStart.GetUnit()) {
     canStoreInRuleTree = PR_FALSE;
     svg->mMarkerStart = parentSVG->mMarkerStart;
   }
 
@@ -6360,17 +6360,17 @@ nsRuleNode::ComputeSVGResetData(void* aS
   } else {
     SetColor(SVGData.mLightingColor, parentSVGReset->mLightingColor,
              mPresContext, aContext, svgReset->mLightingColor,
              canStoreInRuleTree);
   }
 
   // clip-path: url, none, inherit
   if (eCSSUnit_URL == SVGData.mClipPath.GetUnit()) {
-    svgReset->mClipPath = SVGData.mClipPath.GetURLValue();
+    svgReset->mClipPath = SVGData.mClipPath.GetURLStructValue();
   } else if (eCSSUnit_None == SVGData.mClipPath.GetUnit() ||
              eCSSUnit_Initial == SVGData.mClipPath.GetUnit()) {
     svgReset->mClipPath = nsnull;
   } else if (eCSSUnit_Inherit == SVGData.mClipPath.GetUnit()) {
     canStoreInRuleTree = PR_FALSE;
     svgReset->mClipPath = parentSVGReset->mClipPath;
   }
 
@@ -6385,28 +6385,28 @@ nsRuleNode::ComputeSVGResetData(void* aS
   // dominant-baseline: enum, inherit, initial
   SetDiscrete(SVGData.mDominantBaseline, svgReset->mDominantBaseline,
               canStoreInRuleTree, SETDSC_ENUMERATED,
               parentSVGReset->mDominantBaseline,
               NS_STYLE_DOMINANT_BASELINE_AUTO, 0, 0, 0, 0);
 
   // filter: url, none, inherit
   if (eCSSUnit_URL == SVGData.mFilter.GetUnit()) {
-    svgReset->mFilter = SVGData.mFilter.GetURLValue();
+    svgReset->mFilter = SVGData.mFilter.GetURLStructValue();
   } else if (eCSSUnit_None == SVGData.mFilter.GetUnit() ||
              eCSSUnit_Initial == SVGData.mFilter.GetUnit()) {
     svgReset->mFilter = nsnull;
   } else if (eCSSUnit_Inherit == SVGData.mFilter.GetUnit()) {
     canStoreInRuleTree = PR_FALSE;
     svgReset->mFilter = parentSVGReset->mFilter;
   }
 
   // mask: url, none, inherit
   if (eCSSUnit_URL == SVGData.mMask.GetUnit()) {
-    svgReset->mMask = SVGData.mMask.GetURLValue();
+    svgReset->mMask = SVGData.mMask.GetURLStructValue();
   } else if (eCSSUnit_None == SVGData.mMask.GetUnit() ||
              eCSSUnit_Initial == SVGData.mMask.GetUnit()) {
     svgReset->mMask = nsnull;
   } else if (eCSSUnit_Inherit == SVGData.mMask.GetUnit()) {
     canStoreInRuleTree = PR_FALSE;
     svgReset->mMask = parentSVGReset->mMask;
   }
 
diff --git a/layout/style/nsStyleStruct.cpp b/layout/style/nsStyleStruct.cpp
--- a/layout/style/nsStyleStruct.cpp
+++ b/layout/style/nsStyleStruct.cpp
@@ -1054,17 +1054,17 @@ nsChangeHint nsStyleSVGReset::MaxDiffere
                                        nsChangeHint_RepaintFrame);
 }
 #endif
 
 // nsStyleSVGPaint implementation
 nsStyleSVGPaint::~nsStyleSVGPaint()
 {
   if (mType == eStyleSVGPaintType_Server) {
-    NS_IF_RELEASE(mPaint.mPaintServer);
+    mPaint.mPaintServer->Release();
   }
 }
 
 void
 nsStyleSVGPaint::SetType(nsStyleSVGPaintType aType)
 {
   if (mType == eStyleSVGPaintType_Server) {
     this->~nsStyleSVGPaint();
@@ -1078,17 +1078,17 @@ nsStyleSVGPaint& nsStyleSVGPaint::operat
   if (this == &aOther)
     return *this;
 
   SetType(aOther.mType);
 
   mFallbackColor = aOther.mFallbackColor;
   if (mType == eStyleSVGPaintType_Server) {
     mPaint.mPaintServer = aOther.mPaint.mPaintServer;
-    NS_IF_ADDREF(mPaint.mPaintServer);
+    mPaint.mPaintServer->AddRef();
   } else {
     mPaint.mColor = aOther.mPaint.mColor;
   }
   return *this;
 }
 
 PRBool nsStyleSVGPaint::operator==(const nsStyleSVGPaint& aOther) const
 {
diff --git a/layout/style/nsStyleStruct.h b/layout/style/nsStyleStruct.h
--- a/layout/style/nsStyleStruct.h
+++ b/layout/style/nsStyleStruct.h
@@ -56,17 +56,16 @@
 #include "nsStyleCoord.h"
 #include "nsStyleConsts.h"
 #include "nsChangeHint.h"
 #include "nsPresContext.h"
 #include "nsCOMPtr.h"
 #include "nsCOMArray.h"
 #include "nsTArray.h"
 #include "nsIAtom.h"
-#include "nsIURI.h"
 #include "nsCSSValue.h"
 #include "nsStyleTransformMatrix.h"
 #include "nsAlgorithm.h"
 #include "imgIRequest.h"
 #include "gfxRect.h"
 
 class nsIFrame;
 class imgIRequest;
@@ -1913,17 +1912,17 @@ enum nsStyleSVGPaintType {
   eStyleSVGPaintType_Color,
   eStyleSVGPaintType_Server
 };
 
 struct nsStyleSVGPaint
 {
   union {
     nscolor mColor;
-    nsIURI *mPaintServer;
+    nsCSSValue::URL *mPaintServer;
   } mPaint;
   nsStyleSVGPaintType mType;
   nscolor mFallbackColor;
 
   nsStyleSVGPaint() : mType(nsStyleSVGPaintType(0)) { mPaint.mPaintServer = nsnull; }
   ~nsStyleSVGPaint();
   void SetType(nsStyleSVGPaintType aType);
   nsStyleSVGPaint& operator=(const nsStyleSVGPaint& aOther);
@@ -1950,19 +1949,19 @@ struct nsStyleSVG {
   nsChangeHint CalcDifference(const nsStyleSVG& aOther) const;
 #ifdef DEBUG
   static nsChangeHint MaxDifference();
 #endif
   static PRBool ForceCompare() { return PR_FALSE; }
 
   nsStyleSVGPaint  mFill;             // [inherited]
   nsStyleSVGPaint  mStroke;           // [inherited]
-  nsCOMPtr<nsIURI> mMarkerEnd;        // [inherited]
-  nsCOMPtr<nsIURI> mMarkerMid;        // [inherited]
-  nsCOMPtr<nsIURI> mMarkerStart;      // [inherited]
+  nsRefPtr<nsCSSValue::URL> mMarkerEnd; // [inherited]
+  nsRefPtr<nsCSSValue::URL> mMarkerMid; // [inherited]
+  nsRefPtr<nsCSSValue::URL> mMarkerStart; // [inherited]
   nsStyleCoord    *mStrokeDasharray;  // [inherited] coord, percent, factor
 
   nsStyleCoord     mStrokeDashoffset; // [inherited] coord, percent, factor
   nsStyleCoord     mStrokeWidth;      // [inherited] coord, percent, factor
 
   float            mFillOpacity;      // [inherited]
   float            mStrokeMiterlimit; // [inherited]
   float            mStrokeOpacity;    // [inherited]
@@ -1994,19 +1993,19 @@ struct nsStyleSVGReset {
   }
 
   nsChangeHint CalcDifference(const nsStyleSVGReset& aOther) const;
 #ifdef DEBUG
   static nsChangeHint MaxDifference();
 #endif
   static PRBool ForceCompare() { return PR_FALSE; }
 
-  nsCOMPtr<nsIURI> mClipPath;         // [reset]
-  nsCOMPtr<nsIURI> mFilter;           // [reset]
-  nsCOMPtr<nsIURI> mMask;             // [reset]
+  nsRefPtr<nsCSSValue::URL> mClipPath;// [reset]
+  nsRefPtr<nsCSSValue::URL> mFilter;  // [reset]
+  nsRefPtr<nsCSSValue::URL> mMask;    // [reset]
   nscolor          mStopColor;        // [reset]
   nscolor          mFloodColor;       // [reset]
   nscolor          mLightingColor;    // [reset]
 
   float            mStopOpacity;      // [reset]
   float            mFloodOpacity;     // [reset]
 
   PRUint8          mDominantBaseline; // [reset] see nsStyleConsts.h
diff --git a/layout/svg/base/src/nsSVGEffects.cpp b/layout/svg/base/src/nsSVGEffects.cpp
--- a/layout/svg/base/src/nsSVGEffects.cpp
+++ b/layout/svg/base/src/nsSVGEffects.cpp
@@ -96,27 +96,29 @@ nsSVGRenderingObserver::StopListening()
 
 #ifdef _MSC_VER
 // Disable "warning C4355: 'this' : used in base member initializer list".
 // We can ignore that warning because we know that mElement's constructor 
 // doesn't dereference the pointer passed to it.
 #pragma warning(push)
 #pragma warning(disable:4355)
 #endif
-nsSVGIDRenderingObserver::nsSVGIDRenderingObserver(nsIURI *aURI,
+nsSVGIDRenderingObserver::nsSVGIDRenderingObserver(nsCSSValue::URL *aURI,
                                                    nsIFrame *aFrame,
                                                    PRBool aReferenceImage)
   : mElement(this), mFrame(aFrame),
     mFramePresShell(aFrame->PresContext()->PresShell())
 #ifdef _MSC_VER
 #pragma warning(pop)
 #endif
 {
   // Start watching the target element
-  mElement.Reset(aFrame->GetContent(), aURI, PR_TRUE, aReferenceImage);
+  // FIXME: Should pass more information from nsCSSValue::URL.
+  mElement.Reset(aFrame->GetContent(), aURI ? aURI->mURI : nsnull,
+                 PR_TRUE, aReferenceImage);
   StartListening();
 }
 
 nsSVGIDRenderingObserver::~nsSVGIDRenderingObserver()
 {
   StopListening();
 }
 
@@ -322,35 +324,36 @@ nsSVGPaintingProperty::DoUpdate()
   if (mFrame->IsFrameOfType(nsIFrame::eSVG)) {
     nsSVGUtils::InvalidateCoveredRegion(mFrame);
   } else {
     InvalidateAllContinuations(mFrame);
   }
 }
 
 static nsSVGRenderingObserver *
-CreateFilterProperty(nsIURI *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
+CreateFilterProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
 { return new nsSVGFilterProperty(aURI, aFrame, aReferenceImage); }
 
 static nsSVGRenderingObserver *
-CreateMarkerProperty(nsIURI *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
+CreateMarkerProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
 { return new nsSVGMarkerProperty(aURI, aFrame, aReferenceImage); }
 
 static nsSVGRenderingObserver *
-CreateTextPathProperty(nsIURI *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
+CreateTextPathProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
 { return new nsSVGTextPathProperty(aURI, aFrame, aReferenceImage); }
 
 static nsSVGRenderingObserver *
-CreatePaintingProperty(nsIURI *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
+CreatePaintingProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
 { return new nsSVGPaintingProperty(aURI, aFrame, aReferenceImage); }
 
 static nsSVGRenderingObserver *
-GetEffectProperty(nsIURI *aURI, nsIFrame *aFrame,
+GetEffectProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
                   const FramePropertyDescriptor *aProperty,
-                  nsSVGRenderingObserver * (* aCreate)(nsIURI *, nsIFrame *, PRBool))
+                  nsSVGRenderingObserver * (* aCreate)(nsCSSValue::URL *,
+                                                       nsIFrame *, PRBool))
 {
   if (!aURI)
     return nsnull;
 
   FrameProperties props = aFrame->Properties();
   nsSVGRenderingObserver *prop =
     static_cast<nsSVGRenderingObserver*>(props.Get(aProperty));
   if (prop)
@@ -359,33 +362,33 @@ GetEffectProperty(nsIURI *aURI, nsIFrame
   if (!prop)
     return nsnull;
   NS_ADDREF(prop);
   props.Set(aProperty, static_cast<nsISupports*>(prop));
   return prop;
 }
 
 nsSVGMarkerProperty *
-nsSVGEffects::GetMarkerProperty(nsIURI *aURI, nsIFrame *aFrame,
+nsSVGEffects::GetMarkerProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
                                 const FramePropertyDescriptor *aProp)
 {
   return static_cast<nsSVGMarkerProperty*>(
           GetEffectProperty(aURI, aFrame, aProp, CreateMarkerProperty));
 }
 
 nsSVGTextPathProperty *
-nsSVGEffects::GetTextPathProperty(nsIURI *aURI, nsIFrame *aFrame,
+nsSVGEffects::GetTextPathProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
                                   const FramePropertyDescriptor *aProp)
 {
   return static_cast<nsSVGTextPathProperty*>(
           GetEffectProperty(aURI, aFrame, aProp, CreateTextPathProperty));
 }
 
 nsSVGPaintingProperty *
-nsSVGEffects::GetPaintingProperty(nsIURI *aURI, nsIFrame *aFrame,
+nsSVGEffects::GetPaintingProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
                                   const FramePropertyDescriptor *aProp)
 {
   return static_cast<nsSVGPaintingProperty*>(
           GetEffectProperty(aURI, aFrame, aProp, CreatePaintingProperty));
 }
 
 static nsSVGRenderingObserver *
 GetEffectPropertyForURI(nsIURI *aURI, nsIFrame *aFrame,
diff --git a/layout/svg/base/src/nsSVGEffects.h b/layout/svg/base/src/nsSVGEffects.h
--- a/layout/svg/base/src/nsSVGEffects.h
+++ b/layout/svg/base/src/nsSVGEffects.h
@@ -40,16 +40,17 @@
 
 #include "nsIContent.h"
 #include "nsIFrame.h"
 #include "nsReferencedElement.h"
 #include "nsStubMutationObserver.h"
 #include "nsSVGUtils.h"
 #include "nsInterfaceHashtable.h"
 #include "nsURIHashKey.h"
+#include "nsCSSValue.h"
 
 class nsSVGClipPathFrame;
 class nsSVGFilterFrame;
 class nsSVGMaskFrame;
 
 /*
  * This interface allows us to be notified when a piece of SVG content is
  * re-rendered.
@@ -115,18 +116,18 @@ protected:
  * 
  * When a frame references a supporting resource, we create a property
  * object derived from nsSVGIDRenderingObserver to manage the relationship. The
  * property object is attached to the referencing frame.
  */
 class nsSVGIDRenderingObserver : public nsSVGRenderingObserver {
 public:
   typedef mozilla::dom::Element Element;
-  nsSVGIDRenderingObserver(nsIURI* aURI, nsIFrame *aFrame,
-                         PRBool aReferenceImage);
+  nsSVGIDRenderingObserver(nsCSSValue::URL* aURI, nsIFrame *aFrame,
+                           PRBool aReferenceImage);
   virtual ~nsSVGIDRenderingObserver();
 
 protected:
   Element* GetTarget() { return mElement.get(); }
 
   // This is called when the referenced resource changes.
   virtual void DoUpdate();
 
@@ -158,17 +159,17 @@ protected:
   // we test the presshell to see if it's destroying itself. If it is,
   // then the frame pointer is not valid and we know the frame has gone away.
   nsIPresShell *mFramePresShell;
 };
 
 class nsSVGFilterProperty :
   public nsSVGIDRenderingObserver, public nsISVGFilterProperty {
 public:
-  nsSVGFilterProperty(nsIURI *aURI, nsIFrame *aFilteredFrame,
+  nsSVGFilterProperty(nsCSSValue::URL *aURI, nsIFrame *aFilteredFrame,
                       PRBool aReferenceImage)
     : nsSVGIDRenderingObserver(aURI, aFilteredFrame, aReferenceImage) {}
 
   /**
    * @return the filter frame, or null if there is no filter frame
    */
   nsSVGFilterFrame *GetFilterFrame();
 
@@ -180,35 +181,38 @@ public:
 
 private:
   // nsSVGRenderingObserver
   virtual void DoUpdate();
 };
 
 class nsSVGMarkerProperty : public nsSVGIDRenderingObserver {
 public:
-  nsSVGMarkerProperty(nsIURI *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
+  nsSVGMarkerProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
+                      PRBool aReferenceImage)
     : nsSVGIDRenderingObserver(aURI, aFrame, aReferenceImage) {}
 
 protected:
   virtual void DoUpdate();
 };
 
 class nsSVGTextPathProperty : public nsSVGIDRenderingObserver {
 public:
-  nsSVGTextPathProperty(nsIURI *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
+  nsSVGTextPathProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
+                        PRBool aReferenceImage)
     : nsSVGIDRenderingObserver(aURI, aFrame, aReferenceImage) {}
 
 protected:
   virtual void DoUpdate();
 };
  
 class nsSVGPaintingProperty : public nsSVGIDRenderingObserver {
 public:
-  nsSVGPaintingProperty(nsIURI *aURI, nsIFrame *aFrame, PRBool aReferenceImage)
+  nsSVGPaintingProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
+                        PRBool aReferenceImage)
     : nsSVGIDRenderingObserver(aURI, aFrame, aReferenceImage) {}
 
 protected:
   virtual void DoUpdate();
 };
 
 /**
  * A manager for one-shot nsSVGRenderingObserver tracking.
@@ -371,29 +375,29 @@ public:
    */
   static void InvalidateDirectRenderingObservers(Element *aElement);
   static void InvalidateDirectRenderingObservers(nsIFrame *aFrame);
 
   /**
    * Get an nsSVGMarkerProperty for the frame, creating a fresh one if necessary
    */
   static nsSVGMarkerProperty *
-  GetMarkerProperty(nsIURI *aURI, nsIFrame *aFrame,
+  GetMarkerProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
                     const FramePropertyDescriptor *aProperty);
   /**
    * Get an nsSVGTextPathProperty for the frame, creating a fresh one if necessary
    */
   static nsSVGTextPathProperty *
-  GetTextPathProperty(nsIURI *aURI, nsIFrame *aFrame,
+  GetTextPathProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
                       const FramePropertyDescriptor *aProperty);
   /**
    * Get an nsSVGPaintingProperty for the frame, creating a fresh one if necessary
    */
   static nsSVGPaintingProperty *
-  GetPaintingProperty(nsIURI *aURI, nsIFrame *aFrame,
+  GetPaintingProperty(nsCSSValue::URL *aURI, nsIFrame *aFrame,
                       const FramePropertyDescriptor *aProperty);
   /**
    * Get an nsSVGPaintingProperty for the frame for that URI, creating a fresh
    * one if necessary
    */
   static nsSVGPaintingProperty *
   GetPaintingPropertyForURI(nsIURI *aURI, nsIFrame *aFrame,
                             const FramePropertyDescriptor *aProp);
diff --git a/layout/svg/base/src/nsSVGGradientFrame.cpp b/layout/svg/base/src/nsSVGGradientFrame.cpp
--- a/layout/svg/base/src/nsSVGGradientFrame.cpp
+++ b/layout/svg/base/src/nsSVGGradientFrame.cpp
@@ -277,21 +277,27 @@ nsSVGGradientFrame::GetReferencedGradien
     if (href.IsEmpty()) {
       mNoHRefURI = PR_TRUE;
       return nsnull; // no URL
     }
 
     // Convert href to an nsIURI
     nsCOMPtr<nsIURI> targetURI;
     nsCOMPtr<nsIURI> base = mContent->GetBaseURI();
+    nsIDocument *doc = mContent->GetOwnerDoc(); // REVIEW: was GetCurrentDoc
     nsContentUtils::NewURIWithDocumentCharset(getter_AddRefs(targetURI), href,
-                                              mContent->GetCurrentDoc(), base);
+                                              doc, base);
+    nsRefPtr<nsCSSValue::URL> url =
+      new nsCSSValue::URL(targetURI,
+                          nsCSSValue::BufferFromString(href),
+                          doc->GetDocumentURI(),
+                          mContent->NodePrincipal());
 
     property =
-      nsSVGEffects::GetPaintingProperty(targetURI, this, nsSVGEffects::HrefProperty());
+      nsSVGEffects::GetPaintingProperty(url, this, nsSVGEffects::HrefProperty());
     if (!property)
       return nsnull;
   }
 
   nsIFrame *result = property->GetReferencedFrame();
   if (!result)
     return nsnull;
 
diff --git a/layout/svg/base/src/nsSVGPatternFrame.cpp b/layout/svg/base/src/nsSVGPatternFrame.cpp
--- a/layout/svg/base/src/nsSVGPatternFrame.cpp
+++ b/layout/svg/base/src/nsSVGPatternFrame.cpp
@@ -438,21 +438,27 @@ nsSVGPatternFrame::GetReferencedPattern(
     if (href.IsEmpty()) {
       mNoHRefURI = PR_TRUE;
       return nsnull; // no URL
     }
 
     // Convert href to an nsIURI
     nsCOMPtr<nsIURI> targetURI;
     nsCOMPtr<nsIURI> base = mContent->GetBaseURI();
+    nsIDocument *doc = mContent->GetOwnerDoc(); // REVIEW: was GetCurrentDoc
     nsContentUtils::NewURIWithDocumentCharset(getter_AddRefs(targetURI), href,
-                                              mContent->GetCurrentDoc(), base);
+                                              doc, base);
+    nsRefPtr<nsCSSValue::URL> url =
+      new nsCSSValue::URL(targetURI,
+                          nsCSSValue::BufferFromString(href),
+                          doc->GetDocumentURI(),
+                          mContent->NodePrincipal());
 
     property =
-      nsSVGEffects::GetPaintingProperty(targetURI, this, nsSVGEffects::HrefProperty());
+      nsSVGEffects::GetPaintingProperty(url, this, nsSVGEffects::HrefProperty());
     if (!property)
       return nsnull;
   }
 
   nsIFrame *result = property->GetReferencedFrame();
   if (!result)
     return nsnull;
 
diff --git a/layout/svg/base/src/nsSVGTextPathFrame.cpp b/layout/svg/base/src/nsSVGTextPathFrame.cpp
--- a/layout/svg/base/src/nsSVGTextPathFrame.cpp
+++ b/layout/svg/base/src/nsSVGTextPathFrame.cpp
@@ -121,21 +121,27 @@ nsSVGTextPathFrame::GetPathFrame()
     nsAutoString href;
     tp->mStringAttributes[nsSVGTextPathElement::HREF].GetAnimValue(href, tp);
     if (href.IsEmpty()) {
       return nsnull; // no URL
     }
 
     nsCOMPtr<nsIURI> targetURI;
     nsCOMPtr<nsIURI> base = mContent->GetBaseURI();
+    nsIDocument *doc = mContent->GetOwnerDoc(); // REVIEW: was GetCurrentDoc
     nsContentUtils::NewURIWithDocumentCharset(getter_AddRefs(targetURI), href,
-                                              mContent->GetCurrentDoc(), base);
+                                              doc, base);
+    nsRefPtr<nsCSSValue::URL> url =
+      new nsCSSValue::URL(targetURI,
+                          nsCSSValue::BufferFromString(href),
+                          doc->GetDocumentURI(),
+                          mContent->NodePrincipal());
 
     property =
-      nsSVGEffects::GetTextPathProperty(targetURI, this, nsSVGEffects::HrefProperty());
+      nsSVGEffects::GetTextPathProperty(url, this, nsSVGEffects::HrefProperty());
     if (!property)
       return nsnull;
   }
 
   return property->GetReferencedFrame(nsGkAtoms::svgPathGeometryFrame, nsnull);
 }
 
 already_AddRefed<gfxFlattenedPath>

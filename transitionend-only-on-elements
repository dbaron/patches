From: L. David Baron <dbaron@dbaron.org>

Fire transitionend events only for transitions on elements (not pseudo-elements).  (Bug 537140)

diff --git a/layout/style/nsTransitionManager.cpp b/layout/style/nsTransitionManager.cpp
--- a/layout/style/nsTransitionManager.cpp
+++ b/layout/style/nsTransitionManager.cpp
@@ -978,22 +978,29 @@ nsTransitionManager::WillRefresh(mozilla
         --i;
         ElementPropertyTransition &pt = et->mPropertyTransitions[i];
         if (pt.IsRemovedSentinel()) {
           // Actually remove transitions one cycle after their
           // completion.  See comment below.
           et->mPropertyTransitions.RemoveElementAt(i);
         } else if (pt.mStartTime + pt.mDuration <= aTime) {
           // This transition has completed.
-          nsCSSProperty prop = pt.mProperty;
-          if (nsCSSProps::PropHasFlags(prop, CSS_PROPERTY_REPORT_OTHER_NAME)) {
-            prop = nsCSSProps::OtherNameFor(prop);
+
+          // Fire transitionend events only for transitions on elements
+          // and not those on pseudo-elements, since we can't target an
+          // event at pseudo-elements.
+          if (et->mElementProperty == nsGkAtoms::transitionsProperty) {
+            nsCSSProperty prop = pt.mProperty;
+            if (nsCSSProps::PropHasFlags(prop, CSS_PROPERTY_REPORT_OTHER_NAME))
+            {
+              prop = nsCSSProps::OtherNameFor(prop);
+            }
+            events.AppendElement(
+              TransitionEventInfo(et->mElement, prop, pt.mDuration));
           }
-          events.AppendElement(
-            TransitionEventInfo(et->mElement, prop, pt.mDuration));
 
           // Leave this transition in the list for one more refresh
           // cycle, since we haven't yet processed its style change, and
           // if we also have (already, or will have from processing
           // transitionend events or other refresh driver notifications)
           // a non-animation style change that would affect it, we need
           // to know not to start a new transition for the transition
           // from the almost-completed value to the final value.
diff --git a/layout/style/test/test_transitions_events.html b/layout/style/test/test_transitions_events.html
--- a/layout/style/test/test_transitions_events.html
+++ b/layout/style/test/test_transitions_events.html
@@ -12,40 +12,48 @@ https://bugzilla.mozilla.org/show_bug.cg
 <style type="text/css">
 
 .bar { margin: 10px; }
 
 #one { -moz-transition-duration: 500ms; -moz-transition-property: all; }
 #two { -moz-transition: margin-left 1s; }
 #three { -moz-transition: margin 0.5s 0.25s; }
 
-#four, #five, #six {
+#four, #five, #six, #seven::before, #seven::after {
   -moz-transition: 500ms color;
   border-color: black; /* don't derive from color */
   -moz-column-rule-color: black; /* don't derive from color */
 }
 
 #four {
   /* give the reversing transition a long duration; the reversing will
      still be quick */
   -moz-transition-duration: 30s;
   -moz-transition-timing-function: cubic-bezier(0, 1, 1, 0);
 }
 
+/* make sure we don't get events for the pseudo-elements */
+#seven::before, #seven::after {
+  content: "x";
+  -moz-transition-duration: 50ms;
+}
+#seven[foo]::before, #seven[foo]::after { color: lime; }
+
 </style>
 <body>
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=531585">Mozilla Bug 531585</a>
 <p id="display">
 
 <span id="one" style="color:blue"></span>
 <span id="two"></span>
 <span id="three"></span>
 <span id="four" style="color: blue"></span>
 <span id="five" style="color: blue"></span>
 <span id="six" style="color: blue"></span>
+<span id="seven" style="color: blue"></span>
 
 </p>
 <pre id="test">
 <script type="application/javascript">
 
 /** Test for Bug 531585 (transitionend event) **/
 
 SimpleTest.waitForExplicitFinish();
@@ -243,16 +251,19 @@ started_test();
 // We cancel the transition on five by changing 'transition-property',
 // and should thus get no event.
 $("five").style.color = "lime";
 
 // We cancel the transition on six by changing 'transition-duration' and
 // then changing the value, so we should get no event.
 $("six").style.color = "lime";
 
+// We should get no events from transitions on pseudo-elements.
+$("seven").setAttribute("foo", "bar");
+
 setTimeout(function() {
              if (cs("five") != "rgb(0, 255, 0)" &&
                  cs("six") != "rgb(0, 255, 0)") {
                // The transition hasn't finished already.
                did_stops = true;
              }
              $("five").style.MozTransitionProperty = "margin-left";
              $("six").style.MozTransitionDuration = "0s";

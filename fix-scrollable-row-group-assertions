From: L. David Baron <dbaron@dbaron.org>

Fix assertions in the scrollable row group case.  (Bug 531461)  r=roc

diff --git a/layout/reftests/table-background/reftest.list b/layout/reftests/table-background/reftest.list
--- a/layout/reftests/table-background/reftest.list
+++ b/layout/reftests/table-background/reftest.list
@@ -46,8 +46,12 @@ fails == border-collapse-opacity-table-c
 == border-collapse-opacity-table-row.html border-collapse-opacity-table-row-ref.html
 == border-collapse-opacity-table.html border-collapse-opacity-table-ref.html
 == border-separate-opacity-table-cell.html border-separate-opacity-table-cell-ref.html
 fails == border-separate-opacity-table-column-group.html border-separate-opacity-table-column-group-ref.html # bug 424274
 fails == border-separate-opacity-table-column.html border-separate-opacity-table-column-ref.html # bug 424274
 == border-separate-opacity-table-row-group.html border-separate-opacity-table-row-group-ref.html
 == border-separate-opacity-table-row.html border-separate-opacity-table-row-ref.html
 == border-separate-opacity-table.html border-separate-opacity-table-ref.html
+!= scrollable-rowgroup-collapse-background.html scrollable-rowgroup-collapse-notref.html
+!= scrollable-rowgroup-collapse-border.html scrollable-rowgroup-collapse-notref.html
+!= scrollable-rowgroup-separate-background.html scrollable-rowgroup-separate-notref.html
+!= scrollable-rowgroup-separate-border.html scrollable-rowgroup-separate-notref.html
diff --git a/layout/reftests/table-background/scrollable-rowgroup-collapse-background.html b/layout/reftests/table-background/scrollable-rowgroup-collapse-background.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/table-background/scrollable-rowgroup-collapse-background.html
@@ -0,0 +1,6 @@
+<title>Testcase for assertion fix in bug 531461</title>
+<table style="border-collapse:collapse">
+  <tbody style="overflow:scroll; background:yellow">
+    <tr><td>Cell</td></tr>
+  </tbody>
+</table>
diff --git a/layout/reftests/table-background/scrollable-rowgroup-collapse-border.html b/layout/reftests/table-background/scrollable-rowgroup-collapse-border.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/table-background/scrollable-rowgroup-collapse-border.html
@@ -0,0 +1,6 @@
+<title>Testcase for assertion fix in bug 531461</title>
+<table style="border-collapse:collapse">
+  <tbody style="overflow:scroll; border: medium solid black">
+    <tr><td>Cell</td></tr>
+  </tbody>
+</table>
diff --git a/layout/reftests/table-background/scrollable-rowgroup-collapse-notref.html b/layout/reftests/table-background/scrollable-rowgroup-collapse-notref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/table-background/scrollable-rowgroup-collapse-notref.html
@@ -0,0 +1,6 @@
+<title>Testcase for assertion fix in bug 531461</title>
+<table style="border-collapse:collapse">
+  <tbody style="overflow:scroll">
+    <tr><td>Cell</td></tr>
+  </tbody>
+</table>
diff --git a/layout/reftests/table-background/scrollable-rowgroup-separate-background.html b/layout/reftests/table-background/scrollable-rowgroup-separate-background.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/table-background/scrollable-rowgroup-separate-background.html
@@ -0,0 +1,6 @@
+<title>Testcase for assertion fix in bug 531461</title>
+<table>
+  <tbody style="overflow:scroll; background:yellow">
+    <tr><td>Cell</td></tr>
+  </tbody>
+</table>
diff --git a/layout/reftests/table-background/scrollable-rowgroup-separate-border.html b/layout/reftests/table-background/scrollable-rowgroup-separate-border.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/table-background/scrollable-rowgroup-separate-border.html
@@ -0,0 +1,6 @@
+<title>Testcase for assertion fix in bug 531461</title>
+<table>
+  <tbody style="overflow:scroll; border: medium solid black">
+    <tr><td>Cell</td></tr>
+  </tbody>
+</table>
diff --git a/layout/reftests/table-background/scrollable-rowgroup-separate-notref.html b/layout/reftests/table-background/scrollable-rowgroup-separate-notref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/table-background/scrollable-rowgroup-separate-notref.html
@@ -0,0 +1,6 @@
+<title>Testcase for assertion fix in bug 531461</title>
+<table>
+  <tbody style="overflow:scroll">
+    <tr><td>Cell</td></tr>
+  </tbody>
+</table>
diff --git a/layout/tables/nsTableFrame.cpp b/layout/tables/nsTableFrame.cpp
--- a/layout/tables/nsTableFrame.cpp
+++ b/layout/tables/nsTableFrame.cpp
@@ -68,16 +68,17 @@
 #include "nsIScrollableFrame.h"
 #include "nsFrameManager.h"
 #include "nsCSSRendering.h"
 #include "nsLayoutErrors.h"
 #include "nsAutoPtr.h"
 #include "nsCSSFrameConstructor.h"
 #include "nsStyleSet.h"
 #include "nsDisplayList.h"
+#include "nsIScrollableFrame.h"
 
 /********************************************************************************
  ** nsTableReflowState                                                         **
  ********************************************************************************/
 
 struct nsTableReflowState {
 
   // the real reflow state
@@ -1330,16 +1331,21 @@ IsFrameAllowedInTable(nsIAtom* aType)
 }
 #endif
 
 static PRBool
 AnyTablePartHasBorderOrBackground(nsIFrame* aFrame)
 {
   NS_ASSERTION(IsFrameAllowedInTable(aFrame->GetType()), "unexpected frame type");
 
+  nsIScrollableFrame *scrollFrame = do_QueryFrame(aFrame);
+  if (scrollFrame) {
+    return AnyTablePartHasBorderOrBackground(scrollFrame->GetScrolledFrame());
+  }
+
   if (aFrame->GetStyleVisibility()->IsVisible() &&
       (!aFrame->GetStyleBackground()->IsTransparent() ||
        aFrame->GetStyleDisplay()->mAppearance ||
        aFrame->HasBorder()))
     return PR_TRUE;
 
   nsTableCellFrame *cellFrame = do_QueryFrame(aFrame);
   if (cellFrame)

From: L. David Baron <dbaron@dbaron.org>

Flush before any event dispatched using coordinates in case we have throttled animations of transform running.

diff --git a/layout/base/nsPresShell.cpp b/layout/base/nsPresShell.cpp
--- a/layout/base/nsPresShell.cpp
+++ b/layout/base/nsPresShell.cpp
@@ -6094,24 +6094,25 @@ PresShell::HandleEvent(nsIFrame        *
         delete event;
       }
     }
     return NS_OK;
   }
 
   nsIFrame* frame = aFrame;
 
-  if (aEvent->eventStructType == NS_TOUCH_EVENT) {
-    nsIDocument::UnlockPointer();
+  bool dispatchUsingCoordinates = NS_IsEventUsingCoordinates(aEvent);
+  if (dispatchUsingCoordinates) {
+    if (aEvent->eventStructType == NS_KEY_EVENT) {
+      nsIDocument::UnlockPointer();
+    }
+
     FlushPendingNotifications(Flush_Layout);
     frame = GetNearestFrameContainingPresShell(this);
-  }
-
-  bool dispatchUsingCoordinates = NS_IsEventUsingCoordinates(aEvent);
-  if (dispatchUsingCoordinates) {
+
     NS_WARN_IF_FALSE(frame, "Nothing to handle this event!");
     if (!frame)
       return NS_OK;
 
     nsPresContext* framePresContext = frame->PresContext();
     nsPresContext* rootPresContext = framePresContext->GetRootPresContext();
     NS_ASSERTION(rootPresContext == mPresContext->GetRootPresContext(),
                  "How did we end up outside the connected prescontext/viewmanager hierarchy?"); 

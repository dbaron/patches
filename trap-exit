From: L. David Baron <dbaron@dbaron.org>

Trap exit with our crash hooks.

diff --git a/toolkit/xre/glxtest.cpp b/toolkit/xre/glxtest.cpp
--- a/toolkit/xre/glxtest.cpp
+++ b/toolkit/xre/glxtest.cpp
@@ -81,31 +81,31 @@ static func_ptr_type cast(void *ptr)
            reinterpret_cast<size_t>(ptr)
          );
 }
 
 static void fatal_error(const char *str)
 {
   write(write_end_of_the_pipe, str, strlen(str));
   write(write_end_of_the_pipe, "\n", 1);
-  exit(EXIT_FAILURE);
+  _exit(EXIT_FAILURE);
 }
 
 static int
 x_error_handler(Display *, XErrorEvent *ev)
 {
   enum { bufsize = 1024 };
   char buf[bufsize];
   int length = snprintf(buf, bufsize,
                         "X error occurred in GLX probe, error_code=%d, request_code=%d, minor_code=%d\n",
                         ev->error_code,
                         ev->request_code,
                         ev->minor_code);
   write(write_end_of_the_pipe, buf, length);
-  exit(EXIT_FAILURE);
+  _exit(EXIT_FAILURE);
   return 0;
 }
 
 static void glxtest()
 {
   ///// Open libGL and load needed symbols /////
   void *libgl = dlopen("libGL.so.1", RTLD_LAZY);
   if (!libgl)
@@ -216,27 +216,27 @@ static void glxtest()
   dlclose(libgl);
 }
 
 void fire_glxtest_process()
 {
   int pfd[2];
   if (pipe(pfd) == -1) {
       perror("pipe");
-      exit(EXIT_FAILURE);
+      _exit(EXIT_FAILURE);
   }
   pid_t pid = fork();
   if (pid < 0) {
       perror("fork");
-      exit(EXIT_FAILURE);
+      _exit(EXIT_FAILURE);
   }
   if (pid == 0) {
       close(pfd[0]);
       write_end_of_the_pipe = pfd[1];
       glxtest();
       close(pfd[1]);
-      exit(EXIT_SUCCESS);
+      _exit(EXIT_SUCCESS);
   }
 
   close(pfd[1]);
   mozilla::widget::glxtest_pipe = pfd[0];
   mozilla::widget::glxtest_pid = pid;
 }
diff --git a/toolkit/xre/nsSigHandlers.cpp b/toolkit/xre/nsSigHandlers.cpp
--- a/toolkit/xre/nsSigHandlers.cpp
+++ b/toolkit/xre/nsSigHandlers.cpp
@@ -56,16 +56,18 @@
 #include "nsXULAppAPI.h"
 
 #if defined(LINUX)
 #include <sys/time.h>
 #include <sys/resource.h>
 #include <unistd.h>
 #include <stdlib.h> // atoi
 #include <ucontext.h>
+#define _GNU_SOURCE 1
+#include <dlfcn.h>
 #endif
 
 #if defined(SOLARIS)
 #include <sys/resource.h>
 #include <ucontext.h>
 #endif
 
 static char _progname[1024] = "huh?";
@@ -126,16 +128,28 @@ ah_crap_handler(int signum)
 void
 child_ah_crap_handler(int signum)
 {
   if (!getenv("MOZ_DONT_UNBLOCK_PARENT_ON_CHILD_CRASH"))
     close(kClientChannelFd);
   ah_crap_handler(signum);
 }
 
+extern "C" {
+
+/* override exit(3) */
+void exit(int status)
+{
+  ah_crap_handler(SIGABRT);
+  void *next = dlsym(RTLD_NEXT, "exit");
+  ((void (*)(int))next)(status);
+}
+
+}
+
 #endif // CRAWL_STACK_ON_SIGSEGV
 
 #ifdef MOZ_WIDGET_GTK2
 // Need this include for version test below.
 #include <glib.h>
 #endif
 
 #if defined(MOZ_WIDGET_GTK2) && (GLIB_MAJOR_VERSION > 2 || (GLIB_MAJOR_VERSION == 2 && GLIB_MINOR_VERSION >= 6))

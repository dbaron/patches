From: L. David Baron <dbaron@dbaron.org>

Bug 619487 / 980419 - Add assertions for prefs being accessed off the main thread to debug recursion-level assertions that I see after running for a long time.

diff --git a/modules/libpref/Preferences.cpp b/modules/libpref/Preferences.cpp
--- a/modules/libpref/Preferences.cpp
+++ b/modules/libpref/Preferences.cpp
@@ -347,26 +347,30 @@ pref_HashPref(const char* aKey,
 
 #define PREF_HASHTABLE_INITIAL_LENGTH 1024
 
 // The Init function initializes the preference context and creates the
 // preference hashtable.
 static void
 PREF_Init()
 {
+  NS_ASSERTION(NS_IsMainThread(),
+               "pref hashtable is main thread only");
   if (!gHashTable) {
     gHashTable = new PLDHashTable(
       &pref_HashTableOps, sizeof(PrefHashEntry), PREF_HASHTABLE_INITIAL_LENGTH);
   }
 }
 
 // Frees up all the objects except the callback list.
 static void
 PREF_CleanupPrefs()
 {
+  NS_ASSERTION(NS_IsMainThread(),
+               "pref hashtable is main thread only");
   if (gHashTable) {
     delete gHashTable;
     gHashTable = nullptr;
     gPrefNameArena.Clear();
   }
 }
 
 // Frees the callback list. Should be called at program exit.

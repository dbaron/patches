From: L. David Baron <dbaron@dbaron.org>

Bug 619487 / 980419 - Add assertions for prefs being accessed off the main thread to debug recursion-level assertions that I see after running for a long time.

diff --git a/modules/libpref/Preferences.cpp b/modules/libpref/Preferences.cpp
--- a/modules/libpref/Preferences.cpp
+++ b/modules/libpref/Preferences.cpp
@@ -550,16 +550,18 @@ pref_HashPref(const char* aKey,
               PrefType aType,
               uint32_t aFlags);
 
 #define PREF_HASHTABLE_INITIAL_LENGTH 1024
 
 void
 PREF_Init()
 {
+  NS_ASSERTION(NS_IsMainThread(),
+               "pref hashtable is main thread only");
   if (!gHashTable) {
     gHashTable = new PLDHashTable(
       &pref_HashTableOps, sizeof(PrefHashEntry), PREF_HASHTABLE_INITIAL_LENGTH);
   }
 }
 
 // Frees the callback list.
 void
@@ -581,16 +583,18 @@ PREF_Cleanup()
 
   PREF_CleanupPrefs();
 }
 
 // Frees up all the objects except the callback list.
 void
 PREF_CleanupPrefs()
 {
+  NS_ASSERTION(NS_IsMainThread(),
+               "pref hashtable is main thread only");
   if (gHashTable) {
     delete gHashTable;
     gHashTable = nullptr;
     gPrefNameArena.Clear();
   }
 }
 
 // Note that this appends to aResult, and does not assign!

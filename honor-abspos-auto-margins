From: L. David Baron <dbaron@dbaron.org>

Fix implementation of rules for auto margins on absolutely positioned elements; honor auto margins when only one margin is auto, even when the auto margin gets a negative value.  (Bug 419100)  r=roc  (NOTE: passed try on mac 32-bit debug)

diff --git a/layout/generic/nsHTMLReflowState.cpp b/layout/generic/nsHTMLReflowState.cpp
--- a/layout/generic/nsHTMLReflowState.cpp
+++ b/layout/generic/nsHTMLReflowState.cpp
@@ -1308,42 +1308,60 @@ nsHTMLReflowState::InitAbsoluteConstrain
                                mComputedMargin.LeftRight() -
                                mComputedBorderPadding.LeftRight() -
                                mComputedWidth;
     PRBool marginLeftIsAuto =
       eStyleUnit_Auto == mStyleMargin->mMargin.GetLeftUnit();
     PRBool marginRightIsAuto =
       eStyleUnit_Auto == mStyleMargin->mMargin.GetRightUnit();
 
-    if (availMarginSpace < 0 ||
-        (!marginLeftIsAuto && !marginRightIsAuto)) {
-      // We're over-constrained so use the direction of the containing block
-      // to dictate which value to ignore.  (And note that the spec says to ignore
-      // 'left' or 'right' rather than 'margin-left' or 'margin-right'.)
-      if (cbrs &&
-          NS_STYLE_DIRECTION_RTL == cbrs->mStyleVisibility->mDirection) {
-        // Ignore the specified value for 'left'.
-        mComputedOffsets.left += availMarginSpace;
-      } else {
-        // Ignore the specified value for 'right'.
-        mComputedOffsets.right += availMarginSpace;
-      }
-    } else if (marginLeftIsAuto) {
+    if (marginLeftIsAuto) {
       if (marginRightIsAuto) {
-        // Both 'margin-left' and 'margin-right' are 'auto', so they get
-        // equal values
-        mComputedMargin.left = availMarginSpace / 2;
-        mComputedMargin.right = availMarginSpace - mComputedMargin.left;
+        if (availMarginSpace < 0) {
+          // Note that this case is different from the neither-'auto'
+          // case below, where the spec says to ignore 'left'/'right'.
+          if (cbrs &&
+              NS_STYLE_DIRECTION_RTL == cbrs->mStyleVisibility->mDirection) {
+            // Ignore the specified value for 'margin-left'.
+            mComputedMargin.left = availMarginSpace;
+          } else {
+            // Ignore the specified value for 'margin-right'.
+            mComputedMargin.right = availMarginSpace;
+          }
+        } else {
+          // Both 'margin-left' and 'margin-right' are 'auto', so they get
+          // equal values
+          mComputedMargin.left = availMarginSpace / 2;
+          mComputedMargin.right = availMarginSpace - mComputedMargin.left;
+        }
       } else {
         // Just 'margin-left' is 'auto'
         mComputedMargin.left = availMarginSpace;
       }
     } else {
-      // Just 'margin-right' is 'auto'
-      mComputedMargin.right = availMarginSpace;
+      if (marginRightIsAuto) {
+        // Just 'margin-right' is 'auto'
+        mComputedMargin.right = availMarginSpace;
+      } else {
+        // We're over-constrained so use the direction of the containing
+        // block to dictate which value to ignore.  (And note that the
+        // spec says to ignore 'left' or 'right' rather than
+        // 'margin-left' or 'margin-right'.)
+        // Note that this case is different from the both-'auto' case
+        // above, where the spec says to ignore
+        // 'margin-left'/'margin-right'.
+        if (cbrs &&
+            NS_STYLE_DIRECTION_RTL == cbrs->mStyleVisibility->mDirection) {
+          // Ignore the specified value for 'left'.
+          mComputedOffsets.left += availMarginSpace;
+        } else {
+          // Ignore the specified value for 'right'.
+          mComputedOffsets.right += availMarginSpace;
+        }
+      }
     }
   }
 
   if (topIsAuto) {
     // solve for 'top'
     if (heightIsAuto) {
       mComputedOffsets.top = NS_AUTOOFFSET;
     } else {
@@ -1387,34 +1405,41 @@ nsHTMLReflowState::InitAbsoluteConstrain
     //  * we're dealing with a replaced element
     //  * height was constrained by min-height or max-height.
     nscoord availMarginSpace = autoHeight - mComputedHeight;
     PRBool marginTopIsAuto =
       eStyleUnit_Auto == mStyleMargin->mMargin.GetTopUnit();
     PRBool marginBottomIsAuto =
       eStyleUnit_Auto == mStyleMargin->mMargin.GetBottomUnit();
 
-    if (availMarginSpace < 0 || (!marginTopIsAuto && !marginBottomIsAuto)) {
-      // We're over-constrained so ignore the specified value for
-      // 'bottom'.  (And note that the spec says to ignore 'bottom'
-      // rather than 'margin-bottom'.)
-      mComputedOffsets.bottom += availMarginSpace;
-    } else if (marginTopIsAuto) {
+    if (marginTopIsAuto) {
       if (marginBottomIsAuto) {
-        // Both 'margin-top' and 'margin-bottom' are 'auto', so they get
-        // equal values
-        mComputedMargin.top = availMarginSpace / 2;
-        mComputedMargin.bottom = availMarginSpace - mComputedMargin.top;
+        if (availMarginSpace < 0) {
+          // FIXME: Note that the spec doesn't actually say we should do this!
+          mComputedMargin.bottom = availMarginSpace;
+        } else {
+          // Both 'margin-top' and 'margin-bottom' are 'auto', so they get
+          // equal values
+          mComputedMargin.top = availMarginSpace / 2;
+          mComputedMargin.bottom = availMarginSpace - mComputedMargin.top;
+        }
       } else {
         // Just 'margin-top' is 'auto'
         mComputedMargin.top = availMarginSpace;
       }
     } else {
-      // Just 'margin-bottom' is 'auto'
-      mComputedMargin.bottom = availMarginSpace;
+      if (marginBottomIsAuto) {
+        // Just 'margin-bottom' is 'auto'
+        mComputedMargin.bottom = availMarginSpace;
+      } else {
+        // We're over-constrained so ignore the specified value for
+        // 'bottom'.  (And note that the spec says to ignore 'bottom'
+        // rather than 'margin-bottom'.)
+        mComputedOffsets.bottom += availMarginSpace;
+      }
     }
   }
 }
 
 nscoord 
 GetVerticalMarginBorderPadding(const nsHTMLReflowState* aReflowState)
 {
   nscoord result = 0;
diff --git a/layout/reftests/box-properties/abspos-non-replaced-width-offset-margin-ref.html b/layout/reftests/box-properties/abspos-non-replaced-width-offset-margin-ref.html
--- a/layout/reftests/box-properties/abspos-non-replaced-width-offset-margin-ref.html
+++ b/layout/reftests/box-properties/abspos-non-replaced-width-offset-margin-ref.html
@@ -6,26 +6,16 @@
 
 html, body { margin: 0; padding: 0; border: none; }
 div { height: 1px; background: navy; }
 
 </style>
 </head>
 <body>
 
-<!--
-
-Differences between CSS 2.1 and this reference:
-
-2. it ignores single 'auto' margins (one side only) when they should
-   become negative; this is a bug that we should fix:
-   https://bugzilla.mozilla.org/show_bug.cgi?id=419100
-
--->
-
 <!-- ***** NARROW WIDTH ***** -->
 
 <!-- nothing auto -->
 <div style="margin-left: 70px; width: 177px;"></div>
 <div style="margin-left: 496px; width: 177px;"></div>
 <div style="margin-left: 70px; width: 177px;"></div>
 <div style="margin-left: 496px; width: 177px;"></div>
 <div style="margin-left: 70px; width: 177px;"></div>
@@ -349,24 +339,23 @@ 2. it ignores single 'auto' margins (one
 <div style="margin-left: 167px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <div style="margin-left: 167px; width: 684px;"></div>
 <div style="margin-left: 167px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <!-- only margin-left auto -->
-<!-- THIS SET AFFECTED BY CHANGE (2) FROM CSS 2.1 SPEC -->
-<div style="margin-left: 53px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
-<div style="margin-left: 53px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
-<div style="margin-left: 53px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
-<div style="margin-left: 53px; width: 684px;"></div>
+<div style="margin-left: -11px; width: 684px;"></div>
+<div style="margin-left: -11px; width: 684px;"></div>
+<div style="margin-left: -11px; width: 684px;"></div>
+<div style="margin-left: -11px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
 <!-- left and margin-left auto -->
 <div style="margin-left: -11px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
 <div style="margin-left: -11px; width: 684px;"></div>
@@ -386,25 +375,24 @@ 2. it ignores single 'auto' margins (one
 <div style="margin-left: 150px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <div style="margin-left: 150px; width: 684px;"></div>
 <div style="margin-left: 150px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <div style="margin-left: -53px; width: 684px;"></div>
 <!-- only margin-right auto -->
-<!-- THIS SET AFFECTED BY CHANGE (2) FROM CSS 2.1 SPEC -->
 <div style="margin-left: 70px; width: 684px;"></div>
-<div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 70px; width: 684px;"></div>
-<div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 70px; width: 684px;"></div>
-<div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 70px; width: 684px;"></div>
-<div style="margin-left: 8px; width: 684px;"></div>
+<div style="margin-left: 70px; width: 684px;"></div>
+<div style="margin-left: 70px; width: 684px;"></div>
+<div style="margin-left: 70px; width: 684px;"></div>
+<div style="margin-left: 70px; width: 684px;"></div>
 <!-- left and margin-right auto (margin-right like 0) -->
 <div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 8px; width: 684px;"></div>
 <div style="margin-left: 8px; width: 684px;"></div>
diff --git a/layout/reftests/box-properties/abspos-replaced-width-offset-margin-ref.html b/layout/reftests/box-properties/abspos-replaced-width-offset-margin-ref.html
--- a/layout/reftests/box-properties/abspos-replaced-width-offset-margin-ref.html
+++ b/layout/reftests/box-properties/abspos-replaced-width-offset-margin-ref.html
@@ -7,26 +7,16 @@
 html, body { margin: 0; padding: 0; border: none; }
 div { height: 1px; background: blue;
       border-left: 7px solid navy; border-right: 17px solid navy; }
 
 </style>
 </head>
 <body>
 
-<!--
-
-Differences between CSS 2.1 and this reference:
-
-2. it ignores single 'auto' margins (one side only) when they should
-   become negative; this is a bug that we should fix:
-   https://bugzilla.mozilla.org/show_bug.cgi?id=419100
-
--->
-
 <!-- ***** WIDE WIDTH ***** -->
 
 <!-- nothing auto -->
 <div style="margin-left: 70px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
@@ -56,24 +46,23 @@ 2. it ignores single 'auto' margins (one
 <div style="margin-left: 167px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: 167px; width: 660px;"></div>
 <div style="margin-left: 167px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <!-- only margin-left auto -->
-<!-- THIS SET AFFECTED BY CHANGE (2) FROM CSS 2.1 SPEC -->
-<div style="margin-left: 53px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
-<div style="margin-left: 53px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
-<div style="margin-left: 53px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
-<div style="margin-left: 53px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <!-- left and margin-left auto -->
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
@@ -93,25 +82,24 @@ 2. it ignores single 'auto' margins (one
 <div style="margin-left: 150px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: 150px; width: 660px;"></div>
 <div style="margin-left: 150px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <!-- only margin-right auto -->
-<!-- THIS SET AFFECTED BY CHANGE (2) FROM CSS 2.1 SPEC -->
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
 <!-- left and margin-right auto (margin-right like 0) -->
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
@@ -499,24 +487,23 @@ 2. it ignores single 'auto' margins (one
 <div style="margin-left: 167px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: 167px; width: 660px;"></div>
 <div style="margin-left: 167px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <!-- only margin-left auto -->
-<!-- THIS SET AFFECTED BY CHANGE (2) FROM CSS 2.1 SPEC -->
-<div style="margin-left: 53px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
-<div style="margin-left: 53px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
-<div style="margin-left: 53px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
-<div style="margin-left: 53px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
+<div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <!-- left and margin-left auto -->
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
 <div style="margin-left: -11px; width: 660px;"></div>
@@ -536,25 +523,24 @@ 2. it ignores single 'auto' margins (one
 <div style="margin-left: 150px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: 150px; width: 660px;"></div>
 <div style="margin-left: 150px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <div style="margin-left: -53px; width: 660px;"></div>
 <!-- only margin-right auto -->
-<!-- THIS SET AFFECTED BY CHANGE (2) FROM CSS 2.1 SPEC -->
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 70px; width: 660px;"></div>
-<div style="margin-left: 8px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
+<div style="margin-left: 70px; width: 660px;"></div>
 <!-- left and margin-right auto (margin-right like 0) -->
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>
 <div style="margin-left: 8px; width: 660px;"></div>

From: L. David Baron <dbaron@dbaron.org>

Don't leak all the nsFactoryEntry in the component manager.

diff --git a/xpcom/components/nsComponentManager.cpp b/xpcom/components/nsComponentManager.cpp
--- a/xpcom/components/nsComponentManager.cpp
+++ b/xpcom/components/nsComponentManager.cpp
@@ -917,21 +917,22 @@ nsresult nsComponentManagerImpl::Shutdow
          ("nsComponentManager: Beginning Shutdown."));
 
 #if !defined(MOZILLA_XPCOMRT_API)
   UnregisterWeakMemoryReporter(this);
 #endif
 
   // Release all cached factories
   mContractIDs.Clear();
-  mFactories.Clear(); // XXX release the objects, don't just clear
   mLoaderMap.Clear();
   mKnownModules.Clear();
   mKnownStaticModules.Clear();
 
+  mFactories.Clear();
+
   delete sStaticModules;
   delete sModuleLocations;
 #ifdef MOZ_B2G_LOADER
   delete sXPTIInfosBook;
   sXPTIInfosBook = nullptr;
 #endif
 
 #if !defined(MOZILLA_XPCOMRT_API)
@@ -1678,23 +1679,24 @@ nsComponentManagerImpl::UnregisterFactor
 
   {
     SafeMutexAutoLock lock(mLock);
     nsFactoryEntry* f = mFactories.Get(aClass);
     if (!f || f->mFactory != aFactory) {
       return NS_ERROR_FACTORY_NOT_REGISTERED;
     }
 
-    mFactories.Remove(aClass);
-
     // This might leave a stale contractid -> factory mapping in
     // place, so null out the factory entry (see
     // nsFactoryEntry::GetFactory)
     f->mFactory.swap(dyingFactory);
     f->mServiceObject.swap(dyingServiceObject);
+
+    mFactories.Remove(aClass);
+    // FIXME: Need to clean up dangling pointers!
   }
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsComponentManagerImpl::AutoRegister(nsIFile* aLocation)
 {
diff --git a/xpcom/components/nsComponentManager.h b/xpcom/components/nsComponentManager.h
--- a/xpcom/components/nsComponentManager.h
+++ b/xpcom/components/nsComponentManager.h
@@ -172,17 +172,17 @@ public:
                                            uint32_t aContractIDLen);
 
   already_AddRefed<nsIFactory> LoadFactory(nsFactoryEntry* aEntry);
 
   nsFactoryEntry* GetFactoryEntry(const char* aContractID,
                                   uint32_t aContractIDLen);
   nsFactoryEntry* GetFactoryEntry(const nsCID& aClass);
 
-  nsDataHashtable<nsIDHashKey, nsFactoryEntry*> mFactories;
+  nsClassHashtable<nsIDHashKey, nsFactoryEntry> mFactories;
   nsDataHashtable<nsCStringHashKey, nsFactoryEntry*> mContractIDs;
 
   SafeMutex mLock;
 
   static void InitializeStaticModules();
   static void InitializeModuleLocations();
 
   struct ComponentLocation

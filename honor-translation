From: L. David Baron <dbaron@dbaron.org>

Bug 995410 - Honor the translation on mShadowTarget in ClientLayerManager::MakeSnapshotIfRequired.

diff --git a/gfx/layers/client/ClientLayerManager.cpp b/gfx/layers/client/ClientLayerManager.cpp
--- a/gfx/layers/client/ClientLayerManager.cpp
+++ b/gfx/layers/client/ClientLayerManager.cpp
@@ -285,19 +285,25 @@ ClientLayerManager::MakeSnapshotIfRequir
       if (mForwarder->AllocSurfaceDescriptor(bounds.Size().ToIntSize(),
                                              gfxContentType::COLOR_ALPHA,
                                              &inSnapshot) &&
           // The compositor will usually reuse |snapshot| and return
           // it through |outSnapshot|, but if it doesn't, it's
           // responsible for freeing |snapshot|.
           remoteRenderer->SendMakeSnapshot(inSnapshot, &snapshot)) {
         RefPtr<DataSourceSurface> surf = GetSurfaceForDescriptor(snapshot);
-        mShadowTarget->GetDrawTarget()->CopySurface(surf,
-                                                    IntRect(0, 0, bounds.Size().width, bounds.Size().height),
-                                                    IntPoint(0, 0));
+        DrawTarget* dt = mShadowTarget->GetDrawTarget();
+        const Matrix& mat = dt->GetTransform();
+        MOZ_ASSERT(mat.IsIntegerTranslation(),
+                   "don't know how to handle matrix other than translation");
+        Point translation = mat.GetTranslation();
+        dt->CopySurface(surf,
+                        IntRect(IntPoint(0, 0), bounds.Size().ToIntSize()),
+                        IntPoint(floorf(-translation.x + 0.5f),
+                                 floorf(-translation.y + 0.5f)));
       }
       if (IsSurfaceDescriptorValid(snapshot)) {
         mForwarder->DestroySharedSurface(&snapshot);
       }
     }
   }
   mShadowTarget = nullptr;
 }

From: L. David Baron <dbaron@dbaron.org>

Ensure consistent reflow depth across reflows.  (Bug 619021)

diff --git a/layout/generic/nsHTMLReflowState.cpp b/layout/generic/nsHTMLReflowState.cpp
--- a/layout/generic/nsHTMLReflowState.cpp
+++ b/layout/generic/nsHTMLReflowState.cpp
@@ -91,16 +91,24 @@ nsHTMLReflowState::nsHTMLReflowState(nsP
                                      const nsSize&        aAvailableSpace)
   : nsCSSOffsetState(aFrame, aRenderingContext)
   , mBlockDelta(0)
   , mReflowDepth(0)
 {
   NS_PRECONDITION(aPresContext, "no pres context");
   NS_PRECONDITION(aRenderingContext, "no rendering context");
   NS_PRECONDITION(aFrame, "no frame");
+
+  // We must ensure that reflow depth is consistent across reflows;
+  // otherwise we might return NS_FRAME_COMPLETE status for a frame with
+  // continuations.  Therefore, count the ancestors of this frame.
+  for (nsIFrame *p = aFrame->GetParent(); p; p = p->GetParent()) {
+    ++mReflowDepth;
+  }
+
   parentReflowState = nsnull;
   availableWidth = aAvailableSpace.width;
   availableHeight = aAvailableSpace.height;
   mFloatManager = nsnull;
   mLineLayout = nsnull;
   mFlags.mSpecialHeightReflow = PR_FALSE;
   mFlags.mIsTopOfPage = PR_FALSE;
   mFlags.mTableIsSplittable = PR_FALSE;

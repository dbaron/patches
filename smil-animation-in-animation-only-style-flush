From: L. David Baron <dbaron@dbaron.org>

Bug 960465 patch N - Make SMIL animations participate in the animation-only style flush.

FIXME: DOES NOT WORK YET, OR AT LEAST DOES NOT FIX TESTS YET

This should fix at least some of, and hopefully all of, the failing
reftests:
  layout/reftests/svg/smil/smil-transitions-interaction-1a.svg
  layout/reftests/svg/smil/smil-transitions-interaction-1b.svg
  layout/reftests/svg/smil/smil-transitions-interaction-2a.svg
  layout/reftests/svg/smil/smil-transitions-interaction-2b.svg
  layout/reftests/svg/smil/smil-transitions-interaction-4a.svg
  layout/reftests/svg/smil/smil-transitions-interaction-4b.svg

diff --git a/dom/smil/moz.build b/dom/smil/moz.build
--- a/dom/smil/moz.build
+++ b/dom/smil/moz.build
@@ -62,12 +62,13 @@ UNIFIED_SOURCES += [
     'TimeEvent.cpp',
 ]
 
 FAIL_ON_WARNINGS = True
 
 LOCAL_INCLUDES += [
     '/dom/base',
     '/dom/svg',
+    '/layout/base',
     '/layout/style',
 ]
 
 FINAL_LIBRARY = 'xul'
diff --git a/dom/smil/nsSMILAnimationController.cpp b/dom/smil/nsSMILAnimationController.cpp
--- a/dom/smil/nsSMILAnimationController.cpp
+++ b/dom/smil/nsSMILAnimationController.cpp
@@ -9,16 +9,17 @@
 #include "nsCSSProps.h"
 #include "nsITimer.h"
 #include "mozilla/dom/Element.h"
 #include "nsIDocument.h"
 #include "mozilla/dom/SVGAnimationElement.h"
 #include "nsSMILTimedElement.h"
 #include <algorithm>
 #include "mozilla/AutoRestore.h"
+#include "RestyleTracker.h"
 
 using namespace mozilla;
 using namespace mozilla::dom;
 
 //----------------------------------------------------------------------
 // nsSMILAnimationController implementation
 
 //----------------------------------------------------------------------
@@ -811,16 +812,46 @@ nsSMILAnimationController::GetTargetIden
   aResult.mElement = targetElem;
   aResult.mAttributeName = attributeName;
   aResult.mAttributeNamespaceID = attributeNamespaceID;
   aResult.mIsCSS = isCSS;
 
   return true;
 }
 
+/*static*/ PLDHashOperator
+nsSMILAnimationController::AddStyleUpdate(AnimationElementPtrKey* aKey,
+                                          void* aData)
+{
+  SVGAnimationElement* animElement = aKey->GetKey();
+  RestyleTracker* restyleTracker = static_cast<RestyleTracker*>(aData);
+
+  nsSMILTargetIdentifier key;
+  if (!GetTargetIdentifierForAnimation(animElement, key)) {
+    // Something's wrong/missing about animation's target; skip this animation
+    return PL_DHASH_NEXT;
+  }
+
+  // REVIEW: I'm assuming tha mIsCSS means that the rules are the ones
+  // returned from Element::GetSMILOverrideStyleRule, and otherwise
+  // they're the rules returned from
+  // nsSVGElement::GetAnimatedContentStyleRule.
+  nsRestyleHint rshint = key.mIsCSS ? eRestyle_StyleAttribute
+                                    : eRestyle_SVGAttrAnimations;
+  restyleTracker->AddPendingRestyle(key.mElement, rshint, nsChangeHint(0));
+
+  return PL_DHASH_NEXT;
+}
+
+void
+nsSMILAnimationController::AddStyleUpdatesTo(RestyleTracker& aTracker)
+{
+  mAnimationElementTable.EnumerateEntries(AddStyleUpdate, &aTracker);
+}
+
 //----------------------------------------------------------------------
 // Add/remove child time containers
 
 nsresult
 nsSMILAnimationController::AddChild(nsSMILTimeContainer& aChild)
 {
   TimeContainerPtrKey* key = mChildContainerTable.PutEntry(&aChild);
   NS_ENSURE_TRUE(key, NS_ERROR_OUT_OF_MEMORY);
diff --git a/dom/smil/nsSMILAnimationController.h b/dom/smil/nsSMILAnimationController.h
--- a/dom/smil/nsSMILAnimationController.h
+++ b/dom/smil/nsSMILAnimationController.h
@@ -17,16 +17,17 @@
 #include "nsSMILCompositorTable.h"
 #include "nsSMILMilestone.h"
 #include "nsRefreshDriver.h"
 
 struct nsSMILTargetIdentifier;
 class nsIDocument;
 
 namespace mozilla {
+class RestyleTracker;
 namespace dom {
 class SVGAnimationElement;
 }
 }
 
 //----------------------------------------------------------------------
 // nsSMILAnimationController
 //
@@ -100,16 +101,18 @@ public:
   // Methods for relaying the availability of the refresh driver
   void NotifyRefreshDriverCreated(nsRefreshDriver* aRefreshDriver);
   void NotifyRefreshDriverDestroying(nsRefreshDriver* aRefreshDriver);
 
   // Helper to check if we have any animation elements at all
   bool HasRegisteredAnimations()
   { return mAnimationElementTable.Count() != 0; }
 
+  void AddStyleUpdatesTo(mozilla::RestyleTracker& aTracker);
+
 protected:
   ~nsSMILAnimationController();
 
   // Typedefs
   typedef nsPtrHashKey<nsSMILTimeContainer> TimeContainerPtrKey;
   typedef nsTHashtable<TimeContainerPtrKey> TimeContainerHashtable;
   typedef nsPtrHashKey<mozilla::dom::SVGAnimationElement> AnimationElementPtrKey;
   typedef nsTHashtable<AnimationElementPtrKey> AnimationElementHashtable;
@@ -170,16 +173,19 @@ protected:
       AnimationElementPtrKey* aKey, void* aData);
   static void SampleTimedElement(mozilla::dom::SVGAnimationElement* aElement,
                                  TimeContainerHashtable* aActiveContainers);
   static void AddAnimationToCompositorTable(
     mozilla::dom::SVGAnimationElement* aElement, nsSMILCompositorTable* aCompositorTable);
   static bool GetTargetIdentifierForAnimation(
       mozilla::dom::SVGAnimationElement* aAnimElem, nsSMILTargetIdentifier& aResult);
 
+  static PLDHashOperator
+    AddStyleUpdate(AnimationElementPtrKey* aKey, void* aData);
+
   // Methods for adding/removing time containers
   virtual nsresult AddChild(nsSMILTimeContainer& aChild) MOZ_OVERRIDE;
   virtual void     RemoveChild(nsSMILTimeContainer& aChild) MOZ_OVERRIDE;
 
   void FlagDocumentNeedsFlush();
 
   // Members
   nsAutoRefCnt mRefCnt;
diff --git a/layout/base/RestyleManager.cpp b/layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp
+++ b/layout/base/RestyleManager.cpp
@@ -35,16 +35,17 @@
 #include "StickyScrollContainer.h"
 #include "nsIRootBox.h"
 #include "nsIDOMMutationEvent.h"
 #include "nsContentUtils.h"
 #include "nsIFrameInlines.h"
 #include "ActiveLayerTracker.h"
 #include "nsDisplayList.h"
 #include "RestyleTrackerInlines.h"
+#include "nsSMILAnimationController.h"
 
 #ifdef ACCESSIBILITY
 #include "nsAccessibilityService.h"
 #endif
 
 namespace mozilla {
 
 using namespace layers;
@@ -1739,16 +1740,21 @@ RestyleManager::UpdateOnlyAnimationStyle
 
   // FIXME:  We should have the transition manager and animation manager
   // add only the elements for which animations are currently throttled
   // (i.e., animating on the compositor with main-thread style updates
   // suppressed).
   transitionManager->AddStyleUpdatesTo(tracker);
   animationManager->AddStyleUpdatesTo(tracker);
 
+  nsIDocument* document = mPresContext->Document();
+  if (document->HasAnimationController()) {
+    document->GetAnimationController()->AddStyleUpdatesTo(tracker);
+  }
+
   ProcessRestyles(tracker);
 
   transitionManager->SetInAnimationOnlyStyleUpdate(false);
 }
 
 void
 RestyleManager::PostRestyleEventCommon(Element* aElement,
                                        nsRestyleHint aRestyleHint,

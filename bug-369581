Make non-box frames with 'height:auto' respect min-height from overridable nsITheme::GetMinimumWidgetSize.  b=369581

diff -r 1ac630af8b33 layout/generic/nsHTMLReflowState.cpp
--- a/layout/generic/nsHTMLReflowState.cpp	Wed Feb 07 14:36:31 2007 -0800
+++ b/layout/generic/nsHTMLReflowState.cpp	Wed Feb 07 14:43:17 2007 -0800
@@ -2100,6 +2100,31 @@ nsHTMLReflowState::ComputeMinMaxValues(n
     }
   }
 
+  // The use of nsITheme::GetMinimumWidgetSize in nsFrame::ComputeSize
+  // isn't sufficient in the case of heights that can grow, when the
+  // style height is 'auto'.
+  const nsStyleDisplay *disp = frame->GetStyleDisplay();
+  if (frame->IsThemed(disp)) {
+    nsSize size(0, 0);
+    PRBool canOverride = PR_TRUE;
+    nsPresContext *presContext = frame->GetPresContext();
+    presContext->GetTheme()->
+      GetMinimumWidgetSize(rendContext, frame, disp->mAppearance,
+                           &size, &canOverride);
+
+    if (canOverride) {
+      // The only case where we need to bother.
+
+      // GMWS() returns size in pixels, we need to convert it back to
+      // twips, and convert border-box to content-box
+      float p2t = presContext->ScaledPixelsToTwips();
+      nscoord height = NSIntPixelsToTwips(size.height, p2t) -
+                       mComputedBorderPadding.TopBottom();
+      if (height > mComputedMinHeight)
+        mComputedMinHeight = height;
+    }
+  }
+
   // If the computed value of 'min-height' is greater than the value of
   // 'max-height', 'max-height' is set to the value of 'min-height'
   if (mComputedMinHeight > mComputedMaxHeight) {

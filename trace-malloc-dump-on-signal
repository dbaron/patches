Give trace-malloc a SIGUSR1 handler to dump allocations.

diff --git a/tools/trace-malloc/lib/nsTraceMalloc.c b/tools/trace-malloc/lib/nsTraceMalloc.c
--- a/tools/trace-malloc/lib/nsTraceMalloc.c
+++ b/tools/trace-malloc/lib/nsTraceMalloc.c
@@ -67,6 +67,12 @@
 #include "prthread.h"
 #include "nsStackWalk.h"
 #include "nsTraceMallocCallbacks.h"
+#ifdef linux
+#include <signal.h>
+#include <sys/types.h>
+#include <unistd.h>
+#include <time.h>
+#endif
 
 #if defined(XP_MACOSX)
 
@@ -1289,6 +1295,30 @@ log_header(int logfd)
     (void) write(logfd, &ticksPerSec, sizeof ticksPerSec);
 }
 
+#ifdef linux
+static void
+DumpAllocationsHook(int signum)
+{
+    char filename[64];
+    snprintf(filename, sizeof(filename),
+             "trace-malloc.%d.%ld.dump", (int)getpid(), time(NULL));
+    NS_TraceMallocDumpAllocations(filename);
+}
+
+static void
+SetupDumpAllocationsHook(void)
+{
+    sigset_t mset;
+    struct sigaction dump_action;
+
+    sigemptyset(&mset);
+    dump_action.sa_handler = DumpAllocationsHook;
+    dump_action.sa_mask  = mset;
+    dump_action.sa_flags = SA_RESTART;
+    sigaction(SIGUSR1, &dump_action, NULL);
+}
+#endif
+
 PR_IMPLEMENT(void)
 NS_TraceMallocStartup(int logfd)
 {
@@ -1324,6 +1354,10 @@ NS_TraceMallocStartup(int logfd)
 
     if (tracing_enabled)
         StartupHooker();
+
+#ifdef linux
+    SetupDumpAllocationsHook();
+#endif
 }
 
 /*

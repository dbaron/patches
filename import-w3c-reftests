From: L. David Baron <dbaron@dbaron.org>

Do first (small) round of importing W3C reftests into tree.  (This provides a test for bug 782401.)

diff --git a/layout/reftests/w3c-css/import-tests.py b/layout/reftests/w3c-css/import-tests.py
new file mode 100755
--- /dev/null
+++ b/layout/reftests/w3c-css/import-tests.py
@@ -0,0 +1,112 @@
+#!/usr/bin/python
+# This Source Code Form is subject to the terms of the Mozilla Public
+# License, v. 2.0. If a copy of the MPL was not distributed with this
+# file, You can obtain one at http://mozilla.org/MPL/2.0/.
+
+import os
+from optparse import OptionParser
+from subprocess import Popen, PIPE
+import xml.dom.minidom
+import html5lib
+
+op = OptionParser()
+(options, args) = op.parse_args()
+
+if len(args) != 1:
+    op.error("expected a single argument (path to CSS test repository clone)")
+
+srcpath = args[0]
+if not os.path.isdir(srcpath) or \
+   not os.path.isdir(os.path.join(srcpath, ".hg")):
+    raise StandardError("source path does not appear to be a mercurial clone")
+
+destpath = os.path.join(os.path.dirname(os.path.realpath(__file__)), "received")
+
+# Since we're going to commit the tests, we should also commit
+# information about where they came from.
+log = open(os.path.join(destpath, "import.log"), "w")
+
+def log_output_of(subprocess):
+    subprocess.wait()
+    if (subprocess.returncode != 0):
+        raise StandardError("error while running subprocess")
+    log.write(subprocess.stdout.readline().rstrip())
+log.write("Importing revision: ")
+log_output_of(Popen(["hg", "parent", "--template={node}"],
+                    stdout=PIPE, cwd=srcpath))
+log.write("\nfrom repository: ")
+log_output_of(Popen(["hg", "paths", "default"],
+                    stdout=PIPE, cwd=srcpath))
+log.write("\n")
+
+# Eventually we should import all the tests that have references.  (At
+# least for a subset of secs.  And we probably want to organize the
+# directory structure by spec to avoid constant file moves when files
+# move in the W3C repository.  And we probably also want to import each
+# test only once, even if it covers more than one spec.)
+
+# But for now, let's just import one set of tests.
+
+subtree = os.path.join(srcpath, "contributors", "opera", "submitted", "css3-conditional")
+testfiles = []
+for dirpath, dirnames, filenames in os.walk(subtree, topdown=True):
+    if "support" in dirnames:
+       dirnames.remove("support")
+    for f in filenames:
+        if f.find("-ref.") != -1:
+            continue
+        testfiles.append(os.path.join(dirpath, f))
+
+testfiles.sort()
+
+tests = []
+def add_test_items(fn, spec):
+    document = None # an xml.dom.minidom document
+    if fn.endswith(".htm") or fn.endswith(".html"):
+        # An HTML file
+        f = open(fn, "r")
+        parser = html5lib.HTMLParser(tree=html5lib.treebuilders.getTreeBuilder("dom"))
+        document = parser.parse(f)
+        f.close()
+    else:
+        # An XML file
+        document = xml.dom.minidom.parse(fn)
+    refs = []
+    notrefs = []
+    for link in document.getElementsByTagName("link"):
+        rel = link.getAttribute("rel")
+        if rel == "help" and spec == None:
+            specurl = link.getAttribute("href")
+            startidx = specurl.find("/TR/")
+            if startidx != -1:
+                startidx = startidx + 4
+                endidx = specurl.find("/", startidx)
+                if endidx != -1:
+                    spec = str(specurl[startidx:endidx])
+        if rel == "match":
+            arr = refs
+        elif rel == "mismatch":
+            arr = notrefs
+        else:
+            continue
+        arr.append(os.path.join(os.path.dirname(fn), str(link.getAttribute("href"))))
+    if len(refs) > 1:
+        raise StandardError("Need to add code to specify which reference we want to match.")
+    if spec is None:
+        raise StandardError("Could not associate test with specification")
+    for ref in refs:
+        tests.append(["==", fn, ref])
+    for notref in notrefs:
+        tests.append(["!=", fn, notref])
+    # Add chained references too
+    for ref in refs:
+        add_test_items(ref, spec=spec)
+    for notref in notrefs:
+        add_test_items(notref, spec=spec)
+
+for t in testfiles:
+    add_test_items(t, spec=None)
+
+print tests
+
+log.close()
diff --git a/layout/reftests/w3c-css/received/import.log b/layout/reftests/w3c-css/received/import.log
new file mode 100644
--- /dev/null
+++ b/layout/reftests/w3c-css/received/import.log
@@ -0,0 +1,2 @@
+Importing revision: aa7ad3ba9510c83ad82c7b81121dfe689c1541dc
+from repository: https://hg.csswg.org/test

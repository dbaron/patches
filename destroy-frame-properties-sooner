From: L. David Baron <dbaron@dbaron.org>

Destroy frame properties right after destroying the frame tree so they're destroyed before the style set.  (Bug 399994)  r=roc

diff --git a/layout/base/crashtests/399994-1.html b/layout/base/crashtests/399994-1.html
new file mode 100644
--- /dev/null
+++ b/layout/base/crashtests/399994-1.html
@@ -0,0 +1,11 @@
+<html class="reftest-print">
+<head>
+</head>
+<body>
+
+<div style="display: table; position: fixed;">
+  <div style="display: table-row; page-break-after: always;"></div>
+  <div style="display: table-row;"></div>
+</div>
+</body>
+</html>
diff --git a/layout/base/crashtests/crashtests.list b/layout/base/crashtests/crashtests.list
--- a/layout/base/crashtests/crashtests.list
+++ b/layout/base/crashtests/crashtests.list
@@ -166,16 +166,17 @@ load 398510-1.xhtml
 load 399132-1.xhtml
 load 399219-1.xhtml
 load 399365-1.html
 load 399676-1.xhtml
 load 399687-1.html
 load 399940-1.xhtml
 load 399946-1.xhtml
 load 399951-1.html
+load 399994-1.html
 load 400185-1.xul
 load 400445-1.xhtml
 load 400904-1.xhtml
 load 401589-1.xul
 skip load 403175-1.html # times out occasionally, bug 473680
 load 403245-1.html
 load 403569-1.xhtml
 load 403569-2.xhtml
diff --git a/layout/base/nsPresShell.cpp b/layout/base/nsPresShell.cpp
--- a/layout/base/nsPresShell.cpp
+++ b/layout/base/nsPresShell.cpp
@@ -2031,32 +2031,38 @@ PresShell::Destroy()
 
   CancelAllPendingReflows();
   CancelPostedReflowCallbacks();
 
   // Destroy the frame manager. This will destroy the frame hierarchy
   mFrameConstructor->WillDestroyFrameTree();
   FrameManager()->Destroy();
 
-  NS_WARN_IF_FALSE(!mWeakFrames, "Weak frames alive after destroying FrameManager");
-  while (mWeakFrames) {
-    mWeakFrames->Clear(this);
-  }
-
-  // Let the style set do its cleanup.
-  mStyleSet->Shutdown(mPresContext);
-
+  // Destroy all frame properties (whose destruction was suppressed
+  // while destroying the frame tree, but which might contain more
+  // frames within the properties.
   if (mPresContext) {
     // Clear out the prescontext's property table -- since our frame tree is
     // now dead, we shouldn't be looking up any more properties in that table.
     // We want to do this before we call SetShell() on the prescontext, so
     // property destructors can usefully call GetPresShell() on the
     // prescontext.
     mPresContext->PropertyTable()->DeleteAllProperties();
-
+  }
+
+
+  NS_WARN_IF_FALSE(!mWeakFrames, "Weak frames alive after destroying FrameManager");
+  while (mWeakFrames) {
+    mWeakFrames->Clear(this);
+  }
+
+  // Let the style set do its cleanup.
+  mStyleSet->Shutdown(mPresContext);
+
+  if (mPresContext) {
     // We hold a reference to the pres context, and it holds a weak link back
     // to us. To avoid the pres context having a dangling reference, set its 
     // pres shell to NULL
     mPresContext->SetShell(nsnull);
 
     // Clear the link handler (weak reference) as well
     mPresContext->SetLinkHandler(nsnull);
   }

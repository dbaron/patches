From: L. David Baron <dbaron@dbaron.org>

Bug 621618 patch 4:  Make conditions in Element::RemoveFromIdTable match those in AddToIdTable, to avoid asymmetric calls to the document's functions.

diff --git a/content/base/src/Element.cpp b/content/base/src/Element.cpp
--- a/content/base/src/Element.cpp
+++ b/content/base/src/Element.cpp
@@ -731,17 +731,17 @@ Element::RemoveFromIdTable(nsIAtom* aId)
     ShadowRoot* containingShadow = GetContainingShadow();
     // Check for containingShadow because it may have
     // been deleted during unlinking.
     if (containingShadow) {
       containingShadow->RemoveFromIdTable(this, aId);
     }
   } else {
     nsIDocument* doc = GetCurrentDoc();
-    if (doc) {
+    if (doc && (!IsInAnonymousSubtree() || doc->IsXUL())) {
       // id can be null during mutation events evilness. Also, XUL elements
       // loose their proto attributes during cc-unlink, so this can happen
       // during cc-unlink too.
       if (aId) {
         doc->RemoveFromIdTable(this, aId);
       }
     }
   }
diff --git a/dom/plugins/test/mochitest/test_bug813906.html b/dom/plugins/test/mochitest/test_bug813906.html
--- a/dom/plugins/test/mochitest/test_bug813906.html
+++ b/dom/plugins/test/mochitest/test_bug813906.html
@@ -16,33 +16,26 @@ function f() {
   document.getElementsByTagName("base")[0].href = "http://www.safe.com/";
 }
 </script>
 
 <script type="application/javascript">
 SimpleTest.waitForExplicitFinish();
 setTestPluginEnabledState(SpecialPowers.Ci.nsIPluginTag.STATE_ENABLED);
 
-// When the document is torn down or <svg> is removed, we hit bug 621618
-SimpleTest.expectAssertions(1);
-
 var frameLoadCount = 0;
 function frameLoaded() {
   frameLoadCount++;
   if (frameLoadCount == 1) {
     document.getElementsByTagName("object")[0].type = "application/x-test";
     document.getElementsByTagName("use")[0].setAttributeNS("http://www.w3.org/1999/xlink", "href", location.href + "#a");
   } else if (frameLoadCount == 2) {
     isnot(SpecialPowers.wrap(window.frame1).location.href.indexOf('chrome://'),
           0, 'plugin shouldnt be able to cause navigation to chrome URLs');
-
-    // Make sure we trigger bug 621618 before the test finishes so the assertion
-    // is attributed to this test.
-    document.body.removeChild(document.querySelector("svg"));
-    SimpleTest.executeSoon(function() { SimpleTest.finish(); });
+    SimpleTest.finish();
   }
 }
 </script>
 
 <svg>
   <symbol id="a">
     <foreignObject>
       <object bugmode="813906" frame="frame1"></object>

From: L. David Baron <dbaron@dbaron.org>

Bug 879275:  Warn once about use of deprecated XUL display types.

TODO:  Instead of this approach:
 - Give ImportantRule a pointer back to its StyleRule
 - warn once per StyleRule instead of once per document, given how
   hard it is to get the document
 - use the mLineNumber and mColumnNumber

diff --git a/dom/base/nsDeprecatedOperationList.h b/dom/base/nsDeprecatedOperationList.h
--- a/dom/base/nsDeprecatedOperationList.h
+++ b/dom/base/nsDeprecatedOperationList.h
@@ -33,14 +33,15 @@ DEPRECATED_OPERATION(GetSetUserData)
 DEPRECATED_OPERATION(MozGetAsFile)
 DEPRECATED_OPERATION(UseOfCaptureEvents)
 DEPRECATED_OPERATION(UseOfReleaseEvents)
 DEPRECATED_OPERATION(UseOfDOM3LoadMethod)
 DEPRECATED_OPERATION(ShowModalDialog)
 DEPRECATED_OPERATION(Window_Content)
 DEPRECATED_OPERATION(SyncXMLHttpRequest)
 DEPRECATED_OPERATION(DataContainerEvent)
+DEPRECATED_OPERATION(XULDisplayType)
 DEPRECATED_OPERATION(Window_Controllers)
 DEPRECATED_OPERATION(ImportXULIntoContent)
 DEPRECATED_OPERATION(PannerNodeDoppler)
 DEPRECATED_OPERATION(NavigatorGetUserMedia)
 DEPRECATED_OPERATION(WebrtcDeprecatedPrefix)
 DEPRECATED_OPERATION(AppCache)
diff --git a/dom/locales/en-US/chrome/dom/dom.properties b/dom/locales/en-US/chrome/dom/dom.properties
--- a/dom/locales/en-US/chrome/dom/dom.properties
+++ b/dom/locales/en-US/chrome/dom/dom.properties
@@ -147,16 +147,18 @@ UseOfDOM3LoadMethodWarning=Use of docume
 ShowModalDialogWarning=Use of window.showModalDialog() is deprecated. Use window.open() instead. For more help https://developer.mozilla.org/en-US/docs/Web/API/Window.open
 # LOCALIZATION NOTE: Do not translate "window._content" or "window.content"
 Window_ContentWarning=window._content is deprecated.  Please use window.content instead.
 # LOCALIZATION NOTE: Do not translate "XMLHttpRequest"
 SyncXMLHttpRequestWarning=Synchronous XMLHttpRequest on the main thread is deprecated because of its detrimental effects to the end user's experience. For more help http://xhr.spec.whatwg.org/
 ImplicitMetaViewportTagFallback=No meta-viewport tag found. Please explicitly specify one to prevent unexpected behavioural changes in future versions. For more help https://developer.mozilla.org/en/docs/Mozilla/Mobile/Viewport_meta_tag
 # LOCALIZATION NOTE: Do not translate "DataContainerEvent" or "CustomEvent"
 DataContainerEventWarning=Use of DataContainerEvent is deprecated. Use CustomEvent instead.
+# LOCALIZATION NOTE: Do not translate "-moz-box", "-moz-inline-box", "-moz-grid", "-moz-inline-grid", "-moz-grid-group", "-moz-grid-line", "-moz-stack", "-moz-inline-stack", "-moz-deck", "-moz-popup", or "-moz-groupbox
+XULDisplayTypeWarning=The non-standard XUL display types (-moz-box, -moz-inline-box, -moz-grid, -moz-inline-grid, -moz-grid-group, -moz-grid-line, -moz-stack, -moz-inline-stack, -moz-deck, -moz-popup, and -moz-groupbox) are deprecated and will soon be removed. Use the standard flex display types instead.  For more help see https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Flexible_boxes
 # LOCALIZATION NOTE: Do not translate "window.controllers"
 Window_ControllersWarning=window.controllers is deprecated. Do not use it for UA detection.
 ImportXULIntoContentWarning=Importing XUL nodes into a content document is deprecated. This functionality may be removed soon.
 XMLDocumentLoadPrincipalMismatch=Use of document.load forbidden on Documents that come from other Windows. Only the Window in which a Document was created is allowed to call .load on that Document. Preferably, use XMLHttpRequest instead.
 # LOCALIZATION NOTE: Do not translate "IndexedDB".
 IndexedDBTransactionAbortNavigation=An IndexedDB transaction that was not yet complete has been aborted due to page navigation.
 # LOCALIZATION NOTE: Do not translate Will-change, %1$S,%2$S are numbers.
 IgnoringWillChangeOverBudgetWarning=Will-change memory consumption is too high. Budget limit is the document surface area multiplied by %1$S (%2$S px). Occurrences of will-change over the budget will be ignored.
diff --git a/layout/style/CSSStyleSheet.cpp b/layout/style/CSSStyleSheet.cpp
--- a/layout/style/CSSStyleSheet.cpp
+++ b/layout/style/CSSStyleSheet.cpp
@@ -1366,16 +1366,25 @@ CSSStyleSheet::SetPrincipal(nsIPrincipal
   if (aPrincipal) {
     mInner->mPrincipal = aPrincipal;
 #ifdef DEBUG
     mInner->mPrincipalSet = true;
 #endif
   }
 }
 
+mozilla::css::SheetParsingMode
+CSSStyleSheet::ParsingMode() const
+{
+  // allow agent features if the style sheet's principal is the system principal
+  return nsContentUtils::IsSystemPrincipal(mInner->mPrincipal)
+           ? css::eAgentSheetFeatures
+           : css::eAuthorSheetFeatures;
+}
+
 /* virtual */ nsIURI*
 CSSStyleSheet::GetSheetURI() const
 {
   return mInner->mSheetURI;
 }
 
 /* virtual */ nsIURI*
 CSSStyleSheet::GetBaseURI() const
@@ -2260,34 +2269,28 @@ CSSStyleSheet::ReparseSheet(const nsAStr
     child->mParent = nullptr;
     child->mDocument = nullptr;
     child->mNext = nullptr;
     child = next;
   }
   mInner->mFirstChild = nullptr;
   mInner->mNameSpaceMap = nullptr;
 
-  // allow agent features if the style sheet's principal is the system principal
-  css::SheetParsingMode parsingMode =
-    nsContentUtils::IsSystemPrincipal(mInner->mPrincipal)
-      ? css::eAgentSheetFeatures
-      : css::eAuthorSheetFeatures;
-
   uint32_t lineNumber = 1;
   if (mOwningNode) {
     nsCOMPtr<nsIStyleSheetLinkingElement> link = do_QueryInterface(mOwningNode);
     if (link) {
       lineNumber = link->GetLineNumber();
     }
   }
 
   nsCSSParser parser(loader, this);
   nsresult rv = parser.ParseSheet(aInput, mInner->mSheetURI, mInner->mBaseURI,
                                   mInner->mPrincipal, lineNumber,
-                                  parsingMode, &reusableSheets);
+                                  ParsingMode(), &reusableSheets);
   DidDirty(); // we are always 'dirty' here since we always remove rules first
   NS_ENSURE_SUCCESS(rv, rv);
 
   // notify document of all new rules
   if (mDocument) {
     for (int32_t index = 0; index < mInner->mOrderedRules.Count(); ++index) {
       RefPtr<css::Rule> rule = mInner->mOrderedRules.ObjectAt(index);
       if (rule->GetType() == css::Rule::IMPORT_RULE &&
diff --git a/layout/style/CSSStyleSheet.h b/layout/style/CSSStyleSheet.h
--- a/layout/style/CSSStyleSheet.h
+++ b/layout/style/CSSStyleSheet.h
@@ -178,16 +178,18 @@ public:
    * This can only be called once with a non-null principal.  Calling this with
    * a null pointer is allowed and is treated as a no-op.
    */
   void SetPrincipal(nsIPrincipal* aPrincipal);
 
   // Principal() never returns a null pointer.
   nsIPrincipal* Principal() const { return mInner->mPrincipal; }
 
+  mozilla::css::SheetParsingMode ParsingMode() const;
+
   // The document this style sheet is associated with.  May be null
   nsIDocument* GetDocument() const { return mDocument; }
 
   void SetTitle(const nsAString& aTitle) { mTitle = aTitle; }
   void SetMedia(nsMediaList* aMedia);
   void SetOwningNode(nsINode* aOwningNode) { mOwningNode = aOwningNode; /* Not ref counted */ }
 
   void SetOwnerRule(css::ImportRule* aOwnerRule) { mOwnerRule = aOwnerRule; /* Not ref counted */ }
diff --git a/layout/style/Declaration.cpp b/layout/style/Declaration.cpp
--- a/layout/style/Declaration.cpp
+++ b/layout/style/Declaration.cpp
@@ -18,20 +18,50 @@
 
 namespace mozilla {
 namespace css {
 
 NS_IMPL_QUERY_INTERFACE(ImportantStyleData, nsIStyleRule)
 NS_IMPL_ADDREF_USING_AGGREGATOR(ImportantStyleData, Declaration())
 NS_IMPL_RELEASE_USING_AGGREGATOR(ImportantStyleData, Declaration())
 
+static void
+WarnForMozBox(const mozilla::css::Rule* aRule)
+{
+  nsIDocument* warnDoc = nullptr;
+
+  CSSStyleSheet* cssSheet = aRule->GetStyleSheet();
+  if (cssSheet) {
+    if (cssSheet->ParsingMode() == css::eAuthorSheetFeatures) {
+      warnDoc = cssSheet->GetOwningDocument();
+      NS_NOTREACHED("what, no document during rule mapping?");
+    }
+  } else {
+    nsHTMLCSSStyleSheet* styleAttrSheet = aRule->GetHTMLCSSStyleSheet();
+    if (styleAttrSheet) {
+      warnDoc = styleAttrSheet->GetOwningDocument();
+      NS_NOTREACHED("what, no document during rule mapping?");
+    } else {
+      NS_NOTREACHED("what, no sheet during rule mapping?");
+    }
+  }
+
+  if (warnDoc) {
+    warnDoc->WarnOnceAbout(nsIDocument::eXULDisplayType);
+  }
+}
+
 /* virtual */ void
 ImportantStyleData::MapRuleInfoInto(nsRuleData* aRuleData)
 {
   Declaration()->MapImportantRuleInfoInto(aRuleData);
+  if (aRuleData->mWarnForMozBox) {
+    WarnForMozBox(this);
+    aRuleData->mWarnForMozBox = false;
+  }
 }
 
 #ifdef DEBUG
 /* virtual */ void
 ImportantStyleData::List(FILE* out, int32_t aIndent) const
 {
   // Indent
   nsAutoCString str;
@@ -88,16 +118,24 @@ NS_IMPL_RELEASE(Declaration)
 /* virtual */ void
 Declaration::MapRuleInfoInto(nsRuleData* aRuleData)
 {
   MOZ_ASSERT(mData, "called while expanded");
   mData->MapRuleInfoInto(aRuleData);
   if (mVariables) {
     mVariables->MapRuleInfoInto(aRuleData);
   }
+  // FIXME: Move other code here!
+  if (aRuleData->mWarnForMozBox) {
+    // We have useful line number and column number information here,
+    // but ImportantRule doesn't, and nsIDocument::WarnOnceAbout doesn't
+    // handle it.
+    WarnForMozBox(this);
+    aRuleData->mWarnForMozBox = false;
+  }
 }
 
 void
 Declaration::ValueAppended(nsCSSProperty aProperty)
 {
   MOZ_ASSERT(!mData && !mImportantData,
              "should only be called while expanded");
   MOZ_ASSERT(!nsCSSProps::IsShorthand(aProperty),
diff --git a/layout/style/StyleRule.cpp b/layout/style/StyleRule.cpp
--- a/layout/style/StyleRule.cpp
+++ b/layout/style/StyleRule.cpp
@@ -26,16 +26,17 @@
 #include "nsCSSPseudoElements.h"
 #include "nsCSSPseudoClasses.h"
 #include "nsCSSAnonBoxes.h"
 #include "nsTArray.h"
 #include "nsDOMClassInfoID.h"
 #include "nsContentUtils.h"
 #include "nsError.h"
 #include "mozAutoDocUpdate.h"
+#include "nsHTMLCSSStyleSheet.h"
 
 class nsIDOMCSSStyleDeclaration;
 class nsIDOMCSSStyleSheet;
 
 using namespace mozilla;
 
 #define NS_IF_CLONE(member_)                                                  \
   PR_BEGIN_MACRO                                                              \
diff --git a/layout/style/nsCSSDataBlock.cpp b/layout/style/nsCSSDataBlock.cpp
--- a/layout/style/nsCSSDataBlock.cpp
+++ b/layout/style/nsCSSDataBlock.cpp
@@ -160,16 +160,22 @@ MapSinglePropertyInto(nsCSSProperty aPro
                 aTarget->SetColorValue(aRuleData->mPresContext->
                                        DefaultBackgroundColor());
             }
         } else {
             // Ignore 'color', 'border-*-color', etc.
             *aTarget = nsCSSValue();
         }
     }
+    if (aProp == eCSSProperty_display &&
+        aTarget->GetUnit() == eCSSUnit_Enumerated &&
+        nsStyleDisplay::IsDisplayTypeXUL(aTarget->GetIntValue()))
+    {
+        aRuleData->mWarnForMozBox = true;
+    }
 }
 
 /**
  * If aProperty is a logical property, converts it to the equivalent physical
  * property based on writing mode information obtained from aRuleData's
  * style context.
  */
 static inline void
diff --git a/layout/style/nsRuleData.cpp b/layout/style/nsRuleData.cpp
--- a/layout/style/nsRuleData.cpp
+++ b/layout/style/nsRuleData.cpp
@@ -23,31 +23,33 @@ nsRuleData::GetPoisonOffset()
   uintptr_t framePoisonValue = mozPoisonValue();
   return size_t(framePoisonValue - uintptr_t(mValueStorage)) /
          sizeof(nsCSSValue);
 }
 
 nsRuleData::nsRuleData(uint32_t aSIDs, nsCSSValue* aValueStorage,
                        nsPresContext* aContext, nsStyleContext* aStyleContext)
   : mSIDs(aSIDs),
+    mWarnForMozBox(false),
     mPresContext(aContext),
     mStyleContext(aStyleContext),
     mValueStorage(aValueStorage)
 {
 #ifndef MOZ_VALGRIND
   size_t framePoisonOffset = GetPoisonOffset();
   for (size_t i = 0; i < nsStyleStructID_Length; ++i) {
     mValueOffsets[i] = framePoisonOffset;
   }
 #endif
 }
 
 #ifdef DEBUG
 nsRuleData::~nsRuleData()
 {
+  NS_ASSERTION(!mWarnForMozBox, "failed to issue warning");
 #ifndef MOZ_VALGRIND
   // assert nothing in mSIDs has poison value
   size_t framePoisonOffset = GetPoisonOffset();
   for (size_t i = 0; i < nsStyleStructID_Length; ++i) {
     MOZ_ASSERT(!(mSIDs & (1 << i)) || mValueOffsets[i] != framePoisonOffset,
                "value in SIDs was left with poison offset");
   }
 #endif
diff --git a/layout/style/nsRuleData.h b/layout/style/nsRuleData.h
--- a/layout/style/nsRuleData.h
+++ b/layout/style/nsRuleData.h
@@ -23,17 +23,18 @@ class nsStyleContext;
 struct nsRuleData;
 
 typedef void (*nsPostResolveFunc)(void* aStyleStruct, nsRuleData* aData);
 
 struct nsRuleData
 {
   const uint32_t mSIDs;
   mozilla::RuleNodeCacheConditions mConditions;
-  bool mIsImportantRule;
+  bool mIsImportantRule : 1;
+  bool mWarnForMozBox : 1;
   mozilla::SheetType mLevel;
   nsPresContext* const mPresContext;
   nsStyleContext* const mStyleContext;
 
   // We store nsCSSValues needed to compute the data for one or more
   // style structs (specified by the bitfield mSIDs).  These are stored
   // in a single array allocation (which our caller allocates; see
   // AutoCSSValueArray)   The offset of each property |prop| in
diff --git a/layout/style/nsStyleStruct.h b/layout/style/nsStyleStruct.h
--- a/layout/style/nsStyleStruct.h
+++ b/layout/style/nsStyleStruct.h
@@ -2324,16 +2324,30 @@ struct nsStyleDisplay {
   bool IsInlineOutsideStyle() const {
     return IsDisplayTypeInlineOutside(mDisplay);
   }
 
   bool IsOriginalDisplayInlineOutsideStyle() const {
     return IsDisplayTypeInlineOutside(mOriginalDisplay);
   }
 
+  static bool IsDisplayTypeXUL(uint8_t aDisplay) {
+    return aDisplay == NS_STYLE_DISPLAY_BOX ||
+           aDisplay == NS_STYLE_DISPLAY_INLINE_BOX ||
+           aDisplay == NS_STYLE_DISPLAY_XUL_GRID ||
+           aDisplay == NS_STYLE_DISPLAY_INLINE_XUL_GRID ||
+           aDisplay == NS_STYLE_DISPLAY_XUL_GRID_GROUP ||
+           aDisplay == NS_STYLE_DISPLAY_XUL_GRID_LINE ||
+           aDisplay == NS_STYLE_DISPLAY_STACK ||
+           aDisplay == NS_STYLE_DISPLAY_INLINE_STACK ||
+           aDisplay == NS_STYLE_DISPLAY_DECK ||
+           aDisplay == NS_STYLE_DISPLAY_POPUP ||
+           aDisplay == NS_STYLE_DISPLAY_GROUPBOX;
+  }
+
   bool IsInnerTableStyle() const {
     return NS_STYLE_DISPLAY_TABLE_CAPTION == mDisplay ||
            NS_STYLE_DISPLAY_TABLE_CELL == mDisplay ||
            NS_STYLE_DISPLAY_TABLE_ROW == mDisplay ||
            NS_STYLE_DISPLAY_TABLE_ROW_GROUP == mDisplay ||
            NS_STYLE_DISPLAY_TABLE_HEADER_GROUP == mDisplay ||
            NS_STYLE_DISPLAY_TABLE_FOOTER_GROUP == mDisplay ||
            NS_STYLE_DISPLAY_TABLE_COLUMN == mDisplay ||
diff --git a/webapprt/locales/en-US/webapprt/overrides/dom.properties b/webapprt/locales/en-US/webapprt/overrides/dom.properties
--- a/webapprt/locales/en-US/webapprt/overrides/dom.properties
+++ b/webapprt/locales/en-US/webapprt/overrides/dom.properties
@@ -142,13 +142,17 @@ UseOfDOM3LoadMethodWarning=Use of docume
 # LOCALIZATION NOTE: Do not translate "window.showModalDialog()" or "window.open()" 
 ShowModalDialogWarning=Use of window.showModalDialog() is deprecated. Use window.open() instead. For more help https://developer.mozilla.org/en-US/docs/Web/API/Window.open
 # LOCALIZATION NOTE: Do not translate "window._content" or "window.content"
 Window_ContentWarning=window._content is deprecated. Please use window.content instead.
 # LOCALIZATION NOTE: Do not translate "XMLHttpRequest"
 SyncXMLHttpRequestWarning=Synchronous XMLHttpRequest on the main thread is deprecated because of its detrimental effects to the end user's experience. For more help http://xhr.spec.whatwg.org/
 # LOCALIZATION NOTE: Do not translate "DataContainerEvent" or "CustomEvent"
 DataContainerEventWarning=Use of DataContainerEvent is deprecated. Use CustomEvent instead.
+# LOCALIZATION NOTE: Do not translate "sendAsBinary" or "send(Blob data)"
+SendAsBinaryWarning=The non-standard sendAsBinary method is deprecated and will soon be removed. Use the standard send(Blob data) method instead.
+# LOCALIZATION NOTE: Do not translate "-moz-box", "-moz-inline-box", "-moz-grid", "-moz-inline-grid", "-moz-grid-group", "-moz-grid-line", "-moz-stack", "-moz-inline-stack", "-moz-deck", "-moz-popup", or "-moz-groupbox
+XULDisplayTypeWarning=The non-standard XUL display types (-moz-box, -moz-inline-box, -moz-grid, -moz-inline-grid, -moz-grid-group, -moz-grid-line, -moz-stack, -moz-inline-stack, -moz-deck, -moz-popup, and -moz-groupbox) are deprecated and will soon be removed. Use the standard flex display types instead.  For more help see https://developer.mozilla.org/en-US/docs/Web/Guide/CSS/Flexible_boxes
 # LOCALIZATION NOTE: Do not translate "Worker".
 EmptyWorkerSourceWarning=Attempting to create a Worker from an empty source. This is probably unintentional.
 WebrtcDeprecatedPrefixWarning=WebRTC interfaces with the "moz" prefix (mozRTCPeerConnection, mozRTCSessionDescription, mozRTCIceCandidate) have been deprecated.
 NavigatorGetUserMediaWarning=navigator.mozGetUserMedia has been replaced by navigator.mediaDevices.getUserMedia
 ExecCommandCutCopyDeniedNotInputDriven=document.execCommand('cut'/'copy') was denied because it was not called from inside a short running user-generated event handler.

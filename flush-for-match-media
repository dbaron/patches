From: L. David Baron <dbaron@dbaron.org>

Add flush before we find our pres context, to fix media queries tests on ringmark.  (Bug 753777)  r=bzbarsky

diff --git a/dom/base/nsGlobalWindow.cpp b/dom/base/nsGlobalWindow.cpp
--- a/dom/base/nsGlobalWindow.cpp
+++ b/dom/base/nsGlobalWindow.cpp
@@ -3962,16 +3962,24 @@ nsGlobalWindow::MatchMedia(const nsAStri
   // shell/context off the docshell dance is sort of silly; it'd make
   // more sense to forward to the inner, but it's what everyone else
   // (GetSelection, GetScrollXY, etc.) does around here.
   FORWARD_TO_OUTER(MatchMedia, (aMediaQueryList, aResult),
                    NS_ERROR_NOT_INITIALIZED);
 
   *aResult = nsnull;
 
+  // We need this now to ensure that we have a non-null |presContext|
+  // when we ought to.
+  // This is similar to EnsureSizeUpToDate, but only flushes frames.
+  nsGlobalWindow *parent = static_cast<nsGlobalWindow*>(GetPrivateParent());
+  if (parent) {
+    parent->FlushPendingNotifications(Flush_Frames);
+  }
+
   if (!mDocShell)
     return NS_OK;
 
   nsRefPtr<nsPresContext> presContext;
   mDocShell->GetPresContext(getter_AddRefs(presContext));
 
   if (!presContext)
     return NS_OK;
diff --git a/layout/style/test/test_media_query_list.html b/layout/style/test/test_media_query_list.html
--- a/layout/style/test/test_media_query_list.html
+++ b/layout/style/test/test_media_query_list.html
@@ -275,16 +275,29 @@ function run() {
     iframe.style.width = "100px";
     subroot.offsetWidth; // flush layout
     // With the bug, we crash here.  No need for test assertions.
 
     mql.removeListener(null);
     mql.removeListener(null);
   })();
 
+  /* Bug 753777: test that things work in a freshly-created iframe */
+  (function() {
+    var iframe = document.createElement("iframe");
+    document.body.appendChild(iframe);
+
+    is(iframe.contentWindow.matchMedia("(min-width: 1px)").matches, true,
+       "(min-width: 1px) should match in newly-created iframe");
+    is(iframe.contentWindow.matchMedia("(max-width: 1px)").matches, false,
+       "(max-width: 1px) should not match in newly-created iframe");
+
+    document.body.removeChild(iframe);
+  })();
+
   /* Bug 716751: listeners lost due to GC */
   var gc_received = [];
   (function() {
     var received = [];
     var listener1 = function(mql) {
       gc_received.push(1);
     }
 

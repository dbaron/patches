From: L. David Baron <dbaron@dbaron.org>

Bug 1087536 patch 3 - Use new no-selector-matching hints for animation restyles.

This depends on bug 1086937 patch 1 because it requires that
ResolveStyleWithReplacement support eRestyle_ChangeAnimationPhase on
::before and ::after pseudo-elements.

This is needed for bug 960465 so that we can use these hints to detect
whether pending restyles include restyles other than those for
animations.  In other words, patches for bug 960465 (or perhaps a
dependent bug that lands before it) will require that all animation
restyles use an animation-specific nsRestyleHint.

FIXME: Breaks lockscreen on phone after screen has been off!
(Still true as of 2014-11-12.)

FIXME: Breaks some tests in layout/style/test/test_transitions.html
and layout/style/test/test_transitions_events.html related to computed
values at the end of transitions.

diff --git a/layout/style/AnimationCommon.h b/layout/style/AnimationCommon.h
--- a/layout/style/AnimationCommon.h
+++ b/layout/style/AnimationCommon.h
@@ -265,17 +265,20 @@ struct AnimationPlayerCollection : publi
     return NS_LITERAL_STRING("::after");
   }
 
   mozilla::dom::Element* GetElementToRestyle() const;
 
   void PostRestyleForAnimation(nsPresContext *aPresContext) {
     mozilla::dom::Element* element = GetElementToRestyle();
     if (element) {
-      aPresContext->PresShell()->RestyleForAnimation(element, eRestyle_Self);
+      nsRestyleHint hint = IsForTransitions() ? eRestyle_CSSTransitions
+                                              : eRestyle_CSSAnimations;
+      hint |= eRestyle_ChangeAnimationPhase;
+      aPresContext->PresShell()->RestyleForAnimation(element, hint);
     }
   }
 
   static void LogAsyncAnimationFailure(nsCString& aMessage,
                                        const nsIContent* aContent = nullptr);
 
   dom::Element *mElement;
 

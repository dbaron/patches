From: L. David Baron <dbaron@dbaron.org>

Bug 960465 patch N - Use new no-selector-matching hints for animation restyles.

FIXME: This requires that ResolveStyleWithReplacement support the
::before and ::after pseudo-elements for all of the levels implied
by eRestyle_ChangeAnimationPhase.

diff --git a/layout/style/AnimationCommon.h b/layout/style/AnimationCommon.h
--- a/layout/style/AnimationCommon.h
+++ b/layout/style/AnimationCommon.h
@@ -263,17 +263,20 @@ struct AnimationPlayerCollection : publi
     }
   }
 
   mozilla::dom::Element* GetElementToRestyle() const;
 
   void PostRestyleForAnimation(nsPresContext *aPresContext) {
     mozilla::dom::Element* element = GetElementToRestyle();
     if (element) {
-      aPresContext->PresShell()->RestyleForAnimation(element, eRestyle_Self);
+      nsRestyleHint hint = IsForTransitions() ? eRestyle_CSSTransitions
+                                              : eRestyle_CSSAnimations;
+      hint |= eRestyle_ChangeAnimationPhase;
+      aPresContext->PresShell()->RestyleForAnimation(element, hint);
     }
   }
 
   static void LogAsyncAnimationFailure(nsCString& aMessage,
                                        const nsIContent* aContent = nullptr);
 
   dom::Element *mElement;
 
diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -2108,17 +2108,19 @@ SkipAnimationRules(nsRuleNode* aRuleNode
 
   if (ruleNode != aRuleNode && aPostAnimationRestyles) {
     NS_ASSERTION(aElementOrPseudoElement,
                  "How can we have transition rules but no element?");
     // Need to do an animation restyle, just like
     // nsTransitionManager::WalkTransitionRule and
     // nsAnimationManager::GetAnimationRule would.
     aRuleNode->PresContext()->PresShell()->
-      RestyleForAnimation(aElementOrPseudoElement, eRestyle_Self);
+      RestyleForAnimation(aElementOrPseudoElement,
+                          eRestyle_CSSAnimations |
+                            eRestyle_ChangeAnimationPhase);
   }
   return ruleNode;
 }
 
 already_AddRefed<nsStyleContext>
 nsStyleSet::ReparentStyleContext(nsStyleContext* aStyleContext,
                                  nsStyleContext* aNewParentContext,
                                  Element* aElement,

From: L. David Baron <dbaron@dbaron.org>

Bug 1257981 - Mark the root of the rule tree during rule tree GC.  r?heycam

MozReview-Commit-ID: 1riBGYsGspn

diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -2256,22 +2256,23 @@ nsStyleSet::GCRuleTrees()
   // Mark the style context tree by marking all style contexts which
   // have no parent, which will mark all descendants.  This will reach
   // style contexts in the undisplayed map and "additional style
   // contexts" since they are descendants of the roots.
   for (int32_t i = mRoots.Length() - 1; i >= 0; --i) {
     mRoots[i]->Mark();
   }
 
+  // Just in case there are no style contexts alive now, mark the root of
+  // the rule tree.
+  mRuleTree->Mark();
+
   // Sweep the rule tree.
-#ifdef DEBUG
-  bool deleted =
-#endif
-    mRuleTree->Sweep();
-  NS_ASSERTION(!deleted, "Root node must not be gc'd");
+  DebugOnly<bool> deleted = mRuleTree->Sweep();
+  MOZ_ASSERT(!deleted, "Root node must not be gc'd");
 
   // Sweep the old rule trees.
   for (uint32_t i = mOldRuleTrees.Length(); i > 0; ) {
     --i;
     if (mOldRuleTrees[i]->Sweep()) {
       // It was deleted, as it should be.
       mOldRuleTrees.RemoveElementAt(i);
     } else {

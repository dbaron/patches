From: L. David Baron <dbaron@dbaron.org>

ClearRuleCascades when ensuring a stylesheet has a unique inner so that matched rules point back to the new rules.  (Bug 536379)  r=bzbarsky

diff --git a/layout/style/nsCSSStyleSheet.cpp b/layout/style/nsCSSStyleSheet.cpp
--- a/layout/style/nsCSSStyleSheet.cpp
+++ b/layout/style/nsCSSStyleSheet.cpp
@@ -1476,16 +1476,20 @@ nsCSSStyleSheet::EnsureUniqueInner()
     return eUniqueInner_AlreadyUnique;
   }
   nsCSSStyleSheetInner* clone = mInner->CloneFor(this);
   if (!clone) {
     return eUniqueInner_CloneFailed;
   }
   mInner->RemoveSheet(this);
   mInner = clone;
+
+  // otherwise the rule processor has pointers to the old rules
+  ClearRuleCascades();
+
   return eUniqueInner_ClonedInner;
 }
 
 NS_IMETHODIMP
 nsCSSStyleSheet::Clone(nsICSSStyleSheet* aCloneParent,
                        nsICSSImportRule* aCloneOwnerRule,
                        nsIDocument* aCloneDocument,
                        nsIDOMNode* aCloneOwningNode,

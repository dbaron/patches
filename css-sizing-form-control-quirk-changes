From: L. David Baron <dbaron@dbaron.org>

Proposed changes for https://github.com/w3c/csswg-drafts/issues/765 .

MozReview-Commit-ID: 8fxzak3SzRD

diff --git a/layout/base/nsLayoutUtils.cpp b/layout/base/nsLayoutUtils.cpp
--- a/layout/base/nsLayoutUtils.cpp
+++ b/layout/base/nsLayoutUtils.cpp
@@ -4928,16 +4928,18 @@ static int32_t gNoiseIndent = 0;
 // Return true for form controls whose minimum intrinsic inline-size
 // shrinks to 0 when they have a percentage inline-size (but not
 // percentage max-inline-size).  (Proper replaced elements, whose
 // intrinsic minimium inline-size shrinks to 0 for both percentage
 // inline-size and percentage max-inline-size, are handled elsewhere.)
 inline static bool
 FormControlShrinksForPercentISize(nsIFrame* aFrame)
 {
+  // FIXME: change something here?
+
   if (!aFrame->IsFrameOfType(nsIFrame::eReplaced)) {
     // Quick test to reject most frames.
     return false;
   }
 
   LayoutFrameType fType = aFrame->Type();
   if (fType == LayoutFrameType::Meter || fType == LayoutFrameType::Progress) {
     // progress and meter do have this shrinking behavior
@@ -5027,27 +5029,30 @@ AddIntrinsicSizeOffset(gfxContext* aRend
   min += coordOutsideSize;
   result = NSCoordSaturatingAdd(result, coordOutsideSize);
   pctTotal += pctOutsideSize;
 
   const bool shouldAddPercent = aType == nsLayoutUtils::PREF_ISIZE ||
                                 (aFlags & nsLayoutUtils::ADD_PERCENTS);
   nscoord size;
   if (aType == nsLayoutUtils::MIN_ISIZE &&
-      (((aStyleSize.HasPercent() || aStyleMaxSize.HasPercent()) &&
-        aFrame->IsFrameOfType(nsIFrame::eReplacedSizing)) ||
-       (aStyleSize.HasPercent() &&
-        FormControlShrinksForPercentISize(aFrame)))) {
+      (aStyleSize.HasPercent() || aStyleMaxSize.HasPercent()) &&
+      (aFrame->IsFrameOfType(nsIFrame::eReplacedSizing) ||
+       FormControlShrinksForPercentISize(aFrame))) {
     // A percentage width or max-width on replaced elements means they
     // can shrink to 0.
     // This is also true for percentage widths (but not max-widths) on
     // text inputs.
     // Note that if this is max-width, this overrides the fixed-width
     // rule in the next condition.
-    result = 0; // let |min| handle padding/border/margin
+    // If this is a calc() expression with a percent, we only have the
+    // percent part shrink to 0.
+    result = std::min(nsRuleNode::ComputeCoordPercentCalc(aStyleSize, 0),
+                      nsRuleNode::ComputeCoordPercentCalc(aStyleMaxSize, 0));
+    // let |min| handle padding/border/margin
   } else if (GetAbsoluteCoord(aStyleSize, size) ||
              GetIntrinsicCoord(aStyleSize, aRenderingContext, aFrame,
                                PROP_WIDTH, size)) {
     result = size + coordOutsideSize;
     if (shouldAddPercent) {
       result = nsLayoutUtils::AddPercents(result, pctOutsideSize);
     }
   } else {

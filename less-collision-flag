From: L. David Baron <dbaron@dbaron.org>

Don't set the collision flag when adding to PLDHashTable if we've already found the entry we're going to add.

MozReview-Commit-ID: CsXnMYttHVy

diff --git a/xpcom/ds/PLDHashTable.cpp b/xpcom/ds/PLDHashTable.cpp
--- a/xpcom/ds/PLDHashTable.cpp
+++ b/xpcom/ds/PLDHashTable.cpp
@@ -367,21 +367,19 @@ PLDHashTable::SearchTable(const void* aK
   uint32_t sizeMask;
   Hash2(aKeyHash, hash2, sizeMask);
 
   // Save the first removed entry pointer so Add() can recycle it. (Only used
   // if Reason==ForAdd.)
   PLDHashEntryHdr* firstRemoved = nullptr;
 
   for (;;) {
-    if (Reason == ForAdd) {
+    if (Reason == ForAdd && !firstRemoved) {
       if (MOZ_UNLIKELY(EntryIsRemoved(entry))) {
-        if (!firstRemoved) {
-          firstRemoved = entry;
-        }
+        firstRemoved = entry;
       } else {
         entry->mKeyHash |= kCollisionFlag;
       }
     }
 
     hash1 -= hash2;
     hash1 &= sizeMask;
 

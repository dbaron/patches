From: L. David Baron <dbaron@dbaron.org>

Bug 1186061 patch 1 - Add feature to reftest harness to allow skipping the flush.

diff --git a/layout/tools/reftest/README.txt b/layout/tools/reftest/README.txt
--- a/layout/tools/reftest/README.txt
+++ b/layout/tools/reftest/README.txt
@@ -486,16 +486,26 @@ met, the test will fail.
 
 Snapshot The Whole Window: class="reftest-snapshot-all"
 =======================================================
 
 In a reftest-wait test, to disable testing of invalidation and force the final
 snapshot to be taken of the whole window, set the "reftest-snapshot-all"
 class on the root element.
 
+Avoid triggering flushes: class="reftest-no-flush"
+==================================================
+
+The reftest harness normally triggers flushes by calling
+getBoundingClientRect on the root element.  If the root element of the
+test has class="reftest-no-flush", it doesn't do this.
+
+This is useful for testing animations on the compositor thread, since
+the flushing will cause a main thread style update.
+
 Zoom Tests: reftest-zoom="<float>"
 ==================================
 
 When the root element of a test has a "reftest-zoom" attribute, that zoom
 factor is applied when rendering the test. The corresponds to the desktop "full
 zoom" style zoom. The reftest document will be 800 device pixels wide by 1000
 device pixels high. The reftest harness assumes that the CSS pixel dimensions
 are 800/zoom and 1000/zoom. For best results therefore, choose zoom factors
diff --git a/layout/tools/reftest/reftest-content.js b/layout/tools/reftest/reftest-content.js
--- a/layout/tools/reftest/reftest-content.js
+++ b/layout/tools/reftest/reftest-content.js
@@ -397,20 +397,21 @@ const STATE_COMPLETED = 5;
 function FlushRendering() {
     var anyPendingPaintsGeneratedInDescendants = false;
 
     function flushWindow(win) {
         var utils = win.QueryInterface(CI.nsIInterfaceRequestor)
                     .getInterface(CI.nsIDOMWindowUtils);
         var afterPaintWasPending = utils.isMozAfterPaintPending;
 
-        if (win.document.documentElement) {
+        var root = win.document.documentElement;
+        if (root && !root.classList.contains("reftest-no-flush")) {
             try {
                 // Flush pending restyles and reflows for this window
-                win.document.documentElement.getBoundingClientRect();
+                root.getBoundingClientRect();
             } catch (e) {
                 LogWarning("flushWindow failed: " + e + "\n");
             }
         }
 
         if (!afterPaintWasPending && utils.isMozAfterPaintPending) {
             LogInfo("FlushRendering generated paint for window " + win.location.href);
             anyPendingPaintsGeneratedInDescendants = true;

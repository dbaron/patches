From: L. David Baron <dbaron@dbaron.org>

Bug N patch 1 - Depend on the animation-only style flush for updating animations

diff --git a/layout/base/RestyleManager.cpp b/layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp
+++ b/layout/base/RestyleManager.cpp
@@ -1573,16 +1573,17 @@ RestyleManager::ProcessPendingRestyles()
 #endif
 
   // Before we process any restyles, we need to ensure that style
   // resulting from any animations is up-to-date, so that if any style
   // changes we cause trigger transitions, we have the correct old style
   // for starting the transition.
   if (mHavePendingNonAnimationRestyles) {
     ++mAnimationGeneration;
+    // FIXME: ... and we do this!
     UpdateOnlyAnimationStyles();
   }
 
   // Until we get rid of these phases in bug 960465, we need to skip
   // animation restyles during the non-animation phase, and post
   // animation restyles so that we restyle those elements again in the
   // animation phase.
   mSkipAnimationRules = true;
diff --git a/layout/base/nsPresShell.cpp b/layout/base/nsPresShell.cpp
--- a/layout/base/nsPresShell.cpp
+++ b/layout/base/nsPresShell.cpp
@@ -4208,16 +4208,17 @@ PresShell::FlushPendingNotifications(moz
 
       mPresContext->FlushCounterStyles();
 
       // Flush any requested SMIL samples.
       if (mDocument->HasAnimationController()) {
         mDocument->GetAnimationController()->FlushResampleRequests();
       }
 
+      // FIXME: ... and we do this!
       if (aFlush.mFlushAnimations &&
           !mPresContext->StyleUpdateForAllAnimationsIsUpToDate()) {
         if (mPresContext->AnimationManager()) {
           mPresContext->AnimationManager()->
             FlushAnimations(CommonAnimationManager::Cannot_Throttle);
         }
         if (mPresContext->TransitionManager()) {
           mPresContext->TransitionManager()->
diff --git a/layout/style/nsAnimationManager.cpp b/layout/style/nsAnimationManager.cpp
--- a/layout/style/nsAnimationManager.cpp
+++ b/layout/style/nsAnimationManager.cpp
@@ -785,16 +785,17 @@ nsAnimationManager::WillRefresh(mozilla:
     // Someone might be keeping mPresContext alive past the point
     // where it has been torn down; don't bother doing anything in
     // this case.  But do get rid of all our transitions so we stop
     // triggering refreshes.
     RemoveAllElementCollections();
     return;
   }
 
+  // FIXME: We do this...
   FlushAnimations(Can_Throttle);
 }
 
 void
 nsAnimationManager::AddElementCollection(
   AnimationPlayerCollection* aCollection)
 {
   if (!mObservingRefreshDriver) {
diff --git a/layout/style/nsTransitionManager.cpp b/layout/style/nsTransitionManager.cpp
--- a/layout/style/nsTransitionManager.cpp
+++ b/layout/style/nsTransitionManager.cpp
@@ -693,16 +693,17 @@ nsTransitionManager::WillRefresh(mozilla
     // Someone might be keeping mPresContext alive past the point
     // where it has been torn down; don't bother doing anything in
     // this case.  But do get rid of all our transitions so we stop
     // triggering refreshes.
     RemoveAllElementCollections();
     return;
   }
 
+  // FIXME: We do this...
   FlushTransitions(Can_Throttle);
 }
 
 void
 nsTransitionManager::FlushTransitions(FlushFlags aFlags)
 {
   if (PR_CLIST_IS_EMPTY(&mElementCollections)) {
     // no transitions, leave early

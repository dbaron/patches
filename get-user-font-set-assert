Don't assert when we call GetUserFontSet during frame construction.  (Bug 466756)  r+sr=bzbarsky  a191=beltzner

diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -1704,20 +1704,29 @@ nsPresContext::GetUserFontSet()
   // rule cascade creation.  Thus we try to enforce the invariant that
   // we *never* build the user font set until the first call to
   // GetUserFontSet.  However, once it's been requested, we can't wait
   // for somebody to call GetUserFontSet in order to rebuild it (see
   // comments below in RebuildUserFontSet for why).
   if (mUserFontSetDirty) {
     // If this assertion fails, and there have actually been changes to
     // @font-face rules, then we will call StyleChangeReflow in
-    // FlushUserFontSet.  Since we're likely in the middle of reflow,
-    // that's a bad thing to do.
-    NS_ASSERTION(!mGetUserFontSetCalled,
-                 "FlushUserFontSet should have been called first");
+    // FlushUserFontSet.  If we're in the middle of reflow,
+    // that's a bad thing to do, and the caller was responsible for
+    // flushing first.  If we're not (e.g., in frame construction), it's
+    // ok.
+#ifdef DEBUG
+    {
+      PRBool inReflow;
+      NS_ASSERTION(!mGetUserFontSetCalled ||
+                   (NS_SUCCEEDED(mShell->IsReflowLocked(&inReflow)) &&
+                    !inReflow),
+                   "FlushUserFontSet should have been called first");
+    }
+#endif
     FlushUserFontSet();
   }
 
   mGetUserFontSetCalled = PR_TRUE;
   return mUserFontSet;
 }
 
 void

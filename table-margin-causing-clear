Fix extra block-clearing caused by margins on tables.  b=430813  r+sr=roc  a=damon

diff --git a/layout/generic/nsBlockFrame.cpp b/layout/generic/nsBlockFrame.cpp
--- a/layout/generic/nsBlockFrame.cpp
+++ b/layout/generic/nsBlockFrame.cpp
@@ -6836,8 +6836,8 @@ nsBlockFrame::WidthToClearPastFloats(nsB
     aState.ComputeReplacedBlockOffsetsForFloats(aFrame, leftOffset, rightOffset,
                                                 &result);
 
-    nscoord availWidth = aState.mContentArea.width - leftOffset - rightOffset
-                           + result.marginLeft + result.marginRight;
+    // result.marginLeft has already been subtracted from leftOffset (etc.)
+    nscoord availWidth = aState.mContentArea.width - leftOffset - rightOffset;
     // Force the outer frame to shrink-wrap (otherwise it just sizes to
     // the available width unconditionally).
     result.borderBoxWidth =
diff --git a/layout/reftests/bugs/430813-1-ref.html b/layout/reftests/bugs/430813-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/430813-1-ref.html
@@ -0,0 +1,19 @@
+<!DOCTYPE html>
+<html lang="en">
+<head>
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+	<title>Testcase, bug 430813</title>
+	<style type="text/css">
+		table, td { border-spacing: 0; margin: 0; padding: 0; }
+		td { background: aqua; }
+	</style>
+</head>
+<body style="border: 1px solid; width: 500px; height: 600px;">
+<table style="margin-right: 50px"><tr><td>
+This should be near the top of the page, not 200px down.
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+</td></tr></table>
+</body></html>
diff --git a/layout/reftests/bugs/430813-1.html b/layout/reftests/bugs/430813-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/430813-1.html
@@ -0,0 +1,20 @@
+<!DOCTYPE html>
+<html lang="en">
+<head>
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+	<title>Testcase, bug 430813</title>
+	<style type="text/css">
+		table, td { border-spacing: 0; margin: 0; padding: 0; }
+		td { background: aqua; }
+	</style>
+</head>
+<body style="border: 1px solid; width: 500px; height: 600px;">
+<div style="float:right;height:200px;width:50px"></div>
+<table style="margin-right: 10px"><tr><td>
+This should be near the top of the page, not 200px down.
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+</td></tr></table>
+</body></html>
diff --git a/layout/reftests/bugs/430813-2-ref.html b/layout/reftests/bugs/430813-2-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/430813-2-ref.html
@@ -0,0 +1,19 @@
+<!DOCTYPE html>
+<html lang="en">
+<head>
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+	<title>Testcase, bug 430813</title>
+	<style type="text/css">
+		table, td { border-spacing: 0; margin: 0; padding: 0; }
+		td { background: aqua; }
+	</style>
+</head>
+<body style="border: 1px solid; width: 500px; height: 600px;">
+<table style="margin-left: 50px; margin-right: 10px"><tr><td>
+This should be near the top of the page, not 200px down.
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+</td></tr></table>
+</body></html>
diff --git a/layout/reftests/bugs/430813-2.html b/layout/reftests/bugs/430813-2.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/bugs/430813-2.html
@@ -0,0 +1,20 @@
+<!DOCTYPE html>
+<html lang="en">
+<head>
+	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+	<title>Testcase, bug 430813</title>
+	<style type="text/css">
+		table, td { border-spacing: 0; margin: 0; padding: 0; }
+		td { background: aqua; }
+	</style>
+</head>
+<body style="border: 1px solid; width: 500px; height: 600px;">
+<div style="float:left;height:200px;width:50px"></div>
+<table style="margin-right: 10px"><tr><td>
+This should be near the top of the page, not 200px down.
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+blah blah blah blah blah blah blah blah blah blah blah blah blah blah blah
+</td></tr></table>
+</body></html>
diff --git a/layout/reftests/bugs/reftest.list b/layout/reftests/bugs/reftest.list
--- a/layout/reftests/bugs/reftest.list
+++ b/layout/reftests/bugs/reftest.list
@@ -831,4 +831,5 @@ fails-if(MOZ_WIDGET_TOOLKIT=="gtk2") == 
 == 428521-1b.html 428521-1-ref.html
 == 428521-1c.html 428521-1-ref.html
 == 430412-1.html 430412-1-ref.html
-
+== 430813-1.html 430813-1-ref.html
+== 430813-2.html 430813-2-ref.html

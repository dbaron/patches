From: L. David Baron <dbaron@dbaron.org>

Additional test fixes for disable-after-paint (to merge into it).

diff --git a/content/events/test/test_bug426082.html b/content/events/test/test_bug426082.html
--- a/content/events/test/test_bug426082.html
+++ b/content/events/test/test_bug426082.html
@@ -23,16 +23,32 @@ https://bugzilla.mozilla.org/show_bug.cg
   
 </div>
 <pre id="test">
 <script type="application/javascript;version=1.8">
 
 /** Test for Bug 426082 **/
 SimpleTest.waitForExplicitFinish();
 
+function get_after_paint_pref()
+{
+    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
+    var prefs = Components.classes["@mozilla.org/preferences-service;1"].
+                  getService(Components.interfaces.nsIPrefBranch);
+    return prefs.getBoolPref("dom.send_after_paint_to_content");
+}
+
+function set_after_paint_pref(val)
+{
+    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
+    var prefs = Components.classes["@mozilla.org/preferences-service;1"].
+                  getService(Components.interfaces.nsIPrefBranch);
+    prefs.setBoolPref("dom.send_after_paint_to_content", val);
+}
+
 var normalButtonCanvas, pressedButtonCanvas, normalFocusedButtonCanvas,
     pressedFocusedButtonCanvas, currentSnapshot, button, label, outside;
 
 function runTests() {
   normalButtonCanvas = $("normalButtonCanvas");
   pressedButtonCanvas = $("pressedButtonCanvas");
   normalFocusedButtonCanvas = $("normalFocusedButtonCanvas");
   pressedFocusedButtonCanvas = $("pressedFocusedButtonCanvas");
@@ -84,16 +100,18 @@ function executeTests() {
       button.getBoundingClientRect(); // Flush.
       SimpleTest.executeSoon(execNext);
     } catch (e) {}
   }
   execNext();
 }
 
 function tests() {
+  var orig_after_paint_pref = get_after_paint_pref();
+  set_after_paint_pref(true);
   window.addEventListener("MozAfterPaint", paintListener, false);
   // Press the label.
   sendMouseEvent("mousemove", label);
   sendMouseEvent("mousedown", label);
   yield;
   compareSnapshots_(normalButtonCanvas, currentSnapshot, false, "Pressing the label should have pressed the button.");
   takeSnapshot(pressedButtonCanvas);
   // Move the mouse down from the label.
@@ -112,16 +130,17 @@ function tests() {
   sendMouseEvent("mousemove", label);
   sendMouseEvent("mousedown", label);
   yield;
   label.parentNode.removeChild(label);
   yield;
   compareSnapshots_(normalButtonCanvas, currentSnapshot, true, "Removing the label should have unpressed the button.");
   sendMouseEvent("mouseup", label);
   window.removeEventListener("MozAfterPaint", paintListener, false);
+  set_after_paint_pref(orig_after_paint_pref);
   SimpleTest.finish();
 }
 
 function sendMouseEvent(t, elem) {
   var r = elem.getBoundingClientRect();
   synthesizeMouse(elem, r.width / 2, r.height / 2, {type: t});
 }
 

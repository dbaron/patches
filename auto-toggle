From: L. David Baron <dbaron@dbaron.org>

Add AutoToggle class for saving and restoring values.  (Bug 518756)

diff --git a/xpcom/glue/AutoRestore.h b/xpcom/glue/AutoRestore.h
--- a/xpcom/glue/AutoRestore.h
+++ b/xpcom/glue/AutoRestore.h
@@ -169,22 +169,61 @@ namespace mozilla {
    *     // mIsPainting is reset to its old value at the end of this block
    *   }
    */
   template <class T>
   class NS_STACK_CLASS AutoRestore
   {
   private:
     T& mLocation;
-    T mValue;
+    const T mValue;
     MOZILLA_DECL_USE_GUARD_OBJECT_NOTIFIER
   public:
     AutoRestore(T& aValue MOZILLA_GUARD_OBJECT_NOTIFIER_PARAM)
       : mLocation(aValue), mValue(aValue)
     {
       MOZILLA_GUARD_OBJECT_NOTIFIER_INIT;
     }
     ~AutoRestore() { mLocation = mValue; }
   };
 
+  /**
+   * Change the value of a variable from one value to another while the
+   * object is in scope, and then back to the original.  This is
+   * designed to be an optimized variant of AutoRestore for when the
+   * original value is known and doesn't actually need to be saved (so
+   * the compiler can optimize away the storage).
+   *
+   * For example:
+   *   {
+   *     // mInReflow MUST now be false (or you will hit an assertion
+   *     // failure)
+   *     AutoToggle<bool> toggleReflow(mInReflow, false, true);
+   *     // mInReflow is now true
+   *     
+   *     // ... your code here ...
+   *
+   *     // mInReflow reset to false at the end of this block
+   *   }
+   */
+  template <class T>
+  class NS_STACK_CLASS AutoToggle
+  {
+  private:
+    T& mLocation;
+    const T mFromValue;
+    MOZILLA_DECL_USE_GUARD_OBJECT_NOTIFIER
+  public:
+    AutoToggle(T& aLocation, T aFromValue, T aToValue
+               MOZILLA_GUARD_OBJECT_NOTIFIER_PARAM)
+      : mLocation(aLocation), mFromValue(aFromValue)
+    {
+      MOZILLA_GUARD_OBJECT_NOTIFIER_INIT;
+      NS_ABORT_IF_FALSE(aLocation == aFromValue,
+                        "AutoToggle used incorrectly");
+      aLocation = aToValue;
+    }
+    ~AutoToggle() { mLocation = mFromValue; }
+  };
+
 }
 
 #endif /* !defined(mozilla_AutoRestore_h_) */

From: L. David Baron <dbaron@dbaron.org>

Bug 996796 patch 11 - Fix the visited flag handling in ResolveStyleWithReplacement.

This does the same thing as ReparentStyleContext.

diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -1418,17 +1418,25 @@ nsStyleSet::ResolveStyleWithReplacement(
                             aOldStyleContext->GetPseudoType(), aReplacements);
 
   // FIXME: Does this handle visited contexts correctly???
 
   uint32_t flags = eNoFlags;
   if (aOldStyleContext->IsLinkContext()) {
     flags |= eIsLink;
   }
-  if (aOldStyleContext->RelevantLinkVisited()) {
+
+  // If we're a style context for a link, then we already know whether
+  // our relevant link is visited, since that does not depend on our
+  // parent.  Otherwise, we need to match aNewParentContext.
+  bool relevantLinkVisited = aOldStyleContext->IsLinkContext() ?
+    aOldStyleContext->RelevantLinkVisited() :
+    aNewParentContext->RelevantLinkVisited();
+
+  if (relevantLinkVisited) {
     flags |= eIsVisitedLink;
   }
 
   return GetContext(aNewParentContext, ruleNode, nullptr,
                     nullptr, nsCSSPseudoElements::ePseudo_NotPseudoElement,
                     nullptr, flags);
 }
 

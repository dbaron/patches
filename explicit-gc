From: L. David Baron <dbaron@dbaron.org>

Explicitly gc.

diff --git a/toolkit/content/tests/chrome/bug451286_window.xul b/toolkit/content/tests/chrome/bug451286_window.xul
--- a/toolkit/content/tests/chrome/bug451286_window.xul
+++ b/toolkit/content/tests/chrome/bug451286_window.xul
@@ -18,24 +18,25 @@
     const Cc = Components.classes;
     const Cr = Components.results;
     const SEARCH_TEXT = "text";
     const DATAURI = "data:text/html," + SEARCH_TEXT;
 
     var gFindBar = null;
     var gBrowser;
 
-    var imports = ["SimpleTest", "ok", "snapshotWindow", "compareSnapshots"];
+    var imports = ["SimpleTest", "ok", "snapshotWindow", "compareSnapshots",
+                   "parentFinish"];
     for each (var name in imports) {
       window[name] = window.opener.wrappedJSObject[name];
     }
 
     function finish() {
       window.close();
-      SimpleTest.finish();
+      parentFinish();
     }
 
     function startTest() {
       gFindBar = document.getElementById("FindToolbar");
       gBrowser = document.getElementById("content");
       gBrowser.addEventListener("pageshow", onPageShow, false);
 
       // Bug 451286. An iframe that should be highlighted
diff --git a/toolkit/content/tests/chrome/test_bug451286.xul b/toolkit/content/tests/chrome/test_bug451286.xul
--- a/toolkit/content/tests/chrome/test_bug451286.xul
+++ b/toolkit/content/tests/chrome/test_bug451286.xul
@@ -27,16 +27,35 @@ https://bugzilla.mozilla.org/show_bug.cg
     </div>
     <pre id="test">
     </pre>
   </body>
 
   <script class="testbody" type="application/javascript">
     <![CDATA[
 
+      // We trigger assertions that happen during the GC of our parent
+      // window.
+      SimpleTest.expectAssertions(5);
+
+      // To be called by the window we open.
+      function parentFinish() {
+        // This is called with JS code from the window we open on the
+        // stack.  We need to GC everything in that window, so do that
+        // from a timeout and then call SimpleTest.finish().
+        setTimeout(doFinish, 0);
+      }
+
+      function doFinish() {
+        // Garbage collect objects created in this test can cause
+        // assertions, so GC now to blame those assertions to this test.
+        SpecialPowers.gc();
+        SimpleTest.finish();
+      }
+
       /** Test for Bug 451286 **/
       SimpleTest.waitForExplicitFinish();
       window.open("bug451286_window.xul", "451286test", 
                   "chrome,width=600,height=600");
 
     ]]>
   </script>
 

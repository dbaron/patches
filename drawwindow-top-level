From: L. David Baron <dbaron@dbaron.org>

Bug 995721 patch 2 - Run drawWindow mochitests on a toplevel window.

Without patch 1, the final 4 of the set of 7 tests fail on Linux with
accelerated layers (whereas all the ones they were copied from, added in
bug 995661, pass, given the patches in that bug but not this one).  (I
don't need to enable skia-canvas to see the failures without patch 1.  I
thought that didn't match my earlier testing, but I probably just never
tested that combination.  This means the failures happen even without
CanvasRenderingContext2D::DrawWindow going through the codepath where it
creates a DrawTarget.)

diff --git a/content/canvas/test/chrome/chrome.ini b/content/canvas/test/chrome/chrome.ini
--- a/content/canvas/test/chrome/chrome.ini
+++ b/content/canvas/test/chrome/chrome.ini
@@ -1,4 +1,6 @@
 [DEFAULT]
 support-files = nonchrome_webgl_debug_renderer_info.html
 
 [test_webgl_debug_renderer_info.html]
+[test_drawWindow_widget_layers.html]
+support-files = ../file_drawWindow_source.html ../file_drawWindow_common.js
diff --git a/content/canvas/test/test_drawWindow.html b/content/canvas/test/chrome/test_drawWindow_widget_layers.html
copy from content/canvas/test/test_drawWindow.html
copy to content/canvas/test/chrome/test_drawWindow_widget_layers.html
--- a/content/canvas/test/test_drawWindow.html
+++ b/content/canvas/test/chrome/test_drawWindow_widget_layers.html
@@ -1,55 +1,50 @@
 <!DOCTYPE HTML>
 <html>
 <head>
   <meta charset="utf-8">
   <title>Test for canvas drawWindow</title>
-  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
-  <script type="application/javascript" src="/tests/SimpleTest/WindowSnapshot.js"></script>
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript" src="chrome://mochikit/content/tests/SimpleTest/WindowSnapshot.js"></script>
   <script type="application/javascript" src="file_drawWindow_common.js"></script>
-  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+  <link rel="stylesheet" type="text/css" href="chrome://mochikit/content/tests/SimpleTest/test.css"/>
   <script type="application/javascript">
 
   SimpleTest.waitForExplicitFinish();
   window.addEventListener("load", openSourceWindow, false);
 
   var sourceWindow;
 
   function openSourceWindow(event) {
     if (event.target != document) {
       return;
     }
 
+    // Need to open as a toplevel chrome window so that
+    // DRAWWINDOW_USE_WIDGET_LAYERS is honored.
     sourceWindow = window.open("file_drawWindow_source.html", "",
-                               "width=200,height=100");
+                               "chrome,width=200,height=100");
     sourceWindow.addEventListener("load", runTests, false);
   }
 
   function runTests(event) {
     if (event.target != sourceWindow.document) {
       return;
     }
 
-    // Run the tests with the source document in an <iframe> within this
-    // page, which we expect to have transparency.
-    runDrawWindowTests(document.getElementById("source").contentWindow,
-                       0, true);
-
-    // Run the tests on the same source document, but in a window opened
-    // by window.open.  We do not expect this to have transparency...
-    // except on B2G.  (This is *probably* a bug in B2G.)
-    var isB2G = /Mobile|Tablet/.test(navigator.userAgent) &&
-                !navigator.userAgent.contains("Android");
-    runDrawWindowTests(sourceWindow, 0, isB2G);
+    var cxInterfaceWrap = SpecialPowers.wrap(CanvasRenderingContext2D);
+    var flags = cxInterfaceWrap.DRAWWINDOW_USE_WIDGET_LAYERS |
+                cxInterfaceWrap.DRAWWINDOW_DRAW_CARET |
+                cxInterfaceWrap.DRAWWINDOW_DRAW_VIEW;
+    runDrawWindowTests(sourceWindow, flags, true);
 
     sourceWindow.close();
 
     SimpleTest.finish();
   }
 
   </script>
 </head>
 <body>
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
-<iframe id="source" src="file_drawWindow_source.html" width="200" height="100"></iframe>
 </body>
 </html>

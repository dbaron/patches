Expose trace-malloc stack traces.

diff --git a/tools/trace-malloc/lib/nsTraceMalloc.c b/tools/trace-malloc/lib/nsTraceMalloc.c
--- a/tools/trace-malloc/lib/nsTraceMalloc.c
+++ b/tools/trace-malloc/lib/nsTraceMalloc.c
@@ -1692,6 +1692,18 @@ NS_TraceMallocLogTimestamp(const char *c
     TM_EXIT_LOCK_AND_UNSUPPRESS_TRACING(t);
 }
 
+static void
+print_stack(FILE *ofp, callsite *site)
+{
+    while (site) {
+        if (site->name || site->parent) {
+            fprintf(ofp, "%s[%s +0x%X]\n",
+                    site->name, site->library, site->offset);
+        }
+        site = site->parent;
+    }
+}
+
 static PRIntn
 allocation_enumerator(PLHashEntry *he, PRIntn i, void *arg)
 {
@@ -1713,13 +1725,7 @@ allocation_enumerator(PLHashEntry *he, P
         fprintf(ofp, "\t0x%08lX\n", *p);
     }
 
-    while (site) {
-        if (site->name || site->parent) {
-            fprintf(ofp, "%s[%s +0x%X]\n",
-                    site->name, site->library, site->offset);
-        }
-        site = site->parent;
-    }
+    print_stack(ofp, site);
     fputc('\n', ofp);
     return HT_ENUMERATE_NEXT;
 }
@@ -1994,4 +2000,20 @@ FreeCallback(void * ptr, PRUint32 start,
     TM_EXIT_LOCK_AND_UNSUPPRESS_TRACING(t);
 }
 
+PR_IMPLEMENT(nsTMStackTraceID)
+NS_TraceMallocGetStackTrace(void)
+{
+    callsite *site;
+    tm_thread *t = tm_get_thread();
+
+    site = backtrace(t, 2);
+    return (nsTMStackTraceID) site;
+}
+
+PR_IMPLEMENT(void)
+NS_TraceMallocPrintStackTrace(FILE *ofp, nsTMStackTraceID id)
+{
+    print_stack(ofp, (callsite*)id);
+}
+
 #endif /* NS_TRACE_MALLOC */
diff --git a/tools/trace-malloc/lib/nsTraceMalloc.h b/tools/trace-malloc/lib/nsTraceMalloc.h
--- a/tools/trace-malloc/lib/nsTraceMalloc.h
+++ b/tools/trace-malloc/lib/nsTraceMalloc.h
@@ -229,6 +229,16 @@ PR_EXTERN(void)
 PR_EXTERN(void)
 NS_TrackAllocation(void* ptr, FILE *ofp);
 
+/* opaque type for API */
+struct nsTMStackTraceIDStruct;
+typedef nsTMStackTraceIDStruct *nsTMStackTraceID;
+
+PR_EXTERN(nsTMStackTraceID)
+NS_TraceMallocGetStackTrace(void);
+
+PR_EXTERN(void)
+NS_TraceMallocPrintStackTrace(FILE *ofp, nsTMStackTraceID id);
+
 PR_END_EXTERN_C
 
 #endif /* nsTraceMalloc_h___ */

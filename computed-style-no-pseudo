From: L. David Baron <dbaron@dbaron.org>

Make computed style (and canvas text styling, which shares the same code) avoid using style data that was influenced by pseudo-elements.  (Bug 505515) (CHECK FOR INTERACTIONS WITH BUGS 147888, 475109, 296098)

diff --git a/layout/style/nsInspectorCSSUtils.cpp b/layout/style/nsInspectorCSSUtils.cpp
--- a/layout/style/nsInspectorCSSUtils.cpp
+++ b/layout/style/nsInspectorCSSUtils.cpp
@@ -96,18 +96,16 @@ nsInspectorCSSUtils::IsRuleNodeRoot(nsRu
     return NS_OK;
 }
 
 /* static */
 nsStyleContext*
 nsInspectorCSSUtils::GetStyleContextForFrame(nsIFrame* aFrame)
 {
     nsStyleContext* styleContext = aFrame->GetStyleContext();
-    if (!styleContext)
-        return nsnull;
 
     /* For tables the primary frame is the "outer frame" but the style
      * rules are applied to the "inner frame".  Luckily, the "outer
      * frame" actually inherits style from the "inner frame" so we can
      * just move one level up in the style context hierarchy....
      */
     if (aFrame->GetType() == nsGkAtoms::tableOuterFrame)
         return styleContext->GetParent();
@@ -121,20 +119,24 @@ nsInspectorCSSUtils::GetStyleContextForC
                                                nsIAtom* aPseudo,
                                                nsIPresShell* aPresShell)
 {
     if (!aPseudo) {
         aPresShell->FlushPendingNotifications(Flush_Style);
         nsIFrame* frame = aPresShell->GetPrimaryFrameFor(aContent);
         if (frame) {
             nsStyleContext* result = GetStyleContextForFrame(frame);
-            // this function returns an addrefed style context
-            if (result)
+            // Don't use the style context if it was influenced by
+            // pseudo-elements, since then it's not the primary style
+            // for this element.
+            if (!result->HasPseudoElementData()) {
+                // this function returns an addrefed style context
                 result->AddRef();
-            return result;
+                return result;
+            }
         }
     }
 
     // No frame has been created or we have a pseudo, so resolve the
     // style ourselves
     nsRefPtr<nsStyleContext> parentContext;
     nsIContent* parent = aPseudo ? aContent : aContent->GetParent();
     if (parent)

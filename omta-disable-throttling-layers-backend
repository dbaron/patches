From: Markus Stange <mstange@themasta.com>, L. David Baron <dbaron@dbaron.org>

Bug 947753 - Don't throttle main-thread execution of animations when the layer is in a non-OMTC layer tree.

Given the difficulty (related to creating the layer manager to early) of
landing the patch to avoid sending animations to non-OMTC layers, it
seems worth landing this.

(The patch is by mstange; the comments by dbaron.)

diff --git a/layout/style/AnimationCommon.cpp b/layout/style/AnimationCommon.cpp
--- a/layout/style/AnimationCommon.cpp
+++ b/layout/style/AnimationCommon.cpp
@@ -874,16 +874,25 @@ AnimationCollection::CanThrottleAnimatio
     }
 
     Layer* layer = FrameLayerBuilder::GetDedicatedLayer(
                      frame, record.mLayerType);
     if (!layer || mAnimationGeneration > layer->GetAnimationGeneration()) {
       return false;
     }
 
+    // Don't throttle animations if we've sent animations to a layer
+    // that isn't actually using off-main-thread compositing.
+    // (We'd like to avoid doing that in the first place; see bug
+    // 947753.)
+    if (layer->Manager()->GetBackendType() !=
+          layers::LayersBackend::LAYERS_CLIENT) {
+      return false;
+    }
+
     if (record.mProperty == eCSSProperty_transform &&
         !CanThrottleTransformChanges(aTime)) {
       return false;
     }
   }
 
   return true;
 }

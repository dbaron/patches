From: L. David Baron <dbaron@dbaron.org>

Bug 1115812 patch 17 - Do animation-only update properly for a rebuild all.  r=heycam

This fixes another pre-existing bug in the rebuild-all codepath; it
didn't handle the animation-only update correctly, which could have
caused bugs in transitions with OMT animations enabled.

diff --git a/layout/base/RestyleManager.cpp b/layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp
+++ b/layout/base/RestyleManager.cpp
@@ -1585,17 +1585,17 @@ RestyleManager::ProcessPendingRestyles()
 #endif
 
   // Before we process any restyles, we need to ensure that style
   // resulting from any throttled animations (animations that we're
   // running entirely on the compositor thread) is up-to-date, so that
   // if any style changes we cause trigger transitions, we have the
   // correct old style for starting the transition.
   if (nsLayoutUtils::AreAsyncAnimationsEnabled() &&
-      mPendingRestyles.Count() > 0) {
+      NeedToProcessRestylesFor(mPendingRestyles)) {
     IncrementAnimationGeneration();
     UpdateOnlyAnimationStyles();
   }
 
   // Until we get rid of these phases in bug 960465, we need to skip
   // animation restyles during the non-animation phase, and post
   // animation restyles so that we restyle those elements again in the
   // animation phase.
diff --git a/layout/base/RestyleManager.h b/layout/base/RestyleManager.h
--- a/layout/base/RestyleManager.h
+++ b/layout/base/RestyleManager.h
@@ -463,20 +463,24 @@ private:
 
   bool ShouldStartRebuildAllFor(RestyleTracker& aRestyleTracker) {
     // When we process our primary restyle tracker and we have a pending
     // rebuild-all, we need to process it.
     return mDoRebuildAllStyleData &&
            &aRestyleTracker == &mPendingRestyles;
   }
 
+  bool NeedToProcessRestylesFor(RestyleTracker& aRestyleTracker) {
+    return aRestyleTracker.Count() || ShouldStartRebuildAllFor(aRestyleTracker);
+  }
+
   void ProcessRestyles(RestyleTracker& aRestyleTracker) {
     // Fast-path the common case (esp. for the animation restyle
     // tracker) of not having anything to do.
-    if (aRestyleTracker.Count() || ShouldStartRebuildAllFor(aRestyleTracker)) {
+    if (NeedToProcessRestylesFor(aRestyleTracker)) {
       aRestyleTracker.DoProcessRestyles();
     }
   }
 
 private:
   nsPresContext* mPresContext; // weak, disconnected in Disconnect
 
   // True if we need to reconstruct the rule tree the next time we

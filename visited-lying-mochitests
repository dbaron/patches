# HG changeset patch
# Parent 1fb661b2a2dc778c568f09e2ed1727149dc5a286
# User L. David Baron <dbaron@dbaron.org>
Add mochitests for getComputedStyle and querySelector(All) lying about :visited selectors.  (Bug 147777)

diff --git a/layout/style/test/Makefile.in b/layout/style/test/Makefile.in
--- a/layout/style/test/Makefile.in
+++ b/layout/style/test/Makefile.in
@@ -172,16 +172,17 @@ _TEST_FILES =	test_acid3_test46.html \
 		test_transitions_bug537151.html \
 		test_units_angle.html \
 		test_units_frequency.html \
 		test_units_length.html \
 		test_units_time.html \
 		test_value_cloning.html \
 		test_value_computation.html \
 		test_value_storage.html \
+		test_visited_lying.html \
 		test_visited_pref.html \
 		test_visited_reftests.html \
 		css_properties.js \
 		property_database.js \
 		descriptor_database.js \
 		unstyled.xml \
 		unstyled.css \
 		unstyled-frame.xml \
@@ -197,16 +198,17 @@ _TEST_FILES =	test_acid3_test46.html \
 		media_queries_dynamic_xbl_iframe.html \
 		media_queries_dynamic_xbl_style.css \
 		bug453896_iframe.html \
 		bug517224.sjs \
 		test_bug525952.html \
 		ccd-quirks.html \
 		ccd-standards.html \
 		ccd.sjs \
+		visited-lying-inner.html \
 		$(NULL)
 
 _VISITED_REFTEST_FILES = \
 		$(shell find $(topsrcdir)/layout/reftests/css-visited/ -name '*.html' -o -name '*.xhtml') \
 		$(NULL)
 
 _BROWSER_FILES = \
 		browser_bug453896.js \
diff --git a/layout/style/test/test_visited_lying.html b/layout/style/test/test_visited_lying.html
new file mode 100644
--- /dev/null
+++ b/layout/style/test/test_visited_lying.html
@@ -0,0 +1,97 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=147777
+-->
+<head>
+  <title>Test for Bug 147777</title>
+  <script type="application/javascript" src="/MochiKit/packed.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/WindowSnapshot.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=147777">Mozilla Bug 147777</a>
+<iframe id="iframe" src="visited-lying-inner.html" style="width: 20em; height: 5em"></iframe>
+<pre id="test">
+<script type="application/javascript">
+
+/** Test for Bug 147777 **/
+
+SimpleTest.waitForExplicitFinish();
+window.addEventListener("load", start, false);
+
+var iframe;
+var visitedlink, unvisitedlink;
+var snapshot1;
+
+function start()
+{
+  // Our load event has fired, so we know our iframe is loaded.
+  iframe = document.getElementById("iframe");
+  visitedlink = iframe.contentDocument.getElementById("visitedlink");
+  unvisitedlink = iframe.contentDocument.getElementById("unvisitedlink");
+
+  // First, take a snapshot of it with both links unvisited.
+  snapshot1 = snapshotWindow(iframe.contentWindow, false);
+
+  // Then, change one of the links in the iframe to being visited.
+  visitedlink.href = window.location;
+
+  // Then, start polling to see when the history has updated the display.
+  setTimeout(poll_for_restyle, 100);
+}
+
+function poll_for_restyle()
+{
+  var snapshot2 = snapshotWindow(iframe.contentWindow, false);
+  var equal = compareSnapshots(snapshot1, snapshot2, true)[0];
+  if (equal) {
+    // keep polling
+    setTimeout(poll_for_restyle, 100);
+  } else {
+    // We now know that the link is visited, so we're ready to run
+    // tests.
+    run_tests();
+  }
+}
+
+function run_tests()
+{
+  // Test querySelector and querySelectorAll.
+  var subdoc = iframe.contentDocument;
+  is(subdoc.querySelector(":link"), unvisitedlink,
+     "first :link should be the unvisited link");
+  is(subdoc.querySelector(":visited"), null,
+     "querySelector should not find anything :visited");
+  var qsr = subdoc.querySelectorAll(":link");
+  is(qsr.length, 2, "querySelectorAll(:link) should find 2 results");
+  is(qsr[0], unvisitedlink, "querySelectorAll(:link)[0]");
+  is(qsr[1], visitedlink, "querySelectorAll(:link)[1]");
+  qsr = subdoc.querySelectorAll(":visited");
+  is(qsr.length, 0, "querySelectorAll(:visited) should find 0 results");
+
+  // Test getComputedStyle.
+  var subwin = iframe.contentWindow;
+  is(subwin.getComputedStyle(unvisitedlink, "").color, "rgb(0, 0, 255)",
+     "getComputedStyle on unvisited link should report color is blue");
+  is(subwin.getComputedStyle(visitedlink, "").color, "rgb(0, 0, 255)",
+     "getComputedStyle on visited link should report color is blue");
+
+  // Test mozMatchesSelector.
+  is(unvisitedlink.mozMatchesSelector(":link"), true,
+     "unvisited link matches :link");
+  is(visitedlink.mozMatchesSelector(":link"), true,
+     "visited link matches :link");
+  is(unvisitedlink.mozMatchesSelector(":visited"), false,
+     "unvisited link does not match :visited");
+  is(visitedlink.mozMatchesSelector(":visited"), false,
+     "visited link does not match :visited");
+
+  SimpleTest.finish();
+}
+
+</script>
+</pre>
+</body>
+</html>
diff --git a/layout/style/test/visited-lying-inner.html b/layout/style/test/visited-lying-inner.html
new file mode 100644
--- /dev/null
+++ b/layout/style/test/visited-lying-inner.html
@@ -0,0 +1,8 @@
+<!DOCTYPE HTML>
+<title>Test document for test_visited_lying.html</title>
+<style>
+:link { color: blue }
+:visited { color: purple }
+</style>
+<div><a id="unvisitedlink" href="http://www.example.com/url-that-was-never-visited">unvisited link</a></div>
+<div><a id="visitedlink" href="http://www.example.com/url-that-was-never-visited">visited link</a></div>

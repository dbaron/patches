Fix the ignoring of load events for previous documents check so that it also works for (most) cases of the assertion check.  (Bug 477409)

diff --git a/layout/tools/reftest/reftest.js b/layout/tools/reftest/reftest.js
--- a/layout/tools/reftest/reftest.js
+++ b/layout/tools/reftest/reftest.js
@@ -54,16 +54,19 @@ const NS_REFTESTHELPER_CONTRACTID =
 const NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX =
           "@mozilla.org/network/protocol;1?name=";
 const NS_XREAPPINFO_CONTRACTID =
           "@mozilla.org/xre/app-info;1";
 
 
 const LOAD_FAILURE_TIMEOUT = 10000; // ms
 
+// "<!--CLEAR-->"
+const BLANK_URL_FOR_CLEARING = "data:text/html,%3C%21%2D%2DCLEAR%2D%2D%3E";
+
 var gBrowser;
 var gCanvas1, gCanvas2;
 // gCurrentCanvas is non-null between InitCurrentCanvasWithSnapshot and the next
 // DocumentLoaded.
 var gCurrentCanvas = null;
 var gURLs;
 // Map from URI spec to the number of times it remains to be used
 var gURIUseCounts;
@@ -537,17 +540,18 @@ function resetZoom() {
 }
     
 function OnDocumentLoad(event)
 {
     if (event.target != gBrowser.contentDocument)
         // Ignore load events for subframes.
         return;
         
-    if (gClearingForAssertionCheck) {
+    if (gClearingForAssertionCheck &&
+        gBrowser.contentDocument.location.href == BLANK_URL_FOR_CLEARING) {
         DoAssertionCheck();
         return;
     }
 
     if (gBrowser.contentDocument.location.href != gCurrentURL)
         // Ignore load events for previous documents.
         return;
 
@@ -898,20 +902,20 @@ function LoadFailed()
     ++gTestResults.FailedLoad;
     dump("REFTEST TEST-UNEXPECTED-FAIL | " +
          gURLs[0]["url" + gState].spec + " | " + gFailureReason + "\n");
     FinishTestItem();
 }
 
 function FinishTestItem()
 {
-    // Replace document with about:blank in case there are
+    // Replace document with BLANK_URL_FOR_CLEARING in case there are
     // assertions when unloading.
     gClearingForAssertionCheck = true;
-    gBrowser.loadURI("about:blank");
+    gBrowser.loadURI(BLANK_URL_FOR_CLEARING);
 }
 
 function DoAssertionCheck()
 {
     gClearingForAssertionCheck = false;
 
     if (gDebug.isDebugBuild) {
         // TEMPORARILY DISABLING ASSERTION CHECKS FOR NOW.  TO RE-ENABLE,

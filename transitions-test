From: L. David Baron <dbaron@dbaron.org>

Make this test more reliable given imperfect timers, to fix TEST-UNEXPECTED-FAIL that has happened once so far.  (Bug 613888)

diff --git a/layout/style/test/test_transitions_cancel_near_end.html b/layout/style/test/test_transitions_cancel_near_end.html
--- a/layout/style/test/test_transitions_cancel_near_end.html
+++ b/layout/style/test/test_transitions_cancel_near_end.html
@@ -40,17 +40,25 @@ var count_remaining = 6;
 
 window.addEventListener('load', function() {
   var cases = Array.slice(document.querySelectorAll('#animated-elements-container > span'));
 
   cases.forEach(function(aTarget) {
     aTarget.addEventListener('transitionend', function(aEvent) {
       if (aTarget.hasAttribute('should-restyle'))
         aTarget.style.outline = '1px solid';
-      aTarget.setAttribute('transitionend-'+aEvent.propertyName, true);
+      var attr = 'transitionend-' + aEvent.propertyName;
+      if (aTarget.hasAttribute(attr)) {
+        // It's possible, given bad timers, that we might get a
+        // transition that completed before we reversed it, which could
+        // lead to two transitionend events for the same thing.  We
+        // don't want to decrement count_remaining in this case.
+        return;
+      }
+      aTarget.setAttribute(attr, "true");
       if (--count_remaining == 0) {
         cases.forEach(function(aCase, aIndex) {
           ok(aCase.hasAttribute('transitionend-color'),
              "transitionend for color was fired for case "+aIndex);
           ok(aCase.hasAttribute('transitionend-background-color'),
              "transitionend for background-color was fired for case "+aIndex);
         });
         SimpleTest.finish();

From: Ginn Chen <ginn.chen@oracle.com>

Fix color swapping under VNC.  (Bug 610852)

diff --git a/widget/src/shared/nsShmImage.cpp b/widget/src/shared/nsShmImage.cpp
--- a/widget/src/shared/nsShmImage.cpp
+++ b/widget/src/shared/nsShmImage.cpp
@@ -105,19 +105,27 @@ nsShmImage::Create(const gfxIntSize& aSi
         gShmAvailable = PR_FALSE;
         return nsnull;
     }
 
     shm->mXAttached = PR_TRUE;
     shm->mSize = aSize;
     switch (shm->mImage->depth) {
     case 24:
-        shm->mFormat = gfxASurface::ImageFormatRGB24; break;
+        // Only xRGB is supported.
+        if ((shm->mImage->red_mask == 0xff0000) &&
+            (shm->mImage->green_mask == 0xff00) &&
+            (shm->mImage->blue_mask == 0xff)) {
+            shm->mFormat = gfxASurface::ImageFormatRGB24;
+            break;
+        }
+        goto unsupported;
     case 16:
         shm->mFormat = gfxASurface::ImageFormatRGB16_565; break;
+    unsupported:
     default:
         NS_WARNING("Unsupported XShm Image depth!");
         gShmAvailable = PR_FALSE;
         return nsnull;
     }
     return shm.forget();
 }
 

From: L. David Baron <dbaron@dbaron.org>

Fix double-subtraction of opposite margin when one of margin-top/bottom is auto, for absolutely positioned elements.  (Bug 604212)  r=bzbarsky  a2.0=roc

diff --git a/layout/generic/nsHTMLReflowState.cpp b/layout/generic/nsHTMLReflowState.cpp
--- a/layout/generic/nsHTMLReflowState.cpp
+++ b/layout/generic/nsHTMLReflowState.cpp
@@ -1399,21 +1399,21 @@ nsHTMLReflowState::InitAbsoluteConstrain
     } else if (marginTopIsAuto) {
       if (marginBottomIsAuto) {
         // Both 'margin-top' and 'margin-bottom' are 'auto', so they get
         // equal values
         mComputedMargin.top = availMarginSpace / 2;
         mComputedMargin.bottom = availMarginSpace - mComputedMargin.top;
       } else {
         // Just 'margin-top' is 'auto'
-        mComputedMargin.top = availMarginSpace - mComputedMargin.bottom;
+        mComputedMargin.top = availMarginSpace;
       }
     } else {
       // Just 'margin-bottom' is 'auto'
-      mComputedMargin.bottom = availMarginSpace - mComputedMargin.top;
+      mComputedMargin.bottom = availMarginSpace;
     }
   }
 }
 
 nscoord 
 GetVerticalMarginBorderPadding(const nsHTMLReflowState* aReflowState)
 {
   nscoord result = 0;
diff --git a/layout/reftests/abs-pos/abs-pos-auto-margin-1-ref.html b/layout/reftests/abs-pos/abs-pos-auto-margin-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/abs-pos/abs-pos-auto-margin-1-ref.html
@@ -0,0 +1,25 @@
+<!DOCTYPE HTML>
+<title>'auto' top and bottom margins on absolutely positioned elements</title>
+<style>
+
+body > div {
+  position: relative;
+  height: 100px;
+  border: medium solid;
+}
+
+body > div > div {
+  position: absolute;
+  top: 0;
+  height: 40px;
+  width: 10px;
+  background: blue;
+}
+
+</style>
+<div>
+  <div style="left: 10px;top: 10px"></div>
+  <div style="left: 30px;top: 40px"></div>
+  <div style="left: 50px;top: 10px"></div>
+  <div style="left: 70px;top: 30px"></div>
+</div>
diff --git a/layout/reftests/abs-pos/abs-pos-auto-margin-1.html b/layout/reftests/abs-pos/abs-pos-auto-margin-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/abs-pos/abs-pos-auto-margin-1.html
@@ -0,0 +1,28 @@
+<!DOCTYPE HTML>
+<title>'auto' top and bottom margins on absolutely positioned elements</title>
+<style>
+
+body > div {
+  position: relative;
+  height: 100px;
+  border: medium solid;
+}
+
+body > div > div {
+  position: absolute;
+  top: 0;
+  bottom: 0;
+  height: 40px;
+  width: 10px;
+  background: blue;
+  margin-top: 10px;
+  margin-bottom: 20px;
+}
+
+</style>
+<div>
+  <div style="left: 10px;"></div>
+  <div style="left: 30px;margin-top: auto"></div>
+  <div style="left: 50px;margin-bottom: auto"></div>
+  <div style="left: 70px;margin-top: auto; margin-bottom: auto"></div>
+</div>
diff --git a/layout/reftests/abs-pos/reftest.list b/layout/reftests/abs-pos/reftest.list
--- a/layout/reftests/abs-pos/reftest.list
+++ b/layout/reftests/abs-pos/reftest.list
@@ -1,1 +1,2 @@
 == font-size-wrap.html font-size-wrap-ref.html
+== abs-pos-auto-margin-1.html abs-pos-auto-margin-1-ref.html

From: L. David Baron <dbaron@dbaron.org>

Replace the removed part of CanPlaceFloat.  (Bug 563584)  (FIXME: add tests)

diff --git a/layout/generic/nsBlockReflowState.cpp b/layout/generic/nsBlockReflowState.cpp
--- a/layout/generic/nsBlockReflowState.cpp
+++ b/layout/generic/nsBlockReflowState.cpp
@@ -821,16 +821,28 @@ nsBlockReflowState::FlowAndPlaceFloat(ns
   PRBool pushedDown = mY != saveY;
   mBlock->ReflowFloat(*this, adjustedAvailableSpace, aFloat,
                       floatMargin, pushedDown, aReflowStatus);
   if (aFloat->GetPrevInFlow())
     floatMargin.top = 0;
   if (NS_FRAME_IS_NOT_COMPLETE(aReflowStatus))
     floatMargin.bottom = 0;
 
+  // In the case that we're in columns and not splitting floats, we need
+  // to check here that the float's height fit, and if it didn't, bail.
+  // (This code is only for DISABLE_FLOAT_BREAKING_IN_COLUMNS .)
+  if (mContentArea.height != NS_UNCONSTRAINEDSIZE &&
+      adjustedAvailableSpace.height == NS_UNCONSTRAINEDSIZE &&
+      (!mReflowState.mFlags.mIsTopOfPage || pushedDown) &&
+      aFloat->GetSize().height + floatMargin.TopBottom() >
+        mContentArea.height - floatY) {
+    mY = saveY;
+    return PR_FALSE;
+  }
+
   // Calculate the actual origin of the float frame's border rect
   // relative to the parent block; floatX/Y must be converted from space-manager
   // coordinates to parent coordinates, and the margin must be added in
   // to get the border rect
   nsPoint origin(borderPadding.left + floatMargin.left + floatX,
                  borderPadding.top + floatMargin.top + floatY);
 
   // If float is relatively positioned, factor that in as well

From: L. David Baron <dbaron@dbaron.org>

Make nsStyleAnimation::ComputeDistance not crash when given -moz-transform: none.  (Bug 576761)

diff --git a/layout/style/nsStyleAnimation.cpp b/layout/style/nsStyleAnimation.cpp
--- a/layout/style/nsStyleAnimation.cpp
+++ b/layout/style/nsStyleAnimation.cpp
@@ -403,21 +403,28 @@ nsStyleAnimation::ComputeDistance(nsCSSP
       }
       aDistance = sqrt(squareDistance);
       break;
     }
     case eUnit_Transform: {
       const nsCSSValueList *list1 = aStartValue.GetCSSValueListValue();
       const nsCSSValueList *list2 = aEndValue.GetCSSValueListValue();
 
+      nsStyleTransformMatrix matrix1, matrix2; // initialized to identity
+
       PRBool dummy;
-      nsStyleTransformMatrix matrix1 =
-        nsStyleTransformMatrix::ReadTransforms(list1, nsnull, nsnull, dummy),
-                             matrix2 =
-        nsStyleTransformMatrix::ReadTransforms(list2, nsnull, nsnull, dummy);
+      if (list1->mValue.GetUnit() != eCSSUnit_None) {
+        matrix1 = nsStyleTransformMatrix::ReadTransforms(list1, nsnull,
+                                                         nsnull, dummy);
+      }
+      if (list2->mValue.GetUnit() != eCSSUnit_None) {
+        matrix2 = nsStyleTransformMatrix::ReadTransforms(list2, nsnull,
+                                                         nsnull, dummy);
+      }
+
       double diff;
       double squareDistance = 0.0;
       for (PRUint32 i = 0; i < 4; ++i) {
         diff = matrix1.GetMainMatrixEntry(i) - matrix2.GetMainMatrixEntry(i);
         squareDistance += diff * diff;
       }
       diff = nsPresContext::AppUnitsToFloatCSSPixels(
         matrix1.GetCoordXTranslation() - matrix2.GetCoordXTranslation());

From: L. David Baron <dbaron@dbaron.org>

Bug 855464:  Optimize nsBlockReflowState::ClearFloats better, given that nsBlockFrame::WidthToClearPastFloats is somewhat expensive.

This fixes a performance issue that showed up in a profile of the b2g
contacts app (though it's not clear what percentage of the time it was
given the difficulty of understanding output of 'perf').

diff --git a/layout/generic/nsBlockReflowState.cpp b/layout/generic/nsBlockReflowState.cpp
--- a/layout/generic/nsBlockReflowState.cpp
+++ b/layout/generic/nsBlockReflowState.cpp
@@ -232,21 +232,27 @@ nsBlockReflowState::ComputeBlockAvailSpa
   printf("  CBAS: result %d %d %d %d\n", aResult.x, aResult.y, aResult.width, aResult.height);
 #endif
 }
 
 bool
 nsBlockReflowState::ReplacedBlockFitsInAvailSpace(nsIFrame* aReplacedBlock,
                             const nsFlowAreaRect& aFloatAvailableSpace) const
 {
+  if (!aFloatAvailableSpace.mHasFloats) {
+    // If there aren't any floats here, then we always fit.
+    // We check this before calling WidthToClearPastFloats, which is
+    // somewhat expensive.
+    return true;
+  }
+
   nsBlockFrame::ReplacedElementWidthToClear replacedWidth =
     nsBlockFrame::WidthToClearPastFloats(*this, aFloatAvailableSpace.mRect,
                                          aReplacedBlock);
-  return !aFloatAvailableSpace.mHasFloats ||
-         std::max(aFloatAvailableSpace.mRect.x - mContentArea.x,
+  return std::max(aFloatAvailableSpace.mRect.x - mContentArea.x,
                 replacedWidth.marginLeft) +
            replacedWidth.borderBoxWidth +
            std::max(mContentArea.XMost() - aFloatAvailableSpace.mRect.XMost(),
                   replacedWidth.marginRight) <=
          mContentArea.width;
 }
 
 nsFlowAreaRect
@@ -956,17 +962,21 @@ nsBlockReflowState::ClearFloats(nscoord 
   }
 #endif
 
 #ifdef NOISY_FLOAT_CLEARING
   printf("nsBlockReflowState::ClearFloats: aY=%d breakType=%d\n",
          aY, aBreakType);
   mFloatManager->List(stdout);
 #endif
-  
+
+  if (!mFloatManager->HasAnyFloats()) {
+    return aY;
+  }
+
   nscoord newY = aY;
 
   if (aBreakType != NS_STYLE_CLEAR_NONE) {
     newY = mFloatManager->ClearFloats(newY, aBreakType, aFlags);
   }
 
   if (aReplacedBlock) {
     for (;;) {

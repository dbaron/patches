From: L. David Baron <dbaron@dbaron.org>

Bug 930250 patch 2:  Clear restyle data when an element is removed from the tree.

diff --git a/layout/base/RestyleManager.cpp b/layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp
+++ b/layout/base/RestyleManager.cpp
@@ -59,16 +59,24 @@ RestyleManager::RestyleManager(nsPresCon
 }
 
 void
 RestyleManager::NotifyDestroyingFrame(nsIFrame* aFrame)
 {
   mOverflowChangedTracker.RemoveFrame(aFrame);
 }
 
+void
+RestyleManager::ClearRestylesFor(Element* aElement)
+{
+  RestyleTracker::RestyleData unneededData;
+  mPendingRestyles.GetRestyleData(aElement, &unneededData);
+  mPendingAnimationRestyles.GetRestyleData(aElement, &unneededData);
+}
+
 #ifdef DEBUG
   // To ensure that the functions below are only called within
   // |ApplyRenderingChangeToTree|.
 static bool gInApplyRenderingChangeToTree = false;
 #endif
 
 static void
 DoApplyRenderingChangeToTree(nsIFrame* aFrame,
diff --git a/layout/base/RestyleManager.h b/layout/base/RestyleManager.h
--- a/layout/base/RestyleManager.h
+++ b/layout/base/RestyleManager.h
@@ -48,16 +48,20 @@ public:
 
   nsCSSFrameConstructor* FrameConstructor() const
     { return PresContext()->FrameConstructor(); }
 
   // Should be called when a frame is going to be destroyed and
   // WillDestroyFrameTree hasn't been called yet.
   void NotifyDestroyingFrame(nsIFrame* aFrame);
 
+  // Should be called when a content node is being removed from the
+  // document.
+  void ClearRestylesFor(Element* aContent);
+
   // Forwarded nsIDocumentObserver method, to handle restyling (and
   // passing the notification to the frame).
   nsresult ContentStateChanged(nsIContent*   aContent,
                                nsEventStates aStateMask);
 
   // Forwarded nsIMutationObserver method, to handle restyling.
   void AttributeWillChange(Element* aElement,
                            int32_t  aNameSpaceID,
diff --git a/layout/base/nsPresShell.cpp b/layout/base/nsPresShell.cpp
--- a/layout/base/nsPresShell.cpp
+++ b/layout/base/nsPresShell.cpp
@@ -4369,16 +4369,20 @@ PresShell::ContentRemoved(nsIDocument *a
 
 /* virtual */ void
 PresShell::ParentChainChanged(nsIContent* aContent)
 {
   if (aContent->IsInDoc()) {
     // aContent was just bound to the document tree
   } else {
     // aContent was just unbound from the document tree
+
+    if (aContent->IsElement()) {
+      mPresContext->RestyleManager()->ClearRestylesFor(aContent->AsElement());
+    }
   }
 }
 
 nsresult
 PresShell::ReconstructFrames(void)
 {
   NS_PRECONDITION(!mFrameConstructor->GetRootFrame() || mDidInitialize,
                   "Must not have root frame before initial reflow");

From: L. David Baron <dbaron@dbaron.org>

Remove notion of percentage intrinsic size:  remove the single case that (incorrectly) sets percentage intrinsic sizes.  (Bug 611099)

Needed to help CSS 2.1 meet Proposed Recommendation entrance criteria.

TODO: Needs adjustment of the following reftests:
layout/reftests/svg/as-image/img-novb-height-meet-1.html
layout/reftests/svg/as-image/img-novb-height-slice-1.html
layout/reftests/svg/as-image/img-novb-width-meet-1.html
layout/reftests/svg/as-image/img-novb-width-slice-1.html
layout/reftests/svg/sizing/inline--position-absolute--02.xhtml
layout/reftests/svg/sizing/object--auto-auto--0-pct.html
layout/reftests/svg/sizing/object--auto-auto--pct-0.html
layout/reftests/svg/sizing/dynamic--inline-resize-cb-height.xhtml
layout/reftests/svg/sizing/dynamic--inline-resize-cb-width.xhtml
layout/reftests/svg/svg-integration/clipPath-html-06.xhtml
layout/reftests/svg/svg-integration/clipPath-html-06-extref.xhtml
layout/reftests/svg/svg-integration/conditions-outer-svg-01.xhtml
layout/reftests/svg/svg-integration/conditions-outer-svg-02.xhtml
layout/reftests/svg/svg-integration/dynamic-conditions-outer-svg-01.xhtml
layout/reftests/svg/svg-integration/dynamic-conditions-outer-svg-02.xhtml
layout/reftests/svg/svg-integration/dynamic-conditions-outer-svg-03.xhtml
layout/reftests/svg/svg-integration/dynamic-conditions-outer-svg-04.xhtml
layout/reftests/svg/dynamic-rect-04.xhtml
layout/reftests/svg/svg-in-foreignObject-01.xhtml
layout/reftests/svg/svg-in-foreignObject-02.xhtml

diff --git a/layout/svg/base/src/nsSVGOuterSVGFrame.cpp b/layout/svg/base/src/nsSVGOuterSVGFrame.cpp
--- a/layout/svg/base/src/nsSVGOuterSVGFrame.cpp
+++ b/layout/svg/base/src/nsSVGOuterSVGFrame.cpp
@@ -243,31 +243,23 @@ nsSVGOuterSVGFrame::GetIntrinsicSize()
   // specified and we're embedded inside an nsIObjectLoadingContent.
 
   IntrinsicSize intrinsicSize;
 
   nsSVGSVGElement *content = static_cast<nsSVGSVGElement*>(mContent);
   nsSVGLength2 &width  = content->mLengthAttributes[nsSVGSVGElement::WIDTH];
   nsSVGLength2 &height = content->mLengthAttributes[nsSVGSVGElement::HEIGHT];
 
-  if (width.IsPercentage()) {
-    float val = width.GetAnimValInSpecifiedUnits() / 100.0f;
-    if (val < 0.0f) val = 0.0f;
-    intrinsicSize.width.SetPercentValue(val);
-  } else {
+  if (!width.IsPercentage()) {
     nscoord val = nsPresContext::CSSPixelsToAppUnits(width.GetAnimValue(content));
     if (val < 0) val = 0;
     intrinsicSize.width.SetCoordValue(val);
   }
 
-  if (height.IsPercentage()) {
-    float val = height.GetAnimValInSpecifiedUnits() / 100.0f;
-    if (val < 0.0f) val = 0.0f;
-    intrinsicSize.height.SetPercentValue(val);
-  } else {
+  if (!height.IsPercentage()) {
     nscoord val = nsPresContext::CSSPixelsToAppUnits(height.GetAnimValue(content));
     if (val < 0) val = 0;
     intrinsicSize.height.SetCoordValue(val);
   }
 
   return intrinsicSize;
 }
 
@@ -313,26 +305,60 @@ nsSVGOuterSVGFrame::GetIntrinsicRatio()
 /* virtual */ nsSize
 nsSVGOuterSVGFrame::ComputeSize(nsIRenderingContext *aRenderingContext,
                                 nsSize aCBSize, nscoord aAvailableWidth,
                                 nsSize aMargin, nsSize aBorder, nsSize aPadding,
                                 PRBool aShrinkWrap)
 {
   nsSVGSVGElement* content = static_cast<nsSVGSVGElement*>(mContent);
 
-  if ((content->HasValidViewbox() || content->ShouldSynthesizeViewBox()) &&
-      (IsRootOfImage() || IsRootOfReplacedElementSubDoc())) {
-    // The embedding element has done the replaced element sizing, using our
-    // intrinsic dimensions as necessary. We just need to fill the viewport.
-    return aCBSize;
+  IntrinsicSize intrinsicSize = GetIntrinsicSize();
+
+  if (!mContent->GetParent()) {
+    if (IsRootOfImage() || IsRootOfReplacedElementSubDoc()) {
+      if (content->HasValidViewbox() || content->ShouldSynthesizeViewBox()) {
+        // The embedding element has done the replaced element sizing,
+        // using our intrinsic dimensions as necessary. We just need to
+        // fill the viewport.
+        return aCBSize;
+      }
+    } else {
+      // We're the root of a browsing context, so we need to honor
+      // widths and heights in percentages.  (GetIntrinsicSize() doesn't
+      // report these since there's no such thing as a percentage
+      // intrinsic size.)
+      nsSVGLength2 &width =
+        content->mLengthAttributes[nsSVGSVGElement::WIDTH];
+      if (width.IsPercentage()) {
+        NS_ABORT_IF_FALSE(intrinsicSize.width.GetUnit() == eStyleUnit_None,
+                          "GetIntrinsicSize should have reported no "
+                          "intrinsic width");
+        float val = width.GetAnimValInSpecifiedUnits() / 100.0f;
+        if (val < 0.0f) val = 0.0f;
+        intrinsicSize.width.SetCoordValue(val * aCBSize.width);
+      }
+
+      nsSVGLength2 &height =
+        content->mLengthAttributes[nsSVGSVGElement::HEIGHT];
+      NS_ABORT_IF_FALSE(aCBSize.height != NS_AUTOHEIGHT,
+                        "root should not have auto-height containing block");
+      if (height.IsPercentage()) {
+        NS_ABORT_IF_FALSE(intrinsicSize.height.GetUnit() == eStyleUnit_None,
+                          "GetIntrinsicSize should have reported no "
+                          "intrinsic height");
+        float val = height.GetAnimValInSpecifiedUnits() / 100.0f;
+        if (val < 0.0f) val = 0.0f;
+        intrinsicSize.height.SetCoordValue(val * aCBSize.height);
+      }
+    }
   }
 
   return nsLayoutUtils::ComputeSizeWithIntrinsicDimensions(
                             aRenderingContext, this,
-                            GetIntrinsicSize(), GetIntrinsicRatio(), aCBSize,
+                            intrinsicSize, GetIntrinsicRatio(), aCBSize,
                             aMargin, aBorder, aPadding);
 }
 
 NS_IMETHODIMP
 nsSVGOuterSVGFrame::Reflow(nsPresContext*           aPresContext,
                            nsHTMLReflowMetrics&     aDesiredSize,
                            const nsHTMLReflowState& aReflowState,
                            nsReflowStatus&          aStatus)
diff --git a/parser/htmlparser/tests/reftest/bug577418-1.html b/parser/htmlparser/tests/reftest/bug577418-1.html
--- a/parser/htmlparser/tests/reftest/bug577418-1.html
+++ b/parser/htmlparser/tests/reftest/bug577418-1.html
@@ -1,12 +1,12 @@
 <!DOCTYPE html>
 <html style="width:100%;height:100%;margin:0;border:0;overflow:hidden">
 <body style="width:100%;height:100%;margin:0;border:0;overflow:hidden">
-<svg>
+<svg style="width:100%;height:100%">
  <rect height="100%" width="100%" fill="red"/>
    <foreignObject>
      <html>
        <body>
        </body>
      </html>
     </foreignObject>
   <rect height="100%" width="100%" fill="lime"/>

DbgHelp thread-safety fixes.

diff --git a/xpcom/base/nsStackFrameWin.cpp b/xpcom/base/nsStackFrameWin.cpp
--- a/xpcom/base/nsStackFrameWin.cpp
+++ b/xpcom/base/nsStackFrameWin.cpp
@@ -151,6 +151,7 @@ EnsureImageHlpInitialized()
 {
     static PRBool gInitialized = PR_FALSE;
 
+    // XXX Not threadsafe.
     if (gInitialized)
         return gInitialized;
 
@@ -451,16 +452,19 @@ EnsureSymInitialized()
     static PRBool gInitialized = PR_FALSE;
     PRBool retStat;
 
+    // XXX Not threadsafe.
     if (gInitialized)
         return gInitialized;
 
     if (!EnsureImageHlpInitialized())
         return PR_FALSE;
 
+    EnterCriticalSection(&DbgHelpCS);
     _SymSetOptions(SYMOPT_LOAD_LINES | SYMOPT_UNDNAME);
     retStat = _SymInitialize(GetCurrentPIDorHandle(), NULL, TRUE);
     if (!retStat)
         PrintError("SymInitialize");
+    LeaveCriticalSection(&DbgHelpCS);
 
     gInitialized = retStat;
     /* XXX At some point we need to arrange to call _SymCleanup */

From: L. David Baron <dbaron@dbaron.org>

DbgHelp thread-safety fixes.

diff --git a/xpcom/base/nsStackWalk.cpp b/xpcom/base/nsStackWalk.cpp
--- a/xpcom/base/nsStackWalk.cpp
+++ b/xpcom/base/nsStackWalk.cpp
@@ -747,29 +747,32 @@ BOOL SymGetModuleInfoEspecial64(HANDLE a
 }
 
 static bool
 EnsureSymInitialized()
 {
   static bool gInitialized = false;
   bool retStat;
 
+  // XXX Not threadsafe.
   if (gInitialized) {
     return gInitialized;
   }
 
   if (!EnsureWalkThreadReady()) {
     return false;
   }
 
+  EnterCriticalSection(&gDbgHelpCS);
   SymSetOptions(SYMOPT_LOAD_LINES | SYMOPT_UNDNAME);
   retStat = SymInitialize(GetCurrentProcess(), nullptr, TRUE);
   if (!retStat) {
     PrintError("SymInitialize");
   }
+  LeaveCriticalSection(&gDbgHelpCS);
 
   gInitialized = retStat;
   /* XXX At some point we need to arrange to call SymCleanup */
 
   return retStat;
 }
 
 

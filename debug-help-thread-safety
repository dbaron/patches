DbgHelp thread-safety fixes.

diff --git a/xpcom/base/nsStackWalk.cpp b/xpcom/base/nsStackWalk.cpp
--- a/xpcom/base/nsStackWalk.cpp
+++ b/xpcom/base/nsStackWalk.cpp
@@ -300,6 +300,7 @@ EnsureImageHlpInitialized()
 {
     static PRBool gInitialized = PR_FALSE;
 
+    // XXX Not threadsafe.
     if (gInitialized)
         return gInitialized;
 
@@ -911,16 +912,19 @@ EnsureSymInitialized()
     static PRBool gInitialized = PR_FALSE;
     PRBool retStat;
 
+    // XXX Not threadsafe.
     if (gInitialized)
         return gInitialized;
 
     if (!EnsureImageHlpInitialized())
         return PR_FALSE;
 
+    EnterCriticalSection(&gDbgHelpCS);
     _SymSetOptions(SYMOPT_LOAD_LINES | SYMOPT_UNDNAME);
     retStat = _SymInitialize(GetCurrentPIDorHandle(), NULL, TRUE);
     if (!retStat)
         PrintError("SymInitialize");
+    LeaveCriticalSection(&gDbgHelpCS);
 
     gInitialized = retStat;
     /* XXX At some point we need to arrange to call _SymCleanup */

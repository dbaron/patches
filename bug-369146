Flush layout in subframes before doing a drawWindow.  b=369146  r+sr=bzbarsky

diff -r 77cf62b10152 content/canvas/src/nsCanvasRenderingContext2D.cpp
--- a/content/canvas/src/nsCanvasRenderingContext2D.cpp	Thu Feb 01 22:20:18 2007 -0800
+++ b/content/canvas/src/nsCanvasRenderingContext2D.cpp	Fri Feb 02 16:55:39 2007 -0800
@@ -92,6 +92,9 @@
 #include "nsIPresShell.h"
 #include "nsIDOMWindow.h"
 #include "nsPIDOMWindow.h"
+#include "nsIDocShell.h"
+#include "nsIDocShellTreeItem.h"
+#include "nsIDocShellTreeNode.h"
 #include "nsIXPConnect.h"
 #include "jsapi.h"
 #include "jsnum.h"
@@ -2501,6 +2504,37 @@ CheckSaneSubrectSize (PRInt32 x, PRInt32
     return PR_TRUE;
 }
 
+static void
+FlushLayoutForTree(nsIDOMWindow* aWindow)
+{
+    // Note that because FlushPendingNotifications flushes parents, this
+    // is O(N^2) in docshell tree depth.  However, the docshell tree is
+    // usually pretty shallow.
+
+    nsCOMPtr<nsIDOMDocument> domDoc;
+    aWindow->GetDocument(getter_AddRefs(domDoc));
+    nsCOMPtr<nsIDocument> doc = do_QueryInterface(domDoc);
+    if (doc) {
+        doc->FlushPendingNotifications(Flush_Layout);
+    }
+
+    nsCOMPtr<nsPIDOMWindow> piWin = do_QueryInterface(aWindow);
+    nsCOMPtr<nsIDocShellTreeNode> node =
+        do_QueryInterface(piWin->GetDocShell());
+    if (node) {
+        PRInt32 i = 0, i_end;
+        node->GetChildCount(&i_end);
+        for (; i < i_end; ++i) {
+            nsCOMPtr<nsIDocShellTreeItem> item;
+            node->GetChildAt(i, getter_AddRefs(item));
+            nsCOMPtr<nsIDOMWindow> win = do_GetInterface(item);
+            if (win) {
+                FlushLayoutForTree(win);
+            }
+        }
+    }
+}
+
 NS_IMETHODIMP
 nsCanvasRenderingContext2D::DrawWindow(nsIDOMWindow* aWindow, PRInt32 aX, PRInt32 aY,
                                        PRInt32 aW, PRInt32 aH, 
@@ -2526,14 +2560,7 @@ nsCanvasRenderingContext2D::DrawWindow(n
     }
     
     // Flush layout updates
-    nsCOMPtr<nsIDOMDocument> domDoc;
-    aWindow->GetDocument(getter_AddRefs(domDoc));
-    if (domDoc) {
-        nsCOMPtr<nsIDocument> doc = do_QueryInterface(domDoc);
-        if (doc) {
-            doc->FlushPendingNotifications(Flush_Layout);
-        }
-    }
+    FlushLayoutForTree(aWindow);
 
     nsCOMPtr<nsPresContext> presContext;
 #ifdef MOZILLA_1_8_BRANCH
@@ -2600,6 +2627,7 @@ nsCanvasRenderingContext2D::DrawWindow(n
 
     nsIFrame* rootFrame = presShell->FrameManager()->GetRootFrame();
     if (rootFrame) {
+        // XXX This shadows the other |r|, above.
         nsRect r(aX, aY, aW, aH);
         r.ScaleRoundOut(presContext->PixelsToTwips());
 

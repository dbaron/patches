From: L. David Baron <dbaron@dbaron.org>

Convert use of preferences API in style system mochitests to SpecialPowers.  (Bug 653461, patch 1)  r=bzbarsky

diff --git a/layout/style/test/test_bug389464.html b/layout/style/test/test_bug389464.html
--- a/layout/style/test/test_bug389464.html
+++ b/layout/style/test/test_bug389464.html
@@ -23,31 +23,24 @@
 <p><font id="two" size="-1">text</font></p>
 
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 SimpleTest.waitForExplicitFinish();
 
-netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-var prefService = Components.classes["@mozilla.org/preferences-service;1"].
-                    getService(Components.interfaces.nsIPrefService);
-var fontSizeBranch = prefService.getBranch("font.size.");
-
 function get_pref(pref)
 {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-    return fontSizeBranch.getIntPref(pref);
+    return SpecialPowers.getIntPref("font.size." + pref);
 }
 
 function set_pref(pref, val)
 {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-    fontSizeBranch.setIntPref(pref, val);
+    SpecialPowers.setIntPref("font.size." + pref, val);
 }
 
 var cs1 = getComputedStyle(document.getElementById("one"), "");
 var cs2 = getComputedStyle(document.getElementById("two"), "");
 
 var oldVariable = get_pref("variable.x-western");
 var oldFixed = get_pref("fixed.x-western");
 set_pref("variable.x-western", 25);
diff --git a/layout/style/test/test_bug401046.html b/layout/style/test/test_bug401046.html
--- a/layout/style/test/test_bug401046.html
+++ b/layout/style/test/test_bug401046.html
@@ -52,64 +52,52 @@ var elts = [
 
 function fs(idx) {
   // The computed font size actually *doesn't* currently reflect the
   // minimum font size preference, but things in em units do.  Not sure
   // if this is how it ought to be...
   return getComputedStyle(elts[idx], "").marginBottom;
 }
 
-netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-var CC = Components.classes;
-var CI = Components.interfaces;
-var prefs =
-  CC["@mozilla.org/preferences-service;1"].getService(CI.nsIPrefBranch);
-
-prefs.clearUserPref('font.minimum-size.x-western');
+SpecialPowers.clearUserPref('font.minimum-size.x-western');
 
 // preference change is async (although one setTimeout might be enough?)
 setTimeout(setTimeout, 0, step1, 0);
 
 function step1() {
-    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-
     is(fs(0), "0px", "at min font size 0, 0px should compute to 0px");
     is(fs(1), "4px", "at min font size 0, 4px should compute to 4px");
     is(fs(2), "12px", "at min font size 0, 12px should compute to 12px");
     is(fs(3), "28px", "at min font size 0, 28px should compute to 28px");
 
-    prefs.setIntPref('font.minimum-size.x-western', 7);
+    SpecialPowers.setIntPref('font.minimum-size.x-western', 7);
 
     // preference change is async (although one setTimeout might be enough?)
     setTimeout(setTimeout, 0, step2, 0);
 }
 
 function step2() {
-    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-
     is(fs(0), "0px", "at min font size 7, 0px should compute to 0px");
     is(fs(1), "7px", "at min font size 7, 4px should compute to 7px");
     is(fs(2), "12px", "at min font size 7, 12px should compute to 12px");
     is(fs(3), "28px", "at min font size 7, 28px should compute to 28px");
 
-    prefs.setIntPref('font.minimum-size.x-western', 18);
+    SpecialPowers.setIntPref('font.minimum-size.x-western', 18);
 
     // preference change is async (although one setTimeout might be enough?)
     setTimeout(setTimeout, 0, step3, 0);
 }
 
 function step3() {
-    netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
-
     is(fs(0), "0px", "at min font size 18, 0px should compute to 0px");
     is(fs(1), "18px", "at min font size 18, 4px should compute to 18px");
     is(fs(2), "18px", "at min font size 18, 12px should compute to 18px");
     is(fs(3), "28px", "at min font size 18, 28px should compute to 28px");
 
-    prefs.clearUserPref('font.minimum-size.x-western');
+    SpecialPowers.clearUserPref('font.minimum-size.x-western');
 
     SimpleTest.finish();
 }
 
 </script>
 </pre>
 </body>
 </html>
diff --git a/layout/style/test/test_dont_use_document_colors.html b/layout/style/test/test_dont_use_document_colors.html
--- a/layout/style/test/test_dont_use_document_colors.html
+++ b/layout/style/test/test_dont_use_document_colors.html
@@ -38,31 +38,24 @@
 <div id="seven">Hello</div>
 
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
 SimpleTest.waitForExplicitFinish();
 
-netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-var prefService = Components.classes["@mozilla.org/preferences-service;1"].
-                    getService(Components.interfaces.nsIPrefService);
-var dispBranch = prefService.getBranch("browser.display.");
-
 function get_pref()
 {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-    return dispBranch.getBoolPref("use_document_colors");
+    return SpecialPowers.getBoolPref("browser.display.use_document_colors");
 }
 
 function set_pref(val)
 {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-    dispBranch.setBoolPref("use_document_colors", val);
+    SpecialPowers.setBoolPref("browser.display.use_document_colors", val);
 }
 
 var cs1 = getComputedStyle(document.getElementById("one"), "");
 var cs2 = getComputedStyle(document.getElementById("two"), "");
 var cs3 = getComputedStyle(document.getElementById("three"), "");
 var cs4 = getComputedStyle(document.getElementById("four"), "");
 var cs5 = getComputedStyle(document.getElementById("five"), "");
 var cs6 = getComputedStyle(document.getElementById("six"), "");
diff --git a/layout/style/test/test_pixel_lengths.html b/layout/style/test/test_pixel_lengths.html
--- a/layout/style/test/test_pixel_lengths.html
+++ b/layout/style/test/test_pixel_lengths.html
@@ -16,21 +16,17 @@
 <div id="in" style="width:1in; height:1in; background:magenta;">in</div>
 
 <div id="mozmm" style="width:25.4mozmm; height:25.4mozmm; background:cyan;">mozmm</div>
 
 </div>
 <pre id="test">
 <script class="testbody" type="text/javascript">
 
-netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-var prefService = Components.classes["@mozilla.org/preferences-service;1"].
-                    getService(Components.interfaces.nsIPrefService);
-var branch = prefService.getBranch("layout.");
-var oldDPI = branch.getIntPref("css.dpi");
+var oldDPI = SpecialPowers.getIntPref("layout.css.dpi");
 var dpi = oldDPI;
 
 function check(id, val) {
   var e = document.getElementById(id);
   is(Math.round(e.getBoundingClientRect().width), Math.round(val),
      "Checking width in " + id + " at " + dpi + " DPI");
   is(Math.round(e.getBoundingClientRect().height), Math.round(val),
      "Checking height in " + id + " at " + dpi + " DPI");
@@ -41,31 +37,31 @@ function checkPixelRelativeUnits() {
   check("pc", 80);
   check("mm", 96);
   check("cm", 96);
   check("in", 96);
 }
 
 checkPixelRelativeUnits();
 
-branch.setIntPref("css.dpi", dpi = 96);
+SpecialPowers.setIntPref("layout.css.dpi", dpi = 96);
 
 var mozmm = document.getElementById("mozmm");
 var mozmmSize = mozmm.getBoundingClientRect().width;
 is(Math.round(mozmmSize), Math.round(mozmm.getBoundingClientRect().height),
    "mozmm div should be square");
 
 checkPixelRelativeUnits();
 
-branch.setIntPref("css.dpi", dpi = 192);
+SpecialPowers.setIntPref("layout.css.dpi", dpi = 192);
 
 // At 192 dpi, a one-inch box should be twice the number of device pixels,
 // and since we haven't changed the device-pixels-per-CSS-pixel ratio, the
 // mozmm box should be twice the size in CSS pixels.
 check("mozmm", mozmmSize*2);
 checkPixelRelativeUnits();
 
-branch.setIntPref("css.dpi", oldDPI);
+SpecialPowers.setIntPref("layout.css.dpi", oldDPI);
 
 </script>
 </pre>
 </body>
 </html>
diff --git a/layout/style/test/test_visited_pref.html b/layout/style/test/test_visited_pref.html
--- a/layout/style/test/test_visited_pref.html
+++ b/layout/style/test/test_visited_pref.html
@@ -27,31 +27,24 @@ https://bugzilla.mozilla.org/show_bug.cg
 
 function reinsert_node(e) {
   var sib = e.nextSibling;
   var par = e.parentNode;
   par.removeChild(e);
   par.insertBefore(e, sib);
 }
 
-netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-var prefService = Components.classes["@mozilla.org/preferences-service;1"].
-                    getService(Components.interfaces.nsIPrefService);
-var dispBranch = prefService.getBranch("layout.css.");
-
 function get_pref()
 {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-    return dispBranch.getBoolPref("visited_links_enabled");
+    return SpecialPowers.getBoolPref("layout.css.visited_links_enabled");
 }
 
 function set_pref(val)
 {
-    netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
-    dispBranch.setBoolPref("visited_links_enabled", val);
+    SpecialPowers.setBoolPref("layout.css.visited_links_enabled", val);
 }
 
 function snapshotsEqual(snap1, snap2)
 {
   return compareSnapshots(snap1, snap2, true)[0];
 }
 
 SimpleTest.waitForExplicitFinish();

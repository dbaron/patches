Make mochitests not build and search the results table when run inside the harness.  (Bug 466104)  r=sayrer (NEED TO FIX LEAKS BEFORE LANDING)

diff --git a/testing/mochitest/tests/SimpleTest/SimpleTest.js b/testing/mochitest/tests/SimpleTest/SimpleTest.js
--- a/testing/mochitest/tests/SimpleTest/SimpleTest.js
+++ b/testing/mochitest/tests/SimpleTest/SimpleTest.js
@@ -217,32 +217,26 @@ SimpleTest.executeSoon = function(aFunc)
             }
         }, Components.interfaces.nsIThread.DISPATCH_NORMAL);
     } else {
         setTimeout(aFunc, 0);
     }
 }
 
 /**
- * Talks to the TestRunner if being ran on a iframe and the parent has a
- * TestRunner object.
-**/
-SimpleTest.talkToRunner = function () {
-    if (parentRunner) {
-        parentRunner.testFinished(document);
-    }
-};
-
-/**
  * Finishes the tests. This is automatically called, except when
  * SimpleTest.waitForExplicitFinish() has been invoked.
 **/
 SimpleTest.finish = function () {
-    SimpleTest.showReport();
-    SimpleTest.talkToRunner();
+    if (parentRunner) {
+        /* We're running in an iframe, and the parent has a TestRunner */
+        parentRunner.testFinished(SimpleTest._tests);
+    } else {
+        SimpleTest.showReport();
+    }
 };
 
 
 addLoadEvent(function() {
     if (SimpleTest._stopOnLoad) {
         SimpleTest.finish();
     }
 });
diff --git a/testing/mochitest/tests/SimpleTest/TestRunner.js b/testing/mochitest/tests/SimpleTest/TestRunner.js
--- a/testing/mochitest/tests/SimpleTest/TestRunner.js
+++ b/testing/mochitest/tests/SimpleTest/TestRunner.js
@@ -144,45 +144,49 @@ TestRunner.runNextTest = function() {
         if (TestRunner.onComplete)
             TestRunner.onComplete();
     }
 };
 
 /**
  * This stub is called by SimpleTest when a test is finished.
 **/
-TestRunner.testFinished = function(doc) {
+TestRunner.testFinished = function(tests) {
     var finishedURL = TestRunner._urls[TestRunner._currentTest];
 
     if (TestRunner.logEnabled)
         TestRunner.logger.debug("SimpleTest finished " + finishedURL);
 
-    TestRunner.updateUI();
+    TestRunner.updateUI(tests);
     TestRunner._currentTest++;
     TestRunner.runNextTest();
 };
 
 /**
  * Get the results.
  */
-TestRunner.countResults = function(doc) {
-  var nOK = withDocument(doc,
-     partial(getElementsByTagAndClassName, 'div', 'test_ok')
-  ).length;
-  var nNotOK = withDocument(doc,
-     partial(getElementsByTagAndClassName, 'div', 'test_not_ok')
-  ).length;
-  var nTodo = withDocument(doc,
-     partial(getElementsByTagAndClassName, 'div', 'test_todo')
-  ).length;
+TestRunner.countResults = function(tests) {
+  var nOK = 0;
+  var nNotOK = 0;
+  var nTodo = 0;
+  for (var i = 0; i < tests.length; ++i) {
+    var test = tests[i];
+    if (test.todo && !test.result) {
+      nTodo++;
+    } else if (test.result && !test.todo) {
+      nOK++;
+    } else {
+      nNotOK++;
+    }
+  }
   return {"OK": nOK, "notOK": nNotOK, "todo": nTodo};
 }
 
-TestRunner.updateUI = function() {
-  var results = TestRunner.countResults($('testframe').contentDocument);
+TestRunner.updateUI = function(tests) {
+  var results = TestRunner.countResults(tests);
   var passCount = parseInt($("pass-count").innerHTML) + results.OK;
   var failCount = parseInt($("fail-count").innerHTML) + results.notOK;
   var todoCount = parseInt($("todo-count").innerHTML) + results.todo;
   $("pass-count").innerHTML = passCount;
   $("fail-count").innerHTML = failCount;
   $("todo-count").innerHTML = todoCount;
 
   // Set the top Green/Red bar

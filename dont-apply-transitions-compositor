From: L. David Baron <dbaron@dbaron.org>

Bug 1125455 patch 6 - For compositor-thread application of transitions, don't apply transitions when animations are also running.

FIXME: Fatal assertion when running test!

FIXME: Do we need to resend to the compositor in certain conditions?

diff --git a/layout/base/nsDisplayList.cpp b/layout/base/nsDisplayList.cpp
--- a/layout/base/nsDisplayList.cpp
+++ b/layout/base/nsDisplayList.cpp
@@ -381,16 +381,23 @@ AddAnimationForProperty(nsIFrame* aFrame
        propIdx < anim->Properties().Length();
        propIdx++) {
     AnimationProperty& property = anim->Properties()[propIdx];
 
     if (aProperty != property.mProperty) {
       continue;
     }
 
+    if (!property.mWinsInCascade) {
+      // We have an animation or transition, but it isn't actually
+      // winning in the CSS cascade, so we don't want to send it to the
+      // compositor.
+      continue;
+    }
+
     for (uint32_t segIdx = 0; segIdx < property.mSegments.Length(); segIdx++) {
       AnimationPropertySegment& segment = property.mSegments[segIdx];
 
       AnimationSegment* animSegment = animation->segments().AppendElement();
       if (aProperty == eCSSProperty_transform) {
         animSegment->startState() = InfallibleTArray<TransformFunction>();
         animSegment->endState() = InfallibleTArray<TransformFunction>();
 
diff --git a/layout/style/test/test_animations_omta.html b/layout/style/test/test_animations_omta.html
--- a/layout/style/test/test_animations_omta.html
+++ b/layout/style/test/test_animations_omta.html
@@ -2084,19 +2084,19 @@ addAsyncAnimTest(function *() {
   omta_is("opacity", 0.8, RunningOn.Compositor,
           "opacity transition at 0s");
   advance_clock(500);
   yield waitForPaintsFlushed();
   omta_is("opacity", 0.65, RunningOn.Compositor,
           "opacity transition at 0.5s");
   gDiv.style.animation = "opacitymid 2s linear";
   yield waitForPaintsFlushed();
-  omta_todo_is("opacity", 0.2, RunningOn.Compositor,
+  omta_is("opacity", 0.2, RunningOn.Compositor,
           "opacity animation overriding transition at 0s");
   advance_clock(500);
   yield waitForPaintsFlushed();
-  omta_todo_is("opacity", 0.35, RunningOn.Compositor,
+  omta_is("opacity", 0.35, RunningOn.Compositor,
           "opacity animation overriding transition at 0.5s");
   done_div();
 });
 
 </script>
 </html>

From: L. David Baron <dbaron@dbaron.org>

Don't distribute percentage width from column-spanning cells to columns that have no cells originating.  (Bug 810586)

This makes the distribution of pref/min width and the distribution
of percentage width from column-spanning cells more consistent with
each other.

TODO: Fix FLEX_ALL_LARGE distribution too!

diff --git a/layout/tables/BasicTableLayoutStrategy.cpp b/layout/tables/BasicTableLayoutStrategy.cpp
--- a/layout/tables/BasicTableLayoutStrategy.cpp
+++ b/layout/tables/BasicTableLayoutStrategy.cpp
@@ -556,27 +556,34 @@ BasicTableLayoutStrategy::DistributePctW
                                                       int32_t aColCount)
 {
     // First loop to determine:
     int32_t nonPctColCount = 0; // number of spanned columns without % width
     nscoord nonPctTotalPrefWidth = 0; // total pref width of those columns
     // and to reduce aSpanPrefPct by columns that already have % width
 
     int32_t scol, scol_end;
+    nsTableCellMap *cellMap = mTableFrame->GetCellMap();
     for (scol = aFirstCol, scol_end = aFirstCol + aColCount;
          scol < scol_end; ++scol) {
         nsTableColFrame *scolFrame = mTableFrame->GetColFrame(scol);
         if (!scolFrame) {
             NS_ERROR("column frames out of sync with cell map");
             continue;
         }
         float scolPct = scolFrame->GetPrefPercent();
         if (scolPct == 0.0f) {
-            nonPctTotalPrefWidth += scolFrame->GetPrefCoord();
-            ++nonPctColCount;
+            if (cellMap->GetNumCellsOriginatingInCol(scol) > 0) {
+                nonPctTotalPrefWidth += scolFrame->GetPrefCoord();
+                ++nonPctColCount;
+            } else {
+                NS_ASSERTION(scolFrame->GetPrefCoord() == 0,
+                             "shouldn't distribute width to columns with "
+                             "no originating cells");
+            }
         } else {
             aSpanPrefPct -= scolPct;
         }
     }
 
     if (aSpanPrefPct <= 0.0f || nonPctColCount == 0) {
         // There's no %-width on the colspan left over to distribute,
         // or there are no columns to which we could distribute %-width
@@ -589,17 +596,18 @@ BasicTableLayoutStrategy::DistributePctW
     for (scol = aFirstCol, scol_end = aFirstCol + aColCount;
          scol < scol_end; ++scol) {
         nsTableColFrame *scolFrame = mTableFrame->GetColFrame(scol);
         if (!scolFrame) {
             NS_ERROR("column frames out of sync with cell map");
             continue;
         }
 
-        if (scolFrame->GetPrefPercent() == 0.0f) {
+        if (scolFrame->GetPrefPercent() == 0.0f &&
+            cellMap->GetNumCellsOriginatingInCol(scol) > 0) {
             NS_ASSERTION((!spanHasNonPctPref ||
                           nonPctTotalPrefWidth != 0) &&
                          nonPctColCount != 0,
                          "should not be zero if we haven't allocated "
                          "all pref percent");
 
             float allocatedPct; // % width to be given to this column
             if (spanHasNonPctPref) {

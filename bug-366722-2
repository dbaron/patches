Make non-box frames pay better attention to nsITheme::GetWidgetBorder.  b=366722

diff -r 8cb4d6e06a98 layout/generic/nsContainerFrame.cpp
--- a/layout/generic/nsContainerFrame.cpp	Mon Jan 22 20:08:22 2007 -0800
+++ b/layout/generic/nsContainerFrame.cpp	Mon Jan 22 20:08:27 2007 -0800
@@ -582,21 +582,9 @@ SyncFrameViewGeometryDependentProperties
     }
 
     if (hasOverflowClip) {
-      const nsStyleBorder* borderStyle = aStyleContext->GetStyleBorder();
-      const nsStylePadding* paddingStyle = aStyleContext->GetStylePadding();
-
       nsMargin padding;
       nsRect overflowClipRect(0, 0, frameSize.width, frameSize.height);
-      overflowClipRect.Deflate(borderStyle->GetBorder());
-      // XXX We need to handle percentage padding
-      if (paddingStyle->GetPadding(padding)) {
-        overflowClipRect.Deflate(padding);
-      }
-#ifdef DEBUG
-      else {
-        NS_WARNING("Percentage padding and CLIP overflow don't mix");
-      }
-#endif
+      overflowClipRect.Deflate(aFrame->GetUsedBorderAndPadding());
 
       if (hasClip) {
         // If both 'clip' and 'overflow-clip' apply then use the intersection
diff -r 8cb4d6e06a98 layout/generic/nsFrame.cpp
--- a/layout/generic/nsFrame.cpp	Mon Jan 22 20:08:22 2007 -0800
+++ b/layout/generic/nsFrame.cpp	Mon Jan 22 20:08:27 2007 -0800
@@ -713,6 +713,24 @@ nsIFrame::GetUsedBorder() const
                (GetStateBits() & NS_FRAME_IN_REFLOW),
                "cannot call on a dirty frame not currently being reflowed");
 
+  // Theme methods don't use const-ness.
+  nsIFrame *mutable_this = NS_CONST_CAST(nsIFrame*, this);
+
+  const nsStyleDisplay *disp = GetStyleDisplay();
+  if (mutable_this->IsThemed(disp)) {
+    nsMargin result;
+    nsPresContext *presContext = GetPresContext();
+    presContext->GetTheme()->GetWidgetBorder(presContext->DeviceContext(),
+                                             mutable_this, disp->mAppearance,
+                                             &result);
+    float p2t = presContext->ScaledPixelsToTwips();
+    result.top = NSIntPixelsToTwips(result.top, p2t);
+    result.right = NSIntPixelsToTwips(result.right, p2t);
+    result.bottom = NSIntPixelsToTwips(result.bottom, p2t);
+    result.left = NSIntPixelsToTwips(result.left, p2t);
+    return result;
+  }
+
   return GetStyleBorder()->GetBorder();
 }
 
@@ -725,6 +743,25 @@ nsIFrame::GetUsedPadding() const
                "cannot call on a dirty frame not currently being reflowed");
 
   nsMargin padding(0, 0, 0, 0);
+
+  // Theme methods don't use const-ness.
+  nsIFrame *mutable_this = NS_CONST_CAST(nsIFrame*, this);
+
+  const nsStyleDisplay *disp = GetStyleDisplay();
+  if (mutable_this->IsThemed(disp)) {
+    nsPresContext *presContext = GetPresContext();
+    if (presContext->GetTheme()->GetWidgetPadding(presContext->DeviceContext(),
+                                                  mutable_this,
+                                                  disp->mAppearance,
+                                                  &padding)) {
+      float p2t = presContext->ScaledPixelsToTwips();
+      padding.top = NSIntPixelsToTwips(padding.top, p2t);
+      padding.right = NSIntPixelsToTwips(padding.right, p2t);
+      padding.bottom = NSIntPixelsToTwips(padding.bottom, p2t);
+      padding.left = NSIntPixelsToTwips(padding.left, p2t);
+      return padding;
+    }
+  }
   if (!GetStylePadding()->GetPadding(padding)) {
     nsMargin *p = NS_STATIC_CAST(nsMargin*,
                     GetProperty(nsGkAtoms::usedPaddingProperty));
diff -r 8cb4d6e06a98 layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp	Mon Jan 22 20:08:22 2007 -0800
+++ b/layout/style/nsComputedDOMStyle.cpp	Mon Jan 22 20:08:27 2007 -0800
@@ -2993,7 +2993,20 @@ nsComputedDOMStyle::GetBorderWidthFor(PR
   nsROCSSPrimitiveValue* val = GetROCSSPrimitiveValue();
   NS_ENSURE_TRUE(val, NS_ERROR_OUT_OF_MEMORY);
 
-  val->SetTwips(GetStyleBorder()->GetComputedBorderWidth(aSide));
+  nscoord width;
+  const nsStyleDisplay *disp = GetStyleDisplay();
+  if (mFrame->IsThemed(disp)) {
+    nsMargin result;
+    nsPresContext *presContext = mFrame->GetPresContext();
+    presContext->GetTheme()->GetWidgetBorder(presContext->DeviceContext(),
+                                             mFrame, disp->mAppearance,
+                                             &result);
+    width = NSIntPixelsToTwips(result.side(aSide),
+                               presContext->ScaledPixelsToTwips());
+  } else {
+    width = GetStyleBorder()->GetComputedBorderWidth(aSide);
+  }
+  val->SetTwips(width);
 
   return CallQueryInterface(val, aValue);
 }

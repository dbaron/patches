Prevent margin expansion from interfering with table caption position.  b=363248

diff --git a/layout/generic/nsFrame.cpp b/layout/generic/nsFrame.cpp
--- a/layout/generic/nsFrame.cpp
+++ b/layout/generic/nsFrame.cpp
@@ -630,16 +630,6 @@ nsIFrame::ApplySkipSides(nsMargin& aMarg
     aMargin.bottom = 0;
   if (skipSides & (1 << NS_SIDE_LEFT))
     aMargin.left = 0;
-}
-
-nsRect
-nsIFrame::GetMarginRect() const
-{
-  nsMargin m(GetUsedMargin());
-  ApplySkipSides(m);
-  nsRect r(mRect);
-  r.Inflate(m);
-  return r;
 }
 
 nsRect
diff --git a/layout/generic/nsHTMLReflowState.cpp b/layout/generic/nsHTMLReflowState.cpp
--- a/layout/generic/nsHTMLReflowState.cpp
+++ b/layout/generic/nsHTMLReflowState.cpp
@@ -1798,7 +1798,11 @@ nsHTMLReflowState::InitConstraints(nsPre
       NS_ASSERTION(mComputedHeight == NS_UNCONSTRAINEDSIZE ||
                    mComputedHeight >= 0, "Bogus height");
 
-      if (isBlock)
+      PRUint8 captionSide;
+      if (isBlock && (mStyleDisplay->mDisplay != NS_STYLE_TABLE_CAPTION ||
+                      (captionSide = GetStyleTableBorder()->mCaptionSide) ==
+                        NS_STYLE_CAPTION_SIDE_TOP_OUTSIDE ||
+                      captionSide == NS_STYLE_CAPTION_SIDE_BOTTOM_OUTSIDE))
         CalculateBlockSideMargins(availableWidth, mComputedWidth);
     }
   }
@@ -2110,6 +2114,9 @@ nsCSSOffsetState::ComputeMargin(nscoord 
                                mComputedMargin.bottom);
 
     // XXX We need to include 'auto' horizontal margins in this too!
+    // ... but if we did that, we'd need to fix nsFrame::GetUsedMargin
+    // to use it even when the margins are all zero (since sometimes
+    // they get treated as auto)
     frame->SetProperty(nsGkAtoms::usedMarginProperty,
                        new nsMargin(mComputedMargin),
                        DestroyMarginFunc);
diff --git a/layout/generic/nsIFrame.h b/layout/generic/nsIFrame.h
--- a/layout/generic/nsIFrame.h
+++ b/layout/generic/nsIFrame.h
@@ -718,6 +718,7 @@ public:
    * frame has at least *started*.
    *
    * This doesn't include any margin collapsing that may have occurred.
+   * It also treats 'auto' margins as zero.
    */
   virtual nsMargin GetUsedMargin() const;
 
@@ -754,7 +755,6 @@ public:
    * Like the frame's rect (see |GetRect|), which is the border rect,
    * other rectangles of the frame, in twips, relative to the parent.
    */
-  nsRect GetMarginRect() const;
   nsRect GetPaddingRect() const;
   nsRect GetContentRect() const;
 

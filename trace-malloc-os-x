Port trace-malloc to Mac OS X.

diff --git a/tools/trace-malloc/lib/nsTraceMalloc.c b/tools/trace-malloc/lib/nsTraceMalloc.c
--- a/tools/trace-malloc/lib/nsTraceMalloc.c
+++ b/tools/trace-malloc/lib/nsTraceMalloc.c
@@ -70,17 +70,31 @@
 #include "nsStackWalk.h"
 #include "nsTraceMallocCallbacks.h"
 
-#ifdef XP_WIN32
-#include <sys/timeb.h>/*for timeb*/
-#include <sys/stat.h>/*for fstat*/
-
-#include <io.h> /*for write*/
+#if defined(XP_MACOSX)
+
+#include <malloc/malloc.h>
 
 #define WRITE_FLAGS "w"
 
-#endif /* WIN32 */
-
-#ifdef XP_UNIX
+static malloc_zone_t *default_zone = NULL;
+
+static malloc_zone_t *
+get_default_zone()
+{
+    if (!default_zone)
+        default_zone = malloc_default_zone();
+    return default_zone;
+}
+
+typedef void *__ptr_t;
+#define __libc_malloc(x)      (get_default_zone()->malloc)(default_zone, x)
+#define __libc_calloc(x, y)   (get_default_zone()->calloc)(default_zone, x, y)
+#define __libc_valloc(x)      (get_default_zone()->valloc)(default_zone, x)
+#define __libc_realloc(x, y)  (get_default_zone()->realloc)(default_zone, x, y)
+#define __libc_free(x)        (get_default_zone()->free)(default_zone, x)
+
+#elif defined(XP_UNIX)
+
 #define WRITE_FLAGS "w"
 
 #ifdef WRAP_SYSTEM_INCLUDES
@@ -96,9 +110,14 @@ extern __ptr_t __libc_valloc(size_t);
 #pragma GCC visibility pop
 #endif
 
-#endif /* !XP_UNIX */
-
-#ifdef XP_WIN32
+#elif defined(XP_WIN32)
+
+#include <sys/timeb.h>/*for timeb*/
+#include <sys/stat.h>/*for fstat*/
+
+#include <io.h> /*for write*/
+
+#define WRITE_FLAGS "w"
 
 #define __libc_malloc(x)                dhw_orig_malloc(x)
 #define __libc_calloc(x, y)             dhw_orig_calloc(x,y)
@@ -1274,6 +1293,7 @@ valloc(size_t size)
     return ptr;
 }
 
+#ifndef XP_MACOSX
 NS_EXTERNAL_VIS_(void*)
 memalign(size_t boundary, size_t size)
 {
@@ -1329,6 +1349,7 @@ posix_memalign(void **memptr, size_t ali
     *memptr = ptr;
     return 0;
 }
+#endif
 
 NS_EXTERNAL_VIS_(void)
 free(__ptr_t ptr)
@@ -1389,11 +1410,13 @@ free(__ptr_t ptr)
     }
 }
 
+#ifndef XP_MACOSX
 NS_EXTERNAL_VIS_(void)
 cfree(void *ptr)
 {
     free(ptr);
 }
+#endif
 
 #endif /* XP_UNIX */
 
diff --git a/tools/trace-malloc/lib/nsTypeInfo.cpp b/tools/trace-malloc/lib/nsTypeInfo.cpp
--- a/tools/trace-malloc/lib/nsTypeInfo.cpp
+++ b/tools/trace-malloc/lib/nsTypeInfo.cpp
@@ -249,7 +249,7 @@ const char* nsGetTypeName(void* ptr)
 
 #endif
 
-#if defined(linux)
+#if defined(linux) || defined(XP_MACOSX)
 
 #define __USE_GNU
 #include <dlfcn.h>

From: L. David Baron <dbaron@dbaron.org>

Bug 1110277 patch 8 - Add test for passing lazy construction parameters through, using flexbox reframe case.

FIXME: REWRITE THIS COMMENT!
This tests a case fixed by patch 6 (which in turn depends on patch 5).
In particular, I tested that:
 * with all of patches 1-6 applied, the two added tests pass
 * with patches 1-5 applied but patch 6 not applied, the two added tests
   fail, both reporting rgb(255, 255, 0)
 * with patches 1-4 *not* applied but patches 5-6 applied, the two added
   tests pass
 * with patches 1-6 *not* applied, the two added tests fail, both
   reporting rgb(255, 255, 0)

Note that this test is structured in a rather particular way (with two
separate restyles triggered by attributes on different elements, queued
in a particular order) to avoid triggering bug 1111451.

diff --git a/layout/style/test/test_transitions_and_reframes.html b/layout/style/test/test_transitions_and_reframes.html
--- a/layout/style/test/test_transitions_and_reframes.html
+++ b/layout/style/test/test_transitions_and_reframes.html
@@ -34,24 +34,38 @@ https://bugzilla.mozilla.org/show_bug.cg
   }
   .o { overflow: hidden }
   .n { display: none }
 
   #fline { color: blue; font-size: 20px; width: 800px; }
   #fline::first-line { color: yellow }
   #fline.narrow { width: 50px }
   #fline i { transition: color linear 1s }
+
+  #flexboxtest #flex { display: flex; flex-direction: column }
+  #flexboxtest #flextransition { color: blue; transition: color 5s linear }
+
+  #flexboxtest #flexkid[newstyle] { resize: both }
+  #flexboxtest #flextransition[newstyle] { color: yellow }
   </style>
 </head>
 <body>
 <a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=625289">Mozilla Bug 625289</a>
 <div id="container"></div>
 <div id="fline">
   This text has an <i>i element</i> in it.
 </div>
+<div id="flexboxtest">
+  <div id="flex">
+    hello
+    <span id="flexkid">this appears</span>
+    hello
+    <div id="flextransition">color transition</div>
+  </div>
+</div>
 <pre id="test">
 <script>
 "use strict";
 
 function advance_clock(milliseconds) {
   SpecialPowers.DOMWindowUtils.advanceTimeAndRefresh(milliseconds);
 }
 
@@ -255,14 +269,30 @@ var firstline_tests = [
   { widening: true, set_overflow: true },
   { widening: false, set_overflow: true },
 ];
 
 for (var firstline_test_idx in firstline_tests) {
   do_firstline_test(firstline_tests[firstline_test_idx]);
 }
 
+function do_flexbox_reframe_test()
+{
+  var flextransition = document.getElementById("flextransition");
+  var cs = getComputedStyle(flextransition, "");
+  cs.backgroundColor;
+  flextransition.setAttribute("newstyle", "");
+  document.getElementById("flexkid").setAttribute("newstyle", "");
+  is(cs.color, "rgb(0, 0, 255)",
+     "color at start of wrapped flexbox transition");
+  advance_clock(1000);
+  is(cs.color, "rgb(51, 51, 204)",
+     "color one second in to wrapped flexbox transition");
+}
+
+do_flexbox_reframe_test();
+
 SpecialPowers.DOMWindowUtils.restoreNormalRefresh();
 
 </script>
 </pre>
 </body>
 </html>

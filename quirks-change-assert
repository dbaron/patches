Fix assertion about being too late to set quirks style sheet.  (Bug 450191)

diff --git a/layout/style/nsCSSRuleProcessor.h b/layout/style/nsCSSRuleProcessor.h
--- a/layout/style/nsCSSRuleProcessor.h
+++ b/layout/style/nsCSSRuleProcessor.h
@@ -93,17 +93,18 @@ public:
   NS_IMETHOD HasAttributeDependentStyle(AttributeRuleProcessorData* aData,
                                         nsReStyleHint* aResult);
 
   NS_IMETHOD MediumFeaturesChanged(nsPresContext* aPresContext,
                                    PRBool* aRulesChanged);
 
 #ifdef DEBUG
   void AssertQuirksChangeOK() {
-    NS_ASSERTION(!mRuleCascades, "too late to set quirks style sheet");
+    NS_ASSERTION(!mRuleCascades, 
+                 "can't quirks style sheet without clearing rule cascades");
   }
 #endif
 
 protected:
   RuleCascadeData* GetRuleCascade(nsPresContext* aPresContext);
   void RefreshRuleCascade(nsPresContext* aPresContext);
 
   // The sheet order here is the same as in nsStyleSet::mSheets
diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -365,30 +365,35 @@ nsStyleSet::EnableQuirkStyleSheet(PRBool
         // only one quirk style sheet can exist, so stop looking
         break;
       }
     }
   }
   NS_ASSERTION(mQuirkStyleSheet, "no quirk stylesheet");
   if (mQuirkStyleSheet) {
 #ifdef DEBUG
-    if (mRuleProcessors[eAgentSheet]) {
+    PRBool applicableNow;
+    {
+      nsCOMPtr<nsIDOMCSSStyleSheet> domSheet =
+        do_QueryInterface(mQuirkStyleSheet);
+      domSheet->GetDisabled(&applicableNow);
+      applicableNow = !applicableNow;
+    }
+#endif
+    mQuirkStyleSheet->SetEnabled(aEnable);
+#ifdef DEBUG
+    // This should always be OK, since SetEnabled should call
+    // ClearRuleCascades.
+    // Note that we can hit this codepath multiple times when document.open()
+    // (potentially implied) happens multiple times.
+    if (mRuleProcessors[eAgentSheet] && aEnable != applicableNow) {
       static_cast<nsCSSRuleProcessor*>(static_cast<nsIStyleRuleProcessor*>(
         mRuleProcessors[eAgentSheet]))->AssertQuirksChangeOK();
     }
 #endif
-#ifdef DEBUG_dbaron_off // XXX Make this |DEBUG| once it stops firing.
-    PRBool applicableNow;
-    mQuirkStyleSheet->GetApplicable(applicableNow);
-    NS_ASSERTION(!mRuleProcessors[eAgentSheet] || aEnable == applicableNow,
-                 "enabling/disabling quirk stylesheet too late or incomplete quirk stylesheet");
-    if (mRuleProcessors[eAgentSheet] && aEnable == applicableNow)
-      printf("WARNING: We set the quirks mode too many times.\n"); // we do!
-#endif
-    mQuirkStyleSheet->SetEnabled(aEnable);
   }
 }
 
 static PRBool
 EnumRulesMatching(nsIStyleRuleProcessor* aProcessor, void* aData)
 {
   ElementRuleProcessorData* data =
     static_cast<ElementRuleProcessorData*>(aData);

From: L. David Baron <dbaron@dbaron.org>

Bug 847287 patch 7 - Use fully-updated style rule for animations when updating cascade results for transitions.

diff --git a/layout/style/nsTransitionManager.cpp b/layout/style/nsTransitionManager.cpp
--- a/layout/style/nsTransitionManager.cpp
+++ b/layout/style/nsTransitionManager.cpp
@@ -651,18 +651,25 @@ nsTransitionManager::UpdateCascadeResult
   nsCSSPropertySet propertiesUsed;
 #ifdef DEBUG
   nsCSSPropertySet propertiesWithTransitions;
 #endif
 
   // http://dev.w3.org/csswg/css-transitions/#application says that
   // transitions do not apply when the same property has a CSS Animation
   // on that element (even though animations are lower in the cascade).
-  if (aAnimations && aAnimations->mStyleRule) {
-    aAnimations->mStyleRule->AddPropertiesToSet(propertiesUsed);
+  if (aAnimations) {
+    TimeStamp now = mPresContext->RefreshDriver()->MostRecentRefresh();
+    // Passing EnsureStyleRule_IsThrottled is OK since we will
+    // unthrottle when animations are finishing.
+    aAnimations->EnsureStyleRuleFor(now, EnsureStyleRule_IsThrottled);
+
+    if (aAnimations->mStyleRule) {
+      aAnimations->mStyleRule->AddPropertiesToSet(propertiesUsed);
+    }
   }
 
   // Since we should never have more than one transition for the same
   // property, it doesn't matter what order we iterate the transitions.
   // But let's go the same way as animations.
   bool changed = false;
   AnimationPlayerPtrArray& players = aTransitions->mPlayers;
   for (size_t playerIdx = players.Length(); playerIdx-- != 0; ) {

From: L. David Baron <dbaron@dbaron.org>

Use the appropriate color based on visitedness for '-moz-column-rule-color'.  (Bug 557580)  r=roc

diff --git a/layout/generic/nsColumnSetFrame.cpp b/layout/generic/nsColumnSetFrame.cpp
--- a/layout/generic/nsColumnSetFrame.cpp
+++ b/layout/generic/nsColumnSetFrame.cpp
@@ -240,21 +240,18 @@ nsColumnSetFrame::PaintColumnRule(nsIRen
   else
     ruleStyle = colStyle->mColumnRuleStyle;
 
   nsPresContext* presContext = PresContext();
   nscoord ruleWidth = colStyle->GetComputedColumnRuleWidth();
   if (!ruleWidth)
     return;
 
-  nscolor ruleColor;
-  if (colStyle->mColumnRuleColorIsForeground)
-    ruleColor = GetStyleColor()->mColor;
-  else
-    ruleColor = colStyle->mColumnRuleColor;
+  nscolor ruleColor =
+    GetVisitedDependentColor(eCSSProperty__moz_column_rule_color);
 
   // In order to re-use a large amount of code, we treat the column rule as a border.
   // We create a new border style object and fill in all the details of the column rule as
   // the left border. PaintBorder() does all the rendering for us, so we not
   // only save an enormous amount of code but we'll support all the line styles that
   // we support on borders!
   nsStyleBorder border(presContext);
   border.SetBorderWidth(NS_SIDE_LEFT, ruleWidth);
diff --git a/layout/reftests/css-visited/column-rule-1-notref.html b/layout/reftests/css-visited/column-rule-1-notref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-visited/column-rule-1-notref.html
@@ -0,0 +1,11 @@
+<!DOCTYPE HTML>
+<title>Test for privacy restrictions on :visited (Bug 147777)</title>
+<style type="text/css">
+
+div { margin: 8px; -moz-column-count: 2; }
+#link { -moz-column-rule: medium dotted blue; }
+#visited { -moz-column-rule: medium dotted black; }
+
+</style>
+<div id="link">unvisited<br>link</div>
+<div id="visited">visited<br>link</div>
diff --git a/layout/reftests/css-visited/column-rule-1-ref.html b/layout/reftests/css-visited/column-rule-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-visited/column-rule-1-ref.html
@@ -0,0 +1,11 @@
+<!DOCTYPE HTML>
+<title>Test for privacy restrictions on :visited (Bug 147777)</title>
+<style type="text/css">
+
+div { margin: 8px; -moz-column-count: 2; }
+#link { -moz-column-rule: medium dotted blue; }
+#visited { -moz-column-rule: medium dotted silver; }
+
+</style>
+<div id="link">unvisited<br>link</div>
+<div id="visited">visited<br>link</div>
diff --git a/layout/reftests/css-visited/column-rule-1.html b/layout/reftests/css-visited/column-rule-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-visited/column-rule-1.html
@@ -0,0 +1,11 @@
+<!DOCTYPE HTML>
+<title>Test for privacy restrictions on :visited (Bug 147777)</title>
+<style type="text/css">
+
+a { text-decoration: none; color: -moz-initial; display: block; margin: 8px; -moz-column-count: 2; }
+:link { -moz-column-rule: medium dotted blue; }
+:visited { -moz-column-rule: thick dashed silver; }
+
+</style>
+<a href="unvisited-page.html">unvisited<br>link</a>
+<a href="visited-page.html">visited<br>link</a>
diff --git a/layout/style/test/test_visited_reftests.html b/layout/style/test/test_visited_reftests.html
--- a/layout/style/test/test_visited_reftests.html
+++ b/layout/style/test/test_visited_reftests.html
@@ -54,16 +54,18 @@ var gTests = [
   "== border-1.html border-1-ref.html",
   "== border-2a.html border-2-ref.html",
   "== border-2b.html border-2-ref.html",
   // FIXME: Commented out because of dynamic change handling bugs in
   // border-collapse tables that mean we get an incorrect rendering when
   // the asynchronous restyle-from-history arrives.
   //"== border-collapse-1.html border-collapse-1-ref.html",
   "== outline-1.html outline-1-ref.html",
+  "== column-rule-1.html column-rule-1-ref.html",
+  "!= column-rule-1.html column-rule-1-notref.html",
   "== color-choice-1.html color-choice-1-ref.html",
   "== selector-descendant-1.html selector-descendant-1-ref.html",
   "== selector-descendant-2.xhtml selector-descendant-2-ref.xhtml",
   "== selector-child-1.html selector-child-1-ref.html",
   "== selector-child-2.xhtml selector-child-2-ref.xhtml",
   "== selector-adj-sibling-1.html selector-adj-sibling-1-ref.html",
   "== selector-adj-sibling-2.html selector-adj-sibling-2-ref.html",
   "== selector-any-sibling-1.html selector-any-sibling-1-ref.html",

From: L. David Baron <dbaron@dbaron.org>

Use extension alternatives for GLX 1.3 features when GLX 1.3 is not available but equivalent extensions are.

diff --git a/gfx/thebes/GLContextProviderGLX.cpp b/gfx/thebes/GLContextProviderGLX.cpp
--- a/gfx/thebes/GLContextProviderGLX.cpp
+++ b/gfx/thebes/GLContextProviderGLX.cpp
@@ -81,48 +81,57 @@ GLXLibrary::EnsureInitialized()
         mOGLLibrary = PR_LoadLibrary("libGL.so.1");
         if (!mOGLLibrary) {
 	    NS_WARNING("Couldn't load OpenGL shared library.");
 	    return PR_FALSE;
         }
     }
 
     LibrarySymbolLoader::SymLoadStruct symbols[] = {
+        /* functions that were in GLX 1.0 */
         { (PRFuncPtr*) &xDestroyContext, { "glXDestroyContext", NULL } },
         { (PRFuncPtr*) &xMakeCurrent, { "glXMakeCurrent", NULL } },
-        { (PRFuncPtr*) &xGetProcAddress, { "glXGetProcAddress", NULL } },
-        { (PRFuncPtr*) &xChooseFBConfig, { "glXChooseFBConfig", NULL } },
-        { (PRFuncPtr*) &xGetFBConfigs, { "glXGetFBConfigs", NULL } },
-        { (PRFuncPtr*) &xCreateNewContext, { "glXCreateNewContext", NULL } },
-        { (PRFuncPtr*) &xGetVisualFromFBConfig, { "glXGetVisualFromFBConfig", NULL } },
-        { (PRFuncPtr*) &xGetFBConfigAttrib, { "glXGetFBConfigAttrib", NULL } },
         { (PRFuncPtr*) &xSwapBuffers, { "glXSwapBuffers", NULL } },
+        { (PRFuncPtr*) &xGetCurrentContext, { "glXGetCurrentContext", NULL } },
+        /* functions introduced in GLX 1.1 */
         { (PRFuncPtr*) &xQueryExtensionsString, { "glXQueryExtensionsString", NULL } },
         { (PRFuncPtr*) &xQueryServerString, { "glXQueryServerString", NULL } },
+        { (PRFuncPtr*) &xGetClientString, { "glXGetClientString", NULL } },
+        { NULL, { NULL } }
+    };
+
+    LibrarySymbolLoader::SymLoadStruct symbols13[] = {
+        /* functions introduced in GLX 1.3 */
+        { (PRFuncPtr*) &xChooseFBConfig, { "glXChooseFBConfig", NULL } },
+        { (PRFuncPtr*) &xGetFBConfigAttrib, { "glXGetFBConfigAttrib", NULL } },
+        { (PRFuncPtr*) &xGetFBConfigs, { "glXGetFBConfigs", NULL } },
+        { (PRFuncPtr*) &xGetVisualFromFBConfig, { "glXGetVisualFromFBConfig", NULL } },
         { (PRFuncPtr*) &xCreatePixmap, { "glXCreatePixmap", NULL } },
         { (PRFuncPtr*) &xDestroyPixmap, { "glXDestroyPixmap", NULL } },
-        { (PRFuncPtr*) &xGetClientString, { "glXGetClientString", NULL } },
-        { (PRFuncPtr*) &xGetCurrentContext, { "glXGetCurrentContext", NULL } },
+        { (PRFuncPtr*) &xCreateNewContext, { "glXCreateNewContext", NULL } },
+        { NULL, { NULL } }
+    };
+
+    LibrarySymbolLoader::SymLoadStruct symbols14[] = {
+        /* functions introduced in GLX 1.4 */
+        { (PRFuncPtr*) &xGetProcAddress, { "glXGetProcAddress", NULL } },
         { NULL, { NULL } }
     };
 
     if (!LibrarySymbolLoader::LoadSymbols(mOGLLibrary, &symbols[0])) {
         NS_WARNING("Couldn't find required entry point in OpenGL shared library");
         return PR_FALSE;
     }
 
-    const char *vendor = xQueryServerString(DefaultXDisplay(),
-                                            DefaultScreen(DefaultXDisplay()),
-                                            GLX_VENDOR);
-    const char *serverVersionStr = xQueryServerString(DefaultXDisplay(),
-                                                      DefaultScreen(DefaultXDisplay()),
-                                                      GLX_VERSION);
-    const char *clientVersionStr = xGetClientString(DefaultXDisplay(),
-                                                    GLX_VERSION);
-
+    Display *display = DefaultXDisplay();
+    int screen = DefaultScreen(display);
+    const char *vendor = xQueryServerString(display, screen, GLX_VENDOR);
+    const char *serverVersionStr = xQueryServerString(display, screen, GLX_VERSION);
+    const char *clientVersionStr = xGetClientString(display, GLX_VERSION);
+    const char *extensionsStr = xQueryExtensionsString(display, screen);
 
     int serverVersion = 0, clientVersion = 0;
     // FIXME: What about "2" or "1.10"?
     if (serverVersionStr &&
         strlen(serverVersionStr) >= 3 &&
         serverVersionStr[1] == '.')
     {
         serverVersion = (serverVersionStr[0] - '0') << 8 | (serverVersionStr[2] - '0');
@@ -133,19 +142,44 @@ GLXLibrary::EnsureInitialized()
         strlen(clientVersionStr) >= 3 &&
         clientVersionStr[1] == '.')
     {
         clientVersion = (clientVersionStr[0] - '0') << 8 | (clientVersionStr[2] - '0');
     }
 
     int glxVersion = PR_MIN(clientVersion, serverVersion);
 
-    if (glxVersion < 0x0103)
+    if (glxVersion < 0x0101)
+        // Not possible to query for extensions.
         return PR_FALSE;
 
+    if (glxVersion < 0x0103) {
+        // Even if we don't have 1.3, we might have equivalent extensions
+        // (as on the Intel X server).
+        // FIXME: WRITE ME
+        return PR_FALSE;
+    } else {
+        if (!LibrarySymbolLoader::LoadSymbols(mOGLLibrary, &symbols13[0])) {
+            NS_WARNING("Couldn't find required entry point in OpenGL shared library");
+            return PR_FALSE;
+        }
+    }
+
+    if (glxVersion < 0x0104) {
+        // Even if we don't have 1.4, we might have equivalent extensions
+        // (as on the Intel X server).
+        // FIXME: WRITE ME
+        return PR_FALSE;
+    } else {
+        if (!LibrarySymbolLoader::LoadSymbols(mOGLLibrary, &symbols14[0])) {
+            NS_WARNING("Couldn't find required entry point in OpenGL shared library");
+            return PR_FALSE;
+        }
+    }
+
     gIsATI = vendor && DoesVendorStringMatch(vendor, "ATI");
     gIsChromium = (vendor && DoesVendorStringMatch(vendor, "Chromium")) ||
         (serverVersion && DoesVendorStringMatch(serverVersionStr, "Chromium"));
 
     mInitialized = PR_TRUE;
     return PR_TRUE;
 }
 

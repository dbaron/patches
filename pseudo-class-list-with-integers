Make nsPseudoClassList capable of storing integers or integer pairs.  b=75375

diff --git a/layout/style/nsCSSParser.cpp b/layout/style/nsCSSParser.cpp
--- a/layout/style/nsCSSParser.cpp
+++ b/layout/style/nsCSSParser.cpp
@@ -2564,9 +2564,7 @@ CSSParserImpl::ParsePseudoSelector(PRInt
        isTree ||
 #endif
        nsCSSPseudoClasses::notPseudo == pseudo ||
-       nsCSSPseudoClasses::lang == pseudo ||
-       nsCSSPseudoClasses::mozEmptyExceptChildrenWithLocalname == pseudo ||
-       nsCSSPseudoClasses::mozSystemMetric == pseudo)) {
+       nsCSSPseudoClasses::HasStringArg(pseudo))) {
     // There are no other function pseudos
     REPORT_UNEXPECTED_TOKEN(PEPseudoSelNonFunc);
     UngetToken();
@@ -2597,9 +2595,7 @@ CSSParserImpl::ParsePseudoSelector(PRInt
   }    
   else if (!parsingPseudoElement && isPseudoClass) {
     aDataMask |= SEL_MASK_PCLASS;
-    if (nsCSSPseudoClasses::lang == pseudo ||
-        nsCSSPseudoClasses::mozEmptyExceptChildrenWithLocalname == pseudo ||
-        nsCSSPseudoClasses::mozSystemMetric == pseudo) {
+    if (nsCSSPseudoClasses::HasStringArg(pseudo))
       nsSelectorParsingStatus parsingStatus =
         ParsePseudoClassWithIdentArg(aSelector, pseudo, aErrorCode);
       if (eSelectorParsingStatus_Continue != parsingStatus) {
diff --git a/layout/style/nsCSSPseudoClasses.cpp b/layout/style/nsCSSPseudoClasses.cpp
--- a/layout/style/nsCSSPseudoClasses.cpp
+++ b/layout/style/nsCSSPseudoClasses.cpp
@@ -68,3 +68,23 @@ PRBool nsCSSPseudoClasses::IsPseudoClass
                                    NS_ARRAY_LENGTH(CSSPseudoClasses_info));
 }
 
+PRBool
+nsCSSPseudoClasses::HasStringArg(nsIAtom* aAtom)
+{
+  return aAtom == nsCSSPseudoClasses::lang ||
+         aAtom == nsCSSPseudoClasses::mozEmptyExceptChildrenWithLocalname ||
+         aAtom == nsCSSPseudoClasses::mozSystemMetric;
+}
+
+PRBool
+nsCSSPseudoClasses::HasIntegerArg(nsIAtom* aAtom)
+{
+  return PR_FALSE;
+}
+
+PRBool
+nsCSSPseudoClasses::HasIntPairArg(nsIAtom* aAtom)
+{
+  return PR_FALSE;
+}
+
diff --git a/layout/style/nsCSSPseudoClasses.h b/layout/style/nsCSSPseudoClasses.h
--- a/layout/style/nsCSSPseudoClasses.h
+++ b/layout/style/nsCSSPseudoClasses.h
@@ -53,6 +53,9 @@ public:
   static void AddRefAtoms();
 
   static PRBool IsPseudoClass(nsIAtom *aAtom);
+  static PRBool HasStringArg(nsIAtom* aAtom);
+  static PRBool HasIntegerArg(nsIAtom* aAtom);
+  static PRBool HasIntPairArg(nsIAtom* aAtom);
 
 #define CSS_PSEUDO_CLASS(_name, _value) static nsICSSPseudoClass* _name;
 #include "nsCSSPseudoClassList.h"
diff --git a/layout/style/nsCSSStyleRule.cpp b/layout/style/nsCSSStyleRule.cpp
--- a/layout/style/nsCSSStyleRule.cpp
+++ b/layout/style/nsCSSStyleRule.cpp
@@ -73,6 +73,7 @@
 #include "nsCSSPseudoElements.h"
 #include "nsIPrincipal.h"
 #include "nsComponentManagerUtils.h"
+#include "nsCSSPseudoClasses.h"
 
 #include "nsContentUtils.h"
 #include "nsContentErrors.h"
@@ -157,20 +158,66 @@ nsAtomList::~nsAtomList(void)
   NS_IF_DEEP_DELETE(nsAtomList, mNext);
 }
 
+nsPseudoClassList::nsPseudoClassList(nsIAtom* aAtom)
+  : mAtom(aAtom),
+    mNext(nsnull)
+{
+  // We can't assert that it doesn't have a string arg
+  NS_ASSERTION(!nsCSSPseudoClasses::HasStringArg(aAtom) &&
+               !nsCSSPseudoClasses::HasIntegerArg(aAtom) &&
+               !nsCSSPseudoClasses::HasIntPairArg(aAtom),
+               "unexpected pseudo-class");
+  MOZ_COUNT_CTOR(nsPseudoClassList);
+  u.mMemory = nsnull;
+}
+
 nsPseudoClassList::nsPseudoClassList(nsIAtom* aAtom, const PRUnichar* aString)
   : mAtom(aAtom),
-    mString(nsnull),
     mNext(nsnull)
 {
+  NS_ASSERTION(nsCSSPseudoClasses::HasStringArg(aAtom), "unexpected pseudo-class");
+  NS_ASSERTION(aString, "string expected");
   MOZ_COUNT_CTOR(nsPseudoClassList);
-  if (aString)
-    mString = NS_strdup(aString);
+  u.mString = NS_strdup(aString);
+}
+
+nsPseudoClassList::nsPseudoClassList(nsIAtom* aAtom, const PRInt32 aInteger)
+  : mAtom(aAtom),
+    mNext(nsnull)
+{
+  NS_ASSERTION(nsCSSPseudoClasses::HasIntegerArg(aAtom), "unexpected pseudo-class");
+  MOZ_COUNT_CTOR(nsPseudoClassList);
+  u.mNumbers =
+    static_cast<PRInt32*>(nsMemory::Clone(&aInteger, sizeof(PRInt32)));
+}
+
+nsPseudoClassList::nsPseudoClassList(nsIAtom* aAtom, const PRInt32* aIntPair)
+  : mAtom(aAtom),
+    mNext(nsnull)
+{
+  NS_ASSERTION(nsCSSPseudoClasses::HasIntPairArg(aAtom), "unexpected pseudo-class");
+  NS_ASSERTION(aIntPair, "integer pair expected");
+  MOZ_COUNT_CTOR(nsPseudoClassList);
+  u.mNumbers =
+    static_cast<PRInt32*>(nsMemory::Clone(aIntPair, sizeof(PRInt32) * 2));
 }
 
 nsPseudoClassList*
 nsPseudoClassList::Clone(PRBool aDeep) const
 {
-  nsPseudoClassList *result = new nsPseudoClassList(mAtom, mString);
+  nsPseudoClassList *result = new nsPseudoClassList(mAtom);
+  if (u.mMemory) {
+    if (nsCSSPseudoClasses::HasStringArg(mAtom)) {
+      result->u.mString = NS_strdup(u.mString);
+    } else if (nsCSSPseudoClasses::HasIntegerArg(mAtom)) {
+      result->u.mNumbers = static_cast<PRInt32*>(
+        nsMemory::Clone(u.mNumbers, sizeof(PRInt32)));
+    } else {
+      NS_ASSERTION(nsCSSPseudoClasses::HasIntPairArg(mAtom), "unexpected pseudo-class");
+      result->u.mNumbers = static_cast<PRInt32*>(
+        nsMemory::Clone(u.mNumbers, sizeof(PRInt32) * 2));
+    }
+  }
 
   if (aDeep)
     NS_IF_DEEP_CLONE(nsPseudoClassList, mNext, (PR_FALSE));
@@ -181,8 +228,8 @@ nsPseudoClassList::~nsPseudoClassList(vo
 nsPseudoClassList::~nsPseudoClassList(void)
 {
   MOZ_COUNT_DTOR(nsPseudoClassList);
-  if (mString)
-    NS_Free(mString);
+  if (u.mMemory)
+    NS_Free(u.mMemory);
   NS_IF_DEEP_DELETE(nsPseudoClassList, mNext);
 }
 
@@ -346,16 +393,36 @@ void nsCSSSelector::AddClass(const nsStr
   }
 }
 
+void nsCSSSelector::AddPseudoClass(nsIAtom* aPseudoClass)
+{
+  AddPseudoClassInternal(new nsPseudoClassList(aPseudoClass));
+}
+
 void nsCSSSelector::AddPseudoClass(nsIAtom* aPseudoClass,
                                    const PRUnichar* aString)
 {
-  if (nsnull != aPseudoClass) {
-    nsPseudoClassList** list = &mPseudoClassList;
-    while (nsnull != *list) {
-      list = &((*list)->mNext);
-    }
-    *list = new nsPseudoClassList(aPseudoClass, aString);
+  AddPseudoClassInternal(new nsPseudoClassList(aPseudoClass, aString));
+}
+
+void nsCSSSelector::AddPseudoClass(nsIAtom* aPseudoClass,
+                                   const PRInt32 aInteger)
+{
+  AddPseudoClassInternal(new nsPseudoClassList(aPseudoClass, aInteger));
+}
+
+void nsCSSSelector::AddPseudoClass(nsIAtom* aPseudoClass,
+                                   const PRInt32* aIntPair)
+{
+  AddPseudoClassInternal(new nsPseudoClassList(aPseudoClass, aIntPair));
+}
+
+void nsCSSSelector::AddPseudoClassInternal(nsPseudoClassList *aPseudoClass)
+{
+  nsPseudoClassList** list = &mPseudoClassList;
+  while (nsnull != *list) {
+    list = &((*list)->mNext);
   }
+  *list = aPseudoClass;
 }
 
 void nsCSSSelector::AddAttribute(PRInt32 aNameSpace, const nsString& aAttr)
@@ -627,9 +694,23 @@ void nsCSSSelector::ToStringInternal(nsA
     while (list != nsnull) {
       list->mAtom->ToString(temp);
       aString.Append(temp);
-      if (nsnull != list->mString) {
+      if (list->u.mMemory) {
         aString.Append(PRUnichar('('));
-        aString.Append(list->mString);
+        if (nsCSSPseudoClasses::HasStringArg(mAtom)) {
+          aString.Append(list->u.mString);
+        } else if (nsCSSPseudoClasses::HasIntegerArg(mAtom)) {
+          nsString temp;
+          temp.AppendInt(result->u.mNumbers[0]);
+          aString.Append(temp);
+        } else {
+          NS_ASSERTION(nsCSSPseudoClasses::HasIntPairArg(mAtom),
+                       "unexpected pseudo-class");
+          nsString temp;
+          temp.AppendInt(result->u.mNumbers[0]);
+          temp.Append(PRUnichar(','));
+          temp.AppendInt(result->u.mNumbers[1]);
+          aString.Append(temp);
+        }
         aString.Append(PRUnichar(')'));
       }
       list = list->mNext;
diff --git a/layout/style/nsICSSStyleRule.h b/layout/style/nsICSSStyleRule.h
--- a/layout/style/nsICSSStyleRule.h
+++ b/layout/style/nsICSSStyleRule.h
@@ -77,14 +77,22 @@ private:
 
 struct nsPseudoClassList {
 public:
-  nsPseudoClassList(nsIAtom* aAtom, const PRUnichar *aString = nsnull);
+  nsPseudoClassList(nsIAtom* aAtom);
+  nsPseudoClassList(nsIAtom* aAtom, const PRUnichar *aString);
+  nsPseudoClassList(nsIAtom* aAtom, const PRUint32 aInteger);
+  nsPseudoClassList(nsIAtom* aAtom, const PRUint32 *aIntPair);
   ~nsPseudoClassList(void);
 
   /** Do a deep clone.  Should be used only on the first in the linked list. */
   nsPseudoClassList* Clone() const { return Clone(PR_TRUE); }
 
   nsCOMPtr<nsIAtom> mAtom;
-  PRUnichar*        mString;
+  union {
+    void*           mMemory; // all pointer types use NS_Alloc/NS_Free
+    // Which of the following is used depend on mAtom.
+    PRUnichar*      mString;
+    PRInt32*        mNumbers;
+  } u;
   nsPseudoClassList* mNext;
 private: 
   nsPseudoClassList* Clone(PRBool aDeep) const;
@@ -141,7 +149,10 @@ public:
   void SetTag(const nsString& aTag);
   void AddID(const nsString& aID);
   void AddClass(const nsString& aClass);
-  void AddPseudoClass(nsIAtom* aPseudoClass, const PRUnichar* aString = nsnull);
+  void AddPseudoClass(nsIAtom* aPseudoClass);
+  void AddPseudoClass(nsIAtom* aPseudoClass, const PRUnichar* aString);
+  void AddPseudoClass(nsIAtom* aPseudoClass, const PRInt32 aInteger);
+  void AddPseudoClass(nsIAtom* aPseudoClass, const PRInt32* aIntPair);
   void AddAttribute(PRInt32 aNameSpace, const nsString& aAttr);
   void AddAttribute(PRInt32 aNameSpace, const nsString& aAttr, PRUint8 aFunc, 
                     const nsString& aValue, PRBool aCaseSensitive);
@@ -153,6 +164,7 @@ public:
                 PRBool aAppend = PR_FALSE) const;
 
 private:
+  void AddPseudoClassInternal(nsPseudoClassList *aPseudoClass);
   nsCSSSelector* Clone(PRBool aDeepNext, PRBool aDeepNegations) const;
 
   void AppendNegationToString(nsAString& aString);


# HG changeset patch
# User Andrea Marchesini <amarchesini@mozilla.com>
# Date 1412956834 -3600
# Node ID 37dae39533a6806bc5fb44d303013eab0c8b3238
# Parent  0126b86ee7ecc4425b49eeb6d8bae9e32ad45332
Bug 1081008 - nsBaseFilePicker should use the innerWindow for the creation of File objects, r=bz

diff --git a/widget/xpwidgets/nsBaseFilePicker.cpp b/widget/xpwidgets/nsBaseFilePicker.cpp
--- a/widget/xpwidgets/nsBaseFilePicker.cpp
+++ b/widget/xpwidgets/nsBaseFilePicker.cpp
@@ -135,16 +135,20 @@ NS_IMETHODIMP nsBaseFilePicker::Init(nsI
                                      int16_t aMode)
 {
   NS_PRECONDITION(aParent, "Null parent passed to filepicker, no file "
                   "picker for you!");
   nsCOMPtr<nsIWidget> widget = WidgetUtils::DOMWindowToWidget(aParent);
   NS_ENSURE_TRUE(widget, NS_ERROR_FAILURE);
 
   mParent = do_QueryInterface(aParent);
+  if (!mParent->IsInnerWindow()) {
+    mParent = mParent->GetCurrentInnerWindow();
+  }
+
   mMode = aMode;
   InitNative(widget, aTitle);
 
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsBaseFilePicker::Open(nsIFilePickerShownCallback *aCallback)
diff --git a/widget/xpwidgets/nsBaseFilePicker.h b/widget/xpwidgets/nsBaseFilePicker.h
--- a/widget/xpwidgets/nsBaseFilePicker.h
+++ b/widget/xpwidgets/nsBaseFilePicker.h
@@ -41,13 +41,15 @@ public:
   NS_IMETHOD GetDomfiles(nsISimpleEnumerator** aDomfiles);
 
 protected:
 
   virtual void InitNative(nsIWidget *aParent, const nsAString& aTitle) = 0;
 
   bool mAddToRecentDocs;
   nsCOMPtr<nsIFile> mDisplayDirectory;
+
+  // This is an innerWindow.
   nsCOMPtr<nsPIDOMWindow> mParent;
   int16_t mMode;
 };
 
 #endif // nsBaseFilePicker_h__
diff --git a/widget/xpwidgets/nsFilePickerProxy.cpp b/widget/xpwidgets/nsFilePickerProxy.cpp
--- a/widget/xpwidgets/nsFilePickerProxy.cpp
+++ b/widget/xpwidgets/nsFilePickerProxy.cpp
@@ -29,16 +29,20 @@ nsFilePickerProxy::Init(nsIDOMWindow* aP
                         int16_t aMode)
 {
   TabChild* tabChild = TabChild::GetFrom(aParent);
   if (!tabChild) {
     return NS_ERROR_FAILURE;
   }
 
   mParent = do_QueryInterface(aParent);
+  if (!mParent->IsInnerWindow()) {
+    mParent = mParent->GetCurrentInnerWindow();
+  }
+
   mMode = aMode;
 
   NS_ADDREF_THIS();
   tabChild->SendPFilePickerConstructor(this, nsString(aTitle), aMode);
   return NS_OK;
 }
 
 void
diff --git a/widget/xpwidgets/nsFilePickerProxy.h b/widget/xpwidgets/nsFilePickerProxy.h
--- a/widget/xpwidgets/nsFilePickerProxy.h
+++ b/widget/xpwidgets/nsFilePickerProxy.h
@@ -54,16 +54,17 @@ public:
     // PFilePickerChild
     virtual bool
     Recv__delete__(const MaybeInputFiles& aFiles, const int16_t& aResult);
 
 private:
     ~nsFilePickerProxy();
     void InitNative(nsIWidget*, const nsAString&);
 
+    // This is an innerWindow.
     nsCOMPtr<nsPIDOMWindow> mParent;
     nsCOMArray<nsIDOMFile> mDomfiles;
     nsCOMPtr<nsIFilePickerShownCallback> mCallback;
 
     int16_t   mSelectedType;
     nsString  mFile;
     nsString  mDefault;
     nsString  mDefaultExtension;

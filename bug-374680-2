Initialize and destroy text run cache in gfx rather than layout, so we can guarantee it happens before the rest of gfx shutdown.  b=374680

diff --git a/gfx/src/thebes/nsThebesGfxFactory.cpp b/gfx/src/thebes/nsThebesGfxFactory.cpp
--- a/gfx/src/thebes/nsThebesGfxFactory.cpp
+++ b/gfx/src/thebes/nsThebesGfxFactory.cpp
@@ -143,6 +143,16 @@ static const nsModuleComponentInfo compo
     gfxImageFrameConstructor },
 };
 
+PR_STATIC_CALLBACK(nsresult)
+nsThebesGfxModuleCtor(nsIModule *self)
+{
+    gfxPlatform *platform = gfxPlatform::GetPlatform();
+    if (!platform)
+        return NS_ERROR_FAILURE;
+
+    return NS_OK;
+}
+
 PR_STATIC_CALLBACK(void)
 nsThebesGfxModuleDtor(nsIModule *self)
 {
@@ -150,5 +160,7 @@ nsThebesGfxModuleDtor(nsIModule *self)
     gfxPlatform::Shutdown();
 }
 
-NS_IMPL_NSGETMODULE_WITH_DTOR(nsGfxModule, components, nsThebesGfxModuleDtor)
+NS_IMPL_NSGETMODULE_WITH_CTOR_DTOR(nsGfxModule, components,
+                                   nsThebesGfxModuleCtor,
+                                   nsThebesGfxModuleDtor)
 
diff --git a/gfx/thebes/public/gfxPlatform.h b/gfx/thebes/public/gfxPlatform.h
--- a/gfx/thebes/public/gfxPlatform.h
+++ b/gfx/thebes/public/gfxPlatform.h
@@ -123,7 +123,8 @@ public:
     void GetPrefFonts(const char *aLangGroup, nsString& array);
 
 protected:
-    gfxPlatform() { }
+    gfxPlatform() {}
+    nsresult Init();
     virtual ~gfxPlatform();
 
 };
diff --git a/gfx/thebes/src/gfxPlatform.cpp b/gfx/thebes/src/gfxPlatform.cpp
--- a/gfx/thebes/src/gfxPlatform.cpp
+++ b/gfx/thebes/src/gfxPlatform.cpp
@@ -51,6 +51,7 @@
 
 #include "gfxContext.h"
 #include "gfxImageSurface.h"
+#include "gfxTextRunCache.h"
 
 #include "nsIPref.h"
 #include "nsServiceManagerUtils.h"
@@ -79,6 +80,10 @@ gfxPlatform::GetPlatform()
 #elif defined(XP_OS2)
         gPlatform = new gfxOS2Platform;
 #endif
+        if (gPlatform && NS_FAILED(gPlatform->Init())) {
+            delete gPlatform;
+            gPlatform = nsnull;
+        }
     }
 
     return gPlatform;
@@ -91,16 +96,24 @@ gfxPlatform::Shutdown()
     gPlatform = nsnull;
 }
 
+nsresult
+gfxPlatform::Init()
+{
+    nsresult rv = gfxTextRunCache::Init();
+    NS_ENSURE_SUCCESS(rv, rv);
+
+    return NS_OK;
+}
+
 gfxPlatform::~gfxPlatform()
 {
-#if 0 // Comment this out for now, until we fix bug 374680.
+    gfxTextRunCache::Shutdown();
 
     // The cairo folks think we should only clean up in debug builds,
     // but we're generally in the habit of trying to shut down as
     // cleanly as possible even in production code, so call this
     // cairo_debug_* function unconditionally.
     cairo_debug_reset_static_data();
-#endif
 }
 
 PRBool
diff --git a/layout/build/nsLayoutStatics.cpp b/layout/build/nsLayoutStatics.cpp
--- a/layout/build/nsLayoutStatics.cpp
+++ b/layout/build/nsLayoutStatics.cpp
@@ -98,10 +98,6 @@ PRBool NS_SVGEnabled();
 #include "inDOMView.h"
 #endif
 
-#ifdef MOZ_CAIRO_GFX
-#include "gfxTextRunCache.h"
-#endif
-
 #ifndef MOZILLA_PLAINTEXT_EDITOR_ONLY
 #include "nsHTMLEditor.h"
 #include "nsTextServicesDocument.h"
@@ -111,9 +107,6 @@ PRBool NS_SVGEnabled();
 #include "nsTraceRefcnt.h"
 
 static nsrefcnt sLayoutStaticRefcnt;
-#ifdef MOZ_CAIRO_GFX
-static PRBool initedGfxTextRunCache;
-#endif
 
 nsresult
 nsLayoutStatics::Initialize()
@@ -215,15 +208,6 @@ nsLayoutStatics::Initialize()
     return rv;
   }
 
-#ifdef MOZ_CAIRO_GFX
-  rv = gfxTextRunCache::Init();
-  initedGfxTextRunCache = PR_TRUE;  
-  if (NS_FAILED(rv)) {
-    NS_ERROR("Could not initialize gfxTextRunCache");
-    return rv;
-  }
-#endif
-  
   return NS_OK;
 }
 
@@ -293,12 +277,6 @@ nsLayoutStatics::Shutdown()
   nsHTMLEditor::Shutdown();
   nsTextServicesDocument::Shutdown();
 #endif
-
-#ifdef MOZ_CAIRO_GFX
-  if (initedGfxTextRunCache) {
-    gfxTextRunCache::Shutdown();
-  }  
-#endif
 }
 
 void

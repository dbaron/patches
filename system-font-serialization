Make serialization handle system fonts and the font shorthand better.  (Bug 475214)

diff --git a/layout/style/nsCSSDeclaration.cpp b/layout/style/nsCSSDeclaration.cpp
--- a/layout/style/nsCSSDeclaration.cpp
+++ b/layout/style/nsCSSDeclaration.cpp
@@ -896,38 +896,55 @@ nsCSSDeclaration::GetValue(nsCSSProperty
       if (AppendValueToString(eCSSProperty_cue_before, aValue)) {
         aValue.Append(PRUnichar(' '));
         if (!AppendValueToString(eCSSProperty_cue_after, aValue))
           aValue.Truncate();
       }
       break;
     }
     case eCSSProperty_font: {
-      nsCSSValue style, variant, weight, size, lh, family, systemFont;
-      GetValueOrImportantValue(eCSSProperty__x_system_font, systemFont);
-      GetValueOrImportantValue(eCSSProperty_font_style, style);
-      GetValueOrImportantValue(eCSSProperty_font_variant, variant);
-      GetValueOrImportantValue(eCSSProperty_font_weight, weight);
-      GetValueOrImportantValue(eCSSProperty_font_size, size);
-      GetValueOrImportantValue(eCSSProperty_line_height, lh);
-      GetValueOrImportantValue(eCSSProperty_font_family, family);
+      const nsCSSValue &systemFont = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty__x_system_font));
+      const nsCSSValue &style = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_font_style));
+      const nsCSSValue &variant = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_font_variant));
+      const nsCSSValue &weight = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_font_weight));
+      const nsCSSValue &size = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_font_size));
+      const nsCSSValue &lh = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_line_height));
+      const nsCSSValue &family = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_font_family));
+      const nsCSSValue &stretch = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_font_stretch));
+      const nsCSSValue &sizeAdjust = *static_cast<const nsCSSValue*>(
+        data->StorageFor(eCSSProperty_font_size_adjust));
 
       if (systemFont.GetUnit() != eCSSUnit_None &&
           systemFont.GetUnit() != eCSSUnit_Null) {
+        if (style.GetUnit() != eCSSUnit_System_Font ||
+            variant.GetUnit() != eCSSUnit_System_Font ||
+            weight.GetUnit() != eCSSUnit_System_Font ||
+            size.GetUnit() != eCSSUnit_System_Font ||
+            lh.GetUnit() != eCSSUnit_System_Font ||
+            family.GetUnit() != eCSSUnit_System_Font ||
+            stretch.GetUnit() != eCSSUnit_System_Font ||
+            sizeAdjust.GetUnit() != eCSSUnit_System_Font) {
+          // This can't be represented as a shorthand.
+          return NS_OK;
+        }
         AppendCSSValueToString(eCSSProperty__x_system_font, systemFont, aValue);
       } else {
         // The font-stretch and font-size-adjust
         // properties are reset by this shorthand property to their
         // initial values, but can't be represented in its syntax.
-        const nsCSSValue *stretchValue = static_cast<const nsCSSValue*>(
-          data->StorageFor(eCSSProperty_font_stretch));
-        const nsCSSValue *sizeAdjustValue = static_cast<const nsCSSValue*>(
-          data->StorageFor(eCSSProperty_font_size_adjust));
-        if (*stretchValue != nsCSSValue(eCSSUnit_Normal) ||
-            *sizeAdjustValue != nsCSSValue(eCSSUnit_None)) {
+        if (stretch != nsCSSValue(eCSSUnit_Normal) ||
+            sizeAdjust != nsCSSValue(eCSSUnit_None)) {
           return NS_OK;
         }
 
         if (style.GetUnit() != eCSSUnit_Normal) {
           AppendCSSValueToString(eCSSProperty_font_style, style, aValue);
           aValue.Append(PRUnichar(' '));
         }
         if (variant.GetUnit() != eCSSUnit_Normal) {
@@ -1049,16 +1066,22 @@ nsCSSDeclaration::AppendPropertyAndValue
   PRBool  isImportant = GetValueIsImportant(aProperty);
   AppendImportanceToString(isImportant, aResult);
   aResult.AppendLiteral("; ");
 }
 
 nsresult
 nsCSSDeclaration::ToString(nsAString& aString) const
 {
+  nsCSSValue systemFont;
+  GetValueOrImportantValue(eCSSProperty__x_system_font, systemFont);
+  const PRBool haveSystemFont = systemFont.GetUnit() != eCSSUnit_None &&
+                                systemFont.GetUnit() != eCSSUnit_Null;
+  PRBool didSystemFont = PR_FALSE;
+
   PRInt32 count = mOrder.Length();
   PRInt32 index;
   nsAutoTArray<nsCSSProperty, 16> shorthandsUsed;
   for (index = 0; index < count; index++) {
     nsCSSProperty property = OrderValueAt(index);
     PRBool doneProperty = PR_FALSE;
 
     // If we already used this property in a shorthand, skip it.
@@ -1089,16 +1112,39 @@ nsCSSDeclaration::ToString(nsAString& aS
       // value; otherwise it's not possible to use this shorthand.
       GetValue(shorthand, value);
       if (!value.IsEmpty()) {
         AppendPropertyAndValueToString(shorthand, value, aString);
         shorthandsUsed.AppendElement(shorthand);
         doneProperty = PR_TRUE;
         break;
       }
+
+      NS_ASSERTION(shorthand != eCSSProperty_font ||
+                   *(shorthands + 1) == eCSSProperty_UNKNOWN,
+                   "font should always be the only containing shorthand");
+      if (shorthand == eCSSProperty_font && haveSystemFont) {
+        if (!didSystemFont) {
+          // Output the shorthand font declaration that we will
+          // partially override later.  But don't add it to
+          // |shorthandsUsed|, since we will have to override it.
+          AppendCSSValueToString(eCSSProperty__x_system_font, systemFont,
+                                 value);
+          AppendPropertyAndValueToString(eCSSProperty_font, value, aString);
+          value.Truncate();
+          didSystemFont = PR_TRUE;
+        }
+
+        nsCSSValue val;
+        if (property == eCSSProperty__x_system_font ||
+            (GetValueOrImportantValue(property, val),
+             val.GetUnit() == eCSSUnit_System_Font)) {
+          doneProperty = PR_TRUE;
+        }
+      }
     }
     if (doneProperty)
       continue;
     
     NS_ASSERTION(value.IsEmpty(), "value should be empty now");
     AppendPropertyAndValueToString(property, value, aString);
   }
   if (! aString.IsEmpty()) {
diff --git a/layout/style/test/Makefile.in b/layout/style/test/Makefile.in
--- a/layout/style/test/Makefile.in
+++ b/layout/style/test/Makefile.in
@@ -118,16 +118,17 @@ _TEST_FILES =	test_acid3_test46.html \
 		test_parse_rule.html \
 		test_parse_url.html \
 		test_property_database.html \
 		test_property_syntax_errors.html \
 		test_selectors.html \
 		test_selectors_on_anonymous_content.html \
 		test_shorthand_property_getters.html \
 		test_style_struct_copy_constructors.html \
+		test_system_font_serialization.html \
 		test_value_computation.html \
 		test_value_storage.html \
 		test_visited_pref.html \
 		css_properties.js \
 		property_database.js \
 		unstyled.xml \
 		unstyled.css \
 		unstyled-frame.xml \
diff --git a/layout/style/test/test_system_font_serialization.html b/layout/style/test/test_system_font_serialization.html
new file mode 100644
--- /dev/null
+++ b/layout/style/test/test_system_font_serialization.html
@@ -0,0 +1,38 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=475214
+-->
+<head>
+  <title>Test for Bug 475214</title>
+  <script type="application/javascript" src="/MochiKit/MochiKit.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=475214">Mozilla Bug 475214</a>
+<p id="display"></p>
+<div id="content" style="display: none">
+  
+</div>
+<pre id="test">
+<script type="application/javascript">
+
+/** Test for Bug 475214 **/
+
+var e = document.getElementById("content");
+var s = e.style;
+
+e.style.font = "menu";
+is(e.style.cssText, "font: menu;", "serialize system font alone");
+
+e.style.fontFamily = "inherit";
+is(e.style.cssText, "font: menu; font-family: inherit", "serialize system font and font-family");
+
+e.style.font = "message-box";
+is(e.style.cssText, "font: message-box;", "serialize system font alone");
+
+</script>
+</pre>
+</body>
+</html>

From: L. David Baron <dbaron@dbaron.org>

Bug 1266993 - Make nsAlertsIconListener keep itself alive while it's expecting notifications from the icon load.

MozReview-Commit-ID: HgSAtbcvogO

diff --git a/toolkit/system/gnome/nsAlertsIconListener.cpp b/toolkit/system/gnome/nsAlertsIconListener.cpp
--- a/toolkit/system/gnome/nsAlertsIconListener.cpp
+++ b/toolkit/system/gnome/nsAlertsIconListener.cpp
@@ -138,16 +138,19 @@ nsAlertsIconListener::OnLoadComplete(img
   NS_ENSURE_SUCCESS(rv, rv);
   if ((imgStatus & imgIRequest::STATUS_ERROR) && !mLoadedFrame) {
     // We have an error getting the image. Display the notification with no icon.
     ShowAlert(nullptr);
 
     // Cancel any pending request
     mIconRequest->Cancel(NS_BINDING_ABORTED);
     mIconRequest = nullptr;
+    NS_RELEASE_THIS();
+
+    return NS_OK;
   }
 
   nsCOMPtr<imgIContainer> image;
   rv = aRequest->GetImage(getter_AddRefs(image));
   if (NS_WARN_IF(NS_FAILED(rv) || !image)) {
     return rv;
   }
 
@@ -176,16 +179,17 @@ nsAlertsIconListener::OnFrameComplete(im
     g_object_unref(imagePixbuf);
   }
 
   mLoadedFrame = true;
 
   // Cancel any pending request (multipart image loading/decoding for instance)
   mIconRequest->Cancel(NS_BINDING_ABORTED);
   mIconRequest = nullptr;
+  NS_RELEASE_THIS();
 
   return NS_OK;
 }
 
 nsresult
 nsAlertsIconListener::ShowAlert(GdkPixbuf* aPixbuf)
 {
   if (!mBackend->IsActiveListener(mAlertName, this))
@@ -236,16 +240,17 @@ nsAlertsIconListener::ShowAlert(GdkPixbu
 
 nsresult
 nsAlertsIconListener::StartRequest(const nsAString & aImageUrl, bool aInPrivateBrowsing)
 {
   if (mIconRequest) {
     // Another icon request is already in flight.  Kill it.
     mIconRequest->Cancel(NS_BINDING_ABORTED);
     mIconRequest = nullptr;
+    NS_RELEASE_THIS();
   }
 
   nsCOMPtr<nsIURI> imageUri;
   NS_NewURI(getter_AddRefs(imageUri), aImageUrl);
   if (!imageUri)
     return ShowAlert(nullptr);
 
   imgLoader* il = aInPrivateBrowsing ? imgLoader::PrivateBrowsingLoader()
@@ -258,16 +263,19 @@ nsAlertsIconListener::StartRequest(const
                                    this, nullptr,
                                    aInPrivateBrowsing ? nsIRequest::LOAD_ANONYMOUS :
                                                         nsIRequest::LOAD_NORMAL,
                                    nullptr, 0 /* use default */,
                                    getter_AddRefs(mIconRequest));
   if (NS_FAILED(rv))
     return rv;
 
+  // Stay alive to get our notifications from mIconRequest.
+  NS_ADDREF_THIS();
+
   return NS_OK;
 }
 
 void
 nsAlertsIconListener::SendCallback()
 {
   if (mAlertListener)
     mAlertListener->Observe(nullptr, "alertclickcallback", mAlertCookie.get());
@@ -298,16 +306,17 @@ nsAlertsIconListener::Observe(nsISupport
 }
 
 nsresult
 nsAlertsIconListener::Close()
 {
   if (mIconRequest) {
     mIconRequest->Cancel(NS_BINDING_ABORTED);
     mIconRequest = nullptr;
+    NS_RELEASE_THIS();
   }
 
   if (!mNotification) {
     NotifyFinished();
     return NS_OK;
   }
 
   GError* error = nullptr;

From: L. David Baron <dbaron@dbaron.org>

Cache important rule the first time the rule is matched so we don't rely on the declaration for it past that point.  (Bug 522595)  r=bzbarsky

diff --git a/layout/style/nsCSSStyleRule.cpp b/layout/style/nsCSSStyleRule.cpp
--- a/layout/style/nsCSSStyleRule.cpp
+++ b/layout/style/nsCSSStyleRule.cpp
@@ -1404,33 +1404,26 @@ void CSSStyleRuleImpl::SetLineNumber(PRU
 
 nsCSSDeclaration* CSSStyleRuleImpl::GetDeclaration(void) const
 {
   return mDeclaration;
 }
 
 nsIStyleRule* CSSStyleRuleImpl::GetImportantRule(void)
 {
-  if (!mDeclaration->HasImportantData()) {
-    NS_ASSERTION(!mImportantRule, "immutable, so should be no important rule");
-    return nsnull;
-  }
-
-  if (!mImportantRule) {
-    mImportantRule = new CSSImportantRule(mDeclaration);
-    if (!mImportantRule)
-      return nsnull;
-    NS_ADDREF(mImportantRule);
-  }
   return mImportantRule;
 }
 
 /* virtual */ void
 CSSStyleRuleImpl::RuleMatched()
 {
+  if (mDeclaration->HasImportantData() && !mImportantRule) {
+    mImportantRule = new CSSImportantRule(mDeclaration);
+    NS_IF_ADDREF(mImportantRule);
+  }
 }
 
 NS_IMETHODIMP
 CSSStyleRuleImpl::GetStyleSheet(nsIStyleSheet*& aSheet) const
 {
 // XXX What about inner, etc.
   return nsCSSRule::GetStyleSheet(aSheet);
 }

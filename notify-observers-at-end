Move NOTIFY_OBSERVERS to the end of nsBindingManager::ContentRemoved (and avoid early returns so we get to it).  b=382376  Patch by Daniel Holbert <dholbert@mozilla.com>.  r=bzbarsky  sr=sicking

diff --git a/content/xbl/src/nsBindingManager.cpp b/content/xbl/src/nsBindingManager.cpp
--- a/content/xbl/src/nsBindingManager.cpp
+++ b/content/xbl/src/nsBindingManager.cpp
@@ -1324,35 +1324,36 @@ nsBindingManager::ContentRemoved(nsIDocu
                                  nsIContent* aChild,
                                  PRInt32 aIndexInContainer)
 {
+  if (aIndexInContainer != -1 &&
+      (mContentListTable.ops || mAnonymousNodesTable.ops)) {
+    // It's not anonymous
+    nsCOMPtr<nsIContent> point = GetNestedInsertionPoint(aContainer, aChild);
+
+    if (point) {
+      nsCOMPtr<nsIDOMNodeList> nodeList;
+      PRBool isAnonymousContentList;
+      GetXBLChildNodesInternal(point, getter_AddRefs(nodeList),
+                               &isAnonymousContentList);
+      
+      if (nodeList && isAnonymousContentList) {
+        // Find a non-pseudo-insertion point and remove ourselves.
+        nsAnonymousContentList* contentList = NS_STATIC_CAST(nsAnonymousContentList*, NS_STATIC_CAST(nsIDOMNodeList*, nodeList));
+        PRInt32 count = contentList->GetInsertionPointCount();
+        for (PRInt32 i =0; i < count; i++) {
+          nsXBLInsertionPoint* point = contentList->GetInsertionPointAt(i);
+          if (point->GetInsertionIndex() != -1) {
+            point->RemoveChild(aChild);
+          }
+        }
+      }
+    }  
+  }
+
   NS_BINDINGMANAGER_NOTIFY_OBSERVERS(ContentRemoved,
                                      (aDocument, aContainer, aChild,
                                       aIndexInContainer));  
 
-  if (aIndexInContainer == -1 ||
-      (!mContentListTable.ops && !mAnonymousNodesTable.ops))
-    // It's anonymous.
-    return;
-
-  nsCOMPtr<nsIContent> point = GetNestedInsertionPoint(aContainer, aChild);
-
-  if (point) {
-    nsCOMPtr<nsIDOMNodeList> nodeList;
-    PRBool isAnonymousContentList;
-    GetXBLChildNodesInternal(point, getter_AddRefs(nodeList),
-                             &isAnonymousContentList);
-
-    if (nodeList && isAnonymousContentList) {
-      // Find a non-pseudo-insertion point and remove ourselves.
-      nsAnonymousContentList* contentList = NS_STATIC_CAST(nsAnonymousContentList*, NS_STATIC_CAST(nsIDOMNodeList*, nodeList));
-      PRInt32 count = contentList->GetInsertionPointCount();
-      for (PRInt32 i =0; i < count; i++) {
-        nsXBLInsertionPoint* point = contentList->GetInsertionPointAt(i);
-        if (point->GetInsertionIndex() != -1) {
-          point->RemoveChild(aChild);
-        }
-      }
-    }
-  }
+
 }
 
 void

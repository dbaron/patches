From: L. David Baron <dbaron@dbaron.org>

Only serialize percentages in calc() when mHasPercent is true, since there's a semantic difference.

diff --git a/layout/style/nsComputedDOMStyle.cpp b/layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp
+++ b/layout/style/nsComputedDOMStyle.cpp
@@ -1478,21 +1478,23 @@ SetValueToCalc(nsStyleCoord::Calc *aCalc
   nsAutoString tmp, result;
 
   result.AppendLiteral("-moz-calc(");
 
   val->SetAppUnits(aCalc->mLength);
   val->GetCssText(tmp);
   result.Append(tmp);
 
-  result.AppendLiteral(" + ");
-
-  val->SetPercent(aCalc->mPercent);
-  val->GetCssText(tmp);
-  result.Append(tmp);
+  if (aCalc->mHasPercent) {
+    result.AppendLiteral(" + ");
+
+    val->SetPercent(aCalc->mPercent);
+    val->GetCssText(tmp);
+    result.Append(tmp);
+  }
 
   result.AppendLiteral(")");
 
   aValue->SetString(result); // not really SetString
 }
 
 static void
 AppendCSSGradientLength(const nsStyleCoord& aValue,
@@ -1781,27 +1783,29 @@ nsComputedDOMStyle::DoGetBackgroundPosit
     if (pos.mXPosition.mLength == 0) {
       valX->SetPercent(pos.mXPosition.mPercent);
     } else if (pos.mXPosition.mPercent == 0.0f) {
       valX->SetAppUnits(pos.mXPosition.mLength);
     } else {
       nsStyleCoord::Calc calc;
       calc.mPercent = pos.mXPosition.mPercent;
       calc.mLength  = pos.mXPosition.mLength;
+      calc.mHasPercent = PR_TRUE;
       SetValueToCalc(&calc, valX);
     }
 
     if (pos.mYPosition.mLength == 0) {
       valY->SetPercent(pos.mYPosition.mPercent);
     } else if (pos.mYPosition.mPercent == 0.0f) {
       valY->SetAppUnits(pos.mYPosition.mLength);
     } else {
       nsStyleCoord::Calc calc;
       calc.mPercent = pos.mYPosition.mPercent;
       calc.mLength  = pos.mYPosition.mLength;
+      calc.mHasPercent = PR_TRUE;
       SetValueToCalc(&calc, valY);
     }
   }
 
   NS_ADDREF(*aValue = valueList);
   return NS_OK;
 }
 
@@ -1876,16 +1880,17 @@ nsComputedDOMStyle::DoGetMozBackgroundSi
           } else if (size.mWidth.mPercent == 0.0f &&
                      // negative values must have come from calc()
                      size.mWidth.mLength > 0) {
             valX->SetAppUnits(size.mWidth.mLength);
           } else {
             nsStyleCoord::Calc calc;
             calc.mPercent = size.mWidth.mPercent;
             calc.mLength  = size.mWidth.mLength;
+            calc.mHasPercent = PR_TRUE;
             SetValueToCalc(&calc, valX);
           }
         }
 
         if (size.mHeightType == nsStyleBackground::Size::eAuto) {
           valY->SetIdent(eCSSKeyword_auto);
         } else {
           NS_ABORT_IF_FALSE(size.mHeightType ==
@@ -1898,16 +1903,17 @@ nsComputedDOMStyle::DoGetMozBackgroundSi
           } else if (size.mHeight.mPercent == 0.0f &&
                      // negative values must have come from calc()
                      size.mHeight.mLength > 0) {
             valY->SetAppUnits(size.mHeight.mLength);
           } else {
             nsStyleCoord::Calc calc;
             calc.mPercent = size.mHeight.mPercent;
             calc.mLength  = size.mHeight.mLength;
+            calc.mHasPercent = PR_TRUE;
             SetValueToCalc(&calc, valY);
           }
         }
         break;
       }
     }
   }
 

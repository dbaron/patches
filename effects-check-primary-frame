From: L. David Baron <dbaron@dbaron.org>

Bug 1245075 - Fix EffectSet::GetEffectSet(nsIFrame*) and EffectCompositor::GetAnimationElementAndPseudoForFrame to only return effects when the frame is the primary frame for its content.

Locally, the test fails without the patch (the test has opacity 0.25 and
the reference 0.5)), and passes with the patch (both test and reference
have opacity 0.5).

diff --git a/dom/animation/EffectCompositor.cpp b/dom/animation/EffectCompositor.cpp
--- a/dom/animation/EffectCompositor.cpp
+++ b/dom/animation/EffectCompositor.cpp
@@ -520,16 +520,21 @@ EffectCompositor::GetAnimationElementAnd
       pseudoType = nsCSSPseudoElements::ePseudo_after;
     } else {
       return result;
     }
     content = content->GetParent();
     if (!content) {
       return result;
     }
+  } else {
+    if (nsLayoutUtils::GetStyleFrame(content) != aFrame) {
+      // The effects associated with an element are for its primary frame.
+      return result;
+    }
   }
 
   if (!content->IsElement()) {
     return result;
   }
 
   result = Some(MakePair(content->AsElement(), pseudoType));
 
diff --git a/dom/animation/EffectSet.cpp b/dom/animation/EffectSet.cpp
--- a/dom/animation/EffectSet.cpp
+++ b/dom/animation/EffectSet.cpp
@@ -4,16 +4,17 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
 #include "EffectSet.h"
 #include "mozilla/dom/Element.h" // For Element
 #include "RestyleManager.h"
 #include "nsCycleCollectionNoteChild.h" // For CycleCollectionNoteChild
 #include "nsPresContext.h"
+#include "nsLayoutUtils.h"
 
 namespace mozilla {
 
 /* static */ void
 EffectSet::PropertyDtor(void* aObject, nsIAtom* aPropertyName,
                         void* aPropertyValue, void* aData)
 {
   EffectSet* effectSet = static_cast<EffectSet*>(aPropertyValue);
@@ -65,16 +66,20 @@ EffectSet::GetEffectSet(const nsIFrame* 
     } else {
       return nullptr;
     }
     content = content->GetParent();
     if (!content) {
       return nullptr;
     }
   } else {
+    if (nsLayoutUtils::GetStyleFrame(content) != aFrame) {
+      // The effects associated with an element are for its primary frame.
+      return nullptr;
+    }
     propName = nsGkAtoms::animationEffectsProperty;
   }
 
   if (!content->MayHaveAnimations()) {
     return nullptr;
   }
 
   return static_cast<EffectSet*>(content->GetProperty(propName));
diff --git a/layout/reftests/css-animations/animate-display-table-opacity-ref.html b/layout/reftests/css-animations/animate-display-table-opacity-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-animations/animate-display-table-opacity-ref.html
@@ -0,0 +1,10 @@
+<!DOCTYPE html>
+<title>Testcase for bug 1245075</title>
+<style>
+#test {
+  width: 100px; height: 100px;
+  background: blue;
+  opacity: 0.5;
+}
+</style>
+<div id="test"></div>
diff --git a/layout/reftests/css-animations/animate-display-table-opacity.html b/layout/reftests/css-animations/animate-display-table-opacity.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/css-animations/animate-display-table-opacity.html
@@ -0,0 +1,14 @@
+<!DOCTYPE html>
+<title>Testcase for bug 1245075</title>
+<style>
+@keyframes HoldOpacity {
+  from, to { opacity: 0.5 }
+}
+#test {
+  width: 100px; height: 100px;
+  background: blue;
+  display: table;
+  animation: HoldOpacity 5s linear;
+}
+</style>
+<div id="test"></div>
diff --git a/layout/reftests/css-animations/reftest.list b/layout/reftests/css-animations/reftest.list
--- a/layout/reftests/css-animations/reftest.list
+++ b/layout/reftests/css-animations/reftest.list
@@ -1,6 +1,7 @@
 == screen-animations.html screen-animations-ref.html
 != screen-animations.html screen-animations-notref.html
 fails == print-no-animations.html print-no-animations-ref.html # reftest harness doesn't actually make pres context non-dynamic for reftest-print tests
 fails != print-no-animations.html print-no-animations-notref.html # reftest harness doesn't actually make pres context non-dynamic for reftest-print tests
 == animate-opacity.html animate-opacity-ref.html
 == animate-preserves3d.html animate-preserves3d-ref.html
+== animate-display-table-opacity.html animate-display-table-opacity-ref.html

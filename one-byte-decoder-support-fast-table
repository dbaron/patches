From: L. David Baron <dbaron@dbaron.org>

Make nsOneByteDecoderSupport expect to be given the fast table rather than the mapping table.  (Won't compile without the next patch, which changes the callers.)  (Bug 530330)

diff --git a/intl/uconv/util/nsUCConstructors.cpp b/intl/uconv/util/nsUCConstructors.cpp
--- a/intl/uconv/util/nsUCConstructors.cpp
+++ b/intl/uconv/util/nsUCConstructors.cpp
@@ -135,18 +135,17 @@ CreateTableDecoder(uScanClassID aScanCla
                                 aMaxLengthFactor);
   if (!decoder)
     return NS_ERROR_OUT_OF_MEMORY;
 
   return StabilizedQueryInterface(decoder, aIID, aResult);
 }
 
 NS_METHOD
-CreateOneByteDecoder(uMappingTable * aMappingTable,
-                     
+CreateOneByteDecoder(const PRUnichar * aMappingTable,
                      nsISupports* aOuter,
                      REFNSIID aIID,
                      void** aResult)
 {
     if (aOuter) return NS_ERROR_NO_AGGREGATION;
     
     nsOneByteDecoderSupport* decoder =
         new nsOneByteDecoderSupport(aMappingTable);
diff --git a/intl/uconv/util/nsUCConstructors.h b/intl/uconv/util/nsUCConstructors.h
--- a/intl/uconv/util/nsUCConstructors.h
+++ b/intl/uconv/util/nsUCConstructors.h
@@ -63,15 +63,15 @@ CreateTableDecoder(uScanClassID aScanCla
                    uShiftInTable * aShiftInTable,
                    uMappingTable * aMappingTable,
                    uint32_t aMaxLengthFactor,
                    nsISupports* aOuter,
                    REFNSIID aIID,
                    void** aResult);
 
 NS_METHOD
-CreateOneByteDecoder(uMappingTable * aMappingTable,
+CreateOneByteDecoder(const PRUnichar * aMappingTable,
                      nsISupports* aOuter,
                      REFNSIID aIID,
                      void** aResult);
 
                    
 #endif
diff --git a/intl/uconv/util/nsUCSupport.cpp b/intl/uconv/util/nsUCSupport.cpp
--- a/intl/uconv/util/nsUCSupport.cpp
+++ b/intl/uconv/util/nsUCSupport.cpp
@@ -260,47 +260,34 @@ NS_IMETHODIMP nsMultiTableDecoderSupport
                                                     mMappingTable,
                                                     mErrBehavior == kOnError_Signal);
 }
 
 //----------------------------------------------------------------------
 // Class nsOneByteDecoderSupport [implementation]
 
 nsOneByteDecoderSupport::nsOneByteDecoderSupport(
-                         uMappingTable  * aMappingTable)
+                         const PRUnichar* aFastTable)
   : nsBasicDecoderSupport()
-  , mMappingTable(aMappingTable)
-  , mFastTableCreated(false)
-  , mFastTableMutex("nsOneByteDecoderSupport mFastTableMutex")
+  , mFastTable(aFastTable)
 {
 }
 
 nsOneByteDecoderSupport::~nsOneByteDecoderSupport()
 {
 }
 
 //----------------------------------------------------------------------
 // Subclassing of nsBasicDecoderSupport class [implementation]
 
 NS_IMETHODIMP nsOneByteDecoderSupport::Convert(const char * aSrc,
                                               int32_t * aSrcLength,
                                               PRUnichar * aDest,
                                               int32_t * aDestLength)
 {
-  if (!mFastTableCreated) {
-    // Probably better to make this non-lazy and get rid of the mutex
-    mozilla::MutexAutoLock autoLock(mFastTableMutex);
-    if (!mFastTableCreated) {
-      nsresult res = nsUnicodeDecodeHelper::CreateFastTable(
-                         mMappingTable, mFastTable, ONE_BYTE_TABLE_SIZE);
-      if (NS_FAILED(res)) return res;
-      mFastTableCreated = true;
-    }
-  }
-
   return nsUnicodeDecodeHelper::ConvertByFastTable(aSrc, aSrcLength,
                                                    aDest, aDestLength,
                                                    mFastTable,
                                                    ONE_BYTE_TABLE_SIZE,
                                                    mErrBehavior == kOnError_Signal);
 }
 
 NS_IMETHODIMP nsOneByteDecoderSupport::GetMaxLength(const char * aSrc,
diff --git a/intl/uconv/util/nsUCSupport.h b/intl/uconv/util/nsUCSupport.h
--- a/intl/uconv/util/nsUCSupport.h
+++ b/intl/uconv/util/nsUCSupport.h
@@ -236,30 +236,29 @@ protected:
  * @author  Catalin Rotaru [CATA]
  */
 class nsOneByteDecoderSupport : public nsBasicDecoderSupport
 {
 public:
 
   /**
    * Class constructor.
+   *
+   * The argument is a PRUnichar array of ONE_BYTE_TABLE_SIZE elements.
    */
-  nsOneByteDecoderSupport(uMappingTable * aMappingTable);
+  nsOneByteDecoderSupport(const PRUnichar *aFastTable);
 
   /**
    * Class destructor.
    */
   virtual ~nsOneByteDecoderSupport();
 
 protected:
 
-  uMappingTable             * mMappingTable;
-  PRUnichar                 mFastTable[ONE_BYTE_TABLE_SIZE];
-  bool                      mFastTableCreated;
-  mozilla::Mutex            mFastTableMutex;
+  const PRUnichar *         mFastTable;
 
   //--------------------------------------------------------------------
   // Subclassing of nsBasicDecoderSupport class [declaration]
 
   NS_IMETHOD Convert(const char * aSrc, int32_t * aSrcLength, 
       PRUnichar * aDest, int32_t * aDestLength);
   NS_IMETHOD GetMaxLength(const char * aSrc, int32_t aSrcLength, 
       int32_t * aDestLength);

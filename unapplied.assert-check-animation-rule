From: L. David Baron <dbaron@dbaron.org>

Bug 686656 - Assert that we only call CheckAnimationRule in allowed cases.

diff --git a/layout/style/nsAnimationManager.cpp b/layout/style/nsAnimationManager.cpp
--- a/layout/style/nsAnimationManager.cpp
+++ b/layout/style/nsAnimationManager.cpp
@@ -391,16 +391,25 @@ nsAnimationManager::UpdateAnimations(nsS
   // Likewise, when we initially construct frames, we're not in a
   // style change, but also not in an animation restyle.
 
   const nsStyleDisplay* disp = aStyleContext->StyleDisplay();
   CSSAnimationCollection* collection =
     CSSAnimationCollection::GetAnimationCollection(aElement,
                                                    aStyleContext->
                                                      GetPseudoType());
+  MOZ_ASSERT(mPresContext->IsProcessingRestyles() || !collection,
+             "The only case where it's ok to hit this code "
+             "outside of restyle processing is *initial* "
+             "frame construction, when we can't already have "
+             "an animation rule (or transition rules).  If "
+             "we hit it any other time, we might *already* have "
+             "an animation rule, which means CheckAnimationRule "
+             "will produce incorrect results because it builds "
+             "on incorrect base values (see bug 686656).");
   if (!collection &&
       disp->mAnimationNameCount == 1 &&
       disp->mAnimations[0].GetName().IsEmpty()) {
     return;
   }
 
   nsAutoAnimationMutationBatch mb(aElement->OwnerDoc());
 

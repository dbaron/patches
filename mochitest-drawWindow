From: L. David Baron <dbaron@dbaron.org>

Bug 995410 patch 2 - Add mochitest for canvas drawWindow.

diff --git a/content/canvas/test/file_drawWindow_source.html b/content/canvas/test/file_drawWindow_source.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/file_drawWindow_source.html
@@ -0,0 +1,10 @@
+<!DOCTYPE HTML>
+<style>
+
+html, body { margin: 0; padding: 0 }
+div { display: inline-block; margin: 10px; width: 20px; height: 20px }
+
+</style
+><div style="background: fuchsia"></div
+><div style="background: aqua"></div
+><div style="background: yellow"></div>
diff --git a/content/canvas/test/mochitest.ini b/content/canvas/test/mochitest.ini
--- a/content/canvas/test/mochitest.ini
+++ b/content/canvas/test/mochitest.ini
@@ -194,16 +194,18 @@ skip-if = (toolkit == 'gonk' && !debug) 
 [test_canvas_font_setter.html]
 [test_canvas_path.html]
 [test_hitregion_canvas.html]
 skip-if = os == "android" || appname == "b2g"
 [test_canvas_strokeStyle_getter.html]
 [test_drawImageIncomplete.html]
 [test_drawImage_document_domain.html]
 [test_drawImage_edge_cases.html]
+[test_drawWindow.html]
+support-files = file_drawWindow_source.html
 [test_ImageData_ctor.html]
 [test_isPointInStroke.html]
 [test_mozDashOffset.html]
 [test_mozGetAsFile.html]
 [test_strokeText_throw.html]
 [test_toBlob.html]
 [test_toDataURL_alpha.html]
 [test_toDataURL_lowercase_ascii.html]
diff --git a/content/canvas/test/test_drawWindow.html b/content/canvas/test/test_drawWindow.html
new file mode 100644
--- /dev/null
+++ b/content/canvas/test/test_drawWindow.html
@@ -0,0 +1,131 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <meta charset="utf-8">
+  <title>Test for canvas drawWindow</title>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <script type="application/javascript" src="/tests/SimpleTest/WindowSnapshot.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+  <script type="application/javascript">
+
+  const CANVAS_WIDTH = 200;
+  const CANVAS_HEIGHT = 100;
+
+  SimpleTest.waitForExplicitFinish();
+  window.addEventListener("load", runTests, false);
+
+  function runTests(event) {
+    if (event.target != document) {
+      return;
+    }
+
+    var refCanvas = document.getElementById("refCanvas");
+    var testCanvas = document.getElementById("testCanvas");
+
+    var refCx = refCanvas.getContext("2d");
+    var testCx = testCanvas.getContext("2d");
+
+    var refWrapCx = SpecialPowers.wrap(refCx);
+    var testWrapCx = SpecialPowers.wrap(testCx);
+
+    var sourceFrame = document.getElementById("source");
+    var sourceWindow = sourceFrame.contentWindow;
+
+    function clearRef(fillStyle) {
+      refCx.setTransform(1, 0, 0, 1, 0, 0);
+      refCx.fillStyle = fillStyle;
+      refCx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
+    }
+    function clearTest(fillStyle) {
+      testCx.setTransform(1, 0, 0, 1, 0, 0);
+      testCx.fillStyle = fillStyle;
+      testCx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
+    }
+    function clear(fillStyle) {
+      clearRef(fillStyle);
+      clearTest(fillStyle);
+    }
+
+    function testWithFlags(drawWindowFlags) {
+      // Basic tests of drawing the whole document on a background
+
+      clear("white");
+      testWrapCx.drawWindow(sourceWindow, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT,
+                            "rgb(255, 255, 255)", drawWindowFlags);
+      refCx.fillStyle = "fuchsia";
+      refCx.fillRect(10, 10, 20, 20);
+      refCx.fillStyle = "aqua";
+      refCx.fillRect(50, 10, 20, 20);
+      refCx.fillStyle = "yellow";
+      refCx.fillRect(90, 10, 20, 20);
+      assertSnapshots(testCanvas, refCanvas, true /* equal */,
+                      "full draw of source on white background", "reference");
+
+      clearTest("white");
+      testWrapCx.drawWindow(sourceWindow, 0, 0, CANVAS_WIDTH, CANVAS_HEIGHT,
+                            "rgb(255, 255, 0)", drawWindowFlags);
+      assertSnapshots(testCanvas, refCanvas, false /* equal */,
+                      "full draw of source on yellow background", "reference");
+
+      clearRef("yellow");
+      refCx.fillStyle = "fuchsia";
+      refCx.fillRect(10, 10, 20, 20);
+      refCx.fillStyle = "aqua";
+      refCx.fillRect(50, 10, 20, 20);
+      refCx.fillStyle = "yellow";
+      refCx.fillRect(90, 10, 20, 20);
+
+      assertSnapshots(testCanvas, refCanvas, true /* equal */,
+                      "full draw of source on yellow background", "reference");
+
+      // Test drawing a region within the document.
+
+      clear("white");
+
+      testCx.translate(17, 31);
+      testWrapCx.drawWindow(sourceWindow, 40, 0, 40, 40,
+                            "white", drawWindowFlags);
+
+      refCx.fillStyle = "aqua";
+      refCx.fillRect(17 + 10, 31 + 10, 20, 20);
+
+      assertSnapshots(testCanvas, refCanvas, true /* equal */,
+                      "draw of subrect of source with matching background",
+                      "reference");
+
+      clear("blue");
+
+      testCx.translate(17, 31);
+      testWrapCx.drawWindow(sourceWindow, 40, 0, 35, 45,
+                            "green", drawWindowFlags);
+
+      refCx.fillStyle = "green";
+      refCx.fillRect(17, 31, 35, 45);
+      refCx.fillStyle = "aqua";
+      refCx.fillRect(17 + 10, 31 + 10, 20, 20);
+
+      assertSnapshots(testCanvas, refCanvas, true /* equal */,
+                      "draw of subrect of source with different background",
+                    "reference");
+    }
+
+    var cxInterfaceWrap = SpecialPowers.wrap(CanvasRenderingContext2D);
+
+    testWithFlags(0);
+    testWithFlags(cxInterfaceWrap.DRAWWINDOW_USE_WIDGET_LAYERS);
+    testWithFlags(cxInterfaceWrap.DRAWWINDOW_USE_WIDGET_LAYERS |
+                  cxInterfaceWrap.DRAWWINDOW_DRAW_CARET |
+                  cxInterfaceWrap.DRAWWINDOW_DRAW_VIEW);
+
+    SimpleTest.finish();
+  }
+
+  </script>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=">Mozilla Bug </a>
+<iframe id="source" src="file_drawWindow_source.html" width="200" height="100"></iframe>
+<canvas id="testCanvas" width="200" height="100"></canvas>
+<canvas id="refCanvas" width="200" height="100"></canvas>
+</body>
+</html>

From: L. David Baron <dbaron@dbaron.org>

Reflow floating ::first-letter before deciding where to place the float, since we need to reflow it to learn its width.  (Bug 594303)

diff --git a/layout/generic/nsBlockReflowState.cpp b/layout/generic/nsBlockReflowState.cpp
--- a/layout/generic/nsBlockReflowState.cpp
+++ b/layout/generic/nsBlockReflowState.cpp
@@ -675,16 +675,32 @@ nsBlockReflowState::FlowAndPlaceFloat(ns
 
   nsCSSOffsetState offsets(aFloat, mReflowState.rendContext,
                            mReflowState.ComputedWidth());
 
   nscoord floatMarginWidth = FloatMarginWidth(mReflowState,
                                               adjustedAvailableSpace.width,
                                               aFloat, offsets);
 
+  nsMargin floatMargin; // computed margin
+  nsReflowStatus reflowStatus;
+
+  // If it's a floating first-letter, we need to reflow it before we
+  // know how wide it is (since we don't compute which letters are part
+  // of the first letter until reflow!).
+  PRBool isLetter = aFloat->GetType() == nsGkAtoms::letterFrame;
+  if (isLetter) {
+    mBlock->ReflowFloat(*this, adjustedAvailableSpace, aFloat,
+                        floatMargin, PR_FALSE, reflowStatus);
+    floatMarginWidth = aFloat->GetSize().width + floatMargin.LeftRight();
+    NS_ASSERTION(NS_FRAME_IS_COMPLETE(reflowStatus),
+                 "letter frames shouldn't break, and if they do now, "
+                 "then they're breaking at the wrong point");
+  }
+
   // Find a place to place the float. The CSS2 spec doesn't want
   // floats overlapping each other or sticking out of the containing
   // block if possible (CSS2 spec section 9.5.1, see the rule list).
   NS_ASSERTION((NS_STYLE_FLOAT_LEFT == floatDisplay->mFloats) ||
 	       (NS_STYLE_FLOAT_RIGHT == floatDisplay->mFloats),
 	       "invalid float type");
 
   // Can the float fit here?
@@ -795,21 +811,21 @@ nsBlockReflowState::FlowAndPlaceFloat(ns
   // be higher than the top of its containing block."  (Since the
   // containing block is the content edge of the block box, this
   // means the margin edge of the float can't be higher than the
   // content edge of the block that contains it.)
   floatY = NS_MAX(mY, mContentArea.y);
 
   // Reflow the float after computing its vertical position so it knows
   // where to break.
-  nsMargin floatMargin; // computed margin
-  PRBool pushedDown = mY != saveY;
-  nsReflowStatus reflowStatus;
-  mBlock->ReflowFloat(*this, adjustedAvailableSpace, aFloat,
-                      floatMargin, pushedDown, reflowStatus);
+  if (!isLetter) {
+    PRBool pushedDown = mY != saveY;
+    mBlock->ReflowFloat(*this, adjustedAvailableSpace, aFloat,
+                        floatMargin, pushedDown, reflowStatus);
+  }
   if (aFloat->GetPrevInFlow())
     floatMargin.top = 0;
   if (NS_FRAME_IS_NOT_COMPLETE(reflowStatus))
     floatMargin.bottom = 0;
 
   // In the case that we're in columns and not splitting floats, we need
   // to check here that the float's height fit, and if it didn't, bail.
   // (This code is only for DISABLE_FLOAT_BREAKING_IN_COLUMNS .)
diff --git a/layout/reftests/first-letter/594303-1-ref.html b/layout/reftests/first-letter/594303-1-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/594303-1-ref.html
@@ -0,0 +1,7 @@
+<!DOCTYPE HTML>
+<title>Testcase Bug 594303</title>
+<style>
+body { width: 300px; font-size: 16px }
+p::first-letter { font-size: 3em; float: left }
+</style>
+<p>This is a paragraph with a decent amount of text in it, enough to wrap to multiple lines.</p>
diff --git a/layout/reftests/first-letter/594303-1.html b/layout/reftests/first-letter/594303-1.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/first-letter/594303-1.html
@@ -0,0 +1,8 @@
+<!DOCTYPE HTML>
+<title>Testcase Bug 594303</title>
+<style>
+body { width: 500px; font-size: 16px }
+p::first-letter { font-size: 3em; float: left }
+</style>
+<div style="float: right; width: 200px; height: 200px"></div>
+<p>This is a paragraph with a decent amount of text in it, enough to wrap to multiple lines.</p>
diff --git a/layout/reftests/first-letter/reftest.list b/layout/reftests/first-letter/reftest.list
--- a/layout/reftests/first-letter/reftest.list
+++ b/layout/reftests/first-letter/reftest.list
@@ -50,8 +50,9 @@ fails == 329069-2.html 329069-2-ref.html
 == 429968-1a.html 429968-1-ref.html
 == 429968-1b.html 429968-1-ref.html
 == 429968-2a.html 429968-2-ref.html
 == 429968-2b.html 429968-2-ref.html
 == 429968-2c.html 429968-2-ref.html
 == 441418-1.html 441418-1-ref.html
 == 469227-1.html 469227-1-ref.html
 == 484400-1.html 484400-1-ref.html
+== 594303-1.html 594303-1-ref.html

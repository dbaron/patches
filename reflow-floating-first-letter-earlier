From: L. David Baron <dbaron@dbaron.org>

Reflow floating ::first-letter before deciding where to place the float, since we need to reflow it to learn its width.  (Bug 594303)

diff --git a/layout/generic/nsBlockReflowState.cpp b/layout/generic/nsBlockReflowState.cpp
--- a/layout/generic/nsBlockReflowState.cpp
+++ b/layout/generic/nsBlockReflowState.cpp
@@ -675,16 +675,32 @@ nsBlockReflowState::FlowAndPlaceFloat(ns
 
   nsCSSOffsetState offsets(aFloat, mReflowState.rendContext,
                            mReflowState.ComputedWidth());
 
   nscoord floatMarginWidth = FloatMarginWidth(mReflowState,
                                               adjustedAvailableSpace.width,
                                               aFloat, offsets);
 
+  nsMargin floatMargin; // computed margin
+  nsReflowStatus reflowStatus;
+
+  // If it's a floating first-letter, we need to reflow it before we
+  // know how wide it is (since we don't compute which letters are part
+  // of the first letter until reflow!).
+  PRBool isLetter = aFloat->GetType() == nsGkAtoms::letterFrame;
+  if (isLetter) {
+    mBlock->ReflowFloat(*this, adjustedAvailableSpace, aFloat,
+                        floatMargin, PR_FALSE, reflowStatus);
+    floatMarginWidth = aFloat->GetSize().width + floatMargin.LeftRight();
+    NS_ASSERTION(NS_FRAME_IS_COMPLETE(reflowStatus),
+                 "letter frames shouldn't break, and if they do now, "
+                 "then they're breaking at the wrong point");
+  }
+
   // Find a place to place the float. The CSS2 spec doesn't want
   // floats overlapping each other or sticking out of the containing
   // block if possible (CSS2 spec section 9.5.1, see the rule list).
   NS_ASSERTION((NS_STYLE_FLOAT_LEFT == floatDisplay->mFloats) ||
 	       (NS_STYLE_FLOAT_RIGHT == floatDisplay->mFloats),
 	       "invalid float type");
 
   // Can the float fit here?
@@ -795,21 +811,21 @@ nsBlockReflowState::FlowAndPlaceFloat(ns
   // be higher than the top of its containing block."  (Since the
   // containing block is the content edge of the block box, this
   // means the margin edge of the float can't be higher than the
   // content edge of the block that contains it.)
   floatY = NS_MAX(mY, mContentArea.y);
 
   // Reflow the float after computing its vertical position so it knows
   // where to break.
-  nsMargin floatMargin; // computed margin
-  PRBool pushedDown = mY != saveY;
-  nsReflowStatus reflowStatus;
-  mBlock->ReflowFloat(*this, adjustedAvailableSpace, aFloat,
-                      floatMargin, pushedDown, reflowStatus);
+  if (!isLetter) {
+    PRBool pushedDown = mY != saveY;
+    mBlock->ReflowFloat(*this, adjustedAvailableSpace, aFloat,
+                        floatMargin, pushedDown, reflowStatus);
+  }
   if (aFloat->GetPrevInFlow())
     floatMargin.top = 0;
   if (NS_FRAME_IS_NOT_COMPLETE(reflowStatus))
     floatMargin.bottom = 0;
 
   // In the case that we're in columns and not splitting floats, we need
   // to check here that the float's height fit, and if it didn't, bail.
   // (This code is only for DISABLE_FLOAT_BREAKING_IN_COLUMNS .)

Make inline-block and table-caption elements not ignore text-decoration.  b=371249

diff --git a/layout/generic/nsHTMLContainerFrame.cpp b/layout/generic/nsHTMLContainerFrame.cpp
--- a/layout/generic/nsHTMLContainerFrame.cpp
+++ b/layout/generic/nsHTMLContainerFrame.cpp
@@ -261,8 +261,9 @@ nsHTMLContainerFrame::GetTextDecorations
 
       nsStyleContext* styleContext = frame->GetStyleContext();
       const nsStyleDisplay* styleDisplay = styleContext->GetStyleDisplay();
-      if (!styleDisplay->IsBlockOutside() &&
-          styleDisplay->mDisplay != NS_STYLE_DISPLAY_TABLE_CELL) {
+      if (!styleDisplay->IsBlockInside() &&
+          styleDisplay->mDisplay != NS_STYLE_DISPLAY_TABLE_CELL &&
+          styleDisplay->mDisplay != NS_STYLE_DISPLAY_TABLE_CAPTION) {
         // If an inline frame is discovered while walking up the tree,
         // we should stop according to CSS3 draft. CSS2 is rather vague
         // about this.
diff --git a/layout/reftests/reftest.list b/layout/reftests/reftest.list
--- a/layout/reftests/reftest.list
+++ b/layout/reftests/reftest.list
@@ -42,6 +42,9 @@ include first-letter/reftest.list
 # svg/
 include svg/reftest.list
 
+# text-decoration/
+include text-decoration/reftest.list
+
 # text-indent/
 include text-indent/reftest.list
 
diff --git a/layout/reftests/text-decoration/reftest.list b/layout/reftests/text-decoration/reftest.list
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/reftest.list
@@ -0,0 +1,9 @@
+== underline-block-quirks.html underline-block-quirks-ref.html
+!= underline-block-quirks.html underline-block-quirks-notref.html
+== underline-inline-block-quirks.html underline-inline-block-quirks-ref.html
+!= underline-inline-block-quirks.html underline-inline-block-quirks-notref.html
+== underline-table-caption-quirks.html underline-table-caption-quirks-ref.html
+!= underline-table-caption-quirks.html underline-table-caption-quirks-notref.html
+== underline-table-cell-quirks.html underline-table-cell-quirks-ref.html
+!= underline-table-cell-quirks.html underline-table-cell-quirks-notref.html
+== underline-block-propagation-quirks.html underline-block-propagation-quirks-ref.html
diff --git a/layout/reftests/text-decoration/underline-block-propagation-quirks-ref.html b/layout/reftests/text-decoration/underline-block-propagation-quirks-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-block-propagation-quirks-ref.html
@@ -0,0 +1,11 @@
+<div>
+<span style="text-decoration:underline">This text should be underlined.</span>
+
+<div style="float:left;width:10em">This text should not be underlined.</div>
+
+<div style="margin: 1px 2px 3px 4px; border: medium solid; padding: 6px 8px 10px 12px"><span style="text-decoration:underline">This text should be underlined.</span></div>
+
+<div style="position:absolute: top: 400px;left:400px">This should not be underlined.</div>
+
+<span style="text-decoration:underline">This should be underlined but <span style="display:inline:block">this should<br>not have a <br>separate underline</span>.</span>
+
diff --git a/layout/reftests/text-decoration/underline-block-propagation-quirks.html b/layout/reftests/text-decoration/underline-block-propagation-quirks.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-block-propagation-quirks.html
@@ -0,0 +1,11 @@
+<div style="text-decoration:underline">
+This text should be underlined.
+
+<div style="float:left;width:10em">This text should not be underlined.</div>
+
+<div style="margin: 1px 2px 3px 4px; border: medium solid; padding: 6px 8px 10px 12px">This text should be underlined.</div>
+
+<div style="position:absolute: top: 400px;left:400px">This should not be underlined.</div>
+
+This should be underlined but <span style="display:inline:block">this should<br>not have a <br>separate underline</span>.
+
diff --git a/layout/reftests/text-decoration/underline-block-quirks-notref.html b/layout/reftests/text-decoration/underline-block-quirks-notref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-block-quirks-notref.html
@@ -0,0 +1,1 @@
+<div>This text should be underlined.</div>
diff --git a/layout/reftests/text-decoration/underline-block-quirks-ref.html b/layout/reftests/text-decoration/underline-block-quirks-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-block-quirks-ref.html
@@ -0,0 +1,1 @@
+<div><span style="text-decoration:underline">This text should be underlined.</span></div>
diff --git a/layout/reftests/text-decoration/underline-block-quirks.html b/layout/reftests/text-decoration/underline-block-quirks.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-block-quirks.html
@@ -0,0 +1,1 @@
+<div style="text-decoration:underline">This text should be underlined.</div>
diff --git a/layout/reftests/text-decoration/underline-inline-block-quirks-notref.html b/layout/reftests/text-decoration/underline-inline-block-quirks-notref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-inline-block-quirks-notref.html
@@ -0,0 +1,1 @@
+<p>This has an <span style="display:inline-block">inline<br>block</span> in it.</p>
diff --git a/layout/reftests/text-decoration/underline-inline-block-quirks-ref.html b/layout/reftests/text-decoration/underline-inline-block-quirks-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-inline-block-quirks-ref.html
@@ -0,0 +1,1 @@
+<p>This has an <span style="display:inline-block"><span style="text-decoration:underline">inline</span><br><span style="text-decoration:underline">block</span></span> in it.</p>
diff --git a/layout/reftests/text-decoration/underline-inline-block-quirks.html b/layout/reftests/text-decoration/underline-inline-block-quirks.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-inline-block-quirks.html
@@ -0,0 +1,1 @@
+<p>This has an <span style="display:inline-block;text-decoration:underline">inline<br>block</span> in it.</p>
diff --git a/layout/reftests/text-decoration/underline-table-caption-quirks-notref.html b/layout/reftests/text-decoration/underline-table-caption-quirks-notref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-table-caption-quirks-notref.html
@@ -0,0 +1,11 @@
+<table border>
+  <caption>This is the table caption</caption>
+  <tr>
+    <td>Row 1, Cell 1</td>
+    <td>Row 1, Cell 2</td>
+  </tr>
+  <tr>
+    <td>Row 2, Cell 1</td>
+    <td>Row 2, Cell 2</td>
+  </tr>
+</table>
diff --git a/layout/reftests/text-decoration/underline-table-caption-quirks-ref.html b/layout/reftests/text-decoration/underline-table-caption-quirks-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-table-caption-quirks-ref.html
@@ -0,0 +1,11 @@
+<table border>
+  <caption><span style="text-decoration: underline">This is the table caption</span></caption>
+  <tr>
+    <td>Row 1, Cell 1</td>
+    <td>Row 1, Cell 2</td>
+  </tr>
+  <tr>
+    <td>Row 2, Cell 1</td>
+    <td>Row 2, Cell 2</td>
+  </tr>
+</table>
diff --git a/layout/reftests/text-decoration/underline-table-caption-quirks.html b/layout/reftests/text-decoration/underline-table-caption-quirks.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-table-caption-quirks.html
@@ -0,0 +1,11 @@
+<table border>
+  <caption style="text-decoration: underline">This is the table caption</caption>
+  <tr>
+    <td>Row 1, Cell 1</td>
+    <td>Row 1, Cell 2</td>
+  </tr>
+  <tr>
+    <td>Row 2, Cell 1</td>
+    <td>Row 2, Cell 2</td>
+  </tr>
+</table>
diff --git a/layout/reftests/text-decoration/underline-table-cell-quirks-notref.html b/layout/reftests/text-decoration/underline-table-cell-quirks-notref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-table-cell-quirks-notref.html
@@ -0,0 +1,10 @@
+<table border>
+  <tr>
+    <td>Row 1, Cell 1</td>
+    <td>Row 1, Cell 2</td>
+  </tr>
+  <tr>
+    <td>Row 2, Cell 1</td>
+    <td>Row 2, Cell 2</td>
+  </tr>
+</table>
diff --git a/layout/reftests/text-decoration/underline-table-cell-quirks-ref.html b/layout/reftests/text-decoration/underline-table-cell-quirks-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-table-cell-quirks-ref.html
@@ -0,0 +1,10 @@
+<table border>
+  <tr>
+    <td><span style="text-decoration: underline">Row 1, Cell 1</span></td>
+    <td>Row 1, Cell 2</td>
+  </tr>
+  <tr>
+    <td>Row 2, Cell 1</td>
+    <td>Row 2, Cell 2</td>
+  </tr>
+</table>
diff --git a/layout/reftests/text-decoration/underline-table-cell-quirks.html b/layout/reftests/text-decoration/underline-table-cell-quirks.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/text-decoration/underline-table-cell-quirks.html
@@ -0,0 +1,10 @@
+<table border>
+  <tr>
+    <td style="text-decoration: underline">Row 1, Cell 1</td>
+    <td>Row 1, Cell 2</td>
+  </tr>
+  <tr>
+    <td>Row 2, Cell 1</td>
+    <td>Row 2, Cell 2</td>
+  </tr>
+</table>

From: L. David Baron <dbaron@dbaron.org>

Bug 981637:  Make overflow events fire correctly in UpdateOverflow codepath.  r=mats

I confirmed that the mochitest fails without the patch and passes with
it, both standalone and in the directory harness.

diff --git a/layout/generic/nsGfxScrollFrame.cpp b/layout/generic/nsGfxScrollFrame.cpp
--- a/layout/generic/nsGfxScrollFrame.cpp
+++ b/layout/generic/nsGfxScrollFrame.cpp
@@ -4002,16 +4002,17 @@ ScrollFrameHelper::UpdateOverflow()
     mOuter->PresContext()->PresShell()->FrameNeedsReflow(
       mOuter, nsIPresShell::eResize, NS_FRAME_HAS_DIRTY_CHILDREN);
     // Ensure that next time nsHTMLScrollFrame::Reflow runs, we don't skip
     // updating the scrollbars. (Because the overflow area of the scrolled
     // frame has probably just been updated, Reflow won't see it change.)
     mSkippedScrollbarLayout = true;
     return false;  // reflowing will update overflow
   }
+  PostOverflowEvent();
   return mOuter->nsContainerFrame::UpdateOverflow();
 }
 
 void
 ScrollFrameHelper::UpdateSticky()
 {
   StickyScrollContainer* ssc = StickyScrollContainer::
     GetStickyScrollContainerForScrollFrame(mOuter);
diff --git a/layout/generic/test/mochitest.ini b/layout/generic/test/mochitest.ini
--- a/layout/generic/test/mochitest.ini
+++ b/layout/generic/test/mochitest.ini
@@ -100,16 +100,17 @@ skip-if = os=='win' || e10s
 [test_invalidate_during_plugin_paint.html]
 skip-if = buildapp == 'b2g' || toolkit == 'android' || e10s # b2g(plugins not supported) b2g-debug(plugins not supported) b2g-desktop(plugins not supported)
 [test_movement_by_characters.html]
 [test_movement_by_words.html]
 # Disable the caret movement by word test on Linux because the shortcut keys
 # are defined in system level.  So, it depends on the environment.
 # Disable on Windows for too many intermittent failures (bug 916143).
 skip-if = (toolkit == "gtk2") || (toolkit == "gtk3") || (os == "win")
+[test_overflow_event.html]
 [test_page_scroll_with_fixed_pos.html]
 skip-if = (buildapp == 'b2g' && (toolkit != 'gonk' || debug)) # b2g-debug(opened window too small?) b2g-desktop(opened window too small?)
 support-files = page_scroll_with_fixed_pos_window.html
 [test_plugin_clipping.xhtml]
 skip-if = (buildapp == 'b2g' && toolkit != 'gonk') || e10s #Bug 931116, b2g desktop specific, initial triage
 [test_plugin_clipping2.xhtml]
 skip-if = (buildapp == 'b2g' && toolkit != 'gonk') || e10s #Bug 931116, b2g desktop specific, initial triage
 [test_plugin_clipping_transformed.xhtml]
diff --git a/layout/generic/test/test_overflow_event.html b/layout/generic/test/test_overflow_event.html
new file mode 100644
--- /dev/null
+++ b/layout/generic/test/test_overflow_event.html
@@ -0,0 +1,50 @@
+<!DOCTYPE HTML>
+<html>
+<head>
+  <meta charset="utf-8">
+  <title>Test for overflow events</title>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+  <script type="application/javascript">
+
+  SimpleTest.waitForExplicitFinish();
+
+  window.addEventListener("load", function(event) {
+      if (event.target == document) {
+          test_bug981637();
+      }
+  }, false);
+
+  /** Test for Bug 981637:  correct overflow event firing in updateOverflow **/
+
+  var overflow_fired = false;
+  function overflow_listener(event) {
+    overflow_fired = true;
+  }
+
+  function test_bug981637() {
+    var outerDiv = document.getElementById("bug981637");
+    var innerDiv = outerDiv.firstChild;
+    innerDiv.offsetWidth; // flush layout
+    is(overflow_fired, false, "correct setup");
+    outerDiv.addEventListener("overflow", overflow_listener, false);
+    innerDiv.style.transform = "scale(1.2)";
+    innerDiv.offsetWidth; // flush layout
+    // run finish step after the overflow event fires (off the event loop)
+    setTimeout(test_bug981637_step2, 0);
+  }
+
+  function test_bug981637_step2() {
+    is(overflow_fired, true, "overflow event should have fired after updating transform");
+    SimpleTest.finish();
+  }
+
+  </script>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=981637">Mozilla Bug 981637</a>
+<div id="bug981637" style="overflow: hidden; width: 100px; height: 100px;"><div style="transform: scale(0.8); width: 100px; height: 100px"></div></div>
+<pre id="test">
+</pre>
+</body>
+</html>

From: L. David Baron <dbaron@dbaron.org>

Implement serialization of calc() values.  (Bug 363249)

diff --git a/layout/style/nsCSSDeclaration.cpp b/layout/style/nsCSSDeclaration.cpp
--- a/layout/style/nsCSSDeclaration.cpp
+++ b/layout/style/nsCSSDeclaration.cpp
@@ -227,16 +227,32 @@ nsCSSDeclaration::AppendStorageToString(
           }
         } while (item);
       } break;
     }
   }
   return aStorage != nsnull;
 }
 
+static inline PRBool
+IsCalcAdditiveUnit(nsCSSUnit aUnit)
+{
+  return aUnit == eCSSUnit_Calc_Plus ||
+         aUnit == eCSSUnit_Calc_Minus;
+}
+
+static inline PRBool
+IsCalcMultiplicativeUnit(nsCSSUnit aUnit)
+{
+  return aUnit == eCSSUnit_Calc_Times_L ||
+         aUnit == eCSSUnit_Calc_Times_R ||
+         aUnit == eCSSUnit_Calc_Divided ||
+         aUnit == eCSSUnit_Calc_Modulus;
+}
+
 /* static */ PRBool
 nsCSSDeclaration::AppendCSSValueToString(nsCSSProperty aProperty,
                                          const nsCSSValue& aValue,
                                          nsAString& aResult)
 {
   nsCSSUnit unit = aValue.GetUnit();
 
   if (eCSSUnit_Null == unit) {
@@ -319,16 +335,100 @@ nsCSSDeclaration::AppendCSSValueToString
       /* If we're not at the final element, append a comma. */
       if (index + 1 != array->Count())
         aResult.AppendLiteral(", ");
     }
 
     /* Finally, append the closing parenthesis. */
     aResult.AppendLiteral(")");
   }
+  else if (eCSSUnit_Calc <= unit && unit <= eCSSUnit_Calc_Maximum) {
+    const nsCSSValue::Array* array = aValue.GetArrayValue();
+    if (eCSSUnit_Calc == unit) {
+      NS_ABORT_IF_FALSE(array->Count() == 1, "unexpected length");
+      aResult.AppendLiteral("-moz-calc(");
+      // When we make recursive calls, we pass eCSSProperty_UNKNOWN as
+      // the property so we can distinguish min() and max() at toplevel
+      // (where we need to serialize with a -moz- prefix) from min() and
+      // max() within calc() (where we don't).
+      AppendCSSValueToString(eCSSProperty_UNKNOWN, array->Item(0), aResult);
+      aResult.AppendLiteral(")");
+    } else if (eCSSUnit_Calc_Minimum == unit ||
+               eCSSUnit_Calc_Maximum == unit) {
+      if (aProperty == eCSSProperty_UNKNOWN) {
+        // min() or max() inside calc()
+        if (eCSSUnit_Calc_Minimum == unit) {
+          aResult.AppendLiteral("min(");
+        } else {
+          aResult.AppendLiteral("max(");
+        }
+      } else {
+        // min() or max() at toplevel
+        if (eCSSUnit_Calc_Minimum == unit) {
+          aResult.AppendLiteral("-moz-min(");
+        } else {
+          aResult.AppendLiteral("-moz-max(");
+        }
+      }
+
+      for (PRUint32 i = 0, i_end = array->Count(); i < i_end; ++i) {
+        if (i != 0) {
+          aResult.AppendLiteral(", ");
+        }
+        // When we make recursive calls, we pass eCSSProperty_UNKNOWN as
+        // the property so we can distinguish min() and max() at toplevel
+        // (where we need to serialize with a -moz- prefix) from min() and
+        // max() within calc() (where we don't).
+        AppendCSSValueToString(eCSSProperty_UNKNOWN, array->Item(i), aResult);
+      }
+
+      aResult.AppendLiteral(")");
+    } else if (IsCalcAdditiveUnit(unit)) {
+      NS_ABORT_IF_FALSE(array->Count() == 2, "unexpected length");
+
+      AppendCSSValueToString(aProperty, array->Item(0), aResult);
+
+      if (eCSSUnit_Calc_Plus == unit) {
+        aResult.AppendLiteral(" + ");
+      } else {
+        aResult.AppendLiteral(" - ");
+      }
+
+      PRBool needParens = IsCalcAdditiveUnit(array->Item(1).GetUnit());
+      if (needParens)
+        aResult.AppendLiteral("(");
+      AppendCSSValueToString(aProperty, array->Item(1), aResult);
+      if (needParens)
+        aResult.AppendLiteral(")");
+    } else if (IsCalcMultiplicativeUnit(unit)) {
+      PRBool needParens = IsCalcAdditiveUnit(array->Item(0).GetUnit());
+      if (needParens)
+        aResult.AppendLiteral("(");
+      AppendCSSValueToString(aProperty, array->Item(0), aResult);
+      if (needParens)
+        aResult.AppendLiteral(")");
+
+      if (eCSSUnit_Calc_Times_L == unit || eCSSUnit_Calc_Times_R == unit) {
+        aResult.AppendLiteral(" * ");
+      } else if (eCSSUnit_Calc_Divided == unit) {
+        aResult.AppendLiteral(" / ");
+      } else {
+        aResult.AppendLiteral(" mod ");
+      }
+
+      nsCSSUnit subUnit = array->Item(1).GetUnit();
+      needParens = IsCalcAdditiveUnit(subUnit) ||
+                   IsCalcMultiplicativeUnit(subUnit);
+      if (needParens)
+        aResult.AppendLiteral("(");
+      AppendCSSValueToString(aProperty, array->Item(1), aResult);
+      if (needParens)
+        aResult.AppendLiteral(")");
+    }
+  }
   else if (eCSSUnit_Integer == unit) {
     nsAutoString tmpStr;
     tmpStr.AppendInt(aValue.GetIntValue(), 10);
     aResult.Append(tmpStr);
   }
   else if (eCSSUnit_Enumerated == unit) {
     if (eCSSProperty_text_decoration == aProperty) {
       PRInt32 intValue = aValue.GetIntValue();
@@ -530,16 +630,25 @@ nsCSSDeclaration::AppendCSSValueToString
     case eCSSUnit_Array:        break;
     case eCSSUnit_Attr:
     case eCSSUnit_Cubic_Bezier:
     case eCSSUnit_Counter:
     case eCSSUnit_Counters:     aResult.Append(PRUnichar(')'));    break;
     case eCSSUnit_Local_Font:   break;
     case eCSSUnit_Font_Format:  break;
     case eCSSUnit_Function:     break;
+    case eCSSUnit_Calc:         break;
+    case eCSSUnit_Calc_Plus:    break;
+    case eCSSUnit_Calc_Minus:   break;
+    case eCSSUnit_Calc_Times_L: break;
+    case eCSSUnit_Calc_Times_R: break;
+    case eCSSUnit_Calc_Divided: break;
+    case eCSSUnit_Calc_Modulus: break;
+    case eCSSUnit_Calc_Minimum: break;
+    case eCSSUnit_Calc_Maximum: break;
     case eCSSUnit_Integer:      break;
     case eCSSUnit_Enumerated:   break;
     case eCSSUnit_EnumColor:    break;
     case eCSSUnit_Color:        break;
     case eCSSUnit_Percent:      aResult.Append(PRUnichar('%'));    break;
     case eCSSUnit_Number:       break;
     case eCSSUnit_Gradient:     break;
 

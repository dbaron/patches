From: L. David Baron <dbaron@dbaron.org>

Bug 1380521 - Use a more reliably invalid initial mBSizeOfARow so that we reflow properly if it changes to zero.

This fixes a failure in layout/reftests/bugs/467084-1.html, triggered by
the primary patch in bug 1308876, on Android only (or on all platforms
if I add 'html { overflow: hidden }').

MozReview-Commit-ID: 3SjTlnBngBV

diff --git a/layout/forms/nsSelectsAreaFrame.h b/layout/forms/nsSelectsAreaFrame.h
--- a/layout/forms/nsSelectsAreaFrame.h
+++ b/layout/forms/nsSelectsAreaFrame.h
@@ -30,17 +30,17 @@ public:
                       const ReflowInput& aReflowInput,
                       nsReflowStatus&          aStatus) override;
 
   nscoord BSizeOfARow() const { return mBSizeOfARow; }
 
 protected:
   explicit nsSelectsAreaFrame(nsStyleContext* aContext) :
     nsBlockFrame(aContext, kClassID),
-    mBSizeOfARow(0)
+    mBSizeOfARow(nscoord_MIN)
   {}
 
   // We cache the block size of a single row so that changes to the
   // "size" attribute, padding, etc. can all be handled with only one
   // reflow.  We'll have to reflow twice if someone changes our font
   // size or something like that, so that the block size of our options
   // will change.
   nscoord mBSizeOfARow;
diff --git a/layout/reftests/forms/select/listbox-zero-row-initial-ref.html b/layout/reftests/forms/select/listbox-zero-row-initial-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/forms/select/listbox-zero-row-initial-ref.html
@@ -0,0 +1,23 @@
+<!DOCTYPE HTML>
+<title>Testcase for initial reflow of zero height options</title>
+<style>
+
+  html { overflow: hidden }
+  option { height: 0; min-height: 0 }
+
+</style>
+
+<select size="3">
+  <option>One</option>
+  <option>Two</option>
+  <option>Three</option>
+</select>
+
+<script>
+
+  document.body.offsetHeight; // flush layout
+  document.body.style.fontSize = "60px";
+  document.body.offsetHeight; // flush layout
+  document.body.style.fontSize = "";
+
+</script>
diff --git a/layout/reftests/forms/select/listbox-zero-row-initial.html b/layout/reftests/forms/select/listbox-zero-row-initial.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/forms/select/listbox-zero-row-initial.html
@@ -0,0 +1,14 @@
+<!DOCTYPE HTML>
+<title>Testcase for initial reflow of zero height options</title>
+<style>
+
+  html { overflow: hidden }
+  option { height: 0; min-height: 0 }
+
+</style>
+
+<select size="3">
+  <option>One</option>
+  <option>Two</option>
+  <option>Three</option>
+</select>
diff --git a/layout/reftests/forms/select/reftest.list b/layout/reftests/forms/select/reftest.list
--- a/layout/reftests/forms/select/reftest.list
+++ b/layout/reftests/forms/select/reftest.list
@@ -6,8 +6,9 @@ fuzzy-if(Android,4,11) == out-of-bounds-
 fuzzy(1,4) == padding-button-placement.html padding-button-placement-ref.html
 HTTP(../..) == vertical-centering.html vertical-centering-ref.html
 == 997709-2.html 997709-2-ref.html
 fuzzy-if(skiaContent,4,1) needs-focus == focusring-1.html focusring-1-ref.html
 needs-focus == focusring-2.html focusring-2-ref.html
 needs-focus == focusring-3.html focusring-3-ref.html
 == dynamic-text-indent-1.html dynamic-text-indent-1-ref.html
 == dynamic-text-overflow-1.html dynamic-text-overflow-1-ref.html
+== listbox-zero-row-initial.html listbox-zero-row-initial-ref.html

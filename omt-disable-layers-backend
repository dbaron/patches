From: L. David Baron <dbaron@dbaron.org>

Bug 947753 / Bug 1122526 - Don't claim to support off-main-thread animations when the nearest widget is not using OMT compositing.

diff --git a/layout/style/AnimationCommon.cpp b/layout/style/AnimationCommon.cpp
--- a/layout/style/AnimationCommon.cpp
+++ b/layout/style/AnimationCommon.cpp
@@ -582,16 +582,24 @@ bool
 AnimationPlayerCollection::CanPerformOnCompositorThread(
   CanAnimateFlags aFlags) const
 {
   nsIFrame* frame = nsLayoutUtils::GetStyleFrame(mElement);
   if (!frame) {
     return false;
   }
 
+  nsIWidget* widget = frame->GetNearestWidget();
+  if (!widget ||
+      widget->GetLayerManager()->GetBackendType() !=
+        layers::LayersBackend::LAYERS_CLIENT) {
+    // No widget (huh?), or a widget not using off-main-thread compositor.
+    return false;
+  }
+
   if (mElementProperty != nsGkAtoms::transitionsProperty &&
       mElementProperty != nsGkAtoms::animationsProperty) {
     if (nsLayoutUtils::IsAnimationLoggingEnabled()) {
       nsCString message;
       message.AppendLiteral("Gecko bug: Async animation of pseudoelements"
                             " not supported.  See bug 771367 (");
       message.Append(nsAtomCString(mElementProperty));
       message.Append(")");

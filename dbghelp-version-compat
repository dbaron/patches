Allow builds compiled with VC8 to function with older versions of dbghelp.dll.  b=391848  r=bsmedberg

diff --git a/xpcom/base/nsStackWalk.cpp b/xpcom/base/nsStackWalk.cpp
--- a/xpcom/base/nsStackWalk.cpp
+++ b/xpcom/base/nsStackWalk.cpp
@@ -836,6 +836,21 @@ BOOL SymGetModuleInfoEspecial(HANDLE aPr
     return retval;
 }
 
+// New members were added to IMAGEHLP_MODULE64 (that show up in the
+// Platform SDK that ships with VC8, but not the Platform SDK that ships
+// with VC7.1, i.e., between DbgHelp 6.0 and 6.1), but we don't need to
+// use them, and it's useful to be able to function correctly with the
+// older library.  (Stock Windows XP SP2 seems to ship with dbghelp.dll
+// version 5.1.)  Since Platform SDK version need not correspond to
+// compiler version, and the version number in debughlp.h was NOT bumped
+// when these changes were made, ifdef based on a constant that was
+// added between these versions.
+#ifdef SSRVOPT_SETCONTEXT
+#define NS_IMAGEHLP_MODULE64_SIZE (((offsetof(IMAGEHLP_MODULE64, LoadedPdbName) + sizeof(DWORD64) - 1) / sizeof(DWORD64)) * sizeof(DWORD64))
+#else
+#define NS_IMAGEHLP_MODULE64_SIZE sizeof(IMAGEHLP_MODULE64)
+#endif
+
 #ifdef USING_WXP_VERSION
 BOOL SymGetModuleInfoEspecial64(HANDLE aProcess, DWORD64 aAddr, PIMAGEHLP_MODULE64 aModuleInfo, PIMAGEHLP_LINE64 aLineInfo)
 {
@@ -844,7 +859,7 @@ BOOL SymGetModuleInfoEspecial64(HANDLE a
     /*
      * Init the vars if we have em.
      */
-    aModuleInfo->SizeOfStruct = sizeof(IMAGEHLP_MODULE64);
+    aModuleInfo->SizeOfStruct = NS_IMAGEHLP_MODULE64_SIZE;
     if (nsnull != aLineInfo) {
         aLineInfo->SizeOfStruct = sizeof(IMAGEHLP_LINE64);
     }
@@ -951,7 +966,6 @@ NS_DescribeCodeAddress(void *aPC, nsCode
         DWORD64 addr = (DWORD64)aPC;
         IMAGEHLP_MODULE64 modInfo;
         IMAGEHLP_LINE64 lineInfo;
-        modInfo.SizeOfStruct = sizeof(modInfo);
         BOOL modInfoRes;
         modInfoRes = SymGetModuleInfoEspecial64(myProcess, addr, &modInfo, &lineInfo);
 
@@ -989,7 +1003,6 @@ NS_DescribeCodeAddress(void *aPC, nsCode
         DWORD addr = (DWORD)aPC;
         IMAGEHLP_MODULE modInfo;
         IMAGEHLP_LINE lineInfo;
-        modInfo.SizeOfStruct = sizeof(modInfo);
         BOOL modInfoRes;
         modInfoRes = SymGetModuleInfoEspecial(myProcess, addr, &modInfo, &lineInfo);
 

Allow builds compiled with VC8 to function with older versions of dbghelp.dll.  b=391848

diff --git a/xpcom/base/nsStackWalk.cpp b/xpcom/base/nsStackWalk.cpp
--- a/xpcom/base/nsStackWalk.cpp
+++ b/xpcom/base/nsStackWalk.cpp
@@ -833,6 +833,16 @@ BOOL SymGetModuleInfoEspecial(HANDLE aPr
     return retval;
 }
 
+// New members were added to IMAGEHLP_MODULE64 (that show up in the
+// platform headers starting with VC8), but we don't need to use them,
+// and it's useful to be able to function correctly with the older
+// library.
+#if _MSC_VER >= 1400
+#define NS_IMAGEHLP_MODULE64_SIZE (((offsetof(IMAGEHLP_MODULE64, LoadedPdbName) + sizeof(DWORD64) - 1) / sizeof(DWORD64)) * sizeof(DWORD64))
+#else
+#define NS_IMAGEHLP_MODULE64_SIZE sizeof(IMAGEHLP_MODULE64)
+#endif
+
 #ifdef USING_WXP_VERSION
 BOOL SymGetModuleInfoEspecial64(HANDLE aProcess, DWORD64 aAddr, PIMAGEHLP_MODULE64 aModuleInfo, PIMAGEHLP_LINE64 aLineInfo)
 {
@@ -841,7 +851,7 @@ BOOL SymGetModuleInfoEspecial64(HANDLE a
     /*
      * Init the vars if we have em.
      */
-    aModuleInfo->SizeOfStruct = sizeof(IMAGEHLP_MODULE64);
+    aModuleInfo->SizeOfStruct = NS_IMAGEHLP_MODULE64_SIZE;
     if (nsnull != aLineInfo) {
         aLineInfo->SizeOfStruct = sizeof(IMAGEHLP_LINE64);
     }
@@ -948,7 +958,6 @@ NS_DescribeCodeAddress(void *aPC, nsCode
         DWORD64 addr = (DWORD64)aPC;
         IMAGEHLP_MODULE64 modInfo;
         IMAGEHLP_LINE64 lineInfo;
-        modInfo.SizeOfStruct = sizeof(modInfo);
         BOOL modInfoRes;
         modInfoRes = SymGetModuleInfoEspecial64(myProcess, addr, &modInfo, &lineInfo);
 
@@ -986,7 +995,6 @@ NS_DescribeCodeAddress(void *aPC, nsCode
         DWORD addr = (DWORD)aPC;
         IMAGEHLP_MODULE modInfo;
         IMAGEHLP_LINE lineInfo;
-        modInfo.SizeOfStruct = sizeof(modInfo);
         BOOL modInfoRes;
         modInfoRes = SymGetModuleInfoEspecial(myProcess, addr, &modInfo, &lineInfo);
 

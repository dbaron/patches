From: L. David Baron <dbaron@dbaron.org>

Fix 'visibility' animation so that it doesn't animate between values when one of them is not 'visibile'.

TODO: Needs tests.

diff --git a/layout/style/nsStyleAnimation.cpp b/layout/style/nsStyleAnimation.cpp
--- a/layout/style/nsStyleAnimation.cpp
+++ b/layout/style/nsStyleAnimation.cpp
@@ -386,20 +386,26 @@ nsStyleAnimation::ComputeDistance(nsCSSP
           int32_t endInt = aEndValue.GetIntValue();
           aDistance = std::abs(endInt - startInt);
           return true;
         }
         default:
           return false;
       }
    case eUnit_Visibility: {
-      int32_t startVal =
-        aStartValue.GetIntValue() == NS_STYLE_VISIBILITY_VISIBLE;
-      int32_t endVal =
-        aEndValue.GetIntValue() == NS_STYLE_VISIBILITY_VISIBLE;
+      int32_t startEnum = aStartValue.GetIntValue();
+      int32_t endEnum = aEndValue.GetIntValue();
+      if ((startEnum != NS_STYLE_VISIBILITY_VISIBLE &&
+           startEnum != NS_STYLE_VISIBILITY_HIDDEN) ||
+          (endEnum != NS_STYLE_VISIBILITY_VISIBLE &&
+           endEnum != NS_STYLE_VISIBILITY_HIDDEN)) {
+        return false;
+      }
+      int32_t startVal = startEnum == NS_STYLE_VISIBILITY_VISIBLE;
+      int32_t endVal = endEnum == NS_STYLE_VISIBILITY_VISIBLE;
       aDistance = std::abs(startVal - endVal);
       return true;
     }
     case eUnit_Integer: {
       int32_t startInt = aStartValue.GetIntValue();
       int32_t endInt = aEndValue.GetIntValue();
       aDistance = std::abs(endInt - startInt);
       return true;
@@ -1701,18 +1707,26 @@ nsStyleAnimation::AddWeighted(nsCSSPrope
           }
           aResultValue.SetIntValue(result, eUnit_Enumerated);
           return true;
         }
         default:
           return false;
       }
     case eUnit_Visibility: {
-      int32_t val1 = aValue1.GetIntValue() == NS_STYLE_VISIBILITY_VISIBLE;
-      int32_t val2 = aValue2.GetIntValue() == NS_STYLE_VISIBILITY_VISIBLE;
+      int32_t enum1 = aValue1.GetIntValue();
+      int32_t enum2 = aValue2.GetIntValue();
+      if ((enum1 != NS_STYLE_VISIBILITY_VISIBLE &&
+           enum1 != NS_STYLE_VISIBILITY_HIDDEN) ||
+          (enum2 != NS_STYLE_VISIBILITY_VISIBLE &&
+           enum2 != NS_STYLE_VISIBILITY_HIDDEN)) {
+        return false;
+      }
+      int32_t val1 = enum1 == NS_STYLE_VISIBILITY_VISIBLE;
+      int32_t val2 = enum2 == NS_STYLE_VISIBILITY_VISIBLE;
       double interp = aCoeff1 * val1 + aCoeff2 * val2;
       int32_t result = interp > 0.0 ? NS_STYLE_VISIBILITY_VISIBLE
                                     : NS_STYLE_VISIBILITY_HIDDEN;
       aResultValue.SetIntValue(result, eUnit_Visibility);
       return true;
     }
     case eUnit_Integer: {
       // http://dev.w3.org/csswg/css3-transitions/#animation-of-property-types-

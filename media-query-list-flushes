From: L. David Baron <dbaron@dbaron.org>

Bug 1011468:  Add necessary flushes to MediaQueryList implementation.

Bug 753777 added a flush of layout in the parent in
nsGlobalWindow::MatchMedia, but that flush isn't sufficient when layout
changes happen between the call to matchMedia and the call to the
matches getter.

TODO: write test

diff --git a/layout/style/MediaQueryList.cpp b/layout/style/MediaQueryList.cpp
--- a/layout/style/MediaQueryList.cpp
+++ b/layout/style/MediaQueryList.cpp
@@ -65,16 +65,20 @@ void
 MediaQueryList::GetMedia(nsAString &aMedia)
 {
   mMediaList->GetText(aMedia);
 }
 
 bool
 MediaQueryList::Matches()
 {
+  // Ensure that our parent's layout is up-to-date so that our size will
+  // be up-to-date.
+  FlushParent(FlushType::Layout);
+
   if (!mMatchesValid) {
     MOZ_ASSERT(!HasListeners(),
                "when listeners present, must keep mMatches current");
     RecomputeMatches();
   }
 
   return mMatches;
 }
@@ -132,32 +136,39 @@ void
 MediaQueryList::Disconnect()
 {
   DisconnectFromOwner();
 
   IgnoreKeepAliveIfHasListenersFor(ONCHANGE_STRING);
 }
 
 void
-MediaQueryList::RecomputeMatches()
+MediaQueryList::FlushParent(FlushType aFlushType)
 {
-  mMatches = false;
-
   if (!mDocument) {
     return;
   }
 
   if (mDocument->GetParentDocument()) {
-    // Flush frames on the parent so our prescontext will get
-    // recreated as needed.
-    mDocument->GetParentDocument()->FlushPendingNotifications(FlushType::Frames);
-    // That might have killed our document, so recheck that.
-    if (!mDocument) {
-      return;
-    }
+    mDocument->GetParentDocument()->FlushPendingNotifications(aFlushType);
+    // Note that mDocument may now be null.
+  }
+}
+
+void
+MediaQueryList::RecomputeMatches()
+{
+  mMatches = false;
+
+  // Flush frames on the parent so our prescontext will get recreated as
+  // needed.
+  FlushParent(FlushType::Frames);
+
+  if (!mDocument) {
+    return;
   }
 
   nsPresContext* presContext = mDocument->GetPresContext();
   if (!presContext) {
     // XXXbz What's the right behavior here?  Spec doesn't say.
     return;
   }
 
diff --git a/layout/style/MediaQueryList.h b/layout/style/MediaQueryList.h
--- a/layout/style/MediaQueryList.h
+++ b/layout/style/MediaQueryList.h
@@ -11,16 +11,17 @@
 
 #include "nsISupports.h"
 #include "nsCycleCollectionParticipant.h"
 #include "nsCOMPtr.h"
 #include "nsTArray.h"
 #include "mozilla/LinkedList.h"
 #include "mozilla/Attributes.h"
 #include "nsWrapperCache.h"
+#include "mozilla/FlushType.h"
 #include "mozilla/DOMEventTargetHelper.h"
 #include "mozilla/dom/MediaQueryListBinding.h"
 
 class nsIDocument;
 
 namespace mozilla {
 namespace dom {
 
@@ -65,16 +66,17 @@ public:
   IMPL_EVENT_HANDLER(change)
 
   bool HasListeners();
 
   void Disconnect();
 
 private:
   void RecomputeMatches();
+  void FlushParent(FlushType aFlushType);
 
   // We only need a pointer to the document to support lazy
   // reevaluation following dynamic changes.  However, this lazy
   // reevaluation is perhaps somewhat important, since some usage
   // patterns may involve the creation of large numbers of
   // MediaQueryList objects which almost immediately become garbage
   // (after a single call to the .matches getter).
   //

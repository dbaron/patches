From: L. David Baron <dbaron@dbaron.org>

Bug 1011468:  Add necessary flushes to MediaQueryList implementation.

Bug 753777 added a flush of layout in the parent in
nsGlobalWindow::MatchMedia, but that flush isn't sufficient when layout
changes happen between the call to matchMedia and the call to the
matches getter.

TODO: write test

diff --git a/layout/style/MediaQueryList.cpp b/layout/style/MediaQueryList.cpp
--- a/layout/style/MediaQueryList.cpp
+++ b/layout/style/MediaQueryList.cpp
@@ -67,16 +67,28 @@ void
 MediaQueryList::GetMedia(nsAString &aMedia)
 {
   mMediaList->GetText(aMedia);
 }
 
 bool
 MediaQueryList::Matches()
 {
+  // Ensure that our parent's layout is up-to-date so that our size will
+  // be up-to-date.
+  if (mPresContext) {
+    nsPresContext *parentPresContext = mPresContext->GetParentPresContext();
+    if (parentPresContext) {
+      nsIPresShell *parentShell = mPresContext->GetPresShell();
+      if (parentShell) {
+        parentShell->FlushPendingNotifications(Flush_Layout);
+      }
+    }
+  }
+
   if (!mMatchesValid) {
     NS_ABORT_IF_FALSE(!HasListeners(),
                       "when listeners present, must keep mMatches current");
     RecomputeMatches();
   }
 
   return mMatches;
 }

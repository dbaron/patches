From: L. David Baron <dbaron@dbaron.org>

Add necessary flushes to nsDOMMediaQueryList implementation.  (Followup to bug 753777)

TODO: write test

diff --git a/layout/style/nsDOMMediaQueryList.cpp b/layout/style/nsDOMMediaQueryList.cpp
--- a/layout/style/nsDOMMediaQueryList.cpp
+++ b/layout/style/nsDOMMediaQueryList.cpp
@@ -60,16 +60,28 @@ nsDOMMediaQueryList::GetMedia(nsAString 
 {
   mMediaList->GetText(aMedia);
   return NS_OK;
 }
 
 NS_IMETHODIMP
 nsDOMMediaQueryList::GetMatches(bool *aMatches)
 {
+  // Ensure that our parent's layout is up-to-date so that our size will
+  // be up-to-date.
+  if (mPresContext) {
+    nsPresContext *parentPresContext = mPresContext->GetParentPresContext();
+    if (parentPresContext) {
+      nsIPresShell *parentShell = mPresContext->GetPresShell();
+      if (parentShell) {
+        parentShell->FlushPendingNotifications(Flush_Layout);
+      }
+    }
+  }
+
   if (!mMatchesValid) {
     NS_ABORT_IF_FALSE(!HasListeners(),
                       "when listeners present, must keep mMatches current");
     RecomputeMatches();
   }
 
   *aMatches = mMatches;
   return NS_OK;

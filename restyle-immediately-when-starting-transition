From: L. David Baron <dbaron@dbaron.org>

Bug 960465 patch N - Part 1 of switching from posting restyle for animation to immediately restyling:  do the immediate restyle when we start transitions.

This makes the way we start transitions more like the way we start
animations.

FIXME:  This is wrong per the spec and conceptually -- we actually need
to continue to post a restyle when we start transitions, because we need
the without-transition style data to consider behavior on descendants.

(Likewise, we need to make sure that the after-change style we use for
descendants *excludes* any changed transitions.)

But we do still need, as this patch does, to add the transitions styles
for transitions that didn't change (but not the ones that did).  (The
spec currently wants the old state of the transitions that did change,
but that's wrong, because it breaks cancelling of descendant transitions
being symmetric with their starting.)

diff --git a/layout/base/RestyleManager.cpp b/layout/base/RestyleManager.cpp
--- a/layout/base/RestyleManager.cpp
+++ b/layout/base/RestyleManager.cpp
@@ -1975,16 +1975,21 @@ RestyleManager::TryStartingTransition(ns
                                         aNewStyleContext /* inout */)
 {
   if (!aContent || !aContent->IsElement()) {
     return;
   }
 
   bool startedAny = aPresContext->TransitionManager()->StyleContextChanged(
     aContent->AsElement(), aOldStyleContext, *aNewStyleContext);
+  if (startedAny) {
+    *aNewStyleContext = aPresContext->StyleSet()->ResolveStyleWithReplacement(
+      aContent->AsElement(), (*aNewStyleContext)->GetParent(),
+      *aNewStyleContext, eRestyle_CSSTransitions);
+  }
 }
 
 static dom::Element*
 ElementForStyleContext(nsIContent* aParentContent,
                        nsIFrame* aFrame,
                        nsCSSPseudoElements::Type aPseudoType)
 {
   // We don't expect XUL tree stuff here.

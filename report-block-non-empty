From: L. David Baron <dbaron@dbaron.org>

Bug 451791 patch 2 - Report block non-empty to its parent block during margin collapsing if we encounter clearance.

The goal of ComputeCollapsedBStartMargin is to collapse all of the
margins that collapse with a block's top margin.  It does this by
scanning forward through the child list until it finds something that
blocks collapsing; it descends into children through recursion.  When we
find a non-empty child or line, we stop collapsing and report to the
parent that the child is non-empty so that it stops collapsing as well.

This patch changes our behavior when we have clearance to do the same
thing that we do for non-empty lines or blocks.  Without the patch we
would fail to report being non-empty to the parent (and instead report
emptiness based on the IsEmpty() method).  This meant that, prior to
this patch, if the child has a block with clearance but also has
IsEmpty() true, we would stop scanning margins in the child at the
clearance, but continue searching for margins in the parent after the
block that contained a child with clearance.

diff --git a/layout/generic/nsBlockReflowContext.cpp b/layout/generic/nsBlockReflowContext.cpp
--- a/layout/generic/nsBlockReflowContext.cpp
+++ b/layout/generic/nsBlockReflowContext.cpp
@@ -131,16 +131,20 @@ nsBlockReflowContext::ComputeCollapsedBS
         if (line->IsInline()) {
           isEmpty = line->IsEmpty();
         } else {
           nsIFrame* kid = line->mFirstChild;
           if (kid == aClearanceFrame) {
             line->SetHasClearance();
             line->MarkDirty();
             dirtiedLine = true;
+            if (!setBlockIsEmpty && aBlockIsEmpty) {
+              setBlockIsEmpty = true;
+              *aBlockIsEmpty = false;
+            }
             goto done;
           }
           // Here is where we recur. Now that we have determined that a
           // generational collapse is required we need to compute the
           // child blocks margin and so in so that we can look into
           // it. For its margins to be computed we need to have a reflow
           // state for it.
 

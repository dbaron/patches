From: L. David Baron <dbaron@dbaron.org>

Back out changeset 85e5b0ed7081, which was landed with the wrong bug number (really bug 667947, but marked as bug 667948) in order to reland it.

diff --git a/content/canvas/src/nsCanvasRenderingContext2D.cpp b/content/canvas/src/nsCanvasRenderingContext2D.cpp
--- a/content/canvas/src/nsCanvasRenderingContext2D.cpp
+++ b/content/canvas/src/nsCanvasRenderingContext2D.cpp
@@ -2588,17 +2588,17 @@ struct NS_STACK_CLASS nsCanvasBidiProces
 
         // this only measures the height; the total width is gotten from the
         // the return value of ProcessText.
         if (mDoMeasureBoundingBox) {
             textRunMetrics.mBoundingBox.Scale(1.0 / mAppUnitsPerDevPixel);
             mBoundingBox = mBoundingBox.Union(textRunMetrics.mBoundingBox);
         }
 
-        return NSToCoordRound(textRunMetrics.mAdvanceWidth);
+        return static_cast<nscoord>(textRunMetrics.mAdvanceWidth/gfxFloat(mAppUnitsPerDevPixel));
     }
 
     virtual void DrawText(nscoord xOffset, nscoord width)
     {
         gfxPoint point = mPt;
         point.x += xOffset * mAppUnitsPerDevPixel;
 
         // offset is given in terms of left side of string
@@ -2739,35 +2739,34 @@ nsCanvasRenderingContext2D::DrawOrMeasur
     processor.mThebes = mThebes;
     processor.mOp = aOp;
     processor.mBoundingBox = gfxRect(0, 0, 0, 0);
     processor.mDoMeasureBoundingBox = doDrawShadow || !mIsEntireFrameInvalid;
 
     processor.mFontgrp = GetCurrentFontStyle();
     NS_ASSERTION(processor.mFontgrp, "font group is null");
 
-    nscoord totalWidthCoord;
+    nscoord totalWidth;
 
     // calls bidi algo twice since it needs the full text width and the
     // bounding boxes before rendering anything
     rv = bidiUtils->ProcessText(textToDraw.get(),
                                 textToDraw.Length(),
                                 isRTL ? NSBIDI_RTL : NSBIDI_LTR,
                                 presShell->GetPresContext(),
                                 processor,
                                 nsBidiPresUtils::MODE_MEASURE,
                                 nsnull,
                                 0,
-                                &totalWidthCoord);
+                                &totalWidth);
     if (NS_FAILED(rv))
         return rv;
 
-    float totalWidth = float(totalWidthCoord) / processor.mAppUnitsPerDevPixel;
     if (aWidth)
-        *aWidth = totalWidth;
+        *aWidth = static_cast<float>(totalWidth);
 
     // if only measuring, don't need to do any more work
     if (aOp==TEXT_DRAW_OPERATION_MEASURE)
         return NS_OK;
 
     // offset pt.x based on text align
     gfxFloat anchorX;
 

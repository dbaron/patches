From: L. David Baron <dbaron@dbaron.org>

Bug 847287 patch 1 - Add additional tests.

FIXME: Make things pass the last few tests relating to picking up the
previously-overridden animation on the compositor.

FIXME: Push this deeper in the patch queue.

diff --git a/layout/style/test/test_animations_omta.html b/layout/style/test/test_animations_omta.html
--- a/layout/style/test/test_animations_omta.html
+++ b/layout/style/test/test_animations_omta.html
@@ -2093,10 +2093,89 @@ addAsyncAnimTest(function *() {
           "opacity animation overriding transition at 0s");
   advance_clock(500);
   yield waitForPaintsFlushed();
   omta_is("opacity", 0.35, RunningOn.Compositor,
           "opacity animation overriding transition at 0.5s");
   done_div();
 });
 
+// Bug 847287 - Test that changes of when an animation is dynamically
+// overridden work correctly.
+addAsyncAnimTest(function *() {
+  advance_clock(0);
+
+  // anim2 and anim3 are both animations from opacity 0 to 1
+
+  new_div("animation: anim2 1s linear forwards; opacity: 0.5 ! important");
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.5, RunningOn.MainThread,
+          "opacity overriding animation at start (0s)");
+  advance_clock(750);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.5, RunningOn.MainThread,
+          "opacity overriding animation while running (750ms)");
+  advance_clock(1000);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.5, RunningOn.MainThread,
+          "opacity overriding animation while filling (1750ms)");
+  done_div();
+
+  new_div("animation: anim2 1s linear; opacity: 0.5 ! important");
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.5, RunningOn.MainThread,
+          "opacity overriding animation at start (0s)");
+  advance_clock(750);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.5, RunningOn.MainThread,
+          "opacity overriding animation while running (750ms)");
+  advance_clock(1000);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.5, RunningOn.MainThread,
+          "opacity overriding animation after complete (1750ms)");
+  done_div();
+
+  // One animation overriding another, and then not.
+  new_div("animation: anim2 1s linear, anim3 500ms linear reverse");
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 1, RunningOn.Compositor,
+          "anim3 overriding anim2 at start (0s)");
+  advance_clock(400);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.2, RunningOn.Compositor,
+          "anim3 overriding anim2 at 400ms");
+  advance_clock(200);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.6, RunningOn.Compositor,
+          "anim2 at 600ms");
+  done_div();
+
+  // One animation overriding another, and then not, but without a
+  // restyle when the overriding one ends.
+  new_div("animation: anim2 1s steps(8, end)");
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0, RunningOn.Compositor,
+          "anim2 at start (0s)");
+  advance_clock(300);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.25, RunningOn.Compositor,
+          "anim2 at 300ms");
+  gDiv.style.animation = "anim2 1s steps(8, end), anim3 500ms steps(4, end)";
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0, RunningOn.Compositor,
+          "anim3 overriding anim2 at 300ms");
+  advance_clock(475);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.75, RunningOn.Compositor,
+          "anim3 the same as anim2 at 775ms");
+  advance_clock(50);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.75, RunningOn.Compositor,
+          "anim2 at 825ms");
+  advance_clock(75);
+  yield waitForPaintsFlushed();
+  omta_is("opacity", 0.875, RunningOn.Compositor,
+          "anim2 at 900ms");
+  done_div();
+});
+
 </script>
 </html>

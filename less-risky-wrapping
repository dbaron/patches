Do wrapping of kids only for display:-moz-inline-box to introduce less risk for chrome.  b=321402

diff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp
+++ b/layout/base/nsCSSFrameConstructor.cpp
@@ -462,6 +462,18 @@ IsInlineFrame(const nsIFrame* aFrame)
   return aFrame->IsFrameOfType(nsIFrame::eLineParticipant);
 }
 
+// Since the way we wrap kids of a box in a block if they need to be in
+// a line is far from ideal, only do it (and change handling of XUL) for
+// the case that's relevant to Web pages:  where the box has display:
+// -moz-inline-box.  If we had better wrapping we'd probably want to do
+// this for all box frames.
+inline PRBool
+BoxSubjectToWrappingKids(nsIFrame *aFrame)
+{
+  return aFrame->IsBoxFrame() &&
+         aFrame->GetStyleDisplay()->mDisplay == NS_STYLE_DISPLAY_INLINE_BOX;
+}
+
 /**
  * If any children require a block parent, return the first such child.
  * Otherwise return null.
@@ -6226,7 +6238,7 @@ nsCSSFrameConstructor::ConstructXULFrame
         rv = ProcessChildren(aState, aContent, newFrame, PR_FALSE,
                              childItems, PR_FALSE);
         nsIContent *badKid;
-        if (newFrame->IsBoxFrame() &&
+        if (BoxSubjectToWrappingKids(newFrame) &&
             (badKid = AnyKidsNeedBlockParent(childItems.childList))) {
           nsAutoString parentTag, kidTag;
           aContent->Tag()->ToString(parentTag);
@@ -9649,7 +9661,7 @@ nsCSSFrameConstructor::ContentRemoved(ns
     // (If we're in the XUL block-wrapping situation, parentFrame is the
     // wrapper frame.)
     nsIFrame* grandparentFrame = parentFrame->GetParent();
-    if (grandparentFrame && grandparentFrame->IsBoxFrame() &&
+    if (grandparentFrame && BoxSubjectToWrappingKids(grandparentFrame) &&
         (grandparentFrame->GetStateBits() & NS_STATE_BOX_WRAPS_KIDS_IN_BLOCK) &&
         // check if this frame is the only one needing wrapping
         aChild == AnyKidsNeedBlockParent(parentFrame->GetFirstChild(nsnull)) &&
@@ -12983,7 +12995,7 @@ nsCSSFrameConstructor::WipeContainingBlo
 
   // Situation #1 is a XUL frame that contains frames that are required
   // to be wrapped in blocks.
-  if (aFrame->IsBoxFrame() &&
+  if (BoxSubjectToWrappingKids(aFrame) &&
       !(aFrame->GetStateBits() & NS_STATE_BOX_WRAPS_KIDS_IN_BLOCK) &&
       AnyKidsNeedBlockParent(aFrameList.childList)) {
     DestroyNewlyCreatedFrames(aState, aFrame, aFrameList);

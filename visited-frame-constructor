From: L. David Baron <dbaron@dbaron.org>

More efficient handling of visited changes in nsCSSFrameConstructor.  (Bug 557579)

diff --git a/layout/base/nsCSSFrameConstructor.cpp b/layout/base/nsCSSFrameConstructor.cpp
--- a/layout/base/nsCSSFrameConstructor.cpp
+++ b/layout/base/nsCSSFrameConstructor.cpp
@@ -8084,24 +8084,33 @@ nsCSSFrameConstructor::DoContentStateCha
           if (repaint) {
             NS_UpdateHint(hint, nsChangeHint_RepaintFrame);
           }
         }
       }
     }
   }
 
-  nsRestyleHint rshint = 
-    styleSet->HasStateDependentStyle(presContext, aElement, aStateMask);
-      
+  // Don't bother checking for visited/unvisited-dependent style; we
+  // handle that below.
+  PRInt32 checkStateMask =
+    aStateMask & ~(NS_EVENT_STATE_VISITED | NS_EVENT_STATE_UNVISITED);
+  nsRestyleHint rshint;
+  if (checkStateMask != 0) {
+    rshint =
+      styleSet->HasStateDependentStyle(presContext, aElement, checkStateMask);
+  } else {
+    rshint = nsRestyleHint(0);
+  }
+
   if ((aStateMask & NS_EVENT_STATE_HOVER) && rshint != 0) {
     ++mHoverGeneration;
   }
 
-  if (aStateMask & NS_EVENT_STATE_VISITED) {
+  if (aStateMask & (NS_EVENT_STATE_VISITED | NS_EVENT_STATE_UNVISITED)) {
     // Exposing information to the page about whether the link is
     // visited or not isn't really something we can worry about here.
     // FIXME: We could probably do this a bit better.
     NS_UpdateHint(hint, nsChangeHint_RepaintFrame);
   }
 
   PostRestyleEvent(aElement, rshint, hint);
 }

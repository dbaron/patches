From: L. David Baron <dbaron@dbaron.org>

Honor the "gfx.color_management.force_srgb" when it is set as a default pref in addition to when it is set as a user pref.  (Bug 608030)  r=jrmuizel  a2.0=blocking2.0:betaN+

diff --git a/gfx/thebes/gfxPlatform.cpp b/gfx/thebes/gfxPlatform.cpp
--- a/gfx/thebes/gfxPlatform.cpp
+++ b/gfx/thebes/gfxPlatform.cpp
@@ -958,24 +958,26 @@ gfxPlatform::GetCMSOutputProfile()
         NS_TIME_FUNCTION;
 
         nsCOMPtr<nsIPrefBranch> prefs = do_GetService(NS_PREFSERVICE_CONTRACTID);
         if (prefs) {
 
             nsresult rv;
 
             /* Determine if we're using the internal override to force sRGB as
-               an output profile for reftests. See Bug 452125. */
-            PRBool hasSRGBOverride, doSRGBOverride;
-            rv = prefs->PrefHasUserValue(CMForceSRGBPrefName, &hasSRGBOverride);
-            if (NS_SUCCEEDED(rv) && hasSRGBOverride) {
-                rv = prefs->GetBoolPref(CMForceSRGBPrefName, &doSRGBOverride);
-                if (NS_SUCCEEDED(rv) && doSRGBOverride)
-                    gCMSOutputProfile = GetCMSsRGBProfile();
-            }
+               an output profile for reftests. See Bug 452125.
+
+               Note that we don't normally (outside of tests) set a
+               default value of this preference, which means GetBoolPref
+               will typically throw (and leave its out-param untouched).
+             */
+            PRBool doSRGBOverride;
+            rv = prefs->GetBoolPref(CMForceSRGBPrefName, &doSRGBOverride);
+            if (NS_SUCCEEDED(rv) && doSRGBOverride)
+                gCMSOutputProfile = GetCMSsRGBProfile();
 
             if (!gCMSOutputProfile) {
 
                 nsXPIDLCString fname;
                 rv = prefs->GetCharPref(CMProfilePrefName,
                                         getter_Copies(fname));
                 if (NS_SUCCEEDED(rv) && !fname.IsEmpty()) {
                     gCMSOutputProfile = qcms_profile_from_path(fname);

From: L. David Baron <dbaron@dbaron.org>

Bug 837211 patch 3:  Off-by-default preference for testing the effect of supporting -webkit- prefixes or unprefixed properties.

FIXME: Test that names are all correct

FIXME: Add aliases for transition/animation events.

FIXME:
<dbaron> bz, were you aware that Webkit accepts element.style.WebkitTransform or element.style.webkitTransform (either case), but only lowercase shows up when you enumerate?
<bz> dbaron: no, I was not
<bz> dbaron: I knew it accepted element.style["-webkit-transform"]
<bz> dbaron: that's interesting....

diff --git a/layout/style/Makefile.in b/layout/style/Makefile.in
--- a/layout/style/Makefile.in
+++ b/layout/style/Makefile.in
@@ -163,8 +163,17 @@ GARBAGE		+= $(addprefix $(DIST)/bin/res/
 
 libs:: $(_FILES)
 	$(INSTALL) $^ $(DIST)/bin/res
 
 install:: $(_FILES)
 	$(SYSINSTALL) $(IFLAGS1) $^ $(DESTDIR)$(mozappdir)/res
 
 DEFINES += -D_IMPL_NS_LAYOUT
+
+# See comment in nsCSSPropAliasList.h .
+# Note, this is in both layout/style/Makefile.in and
+# layout/style/test/Makefile.in
+ifeq (,$(findstring a,$(GRE_MILESTONE)))
+DEFINES += -DWEBKIT_PREFIX_PREF="layout.css.test-webkit-prefixes"
+else
+DEFINES += -DWEBKIT_PREFIX_PREF=""
+endif
diff --git a/layout/style/nsCSSParser.cpp b/layout/style/nsCSSParser.cpp
--- a/layout/style/nsCSSParser.cpp
+++ b/layout/style/nsCSSParser.cpp
@@ -1610,16 +1610,18 @@ CSSParserImpl::ParseAtRule(RuleAppendFun
     newSection = eCSSSection_General;
 
   } else if (mToken.mIdent.LowerCaseEqualsLiteral("page")) {
     parseFunc = &CSSParserImpl::ParsePageRule;
     newSection = eCSSSection_General;
 
   } else if ((nsCSSProps::IsEnabled(eCSSPropertyAlias_MozAnimation) &&
               mToken.mIdent.LowerCaseEqualsLiteral("-moz-keyframes")) ||
+             (nsCSSProps::IsEnabled(eCSSPropertyAlias_WebkitAnimation) &&
+              mToken.mIdent.LowerCaseEqualsLiteral("-webkit-keyframes")) ||
              mToken.mIdent.LowerCaseEqualsLiteral("keyframes")) {
     parseFunc = &CSSParserImpl::ParseKeyframesRule;
     newSection = eCSSSection_General;
 
   } else if (mToken.mIdent.LowerCaseEqualsLiteral("supports") &&
              CSSSupportsRule::PrefEnabled()) {
     parseFunc = &CSSParserImpl::ParseSupportsRule;
     newSection = eCSSSection_General;
diff --git a/layout/style/nsCSSPropAliasList.h b/layout/style/nsCSSPropAliasList.h
--- a/layout/style/nsCSSPropAliasList.h
+++ b/layout/style/nsCSSPropAliasList.h
@@ -136,8 +136,188 @@ CSS_PROP_ALIAS(-moz-animation-play-state
                MozAnimationPlayState,
                0,
               "layout.css.prefixes.animations")
 CSS_PROP_ALIAS(-moz-animation-timing-function,
                animation_timing_function,
                MozAnimationTimingFunction,
                0,
               "layout.css.prefixes.animations")
+
+// WEBKIT_PREFIX_PREF is defined to be "layout.css.test-webkit-prefixes"
+// in builds with nightly/aurora versions, but the empty string in
+// builds with beta/release versions (which means that there is no
+// preference, but the CSS_PROPERTY_DISABLED_BY_DEFAULT flags disables
+// support for the property always).
+
+// -webkit- prefixes
+CSS_PROP_ALIAS(-webkit-animation,
+               animation,
+               WebkitAnimation,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-delay,
+               animation_delay,
+               WebkitAnimationDelay,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-direction,
+               animation_direction,
+               WebkitAnimationDirection,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-duration,
+               animation_duration,
+               WebkitAnimationDuration,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-fill-mode,
+               animation_fill_mode,
+               WebkitAnimationFillMode,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-iteration-count,
+               animation_iteration_count,
+               WebkitAnimationIterationCount,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-name,
+               animation_name,
+               WebkitAnimationName,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-play-state,
+               animation_play_state,
+               WebkitAnimationPlayState,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-animation-timing-function,
+               animation_timing_function,
+               WebkitAnimationTimingFunction,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+
+CSS_PROP_ALIAS(-webkit-text-size-adjust,
+               text_size_adjust,
+               WebkitTextSizeAdjust,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+
+CSS_PROP_ALIAS(-webkit-transform,
+               transform,
+               WebkitTransform,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-transform-origin,
+               transform_origin,
+               WebkitTransformOrigin,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-transform-style,
+               transform_style,
+               WebkitTransformStyle,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+
+CSS_PROP_ALIAS(-webkit-transition,
+               transition,
+               WebkitTransition,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-transition-delay,
+               transition_delay,
+               WebkitTransitionDelay,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-transition-duration,
+               transition_duration,
+               WebkitTransitionDuration,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-transition-property,
+               transition_property,
+               WebkitTransitionProperty,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-transition-timing-function,
+               transition_timing_function,
+               WebkitTransitionTimingFunction,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+
+CSS_PROP_ALIAS(-webkit-border-radius,
+               border_radius,
+               WebkitBorderRadius,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-border-top-left-radius,
+               border_top_left_radius,
+               WebkitBorderTopLeftRadius, // really no dom property
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-border-top-right-radius,
+               border_top_right_radius,
+               WebkitBorderTopRightRadius, // really no dom property
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-border-bottom-left-radius,
+               border_bottom_left_radius,
+               WebkitBorderBottomLeftRadius, // really no dom property
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-border-bottom-right-radius,
+               border_bottom_right_radius,
+               WebkitBorderBottomRightRadius, // really no dom property
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+
+CSS_PROP_ALIAS(-webkit-appearance,
+               appearance,
+               WebkitAppearance,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-background-clip,
+               background_clip,
+               WebkitBackgroundClip,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-background-origin,
+               background_origin,
+               WebkitBackgroundOrigin,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-background-size,
+               background_size,
+               WebkitBackgroundSize,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-border-image,
+               border_image,
+               WebkitBorderImage,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-box-shadow,
+               box_shadow,
+               WebkitBoxShadow,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(-webkit-user-select,
+               user_select,
+               WebkitUserSelect,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+
+// no prefixes
+CSS_PROP_ALIAS(text-size-adjust,
+               text_size_adjust,
+               TextSizeAdjust,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(appearance,
+               appearance,
+               Appearance,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
+CSS_PROP_ALIAS(user-select,
+               user_select,
+               UserSelect,
+               CSS_PROPERTY_DISABLED_BY_DEFAULT,
+               WEBKIT_PREFIX_PREF)
diff --git a/layout/style/test/Makefile.in b/layout/style/test/Makefile.in
--- a/layout/style/test/Makefile.in
+++ b/layout/style/test/Makefile.in
@@ -248,8 +248,17 @@ css_properties.js: host_ListCSSPropertie
 	$(RM) $@
 	./host_ListCSSProperties$(HOST_BIN_SUFFIX) > $@
 	cat $(srcdir)/css_properties_like_longhand.js >> $@
 
 GARBAGE += css_properties.js
 
 libs:: $(_VISITED_REFTEST_FILES)
 	$(INSTALL) $(foreach f,$^,"$f") $(DEPTH)/_tests/testing/mochitest/tests/$(relativesrcdir)/css-visited/
+
+# See comment in nsCSSPropAliasList.h .
+# Note, this is in both layout/style/Makefile.in and
+# layout/style/test/Makefile.in
+ifeq (,$(findstring a,$(GRE_MILESTONE)))
+DEFINES += -DWEBKIT_PREFIX_PREF="layout.css.test-webkit-prefixes"
+else
+DEFINES += -DWEBKIT_PREFIX_PREF=""
+endif

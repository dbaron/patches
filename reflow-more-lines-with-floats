From: L. David Baron <dbaron@dbaron.org>

In a constrained height situation, we need to reflow anything with floats.  (Bug 563584)  Fixes assertion on layout/generic/crashtests/408883-1.html .  (FIXME: This reflows too much.  See also FIXMEs inside.)

diff --git a/layout/generic/nsBlockFrame.cpp b/layout/generic/nsBlockFrame.cpp
--- a/layout/generic/nsBlockFrame.cpp
+++ b/layout/generic/nsBlockFrame.cpp
@@ -1861,16 +1861,31 @@ nsBlockFrame::ReflowDirtyLines(nsBlockRe
       line->MarkDirty();
       line->ClearPreviousMarginDirty();
     } else if (line->mBounds.YMost() + deltaY > aState.mBottomEdge) {
       // Lines that aren't dirty but get slid past our height constraint must
       // be reflowed.
       line->MarkDirty();
     }
 
+    // If we have a constrained height (i.e., breaking columns/pages),
+    // and the distance to the bottom might have changed, then we need
+    // to reflow any line that might have floats in it, both because the
+    // breakpoints within those floats may have changed and because we
+    // might have to push/pull the floats in their entirety.
+    // FIXME: What about a deltaY or height change that forces us to
+    // push lines?  Why does that work?
+    if (!line->IsDirty() &&
+        aState.mReflowState.availableHeight != NS_UNCONSTRAINEDSIZE &&
+        (deltaY != 0 || aState.mReflowState.mFlags.mVResize)
+        // FIXME: Lines that had floats pushed are unmarked?
+        /* && (line->IsBlock() || line->HasFloats())*/ ) {
+      line->MarkDirty();
+    }
+
     if (!line->IsDirty()) {
       // See if there's any reflow damage that requires that we mark the
       // line dirty.
       PropagateFloatDamage(aState, line, deltaY);
     }
 
     if (needToRecoverState && line->IsDirty()) {
       // We need to reconstruct the bottom margin only if we didn't

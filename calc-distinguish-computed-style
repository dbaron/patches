From: L. David Baron <dbaron@dbaron.org>

Distinguish between 50% and calc(50%), etc., in computed style calc expressions.  (Bug 585715)  a2.0=blocking2.0+

diff --git a/layout/style/CSSCalc.h b/layout/style/CSSCalc.h
--- a/layout/style/CSSCalc.h
+++ b/layout/style/CSSCalc.h
@@ -149,42 +149,43 @@ ComputeCalc(const typename CalcOps::inpu
     }
     default: {
       return aOps.ComputeLeafValue(aValue);
     }
   }
 }
 
 #define CHECK_UNIT(u_)                                                        \
-  PR_STATIC_ASSERT(int(eCSSUnit_Calc_##u_) + 14 == int(eStyleUnit_Calc_##u_));\
-  PR_STATIC_ASSERT(eCSSUnit_Calc_##u_ >= eCSSUnit_Calc_Plus);                 \
-  PR_STATIC_ASSERT(eCSSUnit_Calc_##u_ <= eCSSUnit_Calc_Maximum);
+  PR_STATIC_ASSERT(int(eCSSUnit_##u_) + 14 == int(eStyleUnit_##u_));          \
+  PR_STATIC_ASSERT(eCSSUnit_##u_ >= eCSSUnit_Calc);                           \
+  PR_STATIC_ASSERT(eCSSUnit_##u_ <= eCSSUnit_Calc_Maximum);
 
-CHECK_UNIT(Plus)
-CHECK_UNIT(Minus)
-CHECK_UNIT(Times_L)
-CHECK_UNIT(Times_R)
-CHECK_UNIT(Divided)
-CHECK_UNIT(Minimum)
-CHECK_UNIT(Maximum)
+CHECK_UNIT(Calc)
+CHECK_UNIT(Calc_Plus)
+CHECK_UNIT(Calc_Minus)
+CHECK_UNIT(Calc_Times_L)
+CHECK_UNIT(Calc_Times_R)
+CHECK_UNIT(Calc_Divided)
+CHECK_UNIT(Calc_Minimum)
+CHECK_UNIT(Calc_Maximum)
 
 #undef CHECK_UNIT
 
 inline nsStyleUnit
 ConvertCalcUnit(nsCSSUnit aUnit)
 {
-  NS_ABORT_IF_FALSE(eCSSUnit_Calc_Plus <= aUnit &&
+  NS_ABORT_IF_FALSE(eCSSUnit_Calc <= aUnit &&
                     aUnit <= eCSSUnit_Calc_Maximum, "out of range");
   return nsStyleUnit(aUnit + 14);
 }
 
 inline nsCSSUnit
 ConvertCalcUnit(nsStyleUnit aUnit)
 {
-  NS_ABORT_IF_FALSE(eStyleUnit_Calc_Plus <= aUnit &&
+  NS_ABORT_IF_FALSE(eStyleUnit_Calc <= aUnit &&
                     aUnit <= eStyleUnit_Calc_Maximum, "out of range");
   return nsCSSUnit(aUnit - 14);
 }
 
 /**
  * The input unit operation for input_type being nsCSSValue.
  */
 struct CSSValueInputCalcOps
diff --git a/layout/style/nsRuleNode.cpp b/layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp
+++ b/layout/style/nsRuleNode.cpp
@@ -505,16 +505,24 @@ struct SpecifiedToComputedCalcOps : publ
 static void
 SpecifiedCalcToComputedCalc(const nsCSSValue& aValue, nsStyleCoord& aCoord, 
                             nsStyleContext* aStyleContext,
                             PRBool& aCanStoreInRuleTree)
 {
   SpecifiedToComputedCalcOps ops(aStyleContext, aStyleContext->PresContext(),
                                  aCanStoreInRuleTree);
   aCoord = ComputeCalc(aValue, ops);
+  if (!aCoord.IsCalcUnit()) {
+    // Some callers distinguish between calc(50%) and 50%, or calc(50px)
+    // and 50px.
+    nsStyleCoord::Array *array =
+      nsStyleCoord::Array::Create(aStyleContext, aCanStoreInRuleTree, 1);
+    array->Item(0) = aCoord;
+    aCoord.SetArrayValue(array, eStyleUnit_Calc);
+  }
 }
 
 struct ComputeComputedCalcCalcOps : public css::StyleCoordInputCalcOps,
                                     public css::BasicCoordCalcOps
 {
   const nscoord mPercentageBasis;
 
   ComputeComputedCalcCalcOps(nscoord aPercentageBasis)
diff --git a/layout/style/nsStyleCoord.h b/layout/style/nsStyleCoord.h
--- a/layout/style/nsStyleCoord.h
+++ b/layout/style/nsStyleCoord.h
@@ -55,22 +55,22 @@ enum nsStyleUnit {
   eStyleUnit_Percent      = 10,     // (float) 1.0 == 100%
   eStyleUnit_Factor       = 11,     // (float) a multiplier
   eStyleUnit_Degree       = 12,     // (float) angle in degrees
   eStyleUnit_Grad         = 13,     // (float) angle in grads
   eStyleUnit_Radian       = 14,     // (float) angle in radians
   eStyleUnit_Coord        = 20,     // (nscoord) value is twips
   eStyleUnit_Integer      = 30,     // (int) value is simple integer
   eStyleUnit_Enumerated   = 32,     // (int) value has enumerated meaning
-  // The following are all of the eCSSUnit_Calc_* types (but not
-  // eCSSUnit_Calc itself, since we don't need to distinguish
-  // calc(min()) from min() in compute dstyle).  They are all weak
+  // The following are all of the eCSSUnit_Calc_* types.  They are weak
   // pointers to a calc tree allocated by nsStyleContext::Alloc.
   // NOTE:  They are in the same order as the eCSSUnit_Calc_* values so
   // that converting between the two sets is just addition/subtraction.
+  eStyleUnit_Calc         = 39,     // (Array*) calc() toplevel, to
+                                    // distinguish 50% from calc(50%), etc.
   eStyleUnit_Calc_Plus    = 40,     // (Array*) + node within calc()
   eStyleUnit_Calc_Minus   = 41,     // (Array*) - within calc
   eStyleUnit_Calc_Times_L = 42,     // (Array*) num * val within calc
   eStyleUnit_Calc_Times_R = 43,     // (Array*) val * num within calc
   eStyleUnit_Calc_Divided = 44,     // (Array*) / within calc
   eStyleUnit_Calc_Minimum = 45,     // (Array*) min() within calc
   eStyleUnit_Calc_Maximum = 46      // (Array*) max() within calc
 };
@@ -116,17 +116,17 @@ public:
     return mUnit;
   }
 
   PRBool IsAngleValue() const {
     return eStyleUnit_Degree <= mUnit && mUnit <= eStyleUnit_Radian;
   }
 
   PRBool IsCalcUnit() const {
-    return eStyleUnit_Calc_Plus <= mUnit && mUnit <= eStyleUnit_Calc_Maximum;
+    return eStyleUnit_Calc <= mUnit && mUnit <= eStyleUnit_Calc_Maximum;
   }
 
   PRBool IsArrayValue() const {
     return IsCalcUnit();
   }
 
   nscoord     GetCoordValue() const;
   PRInt32     GetIntValue() const;

From: L. David Baron <dbaron@dbaron.org>

Bug 1122897 patch 1 - Remove quirk that text-decoration propagates to floats and absolutely positioned elements in quirks mode.  r=dholbert

diff --git a/layout/generic/nsTextFrame.cpp b/layout/generic/nsTextFrame.cpp
--- a/layout/generic/nsTextFrame.cpp
+++ b/layout/generic/nsTextFrame.cpp
@@ -4903,27 +4903,26 @@ nsTextFrame::GetTextDecorations(
     uint8_t display = f->GetDisplay();
     if (display != NS_STYLE_DISPLAY_INLINE &&
         (!nsStyleDisplay::IsRubyDisplayType(display) ||
          display == NS_STYLE_DISPLAY_RUBY_TEXT_CONTAINER) &&
         nsStyleDisplay::IsDisplayTypeInlineOutside(display)) {
       break;
     }
 
-    if (compatMode == eCompatibility_NavQuirks) {
-      // In quirks mode, if we're on an HTML table element, we're done.
-      if (f->GetContent()->IsHTML(nsGkAtoms::table)) {
-        break;
-      }
-    } else {
-      // In standards/almost-standards mode, if we're on an
-      // absolutely-positioned element or a floating element, we're done.
-      if (f->IsFloating() || f->IsAbsolutelyPositioned()) {
-        break;
-      }
+    // In quirks mode, if we're on an HTML table element, we're done.
+    if (compatMode == eCompatibility_NavQuirks &&
+        f->GetContent()->IsHTML(nsGkAtoms::table)) {
+      break;
+    }
+
+    // If we're on an absolutely-positioned element or a floating
+    // element, we're done.
+    if (f->IsFloating() || f->IsAbsolutelyPositioned()) {
+      break;
     }
   }
 }
 
 static float
 GetInflationForTextDecorations(nsIFrame* aFrame, nscoord aInflationMinFontSize)
 {
   if (aFrame->IsSVGText()) {
diff --git a/layout/reftests/text-decoration/reftest.list b/layout/reftests/text-decoration/reftest.list
--- a/layout/reftests/text-decoration/reftest.list
+++ b/layout/reftests/text-decoration/reftest.list
@@ -71,17 +71,17 @@ fuzzy-if(B2G,255,1) == dynamic-underline
 == underline-block-quirks.html underline-block-quirks-ref.html
 != underline-block-quirks.html underline-block-quirks-notref.html
 == underline-inline-block-quirks.html underline-inline-block-quirks-ref.html
 != underline-inline-block-quirks.html underline-inline-block-quirks-notref.html
 == underline-table-caption-quirks.html underline-table-caption-quirks-ref.html
 != underline-table-caption-quirks.html underline-table-caption-quirks-notref.html
 == underline-table-cell-quirks.html underline-table-cell-quirks-ref.html
 != underline-table-cell-quirks.html underline-table-cell-quirks-notref.html
-fails == underline-block-propagation-quirks.html underline-block-propagation-quirks-ref.html # currently too quirky (bug 403524)
+== underline-block-propagation-quirks.html underline-block-propagation-quirks-ref.html
 fails == underline-block-propagation-2-quirks.html underline-block-propagation-2-quirks-ref.html # same problem as previous line (bug 403524)
 == underline-block-standards.html underline-block-standards-ref.html
 != underline-block-standards.html underline-block-standards-notref.html
 == underline-inline-block-standards.html underline-inline-block-standards-ref.html
 != underline-inline-block-standards.html underline-inline-block-standards-notref.html
 == underline-table-caption-standards.html underline-table-caption-standards-ref.html
 != underline-table-caption-standards.html underline-table-caption-standards-notref.html
 == underline-table-cell-standards.html underline-table-cell-standards-ref.html
diff --git a/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html b/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html
--- a/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html
+++ b/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html
@@ -1,34 +1,34 @@
 <title>text-decoration</title>
 
 <h1>text-decoration on a block</h1>
 
   <u>text directly in parent</u>
 
   <div><u>text in block</u></div>
 
-  <div style="float:left; clear: left"><u>text in float</u></div>
+  <div style="float:left; clear: left">text in float</div>
   <div style="clear:left"></div>
 
   <div style="display:inline-block">text in<br>inline-block</div><u>
   </u><div style="display:inline-table">text in<br>inline-table</div>
 
   <div style="height: 2em">
-    <div style="position: absolute"><u>text in abs-pos</u></div>
+    <div style="position: absolute">text in abs-pos</div>
   </div>
 
 <h1>text-decoration on an inline</h1>
 
   <u>text directly in parent</u>
 
   <div><u>text in block</u></div>
 
-  <div style="float:left; clear: left"><u>text in float</u></div>
+  <div style="float:left; clear: left">text in float</div>
   <div style="clear:left"></div>
 
   <div style="display:inline-block">text in<br>inline-block</div><u>
   </u><div style="display:inline-table">text in<br>inline-table</div>
 
   <div style="height: 2em">
-    <div style="position: absolute"><u>text in abs-pos</u></div>
+    <div style="position: absolute">text in abs-pos</div>
   </div>
 

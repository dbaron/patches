From: L. David Baron <dbaron@dbaron.org>

Bug 1122897 - Remove quirk that text-decoration propagates to floats and absolutely positioned elements in quirks mode.

Note that the style element addition to
underline-block-propagation-2-quirks.html and its reference is making a
change already made in the -standards version, and the other change is
reflecting a quirk that is not removed, and that is interoperable.

diff --git a/layout/generic/nsTextFrame.cpp b/layout/generic/nsTextFrame.cpp
--- a/layout/generic/nsTextFrame.cpp
+++ b/layout/generic/nsTextFrame.cpp
@@ -4903,27 +4903,26 @@ nsTextFrame::GetTextDecorations(
     uint8_t display = f->GetDisplay();
     if (display != NS_STYLE_DISPLAY_INLINE &&
         (!nsStyleDisplay::IsRubyDisplayType(display) ||
          display == NS_STYLE_DISPLAY_RUBY_TEXT_CONTAINER) &&
         nsStyleDisplay::IsDisplayTypeInlineOutside(display)) {
       break;
     }
 
-    if (compatMode == eCompatibility_NavQuirks) {
-      // In quirks mode, if we're on an HTML table element, we're done.
-      if (f->GetContent()->IsHTML(nsGkAtoms::table)) {
-        break;
-      }
-    } else {
-      // In standards/almost-standards mode, if we're on an
-      // absolutely-positioned element or a floating element, we're done.
-      if (f->IsFloating() || f->IsAbsolutelyPositioned()) {
-        break;
-      }
+    // In quirks mode, if we're on an HTML table element, we're done.
+    if (compatMode == eCompatibility_NavQuirks &&
+        f->GetContent()->IsHTML(nsGkAtoms::table)) {
+      break;
+    }
+
+    // If we're on an absolutely-positioned element or a floating
+    // element, we're done.
+    if (f->IsFloating() || f->IsAbsolutelyPositioned()) {
+      break;
     }
   }
 }
 
 static float
 GetInflationForTextDecorations(nsIFrame* aFrame, nscoord aInflationMinFontSize)
 {
   if (aFrame->IsSVGText()) {
diff --git a/layout/reftests/text-decoration/reftest.list b/layout/reftests/text-decoration/reftest.list
--- a/layout/reftests/text-decoration/reftest.list
+++ b/layout/reftests/text-decoration/reftest.list
@@ -71,18 +71,18 @@ fuzzy-if(B2G,255,1) == dynamic-underline
 == underline-block-quirks.html underline-block-quirks-ref.html
 != underline-block-quirks.html underline-block-quirks-notref.html
 == underline-inline-block-quirks.html underline-inline-block-quirks-ref.html
 != underline-inline-block-quirks.html underline-inline-block-quirks-notref.html
 == underline-table-caption-quirks.html underline-table-caption-quirks-ref.html
 != underline-table-caption-quirks.html underline-table-caption-quirks-notref.html
 == underline-table-cell-quirks.html underline-table-cell-quirks-ref.html
 != underline-table-cell-quirks.html underline-table-cell-quirks-notref.html
-fails == underline-block-propagation-quirks.html underline-block-propagation-quirks-ref.html # currently too quirky (bug 403524)
-fails == underline-block-propagation-2-quirks.html underline-block-propagation-2-quirks-ref.html # same problem as previous line (bug 403524)
+== underline-block-propagation-quirks.html underline-block-propagation-quirks-ref.html
+== underline-block-propagation-2-quirks.html underline-block-propagation-2-quirks-ref.html
 == underline-block-standards.html underline-block-standards-ref.html
 != underline-block-standards.html underline-block-standards-notref.html
 == underline-inline-block-standards.html underline-inline-block-standards-ref.html
 != underline-inline-block-standards.html underline-inline-block-standards-notref.html
 == underline-table-caption-standards.html underline-table-caption-standards-ref.html
 != underline-table-caption-standards.html underline-table-caption-standards-notref.html
 == underline-table-cell-standards.html underline-table-cell-standards-ref.html
 != underline-table-cell-standards.html underline-table-cell-standards-notref.html
diff --git a/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html b/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html
--- a/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html
+++ b/layout/reftests/text-decoration/text-decoration-propagation-1-quirks-ref.html
@@ -1,34 +1,34 @@
 <title>text-decoration</title>
 
 <h1>text-decoration on a block</h1>
 
   <u>text directly in parent</u>
 
   <div><u>text in block</u></div>
 
-  <div style="float:left; clear: left"><u>text in float</u></div>
+  <div style="float:left; clear: left">text in float</div>
   <div style="clear:left"></div>
 
   <div style="display:inline-block">text in<br>inline-block</div><u>
   </u><div style="display:inline-table">text in<br>inline-table</div>
 
   <div style="height: 2em">
-    <div style="position: absolute"><u>text in abs-pos</u></div>
+    <div style="position: absolute">text in abs-pos</div>
   </div>
 
 <h1>text-decoration on an inline</h1>
 
   <u>text directly in parent</u>
 
   <div><u>text in block</u></div>
 
-  <div style="float:left; clear: left"><u>text in float</u></div>
+  <div style="float:left; clear: left">text in float</div>
   <div style="clear:left"></div>
 
   <div style="display:inline-block">text in<br>inline-block</div><u>
   </u><div style="display:inline-table">text in<br>inline-table</div>
 
   <div style="height: 2em">
-    <div style="position: absolute"><u>text in abs-pos</u></div>
+    <div style="position: absolute">text in abs-pos</div>
   </div>
 
diff --git a/layout/reftests/text-decoration/underline-block-propagation-2-quirks-ref.html b/layout/reftests/text-decoration/underline-block-propagation-2-quirks-ref.html
--- a/layout/reftests/text-decoration/underline-block-propagation-2-quirks-ref.html
+++ b/layout/reftests/text-decoration/underline-block-propagation-2-quirks-ref.html
@@ -1,30 +1,36 @@
 <html><head>
 <title>More tests of propagation of text-decoration</title>
+<style>
+textarea { -moz-appearance: none }
+textarea + textarea { margin-left: 10px }
+</style>
 </head>
 <body>
 <!-- t-d should not propagate to the content of a form control -->
 <form>
 <span style="text-decoration:underline">This text should be underlined.</span><br>
 <textarea rows="2" cols="40">This text should not be underlined.</textarea
 ><textarea rows="2" cols="40" style="text-decoration:line-through"
 >This text should be struck out.</textarea>
 <p style="text-decoration:underline">This text should also be underlined.</p>
 </form>
-<!-- t-d should propagate from parent elements to table-cells -->
+<!-- t-d should propagate from parent elements to table-cells, except
+     not through a table element in quirks mode, per
+     https://quirks.spec.whatwg.org/#the-text-decoration-doesn't-propagate-into-tables-quirk
+     -->
 <div>
   <table>
     <tr>
       <td>
-	<span style="text-decoration:underline">
 	<span style="text-decoration:overline">
 	<span style="text-decoration:line-through">
-	underlined, overlined, and struck out
-	</span></span></span>
+	overlined, and struck out
+	</span></span>
       </td>
     </tr>
   </table>
 </div>
 <!-- t-d on a float itself should apply -->
 <div>
   <p style="text-decoration:underline">This text should be underlined.</p>
   <p style="float:left; text-decoration:overline"
diff --git a/layout/reftests/text-decoration/underline-block-propagation-2-quirks.html b/layout/reftests/text-decoration/underline-block-propagation-2-quirks.html
--- a/layout/reftests/text-decoration/underline-block-propagation-2-quirks.html
+++ b/layout/reftests/text-decoration/underline-block-propagation-2-quirks.html
@@ -1,25 +1,32 @@
 <html><head>
 <title>More tests of propagation of text-decoration</title>
+<style>
+textarea { -moz-appearance: none }
+textarea + textarea { margin-left: 10px }
+</style>
 </head>
 <body>
 <!-- t-d should not propagate to the content of a form control -->
 <form style="text-decoration:underline">
 This text should be underlined.<br>
 <textarea rows="2" cols="40">This text should not be underlined.</textarea
 ><textarea rows="2" cols="40" style="text-decoration:line-through"
 >This text should be struck out.</textarea>
 <p>This text should also be underlined.</p>
 </form>
-<!-- t-d should propagate from parent elements to table-cells -->
+<!-- t-d should propagate from parent elements to table-cells, except
+     not through a table element in quirks mode, per
+     https://quirks.spec.whatwg.org/#the-text-decoration-doesn't-propagate-into-tables-quirk
+     -->
 <div style="text-decoration:underline">
   <table style="text-decoration:overline">
     <tr style="text-decoration:line-through">
-      <td>underlined, overlined, and struck out</td>
+      <td>overlined, and struck out</td>
     </tr>
   </table>
 </div>
 <!-- t-d on a float itself should apply -->
 <div style="text-decoration:underline">
   <p>This text should be underlined.</p>
   <p style="float:left; text-decoration:overline"
   >This text should be overlined (only).</p>

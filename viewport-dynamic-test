From: L. David Baron <dbaron@dbaron.org>

Bug 804970, patch 2: Add test for dynamic changes of viewport units.

diff --git a/layout/style/test/Makefile.in b/layout/style/test/Makefile.in
--- a/layout/style/test/Makefile.in
+++ b/layout/style/test/Makefile.in
@@ -145,16 +145,17 @@ MOCHITEST_FILES =	test_acid3_test46.html
 		test_unclosed_parentheses.html \
 		test_units_angle.html \
 		test_units_frequency.html \
 		test_units_length.html \
 		test_units_time.html \
 		test_value_cloning.html \
 		test_value_computation.html \
 		test_value_storage.html \
+		test_viewport_units.html \
 		test_visited_image_loading.html \
 		test_visited_image_loading_empty.html \
 		test_visited_lying.html \
 		test_visited_pref.html \
 		test_visited_reftests.html \
 		animation_utils.js \
 		css_properties.js \
 		property_database.js \
@@ -185,16 +186,17 @@ MOCHITEST_FILES =	test_acid3_test46.html
 		visited_image_loading_frame.html \
 		visited_image_loading_frame_empty.html \
 		test_load_events_on_stylesheets.html \
 		test_bug721136.html \
 		test_bug732153.html \
 		test_bug732209.html \
 		bug732209-css.sjs \
 		test_bug795520.html \
+		viewport_units_iframe.html \
 		$(NULL)
 
 ifdef MOZ_FLEXBOX
 MOCHITEST_FILES +=	\
 		file_flexbox_align_self_auto.html \
 		test_flexbox_align_self_auto.html \
 		file_flexbox_flex_grow_and_shrink.html \
 		test_flexbox_flex_grow_and_shrink.html \
diff --git a/layout/style/test/test_rem_unit.html b/layout/style/test/test_viewport_units.html
copy from layout/style/test/test_rem_unit.html
copy to layout/style/test/test_viewport_units.html
--- a/layout/style/test/test_rem_unit.html
+++ b/layout/style/test/test_viewport_units.html
@@ -1,80 +1,66 @@
 <!DOCTYPE HTML>
 <html>
 <!--
-https://bugzilla.mozilla.org/show_bug.cgi?id=478321
+https://bugzilla.mozilla.org/show_bug.cgi?id=804970
 -->
 <head>
-  <title>Test for CSS 'rem' unit</title>
+  <title>Test for dynamic changes to CSS 'vh', 'vw', 'vmin', and 'vmax' units</title>
   <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
 </head>
 <body>
-<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=478321">Mozilla Bug 478321</a>
-<p id="display"></p>
-<p id="display2"></p>
-<div id="content" style="display: none">
-  
-</div>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=804970">Mozilla Bug 804970</a>
+<iframe id="iframe" src="viewport_units_iframe.html"></iframe>
 <pre id="test">
 <script type="application/javascript">
 
-/** Test for CSS 'rem' unit **/
+/** Test for CSS vh/vw/vmin/vmax units **/
 
 function px_to_num(str)
 {
     return Number(String(str).match(/^([\d.]+)px$/)[1]);
 }
 
-function fs(elt)
+function width(elt)
 {
-    return px_to_num(getComputedStyle(elt, "").fontSize);
+    return px_to_num(elt.ownerDocument.defaultView.getComputedStyle(elt, "").width);
 }
 
-var html = document.documentElement;
-var body = document.body;
-var p = document.getElementById("display");
-var p2 = document.getElementById("display2");
+SimpleTest.waitForExplicitFinish();
 
-html.style.font = "-moz-initial";
+function run() {
+    var iframe = document.getElementById("iframe");
+    var idoc = iframe.contentDocument;
+    var vh = idoc.getElementById("vh");
+    var vw = idoc.getElementById("vw");
+    var vmin = idoc.getElementById("vmin");
+    var vmax = idoc.getElementById("vmax");
 
-var defaultFontSize = fs(html);
+    iframe.style.width = "100px";
+    iframe.style.height = "250px";
+    is(width(vh), 250, "vh should be 250px");
+    is(width(vw), 100, "vw should be 100px");
+    is(width(vmin), 100, "vmin should be 100px");
+    is(width(vmax), 250, "vmax should be 250px");
 
-// NOTE:  This test assumes that the default font size is an
-// integral number of pixels (which is always the case at present).
-// If that ever becomes false, the calls to "is" may need to be replaced by
-// calls to "isapprox" that allows errors of up to some small fraction
-// of a pixel.
+    iframe.style.width = "300px";
+    is(width(vh), 250, "vh should be 250px");
+    is(width(vw), 300, "vw should be 300px");
+    is(width(vmin), 250, "vmin should be 250px");
+    is(width(vmax), 300, "vmax should be 300px");
 
-html.style.fontSize = "3rem";
-is(fs(html), 3 * defaultFontSize,
-   "3rem on root should triple root's font size");
-body.style.font = "-moz-initial";
-is(fs(body), defaultFontSize,
-   "-moz-initial should produce initial font size");
-body.style.fontSize = "1em";
-is(fs(body), 3 * defaultFontSize, "1em should inherit from parent");
-body.style.fontSize = "200%";
-is(fs(body), 6 * defaultFontSize, "200% should double parent");
-body.style.fontSize = "2rem";
-is(fs(body), 6 * defaultFontSize, "2rem should double root");
-p.style.font = "inherit";
-is(fs(p), 6 * defaultFontSize, "inherit should inherit from parent");
-p2.style.fontSize = "2rem";
-is(fs(p2), 6 * defaultFontSize, "2rem should double root");
-body.style.font = "-moz-initial";
-is(fs(p), defaultFontSize, "inherit should inherit from parent");
-is(fs(p2), 6 * defaultFontSize, "2rem should double root");
-body.style.fontSize = "5em";
-html.style.fontSize = "200%";
-is(fs(p), 10 * defaultFontSize, "inherit should inherit from parent");
-is(fs(p2), 4 * defaultFontSize, "2rem should double root");
+    iframe.style.height = "200px";
+    is(width(vh), 200, "vh should be 200px");
+    is(width(vw), 300, "vw should be 300px");
+    is(width(vmin), 200, "vmin should be 200px");
+    is(width(vmax), 300, "vmax should be 300px");
 
+    SimpleTest.finish();
+}
 
-// Make things readable again.
-html.style.fontSize = "1em";
-body.style.fontSize = "1em";
+window.addEventListener("load", run, false);
 
 </script>
 </pre>
 </body>
 </html>
diff --git a/layout/style/test/viewport_units_iframe.html b/layout/style/test/viewport_units_iframe.html
new file mode 100644
--- /dev/null
+++ b/layout/style/test/viewport_units_iframe.html
@@ -0,0 +1,6 @@
+<!DOCTYPE HTML>
+<title>viewport units test</title>
+<div id="vh" style="width: 100vh"></div>
+<div id="vw" style="width: 100vw"></div>
+<div id="vmin" style="width: 100vmin"></div>
+<div id="vmax" style="width: 100vmax"></div>

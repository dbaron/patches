From: L. David Baron <dbaron@dbaron.org>

Block text-shadow when using document-specified colors is disabled.  (Bug 503188)  r=bzbarsky, roc

diff --git a/layout/style/nsCSSPropList.h b/layout/style/nsCSSPropList.h
--- a/layout/style/nsCSSPropList.h
+++ b/layout/style/nsCSSPropList.h
@@ -509,17 +509,17 @@ CSS_PROP_BACKENDONLY(speak-header, speak
 CSS_PROP_BACKENDONLY(speak-numeral, speak_numeral, SpeakNumeral, 0, Aural, mSpeakNumeral, eCSSType_Value, kSpeakNumeralKTable)
 CSS_PROP_BACKENDONLY(speak-punctuation, speak_punctuation, SpeakPunctuation, 0, Aural, mSpeakPunctuation, eCSSType_Value, kSpeakPunctuationKTable)
 CSS_PROP_BACKENDONLY(speech-rate, speech_rate, SpeechRate, 0, Aural, mSpeechRate, eCSSType_Value, kSpeechRateKTable)
 CSS_PROP_BACKENDONLY(stress, stress, Stress, 0, Aural, mStress, eCSSType_Value, nsnull)
 CSS_PROP_TABLE(table-layout, table_layout, TableLayout, 0, Table, mLayout, eCSSType_Value, kTableLayoutKTable)
 CSS_PROP_TEXT(text-align, text_align, TextAlign, 0, Text, mTextAlign, eCSSType_Value, kTextAlignKTable)
 CSS_PROP_TEXTRESET(text-decoration, text_decoration, TextDecoration, CSS_PROPERTY_APPLIES_TO_FIRST_LETTER_AND_FIRST_LINE, Text, mDecoration, eCSSType_Value, kTextDecorationKTable)
 CSS_PROP_TEXT(text-indent, text_indent, TextIndent, 0, Text, mTextIndent, eCSSType_Value, nsnull)
-CSS_PROP_TEXT(text-shadow, text_shadow, TextShadow, CSS_PROPERTY_APPLIES_TO_FIRST_LETTER_AND_FIRST_LINE | CSS_PROPERTY_VALUE_LIST_USES_COMMAS, Text, mTextShadow, eCSSType_ValueList, nsnull)
+CSS_PROP_TEXT(text-shadow, text_shadow, TextShadow, CSS_PROPERTY_APPLIES_TO_FIRST_LETTER_AND_FIRST_LINE | CSS_PROPERTY_VALUE_LIST_USES_COMMAS | CSS_PROPERTY_IGNORED_WHEN_COLORS_DISABLED, Text, mTextShadow, eCSSType_ValueList, nsnull)
 CSS_PROP_TEXT(text-transform, text_transform, TextTransform, CSS_PROPERTY_APPLIES_TO_FIRST_LETTER_AND_FIRST_LINE, Text, mTextTransform, eCSSType_Value, kTextTransformKTable)
 CSS_PROP_DISPLAY(-moz-transform, _moz_transform, MozTransform, 0, Display, mTransform, eCSSType_ValueList, kDisplayKTable)
 CSS_PROP_DISPLAY(-moz-transform-origin, _moz_transform_origin, MozTransformOrigin, 0, Display, mTransformOrigin, eCSSType_ValuePair, kBackgroundPositionKTable)
 CSS_PROP_POSITION(top, top, Top, 0, Position, mOffset.mTop, eCSSType_Value, nsnull)
 CSS_PROP_TEXTRESET(unicode-bidi, unicode_bidi, UnicodeBidi, 0, Text, mUnicodeBidi, eCSSType_Value, kUnicodeBidiKTable)
 CSS_PROP_USERINTERFACE(-moz-user-focus, user_focus, MozUserFocus, 0, UserInterface, mUserFocus, eCSSType_Value, kUserFocusKTable) // XXX bug 3935
 CSS_PROP_USERINTERFACE(-moz-user-input, user_input, MozUserInput, 0, UserInterface, mUserInput, eCSSType_Value, kUserInputKTable) // XXX ??? // XXX bug 3935
 CSS_PROP_USERINTERFACE(-moz-user-modify, user_modify, MozUserModify, 0, UserInterface, mUserModify, eCSSType_Value, kUserModifyKTable) // XXX bug 3935
diff --git a/layout/style/test/test_dont_use_document_colors.html b/layout/style/test/test_dont_use_document_colors.html
--- a/layout/style/test/test_dont_use_document_colors.html
+++ b/layout/style/test/test_dont_use_document_colors.html
@@ -4,17 +4,17 @@
 -->
 <head>
   <title>Test for preference not to use document colors</title>
   <script type="text/javascript" src="/MochiKit/packed.js"></script>
   <script type="text/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
   <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css" />
   <style type="text/css">
 
-  #one, #three { background: blue; color: yellow; border: thin solid red; -moz-column-rule: 2px solid green; }
+  #one, #three { background: blue; color: yellow; border: thin solid red; -moz-column-rule: 2px solid green; text-shadow: 2px 2px green; }
   #two { background: transparent; border: thin solid; }
   #five, #six {border: thick solid red; -moz-border-start-color:green; -moz-border-end-color:blue}
   #seven {
     border: 3px solid;
     -moz-border-top-colors: blue aqua fuchsia;
     -moz-border-right-colors: aqua blue fuchsia;
     -moz-border-bottom-colors: blue fuchsia aqua;
     -moz-border-left-colors: fuchsia blue blue;
@@ -85,26 +85,30 @@ function part1()
     isnot(cs1.borderTopColor, cs2.borderTopColor, "border-top-color applies");
     isnot(cs1.borderRightColor, cs2.borderRightColor,
           "border-right-color applies");
     isnot(cs1.borderLeftColor, cs2.borderLeftColor,
           "border-left-color applies");
     isnot(cs1.borderBottomColor, cs2.borderBottomColor,
           "border-top-color applies");
     isnot(cs1.MozColumnRuleColor, cs2.MozColumnRuleColor,
-       "-moz-column-rule-color applies");
+          "-moz-column-rule-color applies");
+    isnot(cs1.textShadow, cs2.textShadow,
+          "text-shadow applies");
     is(cs1.borderTopColor, cs3.borderTopColor, "border-top-color applies");
     is(cs1.borderRightColor, cs3.borderRightColor,
        "border-right-color applies");
     is(cs1.borderLeftColor, cs3.borderLeftColor,
        "border-left-color applies");
     is(cs1.borderBottomColor, cs3.borderBottomColor, 
        "border-top-color applies");
     is(cs1.MozColumnRuleColor, cs3.MozColumnRuleColor,
        "-moz-column-rule-color applies");
+    is(cs1.TextShadow, cs3.TextShadow,
+       "text-shadow applies");
     isnot(cs5.borderRightColor, cs2.borderRightColor,
           "-moz-border-end-color applies");
     isnot(cs5.borderLeftColor, cs2.borderLeftColor,
           "-moz-border-start-color applies");    
     isnot(cs6.borderRightColor, cs2.borderRightColor,
           "-moz-border-start-color applies");
     isnot(cs6.borderLeftColor, cs2.borderLeftColor,
           "-moz-border-end-color applies");
@@ -163,16 +167,18 @@ function part2()
     is(cs7.MozBorderBottomColors, cs2.MozBorderBottomColors,
        "-moz-border-bottom-colors is blocked");
     is(cs7.MozBorderLeftColors, cs2.MozBorderLeftColors,
        "-moz-border-left-colors is blocked");
     is(cs1.borderBottomColor, cs2.borderBottomColor,
        "border-bottom-color is blocked");
     is(cs1.MozColumnRuleColor, cs2.MozColumnRuleColor,
        "-moz-column-rule-color is blocked");
+    is(cs1.TextShadow, cs2.TextShadow,
+       "text-shadow is blocked");
     is(cs3.backgroundColor, cs1.backgroundColor, "background-color transparency preserved (opaque)");
     is(cs3.color, cs4.color, "color is blocked");
     is(cs3.borderTopColor, cs4.borderTopColor, "border-top-color is blocked");
     is(cs3.borderRightColor, cs4.borderRightColor,
        "border-right-color is blocked");
     is(cs3.borderLeftColor, cs4.borderLeftColor,
        "border-left-color is blocked");
     is(cs3.borderBottomColor, cs4.borderBottomColor,

From: fantasai <fantasai.cvs@inkedblade.net>

Update margin collapsing code to rule change that prevents clearance from moving things up.  (Bug 376365)  r=roc

diff --git a/layout/generic/nsBlockFrame.cpp b/layout/generic/nsBlockFrame.cpp
--- a/layout/generic/nsBlockFrame.cpp
+++ b/layout/generic/nsBlockFrame.cpp
@@ -3171,16 +3171,21 @@ nsBlockFrame::ReflowBlockFrame(nsBlockRe
 
       if (mayNeedRetry) {
         blockHtmlRS.mDiscoveredClearance = &clearanceFrame;
       } else if (!applyTopMargin) {
         blockHtmlRS.mDiscoveredClearance =
           aState.mReflowState.mDiscoveredClearance;
       }
 
+      if (clearance < 0 && clearance + incomingMargin.get() < 0) {
+        // clearance must not move things up, only down
+        clearance -= clearance + incomingMargin.get();
+      }
+
       frameReflowStatus = NS_FRAME_COMPLETE;
       rv = brc.ReflowBlock(availSpace, applyTopMargin, aState.mPrevBottomMargin,
                            clearance, aState.IsAdjacentWithTop(),
                            aLine.get(), blockHtmlRS, frameReflowStatus, aState);
 
       // Now the block has a height.  Using that height, get the
       // available space again and call ComputeBlockAvailSpace again.
       // If ComputeBlockAvailSpace gives a different result, we need to

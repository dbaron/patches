From: fantasai <fantasai.cvs@inkedblade.net>

Update margin collapsing code to rule change that prevents clearance from moving things up.  (Bug 376365)  r=roc  (TODO: requires adjustments to six reftests)

Causes failures of the following six reftests, which probably require adjustment:
layout/reftests/bugs/134706-7.html
layout/reftests/bugs/289480.html#top
layout/reftests/margin-collapsing/block-clear-5c.html
layout/reftests/margin-collapsing/block-clear-5d.html
layout/reftests/margin-collapsing/block-clear-5g.html
layout/reftests/margin-collapsing/block-clear-5h.html

diff --git a/layout/generic/nsBlockFrame.cpp b/layout/generic/nsBlockFrame.cpp
--- a/layout/generic/nsBlockFrame.cpp
+++ b/layout/generic/nsBlockFrame.cpp
@@ -3192,17 +3192,22 @@ nsBlockFrame::ReflowBlockFrame(nsBlockRe
     
     nsFloatManager::SavedState floatManagerState;
     if (mayNeedRetry) {
       blockHtmlRS.mDiscoveredClearance = &clearanceFrame;
       aState.mFloatManager->PushState(&floatManagerState);
     } else if (!applyTopMargin) {
       blockHtmlRS.mDiscoveredClearance = aState.mReflowState.mDiscoveredClearance;
     }
-    
+
+    if (clearance < 0 && clearance + incomingMargin.get() < 0) {
+      // clearance must not move things up, only down
+      clearance -= clearance + incomingMargin.get();
+    }
+
     nsReflowStatus frameReflowStatus = NS_FRAME_COMPLETE;
     rv = brc.ReflowBlock(availSpace, applyTopMargin, aState.mPrevBottomMargin,
                          clearance, aState.IsAdjacentWithTop(),
                          aLine.get(), blockHtmlRS, frameReflowStatus, aState);
 
     // If this was a second-pass reflow and the block's vertical position
     // changed, invalidates from the first pass might have happened in the
     // wrong places.  Invalidate the entire overflow rect at the new position.

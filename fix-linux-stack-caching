From: L. David Baron <dbaron@dbaron.org>

Bug 914253 patch 5 - Implement caching of addr2line results, like bug 812070 did for fix-linux-stack.pl.  No review.

diff --git a/tools/rb/fix_linux_stack.py b/tools/rb/fix_linux_stack.py
--- a/tools/rb/fix_linux_stack.py
+++ b/tools/rb/fix_linux_stack.py
@@ -207,24 +207,30 @@ def address_adjustment_for(file):
             break
     readelf.terminate()
     return adjustment
 
 addr2lines = {}
 def addressToSymbol(file, address):
     converter = None
     address_adjustment = None
+    cache = None
     if not file in addr2lines:
         debug_file = separate_debug_file_for(file) or file
         converter = unbufferedLineConverter('/usr/bin/addr2line', ['-C', '-f', '-e', debug_file])
         address_adjustment = address_adjustment_for(file)
-        addr2lines[file] = (converter, address_adjustment)
+        cache = {}
+        addr2lines[file] = (converter, address_adjustment, cache)
     else:
-        (converter, address_adjustment) = addr2lines[file]
-    return converter.convert(hex(int(address, 16) + address_adjustment))
+        (converter, address_adjustment, cache) = addr2lines[file]
+    if address in cache:
+        return cache[address]
+    result = converter.convert(hex(int(address, 16) + address_adjustment))
+    cache[address] = result
+    return result
 
 line_re = re.compile("^(.*) ?\[([^ ]*) \+(0x[0-9a-f]{1,8})\](.*)$")
 balance_tree_re = re.compile("^([ \|0-9-]*)")
 
 def fixSymbols(line):
     result = line_re.match(line)
     if result is not None:
         # before allows preservation of balance trees

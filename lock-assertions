From: L. David Baron <dbaron@dbaron.org>

Add assertions that fire when callers using nsAutoLock or nsAutoMonitor use PR_NewLock or PR_NewMonitor directly.  (Bug 594666)

diff --git a/xpcom/glue/nsAutoLock.cpp b/xpcom/glue/nsAutoLock.cpp
--- a/xpcom/glue/nsAutoLock.cpp
+++ b/xpcom/glue/nsAutoLock.cpp
@@ -229,24 +229,31 @@ static PRBool WellOrdered(const void* ad
     if (!table) return rv;
     PR_Lock(OrderTableLock);
 
     // Check whether we've already asserted (addr1 < addr2).
     nsNamedVector* vec1 = GetVector(table, addr1);
     if (vec1) {
         PRUint32 i, n;
 
+        NS_ASSERTION(vec1->mName,
+                     "caller should have used nsAutoLock::NewLock "
+                     "or nsAutoMonitor::NewMonitor");
+
         for (i = 0, n = vec1->Count(); i < n; i++)
             if (vec1->ElementAt(i) == addr2)
                 break;
 
         if (i == n) {
             // Now check for (addr2 < addr1) and return false if so.
             nsNamedVector* vec2 = GetVector(table, addr2);
             if (vec2) {
+                NS_ASSERTION(vec2->mName,
+                             "caller should have used nsAutoLock::NewLock "
+                             "or nsAutoMonitor::NewMonitor");
                 for (i = 0, n = vec2->Count(); i < n; i++) {
                     void* addri = vec2->ElementAt(i);
                     PR_ASSERT(addri);
                     if (addri == addr1 || Reachable(table, addr1, addri)) {
                         *index2p = i;
                         *vec1p = vec1;
                         *vec2p = vec2;
                         rv = PR_FALSE;

Don't call SelectorMatches on document fragments.  b=437170

diff --git a/layout/style/crashtests/437170.html b/layout/style/crashtests/437170.html
new file mode 100644
--- /dev/null
+++ b/layout/style/crashtests/437170.html
@@ -0,0 +1,20 @@
+<!DOCTYPE html>
+<html>
+<head>
+<script>
+
+function boom()
+{
+  var r = document.createRange();
+  r.selectNodeContents(document.documentElement);
+  r.cloneContents();
+}
+</script>
+</head>
+
+<body onload="boom();">
+
+<img src="data:image/gif,GIF87a%02%00%02%00%B3%00%00%00%00%00%FF%FF%FF%00%00%00%00%00%00%FF%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%2C%00%00%00%00%02%00%02%00%00%04%03%90H%12%00%3B" onload="window.getComputedStyle(this, null).getPropertyValue('color');">
+
+</body>
+</html>
diff --git a/layout/style/crashtests/crashtests.list b/layout/style/crashtests/crashtests.list
--- a/layout/style/crashtests/crashtests.list
+++ b/layout/style/crashtests/crashtests.list
@@ -7,8 +7,9 @@ load 383979-2.html
 load 383979-2.html
 load 386939-1.html
 load 391034-1.xhtml
 load 397022-1.html
 load 399289-1.svg
 load 404470-1.html
 load 411603-1.html
 load 413274-1.xhtml
+load 437170.html
diff --git a/layout/style/nsCSSRuleProcessor.cpp b/layout/style/nsCSSRuleProcessor.cpp
--- a/layout/style/nsCSSRuleProcessor.cpp
+++ b/layout/style/nsCSSRuleProcessor.cpp
@@ -1736,17 +1736,19 @@ static PRBool SelectorMatchesTree(RulePr
       }
     }
     // for descendant combinators and child combinators, the content
     // to test against is the parent
     else {
       data = prevdata->mParentData;
       if (!data) {
         nsIContent *content = prevdata->mContent->GetParent();
-        if (content) {
+        // GetParent could return a document fragment; we only want
+        // element parents.
+        if (content && content->IsNodeOfType(nsINode::eELEMENT)) {
           data = new (prevdata->mPresContext)
                       RuleProcessorData(prevdata->mPresContext, content,
                                         prevdata->mRuleWalker,
                                         &prevdata->mCompatMode);
           prevdata->mParentData = data;    
         }
       }
     }

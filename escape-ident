From: L. David Baron <dbaron@dbaron.org>

Appropriately escape CSS identifiers when serializing.  (Bug 543428)

diff --git a/layout/style/nsCSSDeclaration.cpp b/layout/style/nsCSSDeclaration.cpp
--- a/layout/style/nsCSSDeclaration.cpp
+++ b/layout/style/nsCSSDeclaration.cpp
@@ -262,18 +262,21 @@ nsCSSDeclaration::AppendCSSValueToString
   if (eCSSUnit_String <= unit && unit <= eCSSUnit_Attr) {
     if (unit == eCSSUnit_Attr) {
       aResult.AppendLiteral("attr(");
     }
     nsAutoString  buffer;
     aValue.GetStringValue(buffer);
     if (unit == eCSSUnit_String) {
       nsStyleUtil::AppendEscapedCSSString(buffer, aResult);
+    } else if (unit == eCSSUnit_Families) {
+      // XXX We really need to do *some* escaping.
+      aResult.Append(buffer);
     } else {
-      aResult.Append(buffer);
+      nsStyleUtil::AppendEscapedCSSIdent(buffer, aResult);
     }
   }
   else if (eCSSUnit_Array <= unit && unit <= eCSSUnit_Cubic_Bezier) {
     switch (unit) {
       case eCSSUnit_Counter:  aResult.AppendLiteral("counter(");  break;
       case eCSSUnit_Counters: aResult.AppendLiteral("counters("); break;
       case eCSSUnit_Cubic_Bezier: aResult.AppendLiteral("cubic-bezier("); break;
       default: break;
@@ -317,17 +320,19 @@ nsCSSDeclaration::AppendCSSValueToString
     NS_ASSERTION(array->Count() >= 1, "Functions must have at least one element for the name.");
 
     /* Append the function name. */
     const nsCSSValue& functionName = array->Item(0);
     if (functionName.GetUnit() == eCSSUnit_Enumerated) {
       // We assume that the first argument is always of nsCSSKeyword type.
       const nsCSSKeyword functionId =
         static_cast<nsCSSKeyword>(functionName.GetIntValue());
-      AppendASCIItoUTF16(nsCSSKeywords::GetStringValue(functionId), aResult);
+      nsStyleUtil::AppendEscapedCSSIdent(
+        NS_ConvertASCIItoUTF16(nsCSSKeywords::GetStringValue(functionId)),
+        aResult);
     } else {
       AppendCSSValueToString(aProperty, functionName, aResult);
     }
     aResult.AppendLiteral("(");
 
     /* Now, step through the function contents, writing each of them as we go. */
     for (PRUint16 index = 1; index < array->Count(); ++index) {
       AppendCSSValueToString(aProperty, array->Item(index), aResult);
diff --git a/layout/style/nsCSSStyleRule.cpp b/layout/style/nsCSSStyleRule.cpp
--- a/layout/style/nsCSSStyleRule.cpp
+++ b/layout/style/nsCSSStyleRule.cpp
@@ -593,17 +593,17 @@ nsCSSSelector::AppendToStringWithoutComb
     } else if (mNameSpace != kNameSpaceID_Unknown) {
       NS_ASSERTION(CanBeNamespaced(aIsNegated),
                    "How did we end up with this namespace?");
       nsIAtom *prefixAtom = sheetNS->FindPrefix(mNameSpace);
       NS_ASSERTION(prefixAtom, "how'd we get a non-default namespace "
                    "without a prefix?");
       nsAutoString prefix;
       prefixAtom->ToString(prefix);
-      aString.Append(prefix);
+      nsStyleUtil::AppendEscapedCSSIdent(prefix, aString);
       aString.Append(PRUnichar('|'));
       wroteNamespace = PR_TRUE;
     } else {
       // A selector for an element in any namespace, while the default
       // namespace is something else.  :not() is special in that the default
       // namespace is not implied for non-type selectors, so if this is a
       // negated non-type selector we don't need to output an explicit wildcard
       // namespace here, since those default to a wildcard namespace.
@@ -620,49 +620,55 @@ nsCSSSelector::AppendToStringWithoutComb
     // inside of :not()
     if (wroteNamespace ||
         (!mIDList && !mClassList && !mPseudoClassList && !mAttrList &&
          (aIsNegated || !mNegations))) {
       aString.Append(PRUnichar('*'));
     }
   } else {
     // Append the tag name
+    nsAutoString tag;
+    (isPseudoElement ? mLowercaseTag : mCasedTag)->ToString(tag);
     if (isPseudoElement) {
       if (!mNext) {
         // Lone pseudo-element selector -- toss in a wildcard type selector
         // XXXldb Why?
         aString.Append(PRUnichar('*'));
       }
       if (!nsCSSPseudoElements::IsCSS2PseudoElement(mLowercaseTag)) {
         aString.Append(PRUnichar(':'));
       }
+      // This should not be escaped since (a) the pseudo-element string
+      // has a ":" that can't be escaped and (b) all pseudo-elements at
+      // this point are known, and therefore we know they don't need
+      // escaping.
+      aString.Append(tag);
+    } else {
+      nsStyleUtil::AppendEscapedCSSIdent(tag, aString);
     }
-    nsAutoString prefix;
-    (isPseudoElement ? mLowercaseTag : mCasedTag)->ToString(prefix);
-    aString.Append(prefix);
   }
 
   // Append the id, if there is one
   if (mIDList) {
     nsAtomList* list = mIDList;
     while (list != nsnull) {
       list->mAtom->ToString(temp);
       aString.Append(PRUnichar('#'));
-      aString.Append(temp);
+      nsStyleUtil::AppendEscapedCSSIdent(temp, aString);
       list = list->mNext;
     }
   }
 
   // Append each class in the linked list
   if (mClassList) {
     nsAtomList* list = mClassList;
     while (list != nsnull) {
       list->mAtom->ToString(temp);
       aString.Append(PRUnichar('.'));
-      aString.Append(temp);
+      nsStyleUtil::AppendEscapedCSSIdent(temp, aString);
       list = list->mNext;
     }
   }
 
   // Append each attribute selector in the linked list
   if (mAttrList) {
     nsAttrSelector* list = mAttrList;
     while (list != nsnull) {
@@ -677,23 +683,23 @@ nsCSSSelector::AppendToStringWithoutComb
           nsIAtom *prefixAtom = sheetNS->FindPrefix(list->mNameSpace);
           // Default namespaces don't apply to attribute selectors, so
           // we must have a useful prefix.
           NS_ASSERTION(prefixAtom,
                        "How did we end up with a namespace if the prefix "
                        "is unknown?");
           nsAutoString prefix;
           prefixAtom->ToString(prefix);
-          aString.Append(prefix);
+          nsStyleUtil::AppendEscapedCSSIdent(prefix, aString);
           aString.Append(PRUnichar('|'));
         }
       }
       // Append the attribute name
       list->mCasedAttr->ToString(temp);
-      aString.Append(temp);
+      nsStyleUtil::AppendEscapedCSSIdent(temp, aString);
 
       if (list->mFunction != NS_ATTR_FUNC_SET) {
         // Append the function
         if (list->mFunction == NS_ATTR_FUNC_INCLUDES)
           aString.Append(PRUnichar('~'));
         else if (list->mFunction == NS_ATTR_FUNC_DASHMATCH)
           aString.Append(PRUnichar('|'));
         else if (list->mFunction == NS_ATTR_FUNC_BEGINSMATCH)
@@ -720,34 +726,39 @@ nsCSSSelector::AppendToStringWithoutComb
 #ifdef MOZ_XUL
     if (mPseudoClassList) {
       NS_ABORT_IF_FALSE(nsCSSAnonBoxes::IsTreePseudoElement(mLowercaseTag),
                         "must be tree pseudo-element");
       aString.Append(PRUnichar('('));
       for (nsPseudoClassList* list = mPseudoClassList; list;
            list = list->mNext) {
         list->mAtom->ToString(temp);
-        aString.Append(temp);
+        nsStyleUtil::AppendEscapedCSSIdent(temp, aString);
         NS_ABORT_IF_FALSE(!list->u.mMemory, "data not expected");
         aString.Append(PRUnichar(','));
       }
       // replace the final comma with a close-paren
       aString.Replace(aString.Length() - 1, 1, PRUnichar(')'));
     }
 #else
     NS_ABORT_IF_FALSE(!mPseudoClassList, "unexpected pseudo-class list");
 #endif
   } else {
     for (nsPseudoClassList* list = mPseudoClassList; list; list = list->mNext) {
       list->mAtom->ToString(temp);
+      // This should not be escaped since (a) the pseudo-class string
+      // has a ":" that can't be escaped and (b) all pseudo-classes at
+      // this point are known, and therefore we know they don't need
+      // escaping.
       aString.Append(temp);
       if (list->u.mMemory) {
         aString.Append(PRUnichar('('));
         if (nsCSSPseudoClasses::HasStringArg(list->mAtom)) {
-          aString.Append(list->u.mString);
+          nsStyleUtil::AppendEscapedCSSIdent(
+            nsDependentString(list->u.mString), aString);
         } else {
           NS_ASSERTION(nsCSSPseudoClasses::HasNthPairArg(list->mAtom),
                        "unexpected pseudo-class");
           PRInt32 a = list->u.mNumbers[0],
                   b = list->u.mNumbers[1];
           temp.Truncate();
           if (a != 0) {
             if (a == -1) {
diff --git a/layout/style/nsComputedDOMStyle.cpp b/layout/style/nsComputedDOMStyle.cpp
--- a/layout/style/nsComputedDOMStyle.cpp
+++ b/layout/style/nsComputedDOMStyle.cpp
@@ -855,34 +855,39 @@ nsComputedDOMStyle::GetContent(nsIDOMCSS
           nsCOMPtr<nsIURI> uri;
           if (data.mContent.mImage) {
             data.mContent.mImage->GetURI(getter_AddRefs(uri));
           }
           val->SetURI(uri);
         }
         break;
       case eStyleContentType_Attr:
-        val->SetString(nsDependentString(data.mContent.mString),
-                       nsIDOMCSSPrimitiveValue::CSS_ATTR);
+        {
+          nsAutoString str;
+          nsStyleUtil::AppendEscapedCSSIdent(
+            nsDependentString(data.mContent.mString), str);
+          val->SetString(str, nsIDOMCSSPrimitiveValue::CSS_ATTR);
+        }
         break;
       case eStyleContentType_Counter:
       case eStyleContentType_Counters:
         {
           /* FIXME: counters should really use an object */
           nsAutoString str;
           if (data.mType == eStyleContentType_Counter) {
             str.AppendLiteral("counter(");
           }
           else {
             str.AppendLiteral("counters(");
           }
           // WRITE ME
           nsCSSValue::Array *a = data.mContent.mCounters;
 
-          str.Append(a->Item(0).GetStringBufferValue());
+          nsStyleUtil::AppendEscapedCSSIdent(
+            nsDependentString(a->Item(0).GetStringBufferValue()), str);
           PRInt32 typeItem = 1;
           if (data.mType == eStyleContentType_Counters) {
             typeItem = 2;
             str.AppendLiteral(", ");
             nsStyleUtil::AppendEscapedCSSString(
               nsDependentString(a->Item(1).GetStringBufferValue()), str);
           }
           NS_ABORT_IF_FALSE(eCSSUnit_None != a->Item(typeItem).GetUnit(),
@@ -947,17 +952,19 @@ nsComputedDOMStyle::GetCounterIncrement(
     nsROCSSPrimitiveValue* value = GetROCSSPrimitiveValue();
     if (!value || !valueList->AppendCSSValue(value)) {
       delete valueList;
       delete value;
       return NS_ERROR_OUT_OF_MEMORY;
     }
 
     const nsStyleCounterData *data = content->GetCounterIncrementAt(i);
-    name->SetString(data->mCounter);
+    nsAutoString escaped;
+    nsStyleUtil::AppendEscapedCSSIdent(data->mCounter, escaped);
+    name->SetString(escaped);
     value->SetNumber(data->mValue); // XXX This should really be integer
   }
 
   return CallQueryInterface(valueList, aValue);
 }
 
 /* Convert the stored representation into a list of two values and then hand
  * it back.
@@ -1099,17 +1106,19 @@ nsComputedDOMStyle::GetCounterReset(nsID
     nsROCSSPrimitiveValue* value = GetROCSSPrimitiveValue();
     if (!value || !valueList->AppendCSSValue(value)) {
       delete valueList;
       delete value;
       return NS_ERROR_OUT_OF_MEMORY;
     }
 
     const nsStyleCounterData *data = content->GetCounterResetAt(i);
-    name->SetString(data->mCounter);
+    nsAutoString escaped;
+    nsStyleUtil::AppendEscapedCSSIdent(data->mCounter, escaped);
+    name->SetString(escaped);
     value->SetNumber(data->mValue); // XXX This should really be integer
   }
 
   return CallQueryInterface(valueList, aValue);
 }
 
 nsresult
 nsComputedDOMStyle::GetQuotes(nsIDOMCSSValue** aValue)
@@ -4323,17 +4332,19 @@ nsComputedDOMStyle::GetTransitionPropert
     if (cssprop == eCSSPropertyExtra_all_properties)
       property->SetIdent(eCSSKeyword_all);
     else if (cssprop == eCSSPropertyExtra_no_properties)
       property->SetIdent(eCSSKeyword_none);
     else if (cssprop == eCSSProperty_UNKNOWN)
     {
       const char *str;
       transition->GetUnknownProperty()->GetUTF8String(&str);
-      property->SetString(nsDependentCString(str)); // really want SetIdent
+      nsAutoString escaped;
+      nsStyleUtil::AppendEscapedCSSIdent(NS_ConvertUTF8toUTF16(str), escaped);
+      property->SetString(escaped); // really want SetIdent
     }
     else
       property->SetString(nsCSSProps::GetStringValue(cssprop));
   } while (++i < display->mTransitionPropertyCount);
 
   return CallQueryInterface(valueList, aValue);
 }
 
diff --git a/layout/style/nsStyleUtil.cpp b/layout/style/nsStyleUtil.cpp
--- a/layout/style/nsStyleUtil.cpp
+++ b/layout/style/nsStyleUtil.cpp
@@ -556,16 +556,71 @@ void nsStyleUtil::AppendEscapedCSSString
        aReturn.Append(PRUnichar(*in));
     }
   }
 
   aReturn.Append(PRUnichar('"'));
 }
 
 /* static */ void
+nsStyleUtil::AppendEscapedCSSIdent(const nsString& aIdent, nsAString& aReturn)
+{
+  // The relevant parts of the CSS grammar are:
+  //   ident    [-]?{nmstart}{nmchar}*
+  //   nmstart  [_a-z]|{nonascii}|{escape}
+  //   nmchar   [_a-z0-9-]|{nonascii}|{escape}
+  //   nonascii [^\0-\177]
+  //   escape   {unicode}|\\[^\n\r\f0-9a-f]
+  //   unicode  \\[0-9a-f]{1,6}(\r\n|[ \n\r\t\f])?
+  // from http://www.w3.org/TR/CSS21/syndata.html#tokenization
+
+  const nsString::char_type* in = aIdent.get();
+  const nsString::char_type* const end = in + aIdent.Length();
+
+  // Deal with the leading dash separately so we don't need to
+  // unnecessarily escape digits.
+  if (in != end && *in == '-') {
+    aReturn.Append(PRUnichar('-'));
+    ++in;
+  }
+
+  PRBool first = PR_TRUE;
+  for (; in != end; ++in, first = PR_FALSE)
+  {
+    if (*in < 0x20 || (first && '0' <= *in && *in <= '9'))
+    {
+      // Escape all characters below 0x20, and digits at the start
+      // (including after a dash), numerically.  If we didn't escape
+      // digits numerically, they'd get interpreted as a numeric escape
+      // for the wrong character.
+
+      /*
+       This is the buffer into which snprintf should write. As the hex.
+       value is, for numbers below 0x7F, max. 2 characters long, we
+       don't need more than 5 characters ("\XX "+NUL).
+      */
+      PRUnichar buf[5];
+      nsTextFormatter::snprintf(buf, NS_ARRAY_LENGTH(buf),
+                                NS_LITERAL_STRING("\\%hX ").get(), *in);
+      aReturn.Append(buf);
+    } else {
+      if (!((*in == PRUnichar('_')) ||
+            (PRUnichar('A') <= *in && *in <= PRUnichar('Z')) ||
+            (PRUnichar('a') <= *in && *in <= PRUnichar('z')) ||
+            (!first && *in == PRUnichar('-')) ||
+            (PRUnichar('0') <= *in && *in <= PRUnichar('9')))) {
+        // Character needs to be escaped
+        aReturn.Append(PRUnichar('\\'));
+      }
+      aReturn.Append(PRUnichar(*in));
+    }
+  }
+}
+
+/* static */ void
 nsStyleUtil::AppendBitmaskCSSValue(nsCSSProperty aProperty,
                                    PRInt32 aMaskedValue,
                                    PRInt32 aFirstMask,
                                    PRInt32 aLastMask,
                                    nsAString& aResult)
 {
   for (PRInt32 mask = aFirstMask; mask <= aLastMask; mask <<= 1) {
     if (mask & aMaskedValue) {
diff --git a/layout/style/nsStyleUtil.h b/layout/style/nsStyleUtil.h
--- a/layout/style/nsStyleUtil.h
+++ b/layout/style/nsStyleUtil.h
@@ -77,16 +77,21 @@ public:
 
  static PRBool DashMatchCompare(const nsAString& aAttributeValue,
                                 const nsAString& aSelectorValue,
                                 const nsStringComparator& aComparator);
                                 
   // Append a quoted (with "") and escaped version of aString to aResult.
   static void AppendEscapedCSSString(const nsString& aString,
                                      nsAString& aResult);
+  // Append the identifier given by |aIdent| to |aResult|, with
+  // appropriate escaping so that it can be reparsed to the same
+  // identifier.
+  static void AppendEscapedCSSIdent(const nsString& aIdent,
+                                    nsAString& aResult);
 
   // Append a bitmask-valued property's value(s) (space-separated) to aResult.
   static void AppendBitmaskCSSValue(nsCSSProperty aProperty,
                                     PRInt32 aMaskedValue,
                                     PRInt32 aFirstMask,
                                     PRInt32 aLastMask,
                                     nsAString& aResult);
 
diff --git a/layout/style/test/property_database.js b/layout/style/test/property_database.js
--- a/layout/style/test/property_database.js
+++ b/layout/style/test/property_database.js
@@ -1270,33 +1270,33 @@ var gCSSProperties = {
 		invalid_values: [ "linearRGB", "red" ]
 	},
 	"content": {
 		domProp: "content",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		/* XXX needs to be on pseudo-elements */
 		initial_values: [ "normal", "none" ],
-		other_values: [ '""', "''", '"hello"', "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==)", "url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==')", 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==")', 'counter(foo)', 'counter(bar, upper-roman)', 'counters(foo, ".")', "counters(bar, '-', lower-greek)", "'-' counter(foo) '.'", "attr(title)", "open-quote", "close-quote", "no-open-quote", "no-close-quote", "close-quote attr(title) counters(foo, '.', upper-alpha)", "counter(foo, none)", "counters(bar, '.', none)" ],
-		invalid_values: [ 'counters(foo)', 'counter(foo, ".")', 'attr("title")', "attr('title')" ]
+		other_values: [ '""', "''", '"hello"', "url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==)", "url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==')", 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAKElEQVR42u3NQQ0AAAgEoNP+nTWFDzcoQE1udQQCgUAgEAgEAsGTYAGjxAE/G/Q2tQAAAABJRU5ErkJggg==")', 'counter(foo)', 'counter(bar, upper-roman)', 'counters(foo, ".")', "counters(bar, '-', lower-greek)", "'-' counter(foo) '.'", "attr(title)", "open-quote", "close-quote", "no-open-quote", "no-close-quote", "close-quote attr(title) counters(foo, '.', upper-alpha)", "counter(foo, none)", "counters(bar, '.', none)", "attr(\\32)", "attr(\\2)", "attr(-\\2)", "attr(-\\32)", "counter(\\2)", "counters(\\32, '.')", "counter(-\\32, upper-roman)", "counters(-\\2, '-', lower-greek)", "counter(\\()", "counters(a\\+b, '.')", "counter(\\}, upper-alpha)" ],
+		invalid_values: [ 'counters(foo)', 'counter(foo, ".")', 'attr("title")', "attr('title')", "attr(2)", "attr(-2)", "counter(2)", "counters(-2, '.')" ]
 	},
 	"counter-increment": {
 		domProp: "counterIncrement",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		initial_values: [ "none" ],
-		other_values: [ "foo 1", "bar", "foo 3 bar baz 2" ],
+		other_values: [ "foo 1", "bar", "foo 3 bar baz 2", "\\32  1", "-\\32  1", "-c 1", "\\32 1", "-\\32 1", "\\2  1", "-\\2  1", "-c 1", "\\2 1", "-\\2 1" ],
 		invalid_values: []
 	},
 	"counter-reset": {
 		domProp: "counterReset",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		initial_values: [ "none" ],
-		other_values: [ "bar 0", "foo", "foo 3 bar baz 2" ],
+		other_values: [ "foo 1", "bar", "foo 3 bar baz 2", "\\32  1", "-\\32  1", "-c 1", "\\32 1", "-\\32 1", "\\2  1", "-\\2  1", "-c 1", "\\2 1", "-\\2 1" ],
 		invalid_values: []
 	},
 	"cue": {
 		domProp: "cue",
 		inherited: false,
 		backend_only: true,
 		type: CSS_TYPE_TRUE_SHORTHAND,
 		subproperties: [ "cue-before", "cue-after" ],
@@ -2064,17 +2064,17 @@ var gCSSProperties = {
 		invalid_values: []
 	},
 	"-moz-transition": {
 		domProp: "MozTransition",
 		inherited: false,
 		type: CSS_TYPE_TRUE_SHORTHAND,
 		subproperties: [ "-moz-transition-property", "-moz-transition-duration", "-moz-transition-timing-function", "-moz-transition-delay" ],
 		initial_values: [ "all 0s ease 0s" ],
-		other_values: [ "width 1s linear 2s", "width 1s 2s linear", "width linear 1s 2s", "linear width 1s 2s", "linear 1s width 2s", "linear 1s 2s width", "1s width linear 2s", "1s width 2s linear", "1s 2s width linear", "1s linear width 2s", "1s linear 2s width", "1s 2s linear width", "width linear 1s", "width 1s linear", "linear width 1s", "linear 1s width", "1s width linear", "1s linear width", "1s 2s width", "1s width 2s", "width 1s 2s", "1s 2s linear", "1s linear 2s", "linear 1s 2s", "width 1s", "1s width", "linear 1s", "1s linear", "1s 2s", "2s 1s", "width", "linear", "1s", "height", "2s", "ease-in-out", "2s ease-in", "opacity linear", "ease-out 2s", "2s color, 1s width, 500ms height linear, 1s opacity 4s cubic-bezier(0.0, 0.1, 1.0, 1.0)" ],
+		other_values: [ "width 1s linear 2s", "width 1s 2s linear", "width linear 1s 2s", "linear width 1s 2s", "linear 1s width 2s", "linear 1s 2s width", "1s width linear 2s", "1s width 2s linear", "1s 2s width linear", "1s linear width 2s", "1s linear 2s width", "1s 2s linear width", "width linear 1s", "width 1s linear", "linear width 1s", "linear 1s width", "1s width linear", "1s linear width", "1s 2s width", "1s width 2s", "width 1s 2s", "1s 2s linear", "1s linear 2s", "linear 1s 2s", "width 1s", "1s width", "linear 1s", "1s linear", "1s 2s", "2s 1s", "width", "linear", "1s", "height", "2s", "ease-in-out", "2s ease-in", "opacity linear", "ease-out 2s", "2s color, 1s width, 500ms height linear, 1s opacity 4s cubic-bezier(0.0, 0.1, 1.0, 1.0)", "1s \\32width linear 2s", "1s -width linear 2s", "1s -\\32width linear 2s", "1s \\32 0width linear 2s", "1s -\\32 0width linear 2s", "1s \\2width linear 2s", "1s -\\2width linear 2s" ],
 		invalid_values: [ "2s, 1s width", "1s width, 2s", "2s all, 1s width", "1s width, 2s all", "1s width, 2s none", "2s none, 1s width", "2s inherit", "inherit 2s", "2s width, 1s inherit", "2s inherit, 1s width", "2s initial", "2s all, 1s width", "2s width, 1s all" ]
 	},
 	"-moz-transition-delay": {
 		domProp: "MozTransitionDelay",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		initial_values: [ "0s", "0ms" ],
 		other_values: [ "1s", "250ms", "-100ms", "-1s", "1s, 250ms, 2.3s"],
@@ -2088,17 +2088,17 @@ var gCSSProperties = {
 		other_values: [ "1s", "250ms", "-1ms", "-2s", "1s, 250ms, 2.3s"],
 		invalid_values: [ "0", "0px" ]
 	},
 	"-moz-transition-property": {
 		domProp: "MozTransitionProperty",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		initial_values: [ "all" ],
-		other_values: [ "none", "left", "top", "color", "width, height, opacity", "foobar", "auto" ],
+		other_values: [ "none", "left", "top", "color", "width, height, opacity", "foobar", "auto", "\\32width", "-width", "-\\32width", "\\32 0width", "-\\32 0width", "\\2width", "-\\2width" ],
 		invalid_values: [ "none, none", "all, all", "color, none", "none, color", "all, color", "color, all", "inherit, color", "color, inherit", "initial, color", "color, initial", "none, color", "color, none", "all, color", "color, all" ]
 	},
 	"-moz-transition-timing-function": {
 		domProp: "MozTransitionTimingFunction",
 		inherited: false,
 		type: CSS_TYPE_LONGHAND,
 		initial_values: [ "ease", "cubic-bezier(0.25, 0.1, 0.25, 1.0)" ],
 		other_values: [ "linear", "ease-in", "ease-out", "ease-in-out", "linear, ease-in, cubic-bezier(0.1, 0.2, 0.8, 0.9)" ],
diff --git a/layout/style/test/test_selectors.html b/layout/style/test/test_selectors.html
--- a/layout/style/test/test_selectors.html
+++ b/layout/style/test/test_selectors.html
@@ -759,16 +759,45 @@ function run() {
                           empty_set, set_single, html_default_ns);
     test_selector_in_html(":-moz-tree-column(x(){} a", single_a,
                           empty_set, set_single, html_default_ns);
     test_selector_in_html(":-moz-tree-column(a b (){} a", single_a,
                           empty_set, set_single, html_default_ns);
     test_selector_in_html(":-moz-tree-column(a, b (){} a", single_a,
                           empty_set, set_single, html_default_ns);
 
+    // Bug 543428 (escaping)
+    test_selector_in_html("\\32|a", single_a, set_single, empty_set,
+                          "@namespace \\32 url(http://www.w3.org/1999/xhtml);");
+    test_selector_in_html("-\\32|a", single_a, set_single, empty_set,
+                          "@namespace -\\32 url(http://www.w3.org/1999/xhtml);");
+    test_selector_in_html("\\2|a", single_a, set_single, empty_set,
+                          "@namespace \\0002 url(http://www.w3.org/1999/xhtml);");
+    test_selector_in_html("-\\2|a", single_a, set_single, empty_set,
+                          "@namespace -\\000002 url(http://www.w3.org/1999/xhtml);");
+    var spans = "<span class='2'></span><span class='&#x2;'></span>" +
+                "<span id='2'></span><span id='&#x2;'></span>"
+    test_selector_in_html(".\\32", spans,
+                          bodychildset([0]), bodychildset([1, 2, 3]));
+    test_selector_in_html("[class=\\32]", spans,
+                          bodychildset([0]), bodychildset([1, 2, 3]));
+    test_selector_in_html(".\\2", spans,
+                          bodychildset([1]), bodychildset([0, 2, 3]));
+    test_selector_in_html("[class=\\2]", spans,
+                          bodychildset([1]), bodychildset([0, 2, 3]));
+    test_selector_in_html("#\\32", spans,
+                          bodychildset([2]), bodychildset([0, 1, 3]));
+    test_selector_in_html("[id=\\32]", spans,
+                          bodychildset([2]), bodychildset([0, 1, 3]));
+    test_selector_in_html("#\\2", spans,
+                          bodychildset([3]), bodychildset([0, 1, 2]));
+    test_selector_in_html("[id=\\2]", spans,
+                          bodychildset([3]), bodychildset([0, 1, 2]));
+    test_balanced_unparseable("#2");
+
     run_deferred_tests();
 }
 
 var deferred_tests = [];
 
 function defer_clonedoc_tests(docurl, onloadfunc)
 {
     deferred_tests.push( { docurl: docurl, onloadfunc: onloadfunc } );

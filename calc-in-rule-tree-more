From: L. David Baron <dbaron@dbaron.org>

Avoid failing to store calc() expressions in the rule tree when they don't mix values.

diff --git a/layout/style/nsRuleNode.cpp b/layout/style/nsRuleNode.cpp
--- a/layout/style/nsRuleNode.cpp
+++ b/layout/style/nsRuleNode.cpp
@@ -504,16 +504,27 @@ static void
 SpecifiedCalcToComputedCalc(const nsCSSValue& aValue, nsStyleCoord& aCoord, 
                             nsStyleContext* aStyleContext,
                             bool& aCanStoreInRuleTree)
 {
   LengthPercentPairCalcOps ops(aStyleContext, aStyleContext->PresContext(),
                                aCanStoreInRuleTree);
   nsRuleNode::ComputedCalc vals = ComputeCalc(aValue, ops);
 
+  if (!ops.mHasPercent) {
+    MOZ_ASSERT(vals.mPercent == 0.0f);
+    aCoord.SetLengthValue(vals.mLength);
+    return;
+  }
+
+  if (ops.mLength == 0) {
+    aCoord.SetPercentValue(vals.mPercent);
+    return;
+  }
+
   nsStyleCoord::Calc *calcObj =
     new (aStyleContext->Alloc(sizeof(nsStyleCoord::Calc))) nsStyleCoord::Calc;
   // Because we use aStyleContext->Alloc(), we have to store the result
   // on the style context and not in the rule tree.
   aCanStoreInRuleTree = false;
 
   calcObj->mLength = vals.mLength;
   calcObj->mPercent = vals.mPercent;

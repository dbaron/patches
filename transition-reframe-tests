From: L. David Baron <dbaron@dbaron.org>

Bug 625289 patch 12 - Tests for transitions on elements that are reframing.

Without the patch, most of the tests fail (although the e1 test and the
two root tests pass).  With the patch, all tests pass.

diff --git a/layout/style/test/mochitest.ini b/layout/style/test/mochitest.ini
--- a/layout/style/test/mochitest.ini
+++ b/layout/style/test/mochitest.ini
@@ -178,16 +178,17 @@ skip-if = (toolkit == 'gonk' && debug) #
 [test_selectors_on_anonymous_content.html]
 [test_shorthand_property_getters.html]
 [test_specified_value_serialization.html]
 [test_style_attribute_quirks.html]
 [test_style_attribute_standards.html]
 [test_style_struct_copy_constructors.html]
 [test_supports_rules.html]
 [test_system_font_serialization.html]
+[test_transitions_and_reframes.html]
 [test_transitions_and_zoom.html]
 [test_transitions_cancel_near_end.html]
 [test_transitions_computed_values.html]
 [test_transitions_computed_value_combinations.html]
 [test_transitions_events.html]
 [test_transitions.html]
 [test_transitions_per_property.html]
 skip-if = buildapp == 'b2g' #bug 775227 # b2g(times out, needs more time + various failures) b2g-debug(times out, needs more time + various failures) b2g-desktop(times out, needs more time + various failures)
diff --git a/layout/style/test/test_transitions_and_reframes.html b/layout/style/test/test_transitions_and_reframes.html
new file mode 100644
--- /dev/null
+++ b/layout/style/test/test_transitions_and_reframes.html
@@ -0,0 +1,176 @@
+<!DOCTYPE HTML>
+<html>
+<!--
+https://bugzilla.mozilla.org/show_bug.cgi?id=625289
+-->
+<head>
+  <meta charset="utf-8">
+  <title>Test for Bug 625289</title>
+  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
+  <link rel="stylesheet" type="text/css" href="/tests/SimpleTest/test.css"/>
+  <style>
+  #e1, #e2 > div,
+  #b1::before, #b2 > div::before,
+  #a1::after, #a2 > div::after {
+    transition: margin-left linear 1s;
+    margin-left: 0;
+    display: block;
+  }
+  #b1::before, #b2 > div::before,
+  #a1::after, #a2 > div::after {
+    content: "x";
+  }
+  :root { margin-left: 0 }
+  :root.m,
+  #e1.m, #e2.m > div,
+  #b1.m::before, #b2.m > div::before,
+  #a1.m::after, #a2.m > div::after {
+    margin-left: 100px;
+  }
+  .o { overflow: hidden }
+  </style>
+</head>
+<body>
+<a target="_blank" href="https://bugzilla.mozilla.org/show_bug.cgi?id=625289">Mozilla Bug 625289</a>
+<div id="container"></div>
+<pre id="test">
+<script>
+
+function advance_clock(milliseconds) {
+  SpecialPowers.DOMWindowUtils.advanceTimeAndRefresh(milliseconds);
+}
+
+var container = document.getElementById("container");
+
+function make_elements(idName, child) {
+  var e = document.createElement("div");
+  e.setAttribute("id", idName);
+  if (child) {
+    e.appendChild(document.createElement("div"));
+  }
+  container.appendChild(e);
+  return e;
+}
+
+function assert_margin_at_quarter(element, pseudo)
+{
+  var desc;
+  var useParent = false;
+  if (element == document.documentElement) {
+    desc = "root element";
+  } else if (element.id) {
+    desc = "element " + element.id;
+  } else {
+    desc = "child of element " + element.parentNode.id;
+    useParent = true;
+  }
+  var classes = (useParent ? element.parentNode : element).getAttribute("class");
+  if (classes) {
+    desc += " (classes: " + classes + ")";
+  }
+  if (pseudo) {
+    desc += " " + pseudo + " pseudo-element";
+  }
+  is(getComputedStyle(element, pseudo).marginLeft, "25px",
+     "margin of " + desc);
+}
+
+var e;
+
+advance_clock(0);
+
+e = make_elements("e1", false);
+advance_clock(100);
+e.classList.add("m");
+e.classList.add("o");
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(e, "");
+e.remove();
+
+e = make_elements("e2", true);
+advance_clock(100);
+e.classList.add("m");
+e.classList.add("o");
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(e.firstChild, "");
+e.remove();
+
+e = make_elements("b1", false);
+advance_clock(100);
+e.classList.add("m");
+e.classList.add("o");
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(e, "::before");
+e.remove();
+
+e = make_elements("b2", true);
+advance_clock(100);
+e.classList.add("m");
+e.classList.add("o");
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(e.firstChild, "::before");
+e.remove();
+
+e = make_elements("a1", false);
+advance_clock(100);
+e.classList.add("m");
+e.classList.add("o");
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(e, "::after");
+e.remove();
+
+e = make_elements("a2", true);
+advance_clock(100);
+e.classList.add("m");
+e.classList.add("o");
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(e.firstChild, "::after");
+e.remove();
+
+var root = document.documentElement;
+
+root.style.transition = "margin-left linear 1s";
+advance_clock(100);
+root.classList.add("m");
+root.classList.add("o");
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(root, "");
+root.style.transition = "";
+root.setAttribute("class", "");
+
+// Recheck e2 and root with a dynamic change in transition
+
+e = make_elements("e2", true);
+e.style.transition = "none";
+advance_clock(100);
+e.classList.add("m");
+e.classList.add("o");
+e.style.transition = "";
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(e.firstChild, "");
+e.remove();
+
+advance_clock(100);
+root.classList.add("m");
+root.classList.add("o");
+root.style.transition = "margin-left linear 1s";
+advance_clock(0);
+advance_clock(250);
+assert_margin_at_quarter(root, "");
+root.style.transition = "";
+root.setAttribute("class", "");
+
+SpecialPowers.DOMWindowUtils.restoreNormalRefresh();
+
+</script>
+</pre>
+</body>
+</html>

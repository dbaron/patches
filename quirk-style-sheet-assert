Assert when we set the quirk style sheet after building rule cascades.  (Bug 448281)

diff --git a/layout/style/nsCSSRuleProcessor.h b/layout/style/nsCSSRuleProcessor.h
--- a/layout/style/nsCSSRuleProcessor.h
+++ b/layout/style/nsCSSRuleProcessor.h
@@ -91,16 +91,22 @@ public:
                                     nsReStyleHint* aResult);
 
   NS_IMETHOD HasAttributeDependentStyle(AttributeRuleProcessorData* aData,
                                         nsReStyleHint* aResult);
 
   NS_IMETHOD MediumFeaturesChanged(nsPresContext* aPresContext,
                                    PRBool* aRulesChanged);
 
+#ifdef DEBUG
+  void AssertQuirksChangeOK() {
+    NS_ASSERTION(!mRuleCascades, "too late to set quirks style sheet");
+  }
+#endif
+
 protected:
   RuleCascadeData* GetRuleCascade(nsPresContext* aPresContext);
   void RefreshRuleCascade(nsPresContext* aPresContext);
 
   // The sheet order here is the same as in nsStyleSet::mSheets
   nsCOMArray<nsICSSStyleSheet> mSheets;
 
   // active first, then cached (most recent first)
diff --git a/layout/style/nsStyleSet.cpp b/layout/style/nsStyleSet.cpp
--- a/layout/style/nsStyleSet.cpp
+++ b/layout/style/nsStyleSet.cpp
@@ -364,16 +364,22 @@ nsStyleSet::EnableQuirkStyleSheet(PRBool
         mQuirkStyleSheet = quirkSheet;
         // only one quirk style sheet can exist, so stop looking
         break;
       }
     }
   }
   NS_ASSERTION(mQuirkStyleSheet, "no quirk stylesheet");
   if (mQuirkStyleSheet) {
+#ifdef DEBUG
+    if (mRuleProcessors[eAgentSheet]) {
+      static_cast<nsCSSRuleProcessor*>(static_cast<nsIStyleRuleProcessor*>(
+        mRuleProcessors[eAgentSheet]))->AssertQuirksChangeOK();
+    }
+#endif
 #ifdef DEBUG_dbaron_off // XXX Make this |DEBUG| once it stops firing.
     PRBool applicableNow;
     mQuirkStyleSheet->GetApplicable(applicableNow);
     NS_ASSERTION(!mRuleProcessors[eAgentSheet] || aEnable == applicableNow,
                  "enabling/disabling quirk stylesheet too late or incomplete quirk stylesheet");
     if (mRuleProcessors[eAgentSheet] && aEnable == applicableNow)
       printf("WARNING: We set the quirks mode too many times.\n"); // we do!
 #endif
